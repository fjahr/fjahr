<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - total_coverage.info - src/wallet/rpcwallet.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/wallet</a> - rpcwallet.cpp<span style="font-size: 80%;"> (source / <a href="rpcwallet.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">total_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2755</td>
            <td class="headerCovTableEntry">2846</td>
            <td class="headerCovTableEntryHi">96.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-09-26 01:30:44</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">93</td>
            <td class="headerCovTableEntry">95</td>
            <td class="headerCovTableEntryHi">97.9 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // Copyright (c) 2010 Satoshi Nakamoto</a>
<a name="2"><span class="lineNum">       2 </span>            : // Copyright (c) 2009-2020 The Bitcoin Core developers</a>
<a name="3"><span class="lineNum">       3 </span>            : // Distributed under the MIT software license, see the accompanying</a>
<a name="4"><span class="lineNum">       4 </span>            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</a>
<a name="5"><span class="lineNum">       5 </span>            : </a>
<a name="6"><span class="lineNum">       6 </span>            : #include &lt;amount.h&gt;</a>
<a name="7"><span class="lineNum">       7 </span>            : #include &lt;core_io.h&gt;</a>
<a name="8"><span class="lineNum">       8 </span>            : #include &lt;interfaces/chain.h&gt;</a>
<a name="9"><span class="lineNum">       9 </span>            : #include &lt;key_io.h&gt;</a>
<a name="10"><span class="lineNum">      10 </span>            : #include &lt;node/context.h&gt;</a>
<a name="11"><span class="lineNum">      11 </span>            : #include &lt;outputtype.h&gt;</a>
<a name="12"><span class="lineNum">      12 </span>            : #include &lt;policy/feerate.h&gt;</a>
<a name="13"><span class="lineNum">      13 </span>            : #include &lt;policy/fees.h&gt;</a>
<a name="14"><span class="lineNum">      14 </span>            : #include &lt;policy/policy.h&gt;</a>
<a name="15"><span class="lineNum">      15 </span>            : #include &lt;policy/rbf.h&gt;</a>
<a name="16"><span class="lineNum">      16 </span>            : #include &lt;rpc/rawtransaction_util.h&gt;</a>
<a name="17"><span class="lineNum">      17 </span>            : #include &lt;rpc/server.h&gt;</a>
<a name="18"><span class="lineNum">      18 </span>            : #include &lt;rpc/util.h&gt;</a>
<a name="19"><span class="lineNum">      19 </span>            : #include &lt;script/descriptor.h&gt;</a>
<a name="20"><span class="lineNum">      20 </span>            : #include &lt;script/sign.h&gt;</a>
<a name="21"><span class="lineNum">      21 </span>            : #include &lt;util/bip32.h&gt;</a>
<a name="22"><span class="lineNum">      22 </span>            : #include &lt;util/fees.h&gt;</a>
<a name="23"><span class="lineNum">      23 </span>            : #include &lt;util/message.h&gt; // For MessageSign()</a>
<a name="24"><span class="lineNum">      24 </span>            : #include &lt;util/moneystr.h&gt;</a>
<a name="25"><span class="lineNum">      25 </span>            : #include &lt;util/ref.h&gt;</a>
<a name="26"><span class="lineNum">      26 </span>            : #include &lt;util/string.h&gt;</a>
<a name="27"><span class="lineNum">      27 </span>            : #include &lt;util/system.h&gt;</a>
<a name="28"><span class="lineNum">      28 </span>            : #include &lt;util/translation.h&gt;</a>
<a name="29"><span class="lineNum">      29 </span>            : #include &lt;util/url.h&gt;</a>
<a name="30"><span class="lineNum">      30 </span>            : #include &lt;util/vector.h&gt;</a>
<a name="31"><span class="lineNum">      31 </span>            : #include &lt;wallet/coincontrol.h&gt;</a>
<a name="32"><span class="lineNum">      32 </span>            : #include &lt;wallet/context.h&gt;</a>
<a name="33"><span class="lineNum">      33 </span>            : #include &lt;wallet/feebumper.h&gt;</a>
<a name="34"><span class="lineNum">      34 </span>            : #include &lt;wallet/load.h&gt;</a>
<a name="35"><span class="lineNum">      35 </span>            : #include &lt;wallet/rpcwallet.h&gt;</a>
<a name="36"><span class="lineNum">      36 </span>            : #include &lt;wallet/wallet.h&gt;</a>
<a name="37"><span class="lineNum">      37 </span>            : #include &lt;wallet/walletdb.h&gt;</a>
<a name="38"><span class="lineNum">      38 </span>            : #include &lt;wallet/walletutil.h&gt;</a>
<a name="39"><span class="lineNum">      39 </span>            : </a>
<a name="40"><span class="lineNum">      40 </span>            : #include &lt;stdint.h&gt;</a>
<a name="41"><span class="lineNum">      41 </span>            : </a>
<a name="42"><span class="lineNum">      42 </span>            : #include &lt;univalue.h&gt;</a>
<a name="43"><span class="lineNum">      43 </span>            : </a>
<a name="44"><span class="lineNum">      44 </span>            : </a>
<a name="45"><span class="lineNum">      45 </span>            : using interfaces::FoundBlock;</a>
<a name="46"><span class="lineNum">      46 </span>            : </a>
<a name="47"><span class="lineNum">      47 </span><span class="lineCov">        650 : static const std::string WALLET_ENDPOINT_BASE = &quot;/wallet/&quot;;</span></a>
<a name="48"><span class="lineNum">      48 </span><span class="lineCov">        650 : static const std::string HELP_REQUIRING_PASSPHRASE{&quot;\nRequires wallet passphrase to be set with walletpassphrase call if wallet is encrypted.\n&quot;};</span></a>
<a name="49"><span class="lineNum">      49 </span>            : </a>
<a name="50"><span class="lineNum">      50 </span>            : static const uint32_t WALLET_BTC_KB_TO_SAT_B = COIN / 1000; // 1 sat / B = 0.00001 BTC / kB</a>
<a name="51"><span class="lineNum">      51 </span>            : </a>
<a name="52"><span class="lineNum">      52 </span><span class="lineCov">       1364 : static inline bool GetAvoidReuseFlag(const CWallet* const pwallet, const UniValue&amp; param) {</span></a>
<a name="53"><span class="lineNum">      53 </span><span class="lineCov">       1364 :     bool can_avoid_reuse = pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_AVOID_REUSE);</span></a>
<a name="54"><span class="lineNum">      54 </span><span class="lineCov">       1364 :     bool avoid_reuse = param.isNull() ? can_avoid_reuse : param.get_bool();</span></a>
<a name="55"><span class="lineNum">      55 </span>            : </a>
<a name="56"><span class="lineNum">      56 </span><span class="lineCov">       1364 :     if (avoid_reuse &amp;&amp; !can_avoid_reuse) {</span></a>
<a name="57"><span class="lineNum">      57 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;wallet does not have the \&quot;avoid reuse\&quot; feature enabled&quot;);</span></a>
<a name="58"><span class="lineNum">      58 </span>            :     }</a>
<a name="59"><span class="lineNum">      59 </span>            : </a>
<a name="60"><span class="lineNum">      60 </span><span class="lineCov">       1364 :     return avoid_reuse;</span></a>
<a name="61"><span class="lineNum">      61 </span><span class="lineNoCov">          0 : }</span></a>
<a name="62"><span class="lineNum">      62 </span>            : </a>
<a name="63"><span class="lineNum">      63 </span>            : </a>
<a name="64"><span class="lineNum">      64 </span>            : /** Used by RPC commands that have an include_watchonly parameter.</a>
<a name="65"><span class="lineNum">      65 </span>            :  *  We default to true for watchonly wallets if include_watchonly isn't</a>
<a name="66"><span class="lineNum">      66 </span>            :  *  explicitly set.</a>
<a name="67"><span class="lineNum">      67 </span>            :  */</a>
<a name="68"><span class="lineNum">      68 </span><span class="lineCov">       1522 : static bool ParseIncludeWatchonly(const UniValue&amp; include_watchonly, const CWallet&amp; pwallet)</span></a>
<a name="69"><span class="lineNum">      69 </span>            : {</a>
<a name="70"><span class="lineNum">      70 </span><span class="lineCov">       1522 :     if (include_watchonly.isNull()) {</span></a>
<a name="71"><span class="lineNum">      71 </span>            :         // if include_watchonly isn't explicitly set, then check if we have a watchonly wallet</a>
<a name="72"><span class="lineNum">      72 </span><span class="lineCov">        824 :         return pwallet.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS);</span></a>
<a name="73"><span class="lineNum">      73 </span>            :     }</a>
<a name="74"><span class="lineNum">      74 </span>            : </a>
<a name="75"><span class="lineNum">      75 </span>            :     // otherwise return whatever include_watchonly was set to</a>
<a name="76"><span class="lineNum">      76 </span><span class="lineCov">        698 :     return include_watchonly.get_bool();</span></a>
<a name="77"><span class="lineNum">      77 </span><span class="lineCov">       1522 : }</span></a>
<a name="78"><span class="lineNum">      78 </span>            : </a>
<a name="79"><span class="lineNum">      79 </span>            : </a>
<a name="80"><span class="lineNum">      80 </span>            : /** Checks if a CKey is in the given CWallet compressed or otherwise*/</a>
<a name="81"><span class="lineNum">      81 </span><span class="lineCov">          7 : bool HaveKey(const SigningProvider&amp; wallet, const CKey&amp; key)</span></a>
<a name="82"><span class="lineNum">      82 </span>            : {</a>
<a name="83"><span class="lineNum">      83 </span><span class="lineCov">          7 :     CKey key2;</span></a>
<a name="84"><span class="lineNum">      84 </span><span class="lineCov">          7 :     key2.Set(key.begin(), key.end(), !key.IsCompressed());</span></a>
<a name="85"><span class="lineNum">      85 </span><span class="lineCov">          7 :     return wallet.HaveKey(key.GetPubKey().GetID()) || wallet.HaveKey(key2.GetPubKey().GetID());</span></a>
<a name="86"><span class="lineNum">      86 </span><span class="lineCov">          7 : }</span></a>
<a name="87"><span class="lineNum">      87 </span>            : </a>
<a name="88"><span class="lineNum">      88 </span><span class="lineCov">      17723 : bool GetWalletNameFromJSONRPCRequest(const JSONRPCRequest&amp; request, std::string&amp; wallet_name)</span></a>
<a name="89"><span class="lineNum">      89 </span>            : {</a>
<a name="90"><span class="lineNum">      90 </span><span class="lineCov">      17723 :     if (URL_DECODE &amp;&amp; request.URI.substr(0, WALLET_ENDPOINT_BASE.size()) == WALLET_ENDPOINT_BASE) {</span></a>
<a name="91"><span class="lineNum">      91 </span>            :         // wallet endpoint was used</a>
<a name="92"><span class="lineNum">      92 </span><span class="lineCov">       1730 :         wallet_name = URL_DECODE(request.URI.substr(WALLET_ENDPOINT_BASE.size()));</span></a>
<a name="93"><span class="lineNum">      93 </span><span class="lineCov">       1730 :         return true;</span></a>
<a name="94"><span class="lineNum">      94 </span>            :     }</a>
<a name="95"><span class="lineNum">      95 </span><span class="lineCov">      15993 :     return false;</span></a>
<a name="96"><span class="lineNum">      96 </span><span class="lineCov">      17723 : }</span></a>
<a name="97"><span class="lineNum">      97 </span>            : </a>
<a name="98"><span class="lineNum">      98 </span><span class="lineCov">      17596 : std::shared_ptr&lt;CWallet&gt; GetWalletForJSONRPCRequest(const JSONRPCRequest&amp; request)</span></a>
<a name="99"><span class="lineNum">      99 </span>            : {</a>
<a name="100"><span class="lineNum">     100 </span><span class="lineCov">      17622 :     CHECK_NONFATAL(!request.fHelp);</span></a>
<a name="101"><span class="lineNum">     101 </span><span class="lineCov">      17596 :     std::string wallet_name;</span></a>
<a name="102"><span class="lineNum">     102 </span><span class="lineCov">      17596 :     if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {</span></a>
<a name="103"><span class="lineNum">     103 </span><span class="lineCov">       1695 :         std::shared_ptr&lt;CWallet&gt; pwallet = GetWallet(wallet_name);</span></a>
<a name="104"><span class="lineNum">     104 </span><span class="lineCov">       1695 :         if (!pwallet) throw JSONRPCError(RPC_WALLET_NOT_FOUND, &quot;Requested wallet does not exist or is not loaded&quot;);</span></a>
<a name="105"><span class="lineNum">     105 </span>            :         return pwallet;</a>
<a name="106"><span class="lineNum">     106 </span><span class="lineCov">       1695 :     }</span></a>
<a name="107"><span class="lineNum">     107 </span>            : </a>
<a name="108"><span class="lineNum">     108 </span><span class="lineCov">      15901 :     std::vector&lt;std::shared_ptr&lt;CWallet&gt;&gt; wallets = GetWallets();</span></a>
<a name="109"><span class="lineNum">     109 </span><span class="lineCov">      15901 :     if (wallets.size() == 1) {</span></a>
<a name="110"><span class="lineNum">     110 </span><span class="lineCov">      15885 :         return wallets[0];</span></a>
<a name="111"><span class="lineNum">     111 </span>            :     }</a>
<a name="112"><span class="lineNum">     112 </span>            : </a>
<a name="113"><span class="lineNum">     113 </span><span class="lineCov">         16 :     if (wallets.empty()) {</span></a>
<a name="114"><span class="lineNum">     114 </span><span class="lineCov">          4 :         throw JSONRPCError(</span></a>
<a name="115"><span class="lineNum">     115 </span><span class="lineCov">          4 :             RPC_METHOD_NOT_FOUND, &quot;Method not found (wallet method is disabled because no wallet is loaded)&quot;);</span></a>
<a name="116"><span class="lineNum">     116 </span>            :     }</a>
<a name="117"><span class="lineNum">     117 </span><span class="lineCov">         12 :     throw JSONRPCError(RPC_WALLET_NOT_SPECIFIED,</span></a>
<a name="118"><span class="lineNum">     118 </span><span class="lineCov">         12 :         &quot;Wallet file not specified (must request wallet RPC through /wallet/&lt;filename&gt; uri-path).&quot;);</span></a>
<a name="119"><span class="lineNum">     119 </span><span class="lineCov">      17606 : }</span></a>
<a name="120"><span class="lineNum">     120 </span>            : </a>
<a name="121"><span class="lineNum">     121 </span><span class="lineCov">       4741 : void EnsureWalletIsUnlocked(const CWallet* pwallet)</span></a>
<a name="122"><span class="lineNum">     122 </span>            : {</a>
<a name="123"><span class="lineNum">     123 </span><span class="lineCov">       4741 :     if (pwallet-&gt;IsLocked()) {</span></a>
<a name="124"><span class="lineNum">     124 </span><span class="lineCov">         13 :         throw JSONRPCError(RPC_WALLET_UNLOCK_NEEDED, &quot;Error: Please enter the wallet passphrase with walletpassphrase first.&quot;);</span></a>
<a name="125"><span class="lineNum">     125 </span>            :     }</a>
<a name="126"><span class="lineNum">     126 </span><span class="lineCov">       4741 : }</span></a>
<a name="127"><span class="lineNum">     127 </span>            : </a>
<a name="128"><span class="lineNum">     128 </span><span class="lineCov">        499 : WalletContext&amp; EnsureWalletContext(const util::Ref&amp; context)</span></a>
<a name="129"><span class="lineNum">     129 </span>            : {</a>
<a name="130"><span class="lineNum">     130 </span><span class="lineCov">        499 :     if (!context.Has&lt;WalletContext&gt;()) {</span></a>
<a name="131"><span class="lineNum">     131 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INTERNAL_ERROR, &quot;Wallet context not found&quot;);</span></a>
<a name="132"><span class="lineNum">     132 </span>            :     }</a>
<a name="133"><span class="lineNum">     133 </span><span class="lineCov">        499 :     return context.Get&lt;WalletContext&gt;();</span></a>
<a name="134"><span class="lineNum">     134 </span><span class="lineNoCov">          0 : }</span></a>
<a name="135"><span class="lineNum">     135 </span>            : </a>
<a name="136"><span class="lineNum">     136 </span>            : // also_create should only be set to true only when the RPC is expected to add things to a blank wallet and make it no longer blank</a>
<a name="137"><span class="lineNum">     137 </span><span class="lineCov">        999 : LegacyScriptPubKeyMan&amp; EnsureLegacyScriptPubKeyMan(CWallet&amp; wallet, bool also_create)</span></a>
<a name="138"><span class="lineNum">     138 </span>            : {</a>
<a name="139"><span class="lineNum">     139 </span><span class="lineCov">        999 :     LegacyScriptPubKeyMan* spk_man = wallet.GetLegacyScriptPubKeyMan();</span></a>
<a name="140"><span class="lineNum">     140 </span><span class="lineCov">        999 :     if (!spk_man &amp;&amp; also_create) {</span></a>
<a name="141"><span class="lineNum">     141 </span><span class="lineCov">          7 :         spk_man = wallet.GetOrCreateLegacyScriptPubKeyMan();</span></a>
<a name="142"><span class="lineNum">     142 </span><span class="lineCov">          7 :     }</span></a>
<a name="143"><span class="lineNum">     143 </span><span class="lineCov">        999 :     if (!spk_man) {</span></a>
<a name="144"><span class="lineNum">     144 </span><span class="lineCov">          9 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;This type of wallet does not support this command&quot;);</span></a>
<a name="145"><span class="lineNum">     145 </span>            :     }</a>
<a name="146"><span class="lineNum">     146 </span><span class="lineCov">        990 :     return *spk_man;</span></a>
<a name="147"><span class="lineNum">     147 </span><span class="lineCov">          9 : }</span></a>
<a name="148"><span class="lineNum">     148 </span>            : </a>
<a name="149"><span class="lineNum">     149 </span><span class="lineCov">       2028 : static void WalletTxToJSON(interfaces::Chain&amp; chain, const CWalletTx&amp; wtx, UniValue&amp; entry)</span></a>
<a name="150"><span class="lineNum">     150 </span>            : {</a>
<a name="151"><span class="lineNum">     151 </span><span class="lineCov">       2028 :     int confirms = wtx.GetDepthInMainChain();</span></a>
<a name="152"><span class="lineNum">     152 </span><span class="lineCov">       2028 :     entry.pushKV(&quot;confirmations&quot;, confirms);</span></a>
<a name="153"><span class="lineNum">     153 </span><span class="lineCov">       2028 :     if (wtx.IsCoinBase())</span></a>
<a name="154"><span class="lineNum">     154 </span><span class="lineCov">       1132 :         entry.pushKV(&quot;generated&quot;, true);</span></a>
<a name="155"><span class="lineNum">     155 </span><span class="lineCov">       2028 :     if (confirms &gt; 0)</span></a>
<a name="156"><span class="lineNum">     156 </span>            :     {</a>
<a name="157"><span class="lineNum">     157 </span><span class="lineCov">       1475 :         entry.pushKV(&quot;blockhash&quot;, wtx.m_confirm.hashBlock.GetHex());</span></a>
<a name="158"><span class="lineNum">     158 </span><span class="lineCov">       1475 :         entry.pushKV(&quot;blockheight&quot;, wtx.m_confirm.block_height);</span></a>
<a name="159"><span class="lineNum">     159 </span><span class="lineCov">       1475 :         entry.pushKV(&quot;blockindex&quot;, wtx.m_confirm.nIndex);</span></a>
<a name="160"><span class="lineNum">     160 </span><span class="lineCov">       1475 :         int64_t block_time;</span></a>
<a name="161"><span class="lineNum">     161 </span><span class="lineCov">       1475 :         CHECK_NONFATAL(chain.findBlock(wtx.m_confirm.hashBlock, FoundBlock().time(block_time)));</span></a>
<a name="162"><span class="lineNum">     162 </span><span class="lineCov">       1475 :         entry.pushKV(&quot;blocktime&quot;, block_time);</span></a>
<a name="163"><span class="lineNum">     163 </span><span class="lineCov">       1475 :     } else {</span></a>
<a name="164"><span class="lineNum">     164 </span><span class="lineCov">        553 :         entry.pushKV(&quot;trusted&quot;, wtx.IsTrusted());</span></a>
<a name="165"><span class="lineNum">     165 </span>            :     }</a>
<a name="166"><span class="lineNum">     166 </span><span class="lineCov">       2028 :     uint256 hash = wtx.GetHash();</span></a>
<a name="167"><span class="lineNum">     167 </span><span class="lineCov">       2028 :     entry.pushKV(&quot;txid&quot;, hash.GetHex());</span></a>
<a name="168"><span class="lineNum">     168 </span><span class="lineCov">       2028 :     UniValue conflicts(UniValue::VARR);</span></a>
<a name="169"><span class="lineNum">     169 </span><span class="lineCov">       2132 :     for (const uint256&amp; conflict : wtx.GetConflicts())</span></a>
<a name="170"><span class="lineNum">     170 </span><span class="lineCov">        104 :         conflicts.push_back(conflict.GetHex());</span></a>
<a name="171"><span class="lineNum">     171 </span><span class="lineCov">       2028 :     entry.pushKV(&quot;walletconflicts&quot;, conflicts);</span></a>
<a name="172"><span class="lineNum">     172 </span><span class="lineCov">       2028 :     entry.pushKV(&quot;time&quot;, wtx.GetTxTime());</span></a>
<a name="173"><span class="lineNum">     173 </span><span class="lineCov">       2028 :     entry.pushKV(&quot;timereceived&quot;, (int64_t)wtx.nTimeReceived);</span></a>
<a name="174"><span class="lineNum">     174 </span>            : </a>
<a name="175"><span class="lineNum">     175 </span>            :     // Add opt-in RBF status</a>
<a name="176"><span class="lineNum">     176 </span><span class="lineCov">       2028 :     std::string rbfStatus = &quot;no&quot;;</span></a>
<a name="177"><span class="lineNum">     177 </span><span class="lineCov">       2028 :     if (confirms &lt;= 0) {</span></a>
<a name="178"><span class="lineNum">     178 </span><span class="lineCov">        553 :         RBFTransactionState rbfState = chain.isRBFOptIn(*wtx.tx);</span></a>
<a name="179"><span class="lineNum">     179 </span><span class="lineCov">        553 :         if (rbfState == RBFTransactionState::UNKNOWN)</span></a>
<a name="180"><span class="lineNum">     180 </span><span class="lineCov">        228 :             rbfStatus = &quot;unknown&quot;;</span></a>
<a name="181"><span class="lineNum">     181 </span><span class="lineCov">        325 :         else if (rbfState == RBFTransactionState::REPLACEABLE_BIP125)</span></a>
<a name="182"><span class="lineNum">     182 </span><span class="lineCov">         37 :             rbfStatus = &quot;yes&quot;;</span></a>
<a name="183"><span class="lineNum">     183 </span><span class="lineCov">        553 :     }</span></a>
<a name="184"><span class="lineNum">     184 </span><span class="lineCov">       2028 :     entry.pushKV(&quot;bip125-replaceable&quot;, rbfStatus);</span></a>
<a name="185"><span class="lineNum">     185 </span>            : </a>
<a name="186"><span class="lineNum">     186 </span><span class="lineCov">       2041 :     for (const std::pair&lt;const std::string, std::string&gt;&amp; item : wtx.mapValue)</span></a>
<a name="187"><span class="lineNum">     187 </span><span class="lineCov">         13 :         entry.pushKV(item.first, item.second);</span></a>
<a name="188"><span class="lineNum">     188 </span><span class="lineCov">       2028 : }</span></a>
<a name="189"><span class="lineNum">     189 </span>            : </a>
<a name="190"><span class="lineNum">     190 </span><span class="lineCov">        430 : static std::string LabelFromValue(const UniValue&amp; value)</span></a>
<a name="191"><span class="lineNum">     191 </span>            : {</a>
<a name="192"><span class="lineNum">     192 </span><span class="lineCov">        430 :     std::string label = value.get_str();</span></a>
<a name="193"><span class="lineNum">     193 </span><span class="lineCov">        430 :     if (label == &quot;*&quot;)</span></a>
<a name="194"><span class="lineNum">     194 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_INVALID_LABEL_NAME, &quot;Invalid label name&quot;);</span></a>
<a name="195"><span class="lineNum">     195 </span>            :     return label;</a>
<a name="196"><span class="lineNum">     196 </span><span class="lineCov">        430 : }</span></a>
<a name="197"><span class="lineNum">     197 </span>            : </a>
<a name="198"><span class="lineNum">     198 </span>            : /**</a>
<a name="199"><span class="lineNum">     199 </span>            :  * Update coin control with fee estimation based on the given parameters</a>
<a name="200"><span class="lineNum">     200 </span>            :  *</a>
<a name="201"><span class="lineNum">     201 </span>            :  * @param[in]     pwallet        Wallet pointer</a>
<a name="202"><span class="lineNum">     202 </span>            :  * @param[in,out] cc             Coin control which is to be updated</a>
<a name="203"><span class="lineNum">     203 </span>            :  * @param[in]     estimate_mode  String value (e.g. &quot;ECONOMICAL&quot;)</a>
<a name="204"><span class="lineNum">     204 </span>            :  * @param[in]     estimate_param Parameter (blocks to confirm, explicit fee rate, etc)</a>
<a name="205"><span class="lineNum">     205 </span>            :  * @throws a JSONRPCError if estimate_mode is unknown, or if estimate_param is missing when required</a>
<a name="206"><span class="lineNum">     206 </span>            :  */</a>
<a name="207"><span class="lineNum">     207 </span><span class="lineCov">       1236 : static void SetFeeEstimateMode(const CWallet* pwallet, CCoinControl&amp; cc, const UniValue&amp; estimate_mode, const UniValue&amp; estimate_param)</span></a>
<a name="208"><span class="lineNum">     208 </span>            : {</a>
<a name="209"><span class="lineNum">     209 </span><span class="lineCov">       1236 :     if (!estimate_mode.isNull()) {</span></a>
<a name="210"><span class="lineNum">     210 </span><span class="lineCov">         26 :         if (!FeeModeFromString(estimate_mode.get_str(), cc.m_fee_mode)) {</span></a>
<a name="211"><span class="lineNum">     211 </span><span class="lineCov">          8 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid estimate_mode parameter&quot;);</span></a>
<a name="212"><span class="lineNum">     212 </span>            :         }</a>
<a name="213"><span class="lineNum">     213 </span>            :     }</a>
<a name="214"><span class="lineNum">     214 </span>            : </a>
<a name="215"><span class="lineNum">     215 </span><span class="lineCov">       1234 :     if (cc.m_fee_mode == FeeEstimateMode::BTC_KB || cc.m_fee_mode == FeeEstimateMode::SAT_B) {</span></a>
<a name="216"><span class="lineNum">     216 </span><span class="lineCov">         22 :         if (estimate_param.isNull()) {</span></a>
<a name="217"><span class="lineNum">     217 </span><span class="lineCov">          6 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Selected estimate_mode requires a fee rate&quot;);</span></a>
<a name="218"><span class="lineNum">     218 </span>            :         }</a>
<a name="219"><span class="lineNum">     219 </span>            : </a>
<a name="220"><span class="lineNum">     220 </span><span class="lineCov">         16 :         CAmount fee_rate = AmountFromValue(estimate_param);</span></a>
<a name="221"><span class="lineNum">     221 </span><span class="lineCov">         16 :         if (cc.m_fee_mode == FeeEstimateMode::SAT_B) {</span></a>
<a name="222"><span class="lineNum">     222 </span><span class="lineCov">          5 :             fee_rate /= WALLET_BTC_KB_TO_SAT_B;</span></a>
<a name="223"><span class="lineNum">     223 </span><span class="lineCov">          5 :         }</span></a>
<a name="224"><span class="lineNum">     224 </span>            : </a>
<a name="225"><span class="lineNum">     225 </span><span class="lineCov">          9 :         cc.m_feerate = CFeeRate(fee_rate);</span></a>
<a name="226"><span class="lineNum">     226 </span>            : </a>
<a name="227"><span class="lineNum">     227 </span>            :         // default RBF to true for explicit fee rate modes</a>
<a name="228"><span class="lineNum">     228 </span><span class="lineCov">          9 :         if (cc.m_signal_bip125_rbf == nullopt) cc.m_signal_bip125_rbf = true;</span></a>
<a name="229"><span class="lineNum">     229 </span><span class="lineCov">       1221 :     } else if (!estimate_param.isNull()) {</span></a>
<a name="230"><span class="lineNum">     230 </span><span class="lineCov">          2 :         cc.m_confirm_target = ParseConfirmTarget(estimate_param, pwallet-&gt;chain().estimateMaxBlocks());</span></a>
<a name="231"><span class="lineNum">     231 </span><span class="lineCov">          2 :     }</span></a>
<a name="232"><span class="lineNum">     232 </span><span class="lineCov">       1229 : }</span></a>
<a name="233"><span class="lineNum">     233 </span>            : </a>
<a name="234"><span class="lineNum">     234 </span><span class="lineCov">       8670 : static UniValue getnewaddress(const JSONRPCRequest&amp; request)</span></a>
<a name="235"><span class="lineNum">     235 </span>            : {</a>
<a name="236"><span class="lineNum">     236 </span><span class="lineCov">      34708 :             RPCHelpMan{&quot;getnewaddress&quot;,</span></a>
<a name="237"><span class="lineNum">     237 </span><span class="lineCov">       8670 :                 &quot;\nReturns a new Bitcoin address for receiving payments.\n&quot;</span></a>
<a name="238"><span class="lineNum">     238 </span>            :                 &quot;If 'label' is specified, it is added to the address book \n&quot;</a>
<a name="239"><span class="lineNum">     239 </span>            :                 &quot;so payments received with the address will be associated with 'label'.\n&quot;,</a>
<a name="240"><span class="lineNum">     240 </span><span class="lineCov">      26016 :                 {</span></a>
<a name="241"><span class="lineNum">     241 </span><span class="lineCov">       8670 :                     {&quot;label&quot;, RPCArg::Type::STR, /* default */ &quot;\&quot;\&quot;&quot;, &quot;The label name for the address to be linked to. It can also be set to the empty string \&quot;\&quot; to represent the default label. The label does not need to exist, it will be created if there is no label by the given name.&quot;},</span></a>
<a name="242"><span class="lineNum">     242 </span><span class="lineCov">       8670 :                     {&quot;address_type&quot;, RPCArg::Type::STR, /* default */ &quot;set by -addresstype&quot;, &quot;The address type to use. Options are \&quot;legacy\&quot;, \&quot;p2sh-segwit\&quot;, and \&quot;bech32\&quot;.&quot;},</span></a>
<a name="243"><span class="lineNum">     243 </span>            :                 },</a>
<a name="244"><span class="lineNum">     244 </span><span class="lineCov">       8670 :                 RPCResult{</span></a>
<a name="245"><span class="lineNum">     245 </span><span class="lineCov">       8670 :                     RPCResult::Type::STR, &quot;address&quot;, &quot;The new bitcoin address&quot;</span></a>
<a name="246"><span class="lineNum">     246 </span>            :                 },</a>
<a name="247"><span class="lineNum">     247 </span><span class="lineCov">       8670 :                 RPCExamples{</span></a>
<a name="248"><span class="lineNum">     248 </span><span class="lineCov">       8670 :                     HelpExampleCli(&quot;getnewaddress&quot;, &quot;&quot;)</span></a>
<a name="249"><span class="lineNum">     249 </span><span class="lineCov">       8670 :             + HelpExampleRpc(&quot;getnewaddress&quot;, &quot;&quot;)</span></a>
<a name="250"><span class="lineNum">     250 </span>            :                 },</a>
<a name="251"><span class="lineNum">     251 </span><span class="lineCov">       8670 :             }.Check(request);</span></a>
<a name="252"><span class="lineNum">     252 </span>            : </a>
<a name="253"><span class="lineNum">     253 </span><span class="lineCov">       8664 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="254"><span class="lineNum">     254 </span><span class="lineCov">       8664 :     if (!wallet) return NullUniValue;</span></a>
<a name="255"><span class="lineNum">     255 </span><span class="lineCov">       8656 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="256"><span class="lineNum">     256 </span>            : </a>
<a name="257"><span class="lineNum">     257 </span><span class="lineCov">       8656 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="258"><span class="lineNum">     258 </span>            : </a>
<a name="259"><span class="lineNum">     259 </span><span class="lineCov">       8656 :     if (!pwallet-&gt;CanGetAddresses()) {</span></a>
<a name="260"><span class="lineNum">     260 </span><span class="lineCov">         20 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Error: This wallet has no available keys&quot;);</span></a>
<a name="261"><span class="lineNum">     261 </span>            :     }</a>
<a name="262"><span class="lineNum">     262 </span>            : </a>
<a name="263"><span class="lineNum">     263 </span>            :     // Parse the label first so we don't generate a key if there's an error</a>
<a name="264"><span class="lineNum">     264 </span><span class="lineCov">       8636 :     std::string label;</span></a>
<a name="265"><span class="lineNum">     265 </span><span class="lineCov">       8636 :     if (!request.params[0].isNull())</span></a>
<a name="266"><span class="lineNum">     266 </span><span class="lineCov">        260 :         label = LabelFromValue(request.params[0]);</span></a>
<a name="267"><span class="lineNum">     267 </span>            : </a>
<a name="268"><span class="lineNum">     268 </span><span class="lineCov">       8636 :     OutputType output_type = pwallet-&gt;m_default_address_type;</span></a>
<a name="269"><span class="lineNum">     269 </span><span class="lineCov">       8636 :     if (!request.params[1].isNull()) {</span></a>
<a name="270"><span class="lineNum">     270 </span><span class="lineCov">       1478 :         if (!ParseOutputType(request.params[1].get_str(), output_type)) {</span></a>
<a name="271"><span class="lineNum">     271 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, strprintf(&quot;Unknown address type '%s'&quot;, request.params[1].get_str()));</span></a>
<a name="272"><span class="lineNum">     272 </span>            :         }</a>
<a name="273"><span class="lineNum">     273 </span>            :     }</a>
<a name="274"><span class="lineNum">     274 </span>            : </a>
<a name="275"><span class="lineNum">     275 </span><span class="lineCov">       8635 :     CTxDestination dest;</span></a>
<a name="276"><span class="lineNum">     276 </span><span class="lineCov">       8635 :     std::string error;</span></a>
<a name="277"><span class="lineNum">     277 </span><span class="lineCov">       8635 :     if (!pwallet-&gt;GetNewDestination(output_type, label, dest, error)) {</span></a>
<a name="278"><span class="lineNum">     278 </span><span class="lineCov">          7 :         throw JSONRPCError(RPC_WALLET_KEYPOOL_RAN_OUT, error);</span></a>
<a name="279"><span class="lineNum">     279 </span>            :     }</a>
<a name="280"><span class="lineNum">     280 </span>            : </a>
<a name="281"><span class="lineNum">     281 </span><span class="lineCov">       8628 :     return EncodeDestination(dest);</span></a>
<a name="282"><span class="lineNum">     282 </span><span class="lineCov">       8692 : }</span></a>
<a name="283"><span class="lineNum">     283 </span>            : </a>
<a name="284"><span class="lineNum">     284 </span><span class="lineCov">         95 : static UniValue getrawchangeaddress(const JSONRPCRequest&amp; request)</span></a>
<a name="285"><span class="lineNum">     285 </span>            : {</a>
<a name="286"><span class="lineNum">     286 </span><span class="lineCov">        311 :             RPCHelpMan{&quot;getrawchangeaddress&quot;,</span></a>
<a name="287"><span class="lineNum">     287 </span><span class="lineCov">         95 :                 &quot;\nReturns a new Bitcoin address, for receiving change.\n&quot;</span></a>
<a name="288"><span class="lineNum">     288 </span>            :                 &quot;This is for use with raw transactions, NOT normal use.\n&quot;,</a>
<a name="289"><span class="lineNum">     289 </span><span class="lineCov">        190 :                 {</span></a>
<a name="290"><span class="lineNum">     290 </span><span class="lineCov">         95 :                     {&quot;address_type&quot;, RPCArg::Type::STR, /* default */ &quot;set by -changetype&quot;, &quot;The address type to use. Options are \&quot;legacy\&quot;, \&quot;p2sh-segwit\&quot;, and \&quot;bech32\&quot;.&quot;},</span></a>
<a name="291"><span class="lineNum">     291 </span>            :                 },</a>
<a name="292"><span class="lineNum">     292 </span><span class="lineCov">         95 :                 RPCResult{</span></a>
<a name="293"><span class="lineNum">     293 </span><span class="lineCov">         95 :                     RPCResult::Type::STR, &quot;address&quot;, &quot;The address&quot;</span></a>
<a name="294"><span class="lineNum">     294 </span>            :                 },</a>
<a name="295"><span class="lineNum">     295 </span><span class="lineCov">         95 :                 RPCExamples{</span></a>
<a name="296"><span class="lineNum">     296 </span><span class="lineCov">         95 :                     HelpExampleCli(&quot;getrawchangeaddress&quot;, &quot;&quot;)</span></a>
<a name="297"><span class="lineNum">     297 </span><span class="lineCov">         95 :             + HelpExampleRpc(&quot;getrawchangeaddress&quot;, &quot;&quot;)</span></a>
<a name="298"><span class="lineNum">     298 </span>            :                 },</a>
<a name="299"><span class="lineNum">     299 </span><span class="lineCov">         95 :             }.Check(request);</span></a>
<a name="300"><span class="lineNum">     300 </span>            : </a>
<a name="301"><span class="lineNum">     301 </span><span class="lineCov">         91 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="302"><span class="lineNum">     302 </span><span class="lineCov">         91 :     if (!wallet) return NullUniValue;</span></a>
<a name="303"><span class="lineNum">     303 </span><span class="lineCov">         91 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="304"><span class="lineNum">     304 </span>            : </a>
<a name="305"><span class="lineNum">     305 </span><span class="lineCov">         91 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="306"><span class="lineNum">     306 </span>            : </a>
<a name="307"><span class="lineNum">     307 </span><span class="lineCov">         91 :     if (!pwallet-&gt;CanGetAddresses(true)) {</span></a>
<a name="308"><span class="lineNum">     308 </span><span class="lineCov">         22 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Error: This wallet has no available keys&quot;);</span></a>
<a name="309"><span class="lineNum">     309 </span>            :     }</a>
<a name="310"><span class="lineNum">     310 </span>            : </a>
<a name="311"><span class="lineNum">     311 </span><span class="lineCov">         69 :     OutputType output_type = pwallet-&gt;m_default_change_type.get_value_or(pwallet-&gt;m_default_address_type);</span></a>
<a name="312"><span class="lineNum">     312 </span><span class="lineCov">         69 :     if (!request.params[0].isNull()) {</span></a>
<a name="313"><span class="lineNum">     313 </span><span class="lineCov">         14 :         if (!ParseOutputType(request.params[0].get_str(), output_type)) {</span></a>
<a name="314"><span class="lineNum">     314 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, strprintf(&quot;Unknown address type '%s'&quot;, request.params[0].get_str()));</span></a>
<a name="315"><span class="lineNum">     315 </span>            :         }</a>
<a name="316"><span class="lineNum">     316 </span>            :     }</a>
<a name="317"><span class="lineNum">     317 </span>            : </a>
<a name="318"><span class="lineNum">     318 </span><span class="lineCov">         67 :     CTxDestination dest;</span></a>
<a name="319"><span class="lineNum">     319 </span><span class="lineCov">         67 :     std::string error;</span></a>
<a name="320"><span class="lineNum">     320 </span><span class="lineCov">         67 :     if (!pwallet-&gt;GetNewChangeDestination(output_type, dest, error)) {</span></a>
<a name="321"><span class="lineNum">     321 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_WALLET_KEYPOOL_RAN_OUT, error);</span></a>
<a name="322"><span class="lineNum">     322 </span>            :     }</a>
<a name="323"><span class="lineNum">     323 </span><span class="lineCov">         65 :     return EncodeDestination(dest);</span></a>
<a name="324"><span class="lineNum">     324 </span><span class="lineCov">        107 : }</span></a>
<a name="325"><span class="lineNum">     325 </span>            : </a>
<a name="326"><span class="lineNum">     326 </span>            : </a>
<a name="327"><span class="lineNum">     327 </span><span class="lineCov">         32 : static UniValue setlabel(const JSONRPCRequest&amp; request)</span></a>
<a name="328"><span class="lineNum">     328 </span>            : {</a>
<a name="329"><span class="lineNum">     329 </span><span class="lineCov">        129 :             RPCHelpMan{&quot;setlabel&quot;,</span></a>
<a name="330"><span class="lineNum">     330 </span><span class="lineCov">         32 :                 &quot;\nSets the label associated with the given address.\n&quot;,</span></a>
<a name="331"><span class="lineNum">     331 </span><span class="lineCov">        100 :                 {</span></a>
<a name="332"><span class="lineNum">     332 </span><span class="lineCov">         32 :                     {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The bitcoin address to be associated with a label.&quot;},</span></a>
<a name="333"><span class="lineNum">     333 </span><span class="lineCov">         32 :                     {&quot;label&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The label to assign to the address.&quot;},</span></a>
<a name="334"><span class="lineNum">     334 </span>            :                 },</a>
<a name="335"><span class="lineNum">     335 </span><span class="lineCov">         32 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="336"><span class="lineNum">     336 </span><span class="lineCov">         32 :                 RPCExamples{</span></a>
<a name="337"><span class="lineNum">     337 </span><span class="lineCov">         32 :                     HelpExampleCli(&quot;setlabel&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; \&quot;tabby\&quot;&quot;)</span></a>
<a name="338"><span class="lineNum">     338 </span><span class="lineCov">         32 :             + HelpExampleRpc(&quot;setlabel&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;, \&quot;tabby\&quot;&quot;)</span></a>
<a name="339"><span class="lineNum">     339 </span>            :                 },</a>
<a name="340"><span class="lineNum">     340 </span><span class="lineCov">         32 :             }.Check(request);</span></a>
<a name="341"><span class="lineNum">     341 </span>            : </a>
<a name="342"><span class="lineNum">     342 </span><span class="lineCov">         28 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="343"><span class="lineNum">     343 </span><span class="lineCov">         28 :     if (!wallet) return NullUniValue;</span></a>
<a name="344"><span class="lineNum">     344 </span><span class="lineCov">         28 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="345"><span class="lineNum">     345 </span>            : </a>
<a name="346"><span class="lineNum">     346 </span><span class="lineCov">         28 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="347"><span class="lineNum">     347 </span>            : </a>
<a name="348"><span class="lineNum">     348 </span><span class="lineCov">         28 :     CTxDestination dest = DecodeDestination(request.params[0].get_str());</span></a>
<a name="349"><span class="lineNum">     349 </span><span class="lineCov">         28 :     if (!IsValidDestination(dest)) {</span></a>
<a name="350"><span class="lineNum">     350 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Invalid Bitcoin address&quot;);</span></a>
<a name="351"><span class="lineNum">     351 </span>            :     }</a>
<a name="352"><span class="lineNum">     352 </span>            : </a>
<a name="353"><span class="lineNum">     353 </span><span class="lineCov">         27 :     std::string label = LabelFromValue(request.params[1]);</span></a>
<a name="354"><span class="lineNum">     354 </span>            : </a>
<a name="355"><span class="lineNum">     355 </span><span class="lineCov">         27 :     if (pwallet-&gt;IsMine(dest)) {</span></a>
<a name="356"><span class="lineNum">     356 </span><span class="lineCov">         27 :         pwallet-&gt;SetAddressBook(dest, label, &quot;receive&quot;);</span></a>
<a name="357"><span class="lineNum">     357 </span><span class="lineCov">         27 :     } else {</span></a>
<a name="358"><span class="lineNum">     358 </span><span class="lineNoCov">          0 :         pwallet-&gt;SetAddressBook(dest, label, &quot;send&quot;);</span></a>
<a name="359"><span class="lineNum">     359 </span>            :     }</a>
<a name="360"><span class="lineNum">     360 </span>            : </a>
<a name="361"><span class="lineNum">     361 </span><span class="lineCov">         27 :     return NullUniValue;</span></a>
<a name="362"><span class="lineNum">     362 </span><span class="lineCov">         52 : }</span></a>
<a name="363"><span class="lineNum">     363 </span>            : </a>
<a name="364"><span class="lineNum">     364 </span><span class="lineCov">       1109 : void ParseRecipients(const UniValue&amp; address_amounts, const UniValue&amp; subtract_fee_outputs, std::vector&lt;CRecipient&gt; &amp;recipients) {</span></a>
<a name="365"><span class="lineNum">     365 </span><span class="lineCov">       1109 :     std::set&lt;CTxDestination&gt; destinations;</span></a>
<a name="366"><span class="lineNum">     366 </span>            :     int i = 0;</a>
<a name="367"><span class="lineNum">     367 </span><span class="lineCov">       5255 :     for (const std::string&amp; address: address_amounts.getKeys()) {</span></a>
<a name="368"><span class="lineNum">     368 </span><span class="lineCov">       4146 :         CTxDestination dest = DecodeDestination(address);</span></a>
<a name="369"><span class="lineNum">     369 </span><span class="lineCov">       4146 :         if (!IsValidDestination(dest)) {</span></a>
<a name="370"><span class="lineNum">     370 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(&quot;Invalid Bitcoin address: &quot;) + address);</span></a>
<a name="371"><span class="lineNum">     371 </span>            :         }</a>
<a name="372"><span class="lineNum">     372 </span>            : </a>
<a name="373"><span class="lineNum">     373 </span><span class="lineCov">       4146 :         if (destinations.count(dest)) {</span></a>
<a name="374"><span class="lineNum">     374 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(&quot;Invalid parameter, duplicated address: &quot;) + address);</span></a>
<a name="375"><span class="lineNum">     375 </span>            :         }</a>
<a name="376"><span class="lineNum">     376 </span><span class="lineCov">       4146 :         destinations.insert(dest);</span></a>
<a name="377"><span class="lineNum">     377 </span>            : </a>
<a name="378"><span class="lineNum">     378 </span><span class="lineCov">       4146 :         CScript script_pub_key = GetScriptForDestination(dest);</span></a>
<a name="379"><span class="lineNum">     379 </span><span class="lineCov">       4146 :         CAmount amount = AmountFromValue(address_amounts[i++]);</span></a>
<a name="380"><span class="lineNum">     380 </span>            : </a>
<a name="381"><span class="lineNum">     381 </span>            :         bool subtract_fee = false;</a>
<a name="382"><span class="lineNum">     382 </span><span class="lineCov">       4172 :         for (unsigned int idx = 0; idx &lt; subtract_fee_outputs.size(); idx++) {</span></a>
<a name="383"><span class="lineNum">     383 </span><span class="lineCov">         30 :             const UniValue&amp; addr = subtract_fee_outputs[idx];</span></a>
<a name="384"><span class="lineNum">     384 </span><span class="lineCov">         30 :             if (addr.get_str() == address) {</span></a>
<a name="385"><span class="lineNum">     385 </span>            :                 subtract_fee = true;</a>
<a name="386"><span class="lineNum">     386 </span><span class="lineCov">         30 :             }</span></a>
<a name="387"><span class="lineNum">     387 </span>            :         }</a>
<a name="388"><span class="lineNum">     388 </span>            : </a>
<a name="389"><span class="lineNum">     389 </span><span class="lineCov">       4142 :         CRecipient recipient = {script_pub_key, amount, subtract_fee};</span></a>
<a name="390"><span class="lineNum">     390 </span><span class="lineCov">       4142 :         recipients.push_back(recipient);</span></a>
<a name="391"><span class="lineNum">     391 </span><span class="lineCov">       4146 :     }</span></a>
<a name="392"><span class="lineNum">     392 </span><span class="lineCov">       1113 : }</span></a>
<a name="393"><span class="lineNum">     393 </span>            : </a>
<a name="394"><span class="lineNum">     394 </span><span class="lineCov">       1105 : UniValue SendMoney(CWallet* const pwallet, const CCoinControl &amp;coin_control, std::vector&lt;CRecipient&gt; &amp;recipients, mapValue_t map_value)</span></a>
<a name="395"><span class="lineNum">     395 </span>            : {</a>
<a name="396"><span class="lineNum">     396 </span><span class="lineCov">       1105 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="397"><span class="lineNum">     397 </span>            : </a>
<a name="398"><span class="lineNum">     398 </span>            :     // Shuffle recipient list</a>
<a name="399"><span class="lineNum">     399 </span><span class="lineCov">       1105 :     std::shuffle(recipients.begin(), recipients.end(), FastRandomContext());</span></a>
<a name="400"><span class="lineNum">     400 </span>            : </a>
<a name="401"><span class="lineNum">     401 </span>            :     // Send</a>
<a name="402"><span class="lineNum">     402 </span><span class="lineCov">       1105 :     CAmount nFeeRequired = 0;</span></a>
<a name="403"><span class="lineNum">     403 </span><span class="lineCov">       1105 :     int nChangePosRet = -1;</span></a>
<a name="404"><span class="lineNum">     404 </span><span class="lineCov">       1105 :     bilingual_str error;</span></a>
<a name="405"><span class="lineNum">     405 </span><span class="lineCov">       1105 :     CTransactionRef tx;</span></a>
<a name="406"><span class="lineNum">     406 </span><span class="lineCov">       1105 :     bool fCreated = pwallet-&gt;CreateTransaction(recipients, tx, nFeeRequired, nChangePosRet, error, coin_control, !pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));</span></a>
<a name="407"><span class="lineNum">     407 </span><span class="lineCov">       1105 :     if (!fCreated) {</span></a>
<a name="408"><span class="lineNum">     408 </span><span class="lineCov">         13 :         throw JSONRPCError(RPC_WALLET_INSUFFICIENT_FUNDS, error.original);</span></a>
<a name="409"><span class="lineNum">     409 </span>            :     }</a>
<a name="410"><span class="lineNum">     410 </span><span class="lineCov">       1092 :     pwallet-&gt;CommitTransaction(tx, std::move(map_value), {} /* orderForm */);</span></a>
<a name="411"><span class="lineNum">     411 </span><span class="lineCov">       1092 :     return tx-&gt;GetHash().GetHex();</span></a>
<a name="412"><span class="lineNum">     412 </span><span class="lineCov">       1105 : }</span></a>
<a name="413"><span class="lineNum">     413 </span>            : </a>
<a name="414"><span class="lineNum">     414 </span><span class="lineCov">       1009 : static UniValue sendtoaddress(const JSONRPCRequest&amp; request)</span></a>
<a name="415"><span class="lineNum">     415 </span>            : {</a>
<a name="416"><span class="lineNum">     416 </span><span class="lineCov">      11116 :             RPCHelpMan{&quot;sendtoaddress&quot;,</span></a>
<a name="417"><span class="lineNum">     417 </span><span class="lineCov">       1009 :                 &quot;\nSend an amount to a given address.&quot; +</span></a>
<a name="418"><span class="lineNum">     418 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="419"><span class="lineNum">     419 </span><span class="lineCov">      10094 :                 {</span></a>
<a name="420"><span class="lineNum">     420 </span><span class="lineCov">       1009 :                     {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The bitcoin address to send to.&quot;},</span></a>
<a name="421"><span class="lineNum">     421 </span><span class="lineCov">       1009 :                     {&quot;amount&quot;, RPCArg::Type::AMOUNT, RPCArg::Optional::NO, &quot;The amount in &quot; + CURRENCY_UNIT + &quot; to send. eg 0.1&quot;},</span></a>
<a name="422"><span class="lineNum">     422 </span><span class="lineCov">       1009 :                     {&quot;comment&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;A comment used to store what the transaction is for.\n&quot;</span></a>
<a name="423"><span class="lineNum">     423 </span>            :             &quot;                             This is not part of the transaction, just kept in your wallet.&quot;},</a>
<a name="424"><span class="lineNum">     424 </span><span class="lineCov">       1009 :                     {&quot;comment_to&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;A comment to store the name of the person or organization\n&quot;</span></a>
<a name="425"><span class="lineNum">     425 </span>            :             &quot;                             to which you're sending the transaction. This is not part of the \n&quot;</a>
<a name="426"><span class="lineNum">     426 </span>            :             &quot;                             transaction, just kept in your wallet.&quot;},</a>
<a name="427"><span class="lineNum">     427 </span><span class="lineCov">       1009 :                     {&quot;subtractfeefromamount&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;The fee will be deducted from the amount being sent.\n&quot;</span></a>
<a name="428"><span class="lineNum">     428 </span>            :             &quot;                             The recipient will receive less bitcoins than you enter in the amount field.&quot;},</a>
<a name="429"><span class="lineNum">     429 </span><span class="lineCov">       1009 :                     {&quot;replaceable&quot;, RPCArg::Type::BOOL, /* default */ &quot;wallet default&quot;, &quot;Allow this transaction to be replaced by a transaction with higher fees via BIP 125&quot;},</span></a>
<a name="430"><span class="lineNum">     430 </span><span class="lineCov">       1009 :                     {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;wallet default&quot;, &quot;Confirmation target (in blocks), or fee rate (for &quot; + CURRENCY_UNIT + &quot;/kB or &quot; + CURRENCY_ATOM + &quot;/B estimate modes)&quot;},</span></a>
<a name="431"><span class="lineNum">     431 </span><span class="lineCov">       2018 :                     {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="432"><span class="lineNum">     432 </span><span class="lineCov">       1009 :             &quot;       \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="433"><span class="lineNum">     433 </span><span class="lineCov">       1009 :                     {&quot;avoid_reuse&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;(only available if avoid_reuse wallet flag is set) Avoid spending from dirty addresses; addresses are considered\n&quot;</span></a>
<a name="434"><span class="lineNum">     434 </span>            :             &quot;                             dirty if they have previously been used in a transaction.&quot;},</a>
<a name="435"><span class="lineNum">     435 </span>            :                 },</a>
<a name="436"><span class="lineNum">     436 </span><span class="lineCov">       1009 :                 RPCResult{</span></a>
<a name="437"><span class="lineNum">     437 </span><span class="lineCov">       1009 :                     RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The transaction id.&quot;</span></a>
<a name="438"><span class="lineNum">     438 </span>            :                 },</a>
<a name="439"><span class="lineNum">     439 </span><span class="lineCov">       1009 :                 RPCExamples{</span></a>
<a name="440"><span class="lineNum">     440 </span><span class="lineCov">       1009 :                     HelpExampleCli(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 0.1&quot;)</span></a>
<a name="441"><span class="lineNum">     441 </span><span class="lineCov">       1009 :             + HelpExampleCli(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 0.1 \&quot;donation\&quot; \&quot;seans outpost\&quot;&quot;)</span></a>
<a name="442"><span class="lineNum">     442 </span><span class="lineCov">       1009 :             + HelpExampleCli(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 0.1 \&quot;\&quot; \&quot;\&quot; true&quot;)</span></a>
<a name="443"><span class="lineNum">     443 </span><span class="lineCov">       1009 :             + HelpExampleCli(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 0.1 \&quot;\&quot; \&quot;\&quot; false true 0.00002 &quot; + (CURRENCY_UNIT + &quot;/kB&quot;))</span></a>
<a name="444"><span class="lineNum">     444 </span><span class="lineCov">       1009 :             + HelpExampleCli(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 0.1 \&quot;\&quot; \&quot;\&quot; false true 2 &quot; + (CURRENCY_ATOM + &quot;/B&quot;))</span></a>
<a name="445"><span class="lineNum">     445 </span><span class="lineCov">       1009 :             + HelpExampleRpc(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;, 0.1, \&quot;donation\&quot;, \&quot;seans outpost\&quot;&quot;)</span></a>
<a name="446"><span class="lineNum">     446 </span>            :                 },</a>
<a name="447"><span class="lineNum">     447 </span><span class="lineCov">       1009 :             }.Check(request);</span></a>
<a name="448"><span class="lineNum">     448 </span>            : </a>
<a name="449"><span class="lineNum">     449 </span><span class="lineCov">       1005 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="450"><span class="lineNum">     450 </span><span class="lineCov">       1005 :     if (!wallet) return NullUniValue;</span></a>
<a name="451"><span class="lineNum">     451 </span><span class="lineCov">       1005 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="452"><span class="lineNum">     452 </span>            : </a>
<a name="453"><span class="lineNum">     453 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="454"><span class="lineNum">     454 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="455"><span class="lineNum">     455 </span><span class="lineCov">       1005 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="456"><span class="lineNum">     456 </span>            : </a>
<a name="457"><span class="lineNum">     457 </span><span class="lineCov">       1005 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="458"><span class="lineNum">     458 </span>            : </a>
<a name="459"><span class="lineNum">     459 </span>            :     // Wallet comments</a>
<a name="460"><span class="lineNum">     460 </span><span class="lineCov">       1005 :     mapValue_t mapValue;</span></a>
<a name="461"><span class="lineNum">     461 </span><span class="lineCov">       1005 :     if (!request.params[2].isNull() &amp;&amp; !request.params[2].get_str().empty())</span></a>
<a name="462"><span class="lineNum">     462 </span><span class="lineCov">          1 :         mapValue[&quot;comment&quot;] = request.params[2].get_str();</span></a>
<a name="463"><span class="lineNum">     463 </span><span class="lineCov">       1005 :     if (!request.params[3].isNull() &amp;&amp; !request.params[3].get_str().empty())</span></a>
<a name="464"><span class="lineNum">     464 </span><span class="lineCov">          1 :         mapValue[&quot;to&quot;] = request.params[3].get_str();</span></a>
<a name="465"><span class="lineNum">     465 </span>            : </a>
<a name="466"><span class="lineNum">     466 </span>            :     bool fSubtractFeeFromAmount = false;</a>
<a name="467"><span class="lineNum">     467 </span><span class="lineCov">       1005 :     if (!request.params[4].isNull()) {</span></a>
<a name="468"><span class="lineNum">     468 </span><span class="lineCov">         28 :         fSubtractFeeFromAmount = request.params[4].get_bool();</span></a>
<a name="469"><span class="lineNum">     469 </span><span class="lineCov">         28 :     }</span></a>
<a name="470"><span class="lineNum">     470 </span>            : </a>
<a name="471"><span class="lineNum">     471 </span><span class="lineCov">       1005 :     CCoinControl coin_control;</span></a>
<a name="472"><span class="lineNum">     472 </span><span class="lineCov">       1005 :     if (!request.params[5].isNull()) {</span></a>
<a name="473"><span class="lineNum">     473 </span><span class="lineCov">          2 :         coin_control.m_signal_bip125_rbf = request.params[5].get_bool();</span></a>
<a name="474"><span class="lineNum">     474 </span><span class="lineCov">          2 :     }</span></a>
<a name="475"><span class="lineNum">     475 </span>            : </a>
<a name="476"><span class="lineNum">     476 </span><span class="lineCov">       1005 :     coin_control.m_avoid_address_reuse = GetAvoidReuseFlag(pwallet, request.params[8]);</span></a>
<a name="477"><span class="lineNum">     477 </span>            :     // We also enable partial spend avoidance if reuse avoidance is set.</a>
<a name="478"><span class="lineNum">     478 </span><span class="lineCov">       1005 :     coin_control.m_avoid_partial_spends |= coin_control.m_avoid_address_reuse;</span></a>
<a name="479"><span class="lineNum">     479 </span>            : </a>
<a name="480"><span class="lineNum">     480 </span><span class="lineCov">       1005 :     SetFeeEstimateMode(pwallet, coin_control, request.params[7], request.params[6]);</span></a>
<a name="481"><span class="lineNum">     481 </span>            : </a>
<a name="482"><span class="lineNum">     482 </span><span class="lineCov">       1001 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="483"><span class="lineNum">     483 </span>            : </a>
<a name="484"><span class="lineNum">     484 </span><span class="lineCov">       1000 :     UniValue address_amounts(UniValue::VOBJ);</span></a>
<a name="485"><span class="lineNum">     485 </span><span class="lineCov">       1000 :     const std::string address = request.params[0].get_str();</span></a>
<a name="486"><span class="lineNum">     486 </span><span class="lineCov">       1000 :     address_amounts.pushKV(address, request.params[1]);</span></a>
<a name="487"><span class="lineNum">     487 </span><span class="lineCov">       1000 :     UniValue subtractFeeFromAmount(UniValue::VARR);</span></a>
<a name="488"><span class="lineNum">     488 </span><span class="lineCov">       1000 :     if (fSubtractFeeFromAmount) {</span></a>
<a name="489"><span class="lineNum">     489 </span><span class="lineCov">         26 :         subtractFeeFromAmount.push_back(address);</span></a>
<a name="490"><span class="lineNum">     490 </span>            :     }</a>
<a name="491"><span class="lineNum">     491 </span>            : </a>
<a name="492"><span class="lineNum">     492 </span><span class="lineCov">       1000 :     std::vector&lt;CRecipient&gt; recipients;</span></a>
<a name="493"><span class="lineNum">     493 </span><span class="lineCov">       1000 :     ParseRecipients(address_amounts, subtractFeeFromAmount, recipients);</span></a>
<a name="494"><span class="lineNum">     494 </span>            : </a>
<a name="495"><span class="lineNum">     495 </span><span class="lineCov">        996 :     return SendMoney(pwallet, coin_control, recipients, mapValue);</span></a>
<a name="496"><span class="lineNum">     496 </span><span class="lineCov">       1085 : }</span></a>
<a name="497"><span class="lineNum">     497 </span>            : </a>
<a name="498"><span class="lineNum">     498 </span><span class="lineCov">          8 : static UniValue listaddressgroupings(const JSONRPCRequest&amp; request)</span></a>
<a name="499"><span class="lineNum">     499 </span>            : {</a>
<a name="500"><span class="lineNum">     500 </span><span class="lineCov">         40 :             RPCHelpMan{&quot;listaddressgroupings&quot;,</span></a>
<a name="501"><span class="lineNum">     501 </span><span class="lineCov">          8 :                 &quot;\nLists groups of addresses which have had their common ownership\n&quot;</span></a>
<a name="502"><span class="lineNum">     502 </span>            :                 &quot;made public by common use as inputs or as the resulting change\n&quot;</a>
<a name="503"><span class="lineNum">     503 </span>            :                 &quot;in past transactions\n&quot;,</a>
<a name="504"><span class="lineNum">     504 </span><span class="lineCov">          8 :                 {},</span></a>
<a name="505"><span class="lineNum">     505 </span><span class="lineCov">          8 :                 RPCResult{</span></a>
<a name="506"><span class="lineNum">     506 </span><span class="lineCov">          8 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="507"><span class="lineNum">     507 </span><span class="lineCov">         16 :                     {</span></a>
<a name="508"><span class="lineNum">     508 </span><span class="lineCov">         16 :                         {RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="509"><span class="lineNum">     509 </span><span class="lineCov">         16 :                         {</span></a>
<a name="510"><span class="lineNum">     510 </span><span class="lineCov">         16 :                             {RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="511"><span class="lineNum">     511 </span><span class="lineCov">         36 :                             {</span></a>
<a name="512"><span class="lineNum">     512 </span><span class="lineCov">          8 :                                 {RPCResult::Type::STR, &quot;address&quot;, &quot;The bitcoin address&quot;},</span></a>
<a name="513"><span class="lineNum">     513 </span><span class="lineCov">          8 :                                 {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The amount in &quot; + CURRENCY_UNIT},</span></a>
<a name="514"><span class="lineNum">     514 </span><span class="lineCov">          8 :                                 {RPCResult::Type::STR, &quot;label&quot;, /* optional */ true, &quot;The label&quot;},</span></a>
<a name="515"><span class="lineNum">     515 </span>            :                             }},</a>
<a name="516"><span class="lineNum">     516 </span>            :                         }},</a>
<a name="517"><span class="lineNum">     517 </span>            :                     }</a>
<a name="518"><span class="lineNum">     518 </span>            :                 },</a>
<a name="519"><span class="lineNum">     519 </span><span class="lineCov">          8 :                 RPCExamples{</span></a>
<a name="520"><span class="lineNum">     520 </span><span class="lineCov">          8 :                     HelpExampleCli(&quot;listaddressgroupings&quot;, &quot;&quot;)</span></a>
<a name="521"><span class="lineNum">     521 </span><span class="lineCov">          8 :             + HelpExampleRpc(&quot;listaddressgroupings&quot;, &quot;&quot;)</span></a>
<a name="522"><span class="lineNum">     522 </span>            :                 },</a>
<a name="523"><span class="lineNum">     523 </span><span class="lineCov">          8 :             }.Check(request);</span></a>
<a name="524"><span class="lineNum">     524 </span>            : </a>
<a name="525"><span class="lineNum">     525 </span><span class="lineCov">          4 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="526"><span class="lineNum">     526 </span><span class="lineCov">          4 :     if (!wallet) return NullUniValue;</span></a>
<a name="527"><span class="lineNum">     527 </span><span class="lineCov">          4 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="528"><span class="lineNum">     528 </span>            : </a>
<a name="529"><span class="lineNum">     529 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="530"><span class="lineNum">     530 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="531"><span class="lineNum">     531 </span><span class="lineCov">          4 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="532"><span class="lineNum">     532 </span>            : </a>
<a name="533"><span class="lineNum">     533 </span><span class="lineCov">          4 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="534"><span class="lineNum">     534 </span>            : </a>
<a name="535"><span class="lineNum">     535 </span><span class="lineCov">          4 :     UniValue jsonGroupings(UniValue::VARR);</span></a>
<a name="536"><span class="lineNum">     536 </span><span class="lineCov">          4 :     std::map&lt;CTxDestination, CAmount&gt; balances = pwallet-&gt;GetAddressBalances();</span></a>
<a name="537"><span class="lineNum">     537 </span><span class="lineCov">         10 :     for (const std::set&lt;CTxDestination&gt;&amp; grouping : pwallet-&gt;GetAddressGroupings()) {</span></a>
<a name="538"><span class="lineNum">     538 </span><span class="lineCov">          6 :         UniValue jsonGrouping(UniValue::VARR);</span></a>
<a name="539"><span class="lineNum">     539 </span><span class="lineCov">         14 :         for (const CTxDestination&amp; address : grouping)</span></a>
<a name="540"><span class="lineNum">     540 </span>            :         {</a>
<a name="541"><span class="lineNum">     541 </span><span class="lineCov">          8 :             UniValue addressInfo(UniValue::VARR);</span></a>
<a name="542"><span class="lineNum">     542 </span><span class="lineCov">          8 :             addressInfo.push_back(EncodeDestination(address));</span></a>
<a name="543"><span class="lineNum">     543 </span><span class="lineCov">          8 :             addressInfo.push_back(ValueFromAmount(balances[address]));</span></a>
<a name="544"><span class="lineNum">     544 </span>            :             {</a>
<a name="545"><span class="lineNum">     545 </span><span class="lineCov">          8 :                 const auto* address_book_entry = pwallet-&gt;FindAddressBookEntry(address);</span></a>
<a name="546"><span class="lineNum">     546 </span><span class="lineCov">          8 :                 if (address_book_entry) {</span></a>
<a name="547"><span class="lineNum">     547 </span><span class="lineCov">          8 :                     addressInfo.push_back(address_book_entry-&gt;GetLabel());</span></a>
<a name="548"><span class="lineNum">     548 </span>            :                 }</a>
<a name="549"><span class="lineNum">     549 </span><span class="lineNoCov">          0 :             }</span></a>
<a name="550"><span class="lineNum">     550 </span><span class="lineCov">          8 :             jsonGrouping.push_back(addressInfo);</span></a>
<a name="551"><span class="lineNum">     551 </span><span class="lineCov">          8 :         }</span></a>
<a name="552"><span class="lineNum">     552 </span><span class="lineCov">          6 :         jsonGroupings.push_back(jsonGrouping);</span></a>
<a name="553"><span class="lineNum">     553 </span><span class="lineCov">          6 :     }</span></a>
<a name="554"><span class="lineNum">     554 </span><span class="lineCov">          4 :     return jsonGroupings;</span></a>
<a name="555"><span class="lineNum">     555 </span><span class="lineCov">         32 : }</span></a>
<a name="556"><span class="lineNum">     556 </span>            : </a>
<a name="557"><span class="lineNum">     557 </span><span class="lineCov">         26 : static UniValue signmessage(const JSONRPCRequest&amp; request)</span></a>
<a name="558"><span class="lineNum">     558 </span>            : {</a>
<a name="559"><span class="lineNum">     559 </span><span class="lineCov">        114 :             RPCHelpMan{&quot;signmessage&quot;,</span></a>
<a name="560"><span class="lineNum">     560 </span><span class="lineCov">         26 :                 &quot;\nSign a message with the private key of an address&quot; +</span></a>
<a name="561"><span class="lineNum">     561 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="562"><span class="lineNum">     562 </span><span class="lineCov">         82 :                 {</span></a>
<a name="563"><span class="lineNum">     563 </span><span class="lineCov">         26 :                     {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The bitcoin address to use for the private key.&quot;},</span></a>
<a name="564"><span class="lineNum">     564 </span><span class="lineCov">         26 :                     {&quot;message&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The message to create a signature of.&quot;},</span></a>
<a name="565"><span class="lineNum">     565 </span>            :                 },</a>
<a name="566"><span class="lineNum">     566 </span><span class="lineCov">         26 :                 RPCResult{</span></a>
<a name="567"><span class="lineNum">     567 </span><span class="lineCov">         26 :                     RPCResult::Type::STR, &quot;signature&quot;, &quot;The signature of the message encoded in base 64&quot;</span></a>
<a name="568"><span class="lineNum">     568 </span>            :                 },</a>
<a name="569"><span class="lineNum">     569 </span><span class="lineCov">         26 :                 RPCExamples{</span></a>
<a name="570"><span class="lineNum">     570 </span><span class="lineCov">         26 :             &quot;\nUnlock the wallet for 30 seconds\n&quot;</span></a>
<a name="571"><span class="lineNum">     571 </span><span class="lineCov">         26 :             + HelpExampleCli(&quot;walletpassphrase&quot;, &quot;\&quot;mypassphrase\&quot; 30&quot;) +</span></a>
<a name="572"><span class="lineNum">     572 </span>            :             &quot;\nCreate the signature\n&quot;</a>
<a name="573"><span class="lineNum">     573 </span><span class="lineCov">         26 :             + HelpExampleCli(&quot;signmessage&quot;, &quot;\&quot;1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\&quot; \&quot;my message\&quot;&quot;) +</span></a>
<a name="574"><span class="lineNum">     574 </span>            :             &quot;\nVerify the signature\n&quot;</a>
<a name="575"><span class="lineNum">     575 </span><span class="lineCov">         26 :             + HelpExampleCli(&quot;verifymessage&quot;, &quot;\&quot;1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\&quot; \&quot;signature\&quot; \&quot;my message\&quot;&quot;) +</span></a>
<a name="576"><span class="lineNum">     576 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="577"><span class="lineNum">     577 </span><span class="lineCov">         26 :             + HelpExampleRpc(&quot;signmessage&quot;, &quot;\&quot;1D1ZrZNe3JUo7ZycKEYQQiQAWd9y54F4XX\&quot;, \&quot;my message\&quot;&quot;)</span></a>
<a name="578"><span class="lineNum">     578 </span>            :                 },</a>
<a name="579"><span class="lineNum">     579 </span><span class="lineCov">         26 :             }.Check(request);</span></a>
<a name="580"><span class="lineNum">     580 </span>            : </a>
<a name="581"><span class="lineNum">     581 </span><span class="lineCov">         22 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="582"><span class="lineNum">     582 </span><span class="lineCov">         22 :     if (!wallet) return NullUniValue;</span></a>
<a name="583"><span class="lineNum">     583 </span><span class="lineCov">         22 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="584"><span class="lineNum">     584 </span>            : </a>
<a name="585"><span class="lineNum">     585 </span><span class="lineCov">         22 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="586"><span class="lineNum">     586 </span>            : </a>
<a name="587"><span class="lineNum">     587 </span><span class="lineCov">         22 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="588"><span class="lineNum">     588 </span>            : </a>
<a name="589"><span class="lineNum">     589 </span><span class="lineCov">         12 :     std::string strAddress = request.params[0].get_str();</span></a>
<a name="590"><span class="lineNum">     590 </span><span class="lineCov">         12 :     std::string strMessage = request.params[1].get_str();</span></a>
<a name="591"><span class="lineNum">     591 </span>            : </a>
<a name="592"><span class="lineNum">     592 </span><span class="lineCov">         12 :     CTxDestination dest = DecodeDestination(strAddress);</span></a>
<a name="593"><span class="lineNum">     593 </span><span class="lineCov">         12 :     if (!IsValidDestination(dest)) {</span></a>
<a name="594"><span class="lineNum">     594 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_TYPE_ERROR, &quot;Invalid address&quot;);</span></a>
<a name="595"><span class="lineNum">     595 </span>            :     }</a>
<a name="596"><span class="lineNum">     596 </span>            : </a>
<a name="597"><span class="lineNum">     597 </span><span class="lineCov">         12 :     const PKHash *pkhash = boost::get&lt;PKHash&gt;(&amp;dest);</span></a>
<a name="598"><span class="lineNum">     598 </span><span class="lineCov">         12 :     if (!pkhash) {</span></a>
<a name="599"><span class="lineNum">     599 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_TYPE_ERROR, &quot;Address does not refer to key&quot;);</span></a>
<a name="600"><span class="lineNum">     600 </span>            :     }</a>
<a name="601"><span class="lineNum">     601 </span>            : </a>
<a name="602"><span class="lineNum">     602 </span><span class="lineCov">         12 :     std::string signature;</span></a>
<a name="603"><span class="lineNum">     603 </span><span class="lineCov">         12 :     SigningResult err = pwallet-&gt;SignMessage(strMessage, *pkhash, signature);</span></a>
<a name="604"><span class="lineNum">     604 </span><span class="lineCov">         12 :     if (err == SigningResult::SIGNING_FAILED) {</span></a>
<a name="605"><span class="lineNum">     605 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, SigningResultString(err));</span></a>
<a name="606"><span class="lineNum">     606 </span><span class="lineCov">         12 :     } else if (err != SigningResult::OK){</span></a>
<a name="607"><span class="lineNum">     607 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, SigningResultString(err));</span></a>
<a name="608"><span class="lineNum">     608 </span>            :     }</a>
<a name="609"><span class="lineNum">     609 </span>            : </a>
<a name="610"><span class="lineNum">     610 </span><span class="lineCov">         12 :     return signature;</span></a>
<a name="611"><span class="lineNum">     611 </span><span class="lineCov">         42 : }</span></a>
<a name="612"><span class="lineNum">     612 </span>            : </a>
<a name="613"><span class="lineNum">     613 </span><span class="lineCov">         44 : static CAmount GetReceived(const CWallet&amp; wallet, const UniValue&amp; params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)</span></a>
<a name="614"><span class="lineNum">     614 </span>            : {</a>
<a name="615"><span class="lineNum">     615 </span><span class="lineCov">         44 :     std::set&lt;CTxDestination&gt; address_set;</span></a>
<a name="616"><span class="lineNum">     616 </span>            : </a>
<a name="617"><span class="lineNum">     617 </span><span class="lineCov">         44 :     if (by_label) {</span></a>
<a name="618"><span class="lineNum">     618 </span>            :         // Get the set of addresses assigned to label</a>
<a name="619"><span class="lineNum">     619 </span><span class="lineCov">         30 :         std::string label = LabelFromValue(params[0]);</span></a>
<a name="620"><span class="lineNum">     620 </span><span class="lineCov">         30 :         address_set = wallet.GetLabelAddresses(label);</span></a>
<a name="621"><span class="lineNum">     621 </span><span class="lineCov">         30 :     } else {</span></a>
<a name="622"><span class="lineNum">     622 </span>            :         // Get the address</a>
<a name="623"><span class="lineNum">     623 </span><span class="lineCov">         14 :         CTxDestination dest = DecodeDestination(params[0].get_str());</span></a>
<a name="624"><span class="lineNum">     624 </span><span class="lineCov">         14 :         if (!IsValidDestination(dest)) {</span></a>
<a name="625"><span class="lineNum">     625 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Invalid Bitcoin address&quot;);</span></a>
<a name="626"><span class="lineNum">     626 </span>            :         }</a>
<a name="627"><span class="lineNum">     627 </span><span class="lineCov">         14 :         CScript script_pub_key = GetScriptForDestination(dest);</span></a>
<a name="628"><span class="lineNum">     628 </span><span class="lineCov">         14 :         if (!wallet.IsMine(script_pub_key)) {</span></a>
<a name="629"><span class="lineNum">     629 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_WALLET_ERROR, &quot;Address not found in wallet&quot;);</span></a>
<a name="630"><span class="lineNum">     630 </span>            :         }</a>
<a name="631"><span class="lineNum">     631 </span><span class="lineCov">         13 :         address_set.insert(dest);</span></a>
<a name="632"><span class="lineNum">     632 </span><span class="lineCov">         14 :     }</span></a>
<a name="633"><span class="lineNum">     633 </span>            : </a>
<a name="634"><span class="lineNum">     634 </span>            :     // Minimum confirmations</a>
<a name="635"><span class="lineNum">     635 </span>            :     int min_depth = 1;</a>
<a name="636"><span class="lineNum">     636 </span><span class="lineCov">         43 :     if (!params[1].isNull())</span></a>
<a name="637"><span class="lineNum">     637 </span><span class="lineCov">          1 :         min_depth = params[1].get_int();</span></a>
<a name="638"><span class="lineNum">     638 </span>            : </a>
<a name="639"><span class="lineNum">     639 </span>            :     // Tally</a>
<a name="640"><span class="lineNum">     640 </span><span class="lineCov">       7815 :     CAmount amount = 0;</span></a>
<a name="641"><span class="lineNum">     641 </span><span class="lineCov">       3929 :     for (const std::pair&lt;const uint256, CWalletTx&gt;&amp; wtx_pair : wallet.mapWallet) {</span></a>
<a name="642"><span class="lineNum">     642 </span><span class="lineCov">       3886 :         const CWalletTx&amp; wtx = wtx_pair.second;</span></a>
<a name="643"><span class="lineNum">     643 </span><span class="lineCov">       3886 :         if (wtx.IsCoinBase() || !wallet.chain().checkFinalTx(*wtx.tx) || wtx.GetDepthInMainChain() &lt; min_depth) {</span></a>
<a name="644"><span class="lineNum">     644 </span><span class="lineCov">       3634 :             continue;</span></a>
<a name="645"><span class="lineNum">     645 </span>            :         }</a>
<a name="646"><span class="lineNum">     646 </span>            : </a>
<a name="647"><span class="lineNum">     647 </span><span class="lineCov">        726 :         for (const CTxOut&amp; txout : wtx.tx-&gt;vout) {</span></a>
<a name="648"><span class="lineNum">     648 </span><span class="lineCov">        474 :             CTxDestination address;</span></a>
<a name="649"><span class="lineNum">     649 </span><span class="lineCov">        474 :             if (ExtractDestination(txout.scriptPubKey, address) &amp;&amp; wallet.IsMine(address) &amp;&amp; address_set.count(address)) {</span></a>
<a name="650"><span class="lineNum">     650 </span><span class="lineCov">         52 :                 amount += txout.nValue;</span></a>
<a name="651"><span class="lineNum">     651 </span><span class="lineCov">         52 :             }</span></a>
<a name="652"><span class="lineNum">     652 </span><span class="lineCov">        474 :         }</span></a>
<a name="653"><span class="lineNum">     653 </span><span class="lineCov">        504 :     }</span></a>
<a name="654"><span class="lineNum">     654 </span>            : </a>
<a name="655"><span class="lineNum">     655 </span>            :     return amount;</a>
<a name="656"><span class="lineNum">     656 </span><span class="lineCov">         45 : }</span></a>
<a name="657"><span class="lineNum">     657 </span>            : </a>
<a name="658"><span class="lineNum">     658 </span>            : </a>
<a name="659"><span class="lineNum">     659 </span><span class="lineCov">         18 : static UniValue getreceivedbyaddress(const JSONRPCRequest&amp; request)</span></a>
<a name="660"><span class="lineNum">     660 </span>            : {</a>
<a name="661"><span class="lineNum">     661 </span><span class="lineCov">         73 :             RPCHelpMan{&quot;getreceivedbyaddress&quot;,</span></a>
<a name="662"><span class="lineNum">     662 </span><span class="lineCov">         18 :                 &quot;\nReturns the total amount received by the given address in transactions with at least minconf confirmations.\n&quot;,</span></a>
<a name="663"><span class="lineNum">     663 </span><span class="lineCov">         58 :                 {</span></a>
<a name="664"><span class="lineNum">     664 </span><span class="lineCov">         18 :                     {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The bitcoin address for transactions.&quot;},</span></a>
<a name="665"><span class="lineNum">     665 </span><span class="lineCov">         18 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, /* default */ &quot;1&quot;, &quot;Only include transactions confirmed at least this many times.&quot;},</span></a>
<a name="666"><span class="lineNum">     666 </span>            :                 },</a>
<a name="667"><span class="lineNum">     667 </span><span class="lineCov">         18 :                 RPCResult{</span></a>
<a name="668"><span class="lineNum">     668 </span><span class="lineCov">         18 :                     RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The total amount in &quot; + CURRENCY_UNIT + &quot; received at this address.&quot;</span></a>
<a name="669"><span class="lineNum">     669 </span>            :                 },</a>
<a name="670"><span class="lineNum">     670 </span><span class="lineCov">         18 :                 RPCExamples{</span></a>
<a name="671"><span class="lineNum">     671 </span><span class="lineCov">         18 :             &quot;\nThe amount from transactions with at least 1 confirmation\n&quot;</span></a>
<a name="672"><span class="lineNum">     672 </span><span class="lineCov">         18 :             + HelpExampleCli(&quot;getreceivedbyaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;&quot;) +</span></a>
<a name="673"><span class="lineNum">     673 </span>            :             &quot;\nThe amount including unconfirmed transactions, zero confirmations\n&quot;</a>
<a name="674"><span class="lineNum">     674 </span><span class="lineCov">         18 :             + HelpExampleCli(&quot;getreceivedbyaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 0&quot;) +</span></a>
<a name="675"><span class="lineNum">     675 </span>            :             &quot;\nThe amount with at least 6 confirmations\n&quot;</a>
<a name="676"><span class="lineNum">     676 </span><span class="lineCov">         18 :             + HelpExampleCli(&quot;getreceivedbyaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 6&quot;) +</span></a>
<a name="677"><span class="lineNum">     677 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="678"><span class="lineNum">     678 </span><span class="lineCov">         18 :             + HelpExampleRpc(&quot;getreceivedbyaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;, 6&quot;)</span></a>
<a name="679"><span class="lineNum">     679 </span>            :                 },</a>
<a name="680"><span class="lineNum">     680 </span><span class="lineCov">         18 :             }.Check(request);</span></a>
<a name="681"><span class="lineNum">     681 </span>            : </a>
<a name="682"><span class="lineNum">     682 </span><span class="lineCov">         14 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="683"><span class="lineNum">     683 </span><span class="lineCov">         14 :     if (!wallet) return NullUniValue;</span></a>
<a name="684"><span class="lineNum">     684 </span><span class="lineCov">         14 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="685"><span class="lineNum">     685 </span>            : </a>
<a name="686"><span class="lineNum">     686 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="687"><span class="lineNum">     687 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="688"><span class="lineNum">     688 </span><span class="lineCov">         14 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="689"><span class="lineNum">     689 </span>            : </a>
<a name="690"><span class="lineNum">     690 </span><span class="lineCov">         14 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="691"><span class="lineNum">     691 </span>            : </a>
<a name="692"><span class="lineNum">     692 </span><span class="lineCov">         14 :     return ValueFromAmount(GetReceived(*pwallet, request.params, /* by_label */ false));</span></a>
<a name="693"><span class="lineNum">     693 </span><span class="lineCov">         39 : }</span></a>
<a name="694"><span class="lineNum">     694 </span>            : </a>
<a name="695"><span class="lineNum">     695 </span>            : </a>
<a name="696"><span class="lineNum">     696 </span><span class="lineCov">         34 : static UniValue getreceivedbylabel(const JSONRPCRequest&amp; request)</span></a>
<a name="697"><span class="lineNum">     697 </span>            : {</a>
<a name="698"><span class="lineNum">     698 </span><span class="lineCov">        136 :             RPCHelpMan{&quot;getreceivedbylabel&quot;,</span></a>
<a name="699"><span class="lineNum">     699 </span><span class="lineCov">         34 :                 &quot;\nReturns the total amount received by addresses with &lt;label&gt; in transactions with at least [minconf] confirmations.\n&quot;,</span></a>
<a name="700"><span class="lineNum">     700 </span><span class="lineCov">        106 :                 {</span></a>
<a name="701"><span class="lineNum">     701 </span><span class="lineCov">         34 :                     {&quot;label&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The selected label, may be the default label using \&quot;\&quot;.&quot;},</span></a>
<a name="702"><span class="lineNum">     702 </span><span class="lineCov">         34 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, /* default */ &quot;1&quot;, &quot;Only include transactions confirmed at least this many times.&quot;},</span></a>
<a name="703"><span class="lineNum">     703 </span>            :                 },</a>
<a name="704"><span class="lineNum">     704 </span><span class="lineCov">         34 :                 RPCResult{</span></a>
<a name="705"><span class="lineNum">     705 </span><span class="lineCov">         34 :                     RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The total amount in &quot; + CURRENCY_UNIT + &quot; received for this label.&quot;</span></a>
<a name="706"><span class="lineNum">     706 </span>            :                 },</a>
<a name="707"><span class="lineNum">     707 </span><span class="lineCov">         34 :                 RPCExamples{</span></a>
<a name="708"><span class="lineNum">     708 </span><span class="lineCov">         34 :             &quot;\nAmount received by the default label with at least 1 confirmation\n&quot;</span></a>
<a name="709"><span class="lineNum">     709 </span><span class="lineCov">         34 :             + HelpExampleCli(&quot;getreceivedbylabel&quot;, &quot;\&quot;\&quot;&quot;) +</span></a>
<a name="710"><span class="lineNum">     710 </span>            :             &quot;\nAmount received at the tabby label including unconfirmed amounts with zero confirmations\n&quot;</a>
<a name="711"><span class="lineNum">     711 </span><span class="lineCov">         34 :             + HelpExampleCli(&quot;getreceivedbylabel&quot;, &quot;\&quot;tabby\&quot; 0&quot;) +</span></a>
<a name="712"><span class="lineNum">     712 </span>            :             &quot;\nThe amount with at least 6 confirmations\n&quot;</a>
<a name="713"><span class="lineNum">     713 </span><span class="lineCov">         34 :             + HelpExampleCli(&quot;getreceivedbylabel&quot;, &quot;\&quot;tabby\&quot; 6&quot;) +</span></a>
<a name="714"><span class="lineNum">     714 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="715"><span class="lineNum">     715 </span><span class="lineCov">         34 :             + HelpExampleRpc(&quot;getreceivedbylabel&quot;, &quot;\&quot;tabby\&quot;, 6&quot;)</span></a>
<a name="716"><span class="lineNum">     716 </span>            :                 },</a>
<a name="717"><span class="lineNum">     717 </span><span class="lineCov">         34 :             }.Check(request);</span></a>
<a name="718"><span class="lineNum">     718 </span>            : </a>
<a name="719"><span class="lineNum">     719 </span><span class="lineCov">         30 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="720"><span class="lineNum">     720 </span><span class="lineCov">         30 :     if (!wallet) return NullUniValue;</span></a>
<a name="721"><span class="lineNum">     721 </span><span class="lineCov">         30 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="722"><span class="lineNum">     722 </span>            : </a>
<a name="723"><span class="lineNum">     723 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="724"><span class="lineNum">     724 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="725"><span class="lineNum">     725 </span><span class="lineCov">         30 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="726"><span class="lineNum">     726 </span>            : </a>
<a name="727"><span class="lineNum">     727 </span><span class="lineCov">         30 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="728"><span class="lineNum">     728 </span>            : </a>
<a name="729"><span class="lineNum">     729 </span><span class="lineCov">         30 :     return ValueFromAmount(GetReceived(*pwallet, request.params, /* by_label */ true));</span></a>
<a name="730"><span class="lineNum">     730 </span><span class="lineCov">         54 : }</span></a>
<a name="731"><span class="lineNum">     731 </span>            : </a>
<a name="732"><span class="lineNum">     732 </span>            : </a>
<a name="733"><span class="lineNum">     733 </span><span class="lineCov">        364 : static UniValue getbalance(const JSONRPCRequest&amp; request)</span></a>
<a name="734"><span class="lineNum">     734 </span>            : {</a>
<a name="735"><span class="lineNum">     735 </span><span class="lineCov">       2185 :             RPCHelpMan{&quot;getbalance&quot;,</span></a>
<a name="736"><span class="lineNum">     736 </span><span class="lineCov">        364 :                 &quot;\nReturns the total available balance.\n&quot;</span></a>
<a name="737"><span class="lineNum">     737 </span>            :                 &quot;The available balance is what the wallet considers currently spendable, and is\n&quot;</a>
<a name="738"><span class="lineNum">     738 </span>            :                 &quot;thus affected by options which limit spendability such as -spendzeroconfchange.\n&quot;,</a>
<a name="739"><span class="lineNum">     739 </span><span class="lineCov">       1824 :                 {</span></a>
<a name="740"><span class="lineNum">     740 </span><span class="lineCov">        364 :                     {&quot;dummy&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;Remains for backward compatibility. Must be excluded or set to \&quot;*\&quot;.&quot;},</span></a>
<a name="741"><span class="lineNum">     741 </span><span class="lineCov">        364 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, /* default */ &quot;0&quot;, &quot;Only include transactions confirmed at least this many times.&quot;},</span></a>
<a name="742"><span class="lineNum">     742 </span><span class="lineCov">        364 :                     {&quot;include_watchonly&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Also include balance in watch-only addresses (see 'importaddress')&quot;},</span></a>
<a name="743"><span class="lineNum">     743 </span><span class="lineCov">        364 :                     {&quot;avoid_reuse&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;(only available if avoid_reuse wallet flag is set) Do not include balance in dirty outputs; addresses are considered dirty if they have previously been used in a transaction.&quot;},</span></a>
<a name="744"><span class="lineNum">     744 </span>            :                 },</a>
<a name="745"><span class="lineNum">     745 </span><span class="lineCov">        364 :                 RPCResult{</span></a>
<a name="746"><span class="lineNum">     746 </span><span class="lineCov">        364 :                     RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The total amount in &quot; + CURRENCY_UNIT + &quot; received for this wallet.&quot;</span></a>
<a name="747"><span class="lineNum">     747 </span>            :                 },</a>
<a name="748"><span class="lineNum">     748 </span><span class="lineCov">        364 :                 RPCExamples{</span></a>
<a name="749"><span class="lineNum">     749 </span><span class="lineCov">        364 :             &quot;\nThe total amount in the wallet with 0 or more confirmations\n&quot;</span></a>
<a name="750"><span class="lineNum">     750 </span><span class="lineCov">        364 :             + HelpExampleCli(&quot;getbalance&quot;, &quot;&quot;) +</span></a>
<a name="751"><span class="lineNum">     751 </span>            :             &quot;\nThe total amount in the wallet with at least 6 confirmations\n&quot;</a>
<a name="752"><span class="lineNum">     752 </span><span class="lineCov">        364 :             + HelpExampleCli(&quot;getbalance&quot;, &quot;\&quot;*\&quot; 6&quot;) +</span></a>
<a name="753"><span class="lineNum">     753 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="754"><span class="lineNum">     754 </span><span class="lineCov">        364 :             + HelpExampleRpc(&quot;getbalance&quot;, &quot;\&quot;*\&quot;, 6&quot;)</span></a>
<a name="755"><span class="lineNum">     755 </span>            :                 },</a>
<a name="756"><span class="lineNum">     756 </span><span class="lineCov">        364 :             }.Check(request);</span></a>
<a name="757"><span class="lineNum">     757 </span>            : </a>
<a name="758"><span class="lineNum">     758 </span><span class="lineCov">        360 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="759"><span class="lineNum">     759 </span><span class="lineCov">        360 :     if (!wallet) return NullUniValue;</span></a>
<a name="760"><span class="lineNum">     760 </span><span class="lineCov">        360 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="761"><span class="lineNum">     761 </span>            : </a>
<a name="762"><span class="lineNum">     762 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="763"><span class="lineNum">     763 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="764"><span class="lineNum">     764 </span><span class="lineCov">        360 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="765"><span class="lineNum">     765 </span>            : </a>
<a name="766"><span class="lineNum">     766 </span><span class="lineCov">        360 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="767"><span class="lineNum">     767 </span>            : </a>
<a name="768"><span class="lineNum">     768 </span><span class="lineCov">        360 :     const UniValue&amp; dummy_value = request.params[0];</span></a>
<a name="769"><span class="lineNum">     769 </span><span class="lineCov">        360 :     if (!dummy_value.isNull() &amp;&amp; dummy_value.get_str() != &quot;*&quot;) {</span></a>
<a name="770"><span class="lineNum">     770 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_METHOD_DEPRECATED, &quot;dummy first argument must be excluded or set to \&quot;*\&quot;.&quot;);</span></a>
<a name="771"><span class="lineNum">     771 </span>            :     }</a>
<a name="772"><span class="lineNum">     772 </span>            : </a>
<a name="773"><span class="lineNum">     773 </span>            :     int min_depth = 0;</a>
<a name="774"><span class="lineNum">     774 </span><span class="lineCov">        359 :     if (!request.params[1].isNull()) {</span></a>
<a name="775"><span class="lineNum">     775 </span><span class="lineCov">         20 :         min_depth = request.params[1].get_int();</span></a>
<a name="776"><span class="lineNum">     776 </span><span class="lineCov">         20 :     }</span></a>
<a name="777"><span class="lineNum">     777 </span>            : </a>
<a name="778"><span class="lineNum">     778 </span><span class="lineCov">        359 :     bool include_watchonly = ParseIncludeWatchonly(request.params[2], *pwallet);</span></a>
<a name="779"><span class="lineNum">     779 </span>            : </a>
<a name="780"><span class="lineNum">     780 </span><span class="lineCov">        359 :     bool avoid_reuse = GetAvoidReuseFlag(pwallet, request.params[3]);</span></a>
<a name="781"><span class="lineNum">     781 </span>            : </a>
<a name="782"><span class="lineNum">     782 </span><span class="lineCov">        359 :     const auto bal = pwallet-&gt;GetBalance(min_depth, avoid_reuse);</span></a>
<a name="783"><span class="lineNum">     783 </span>            : </a>
<a name="784"><span class="lineNum">     784 </span><span class="lineCov">        359 :     return ValueFromAmount(bal.m_mine_trusted + (include_watchonly ? bal.m_watchonly_trusted : 0));</span></a>
<a name="785"><span class="lineNum">     785 </span><span class="lineCov">        388 : }</span></a>
<a name="786"><span class="lineNum">     786 </span>            : </a>
<a name="787"><span class="lineNum">     787 </span><span class="lineCov">          8 : static UniValue getunconfirmedbalance(const JSONRPCRequest &amp;request)</span></a>
<a name="788"><span class="lineNum">     788 </span>            : {</a>
<a name="789"><span class="lineNum">     789 </span><span class="lineCov">         24 :             RPCHelpMan{&quot;getunconfirmedbalance&quot;,</span></a>
<a name="790"><span class="lineNum">     790 </span><span class="lineCov">          8 :                 &quot;DEPRECATED\nIdentical to getbalances().mine.untrusted_pending\n&quot;,</span></a>
<a name="791"><span class="lineNum">     791 </span><span class="lineCov">          8 :                 {},</span></a>
<a name="792"><span class="lineNum">     792 </span><span class="lineCov">          8 :                 RPCResult{RPCResult::Type::NUM, &quot;&quot;, &quot;The balance&quot;},</span></a>
<a name="793"><span class="lineNum">     793 </span><span class="lineCov">          8 :                 RPCExamples{&quot;&quot;},</span></a>
<a name="794"><span class="lineNum">     794 </span><span class="lineCov">          8 :             }.Check(request);</span></a>
<a name="795"><span class="lineNum">     795 </span>            : </a>
<a name="796"><span class="lineNum">     796 </span><span class="lineCov">          4 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="797"><span class="lineNum">     797 </span><span class="lineCov">          4 :     if (!wallet) return NullUniValue;</span></a>
<a name="798"><span class="lineNum">     798 </span><span class="lineCov">          4 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="799"><span class="lineNum">     799 </span>            : </a>
<a name="800"><span class="lineNum">     800 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="801"><span class="lineNum">     801 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="802"><span class="lineNum">     802 </span><span class="lineCov">          4 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="803"><span class="lineNum">     803 </span>            : </a>
<a name="804"><span class="lineNum">     804 </span><span class="lineCov">          4 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="805"><span class="lineNum">     805 </span>            : </a>
<a name="806"><span class="lineNum">     806 </span><span class="lineCov">          4 :     return ValueFromAmount(pwallet-&gt;GetBalance().m_mine_untrusted_pending);</span></a>
<a name="807"><span class="lineNum">     807 </span><span class="lineCov">          8 : }</span></a>
<a name="808"><span class="lineNum">     808 </span>            : </a>
<a name="809"><span class="lineNum">     809 </span>            : </a>
<a name="810"><span class="lineNum">     810 </span><span class="lineCov">        121 : static UniValue sendmany(const JSONRPCRequest&amp; request)</span></a>
<a name="811"><span class="lineNum">     811 </span>            : {</a>
<a name="812"><span class="lineNum">     812 </span><span class="lineCov">       1223 :     RPCHelpMan{&quot;sendmany&quot;,</span></a>
<a name="813"><span class="lineNum">     813 </span><span class="lineCov">        121 :                 &quot;\nSend multiple times. Amounts are double-precision floating point numbers.&quot; +</span></a>
<a name="814"><span class="lineNum">     814 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="815"><span class="lineNum">     815 </span><span class="lineCov">       1109 :                 {</span></a>
<a name="816"><span class="lineNum">     816 </span><span class="lineCov">        121 :                     {&quot;dummy&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;Must be set to \&quot;\&quot; for backwards compatibility.&quot;, &quot;\&quot;\&quot;&quot;},</span></a>
<a name="817"><span class="lineNum">     817 </span><span class="lineCov">        242 :                     {&quot;amounts&quot;, RPCArg::Type::OBJ, RPCArg::Optional::NO, &quot;The addresses and amounts&quot;,</span></a>
<a name="818"><span class="lineNum">     818 </span><span class="lineCov">        242 :                         {</span></a>
<a name="819"><span class="lineNum">     819 </span><span class="lineCov">        121 :                             {&quot;address&quot;, RPCArg::Type::AMOUNT, RPCArg::Optional::NO, &quot;The bitcoin address is the key, the numeric amount (can be string) in &quot; + CURRENCY_UNIT + &quot; is the value&quot;},</span></a>
<a name="820"><span class="lineNum">     820 </span>            :                         },</a>
<a name="821"><span class="lineNum">     821 </span>            :                     },</a>
<a name="822"><span class="lineNum">     822 </span><span class="lineCov">        121 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;Ignored dummy value&quot;},</span></a>
<a name="823"><span class="lineNum">     823 </span><span class="lineCov">        121 :                     {&quot;comment&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;A comment&quot;},</span></a>
<a name="824"><span class="lineNum">     824 </span><span class="lineCov">        242 :                     {&quot;subtractfeefrom&quot;, RPCArg::Type::ARR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;The addresses.\n&quot;</span></a>
<a name="825"><span class="lineNum">     825 </span>            :             &quot;                           The fee will be equally deducted from the amount of each selected address.\n&quot;</a>
<a name="826"><span class="lineNum">     826 </span>            :             &quot;                           Those recipients will receive less bitcoins than you enter in their corresponding amount field.\n&quot;</a>
<a name="827"><span class="lineNum">     827 </span>            :             &quot;                           If no addresses are specified here, the sender pays the fee.&quot;,</a>
<a name="828"><span class="lineNum">     828 </span><span class="lineCov">        242 :                         {</span></a>
<a name="829"><span class="lineNum">     829 </span><span class="lineCov">        121 :                             {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED, &quot;Subtract fee from this address&quot;},</span></a>
<a name="830"><span class="lineNum">     830 </span>            :                         },</a>
<a name="831"><span class="lineNum">     831 </span>            :                     },</a>
<a name="832"><span class="lineNum">     832 </span><span class="lineCov">        121 :                     {&quot;replaceable&quot;, RPCArg::Type::BOOL, /* default */ &quot;wallet default&quot;, &quot;Allow this transaction to be replaced by a transaction with higher fees via BIP 125&quot;},</span></a>
<a name="833"><span class="lineNum">     833 </span><span class="lineCov">        121 :                     {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;wallet default&quot;, &quot;Confirmation target (in blocks), or fee rate (for &quot; + CURRENCY_UNIT + &quot;/kB or &quot; + CURRENCY_ATOM + &quot;/B estimate modes)&quot;},</span></a>
<a name="834"><span class="lineNum">     834 </span><span class="lineCov">        242 :                     {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="835"><span class="lineNum">     835 </span><span class="lineCov">        121 :             &quot;       \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="836"><span class="lineNum">     836 </span>            :                 },</a>
<a name="837"><span class="lineNum">     837 </span><span class="lineCov">        121 :                  RPCResult{</span></a>
<a name="838"><span class="lineNum">     838 </span><span class="lineCov">        121 :                      RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The transaction id for the send. Only 1 transaction is created regardless of\n&quot;</span></a>
<a name="839"><span class="lineNum">     839 </span>            :             &quot;the number of addresses.&quot;</a>
<a name="840"><span class="lineNum">     840 </span>            :                  },</a>
<a name="841"><span class="lineNum">     841 </span><span class="lineCov">        121 :                 RPCExamples{</span></a>
<a name="842"><span class="lineNum">     842 </span><span class="lineCov">        121 :             &quot;\nSend two amounts to two different addresses:\n&quot;</span></a>
<a name="843"><span class="lineNum">     843 </span><span class="lineCov">        121 :             + HelpExampleCli(&quot;sendmany&quot;, &quot;\&quot;\&quot; \&quot;{\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;:0.01,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;:0.02}\&quot;&quot;) +</span></a>
<a name="844"><span class="lineNum">     844 </span>            :             &quot;\nSend two amounts to two different addresses setting the confirmation and comment:\n&quot;</a>
<a name="845"><span class="lineNum">     845 </span><span class="lineCov">        121 :             + HelpExampleCli(&quot;sendmany&quot;, &quot;\&quot;\&quot; \&quot;{\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;:0.01,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;:0.02}\&quot; 6 \&quot;testing\&quot;&quot;) +</span></a>
<a name="846"><span class="lineNum">     846 </span>            :             &quot;\nSend two amounts to two different addresses, subtract fee from amount:\n&quot;</a>
<a name="847"><span class="lineNum">     847 </span><span class="lineCov">        121 :             + HelpExampleCli(&quot;sendmany&quot;, &quot;\&quot;\&quot; \&quot;{\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;:0.01,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;:0.02}\&quot; 1 \&quot;\&quot; \&quot;[\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;]\&quot;&quot;) +</span></a>
<a name="848"><span class="lineNum">     848 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="849"><span class="lineNum">     849 </span><span class="lineCov">        121 :             + HelpExampleRpc(&quot;sendmany&quot;, &quot;\&quot;\&quot;, {\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;:0.01,\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\&quot;:0.02}, 6, \&quot;testing\&quot;&quot;)</span></a>
<a name="850"><span class="lineNum">     850 </span>            :                 },</a>
<a name="851"><span class="lineNum">     851 </span><span class="lineCov">        121 :     }.Check(request);</span></a>
<a name="852"><span class="lineNum">     852 </span>            : </a>
<a name="853"><span class="lineNum">     853 </span><span class="lineCov">        117 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="854"><span class="lineNum">     854 </span><span class="lineCov">        117 :     if (!wallet) return NullUniValue;</span></a>
<a name="855"><span class="lineNum">     855 </span><span class="lineCov">        117 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="856"><span class="lineNum">     856 </span>            : </a>
<a name="857"><span class="lineNum">     857 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="858"><span class="lineNum">     858 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="859"><span class="lineNum">     859 </span><span class="lineCov">        117 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="860"><span class="lineNum">     860 </span>            : </a>
<a name="861"><span class="lineNum">     861 </span><span class="lineCov">        117 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="862"><span class="lineNum">     862 </span>            : </a>
<a name="863"><span class="lineNum">     863 </span><span class="lineCov">        117 :     if (!request.params[0].isNull() &amp;&amp; !request.params[0].get_str().empty()) {</span></a>
<a name="864"><span class="lineNum">     864 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Dummy value must be set to \&quot;\&quot;&quot;);</span></a>
<a name="865"><span class="lineNum">     865 </span>            :     }</a>
<a name="866"><span class="lineNum">     866 </span><span class="lineCov">        117 :     UniValue sendTo = request.params[1].get_obj();</span></a>
<a name="867"><span class="lineNum">     867 </span>            : </a>
<a name="868"><span class="lineNum">     868 </span><span class="lineCov">        117 :     mapValue_t mapValue;</span></a>
<a name="869"><span class="lineNum">     869 </span><span class="lineCov">        117 :     if (!request.params[3].isNull() &amp;&amp; !request.params[3].get_str().empty())</span></a>
<a name="870"><span class="lineNum">     870 </span><span class="lineNoCov">          0 :         mapValue[&quot;comment&quot;] = request.params[3].get_str();</span></a>
<a name="871"><span class="lineNum">     871 </span>            : </a>
<a name="872"><span class="lineNum">     872 </span><span class="lineCov">        117 :     UniValue subtractFeeFromAmount(UniValue::VARR);</span></a>
<a name="873"><span class="lineNum">     873 </span><span class="lineCov">        117 :     if (!request.params[4].isNull())</span></a>
<a name="874"><span class="lineNum">     874 </span><span class="lineCov">          6 :         subtractFeeFromAmount = request.params[4].get_array();</span></a>
<a name="875"><span class="lineNum">     875 </span>            : </a>
<a name="876"><span class="lineNum">     876 </span><span class="lineCov">        117 :     CCoinControl coin_control;</span></a>
<a name="877"><span class="lineNum">     877 </span><span class="lineCov">        117 :     if (!request.params[5].isNull()) {</span></a>
<a name="878"><span class="lineNum">     878 </span><span class="lineNoCov">          0 :         coin_control.m_signal_bip125_rbf = request.params[5].get_bool();</span></a>
<a name="879"><span class="lineNum">     879 </span><span class="lineNoCov">          0 :     }</span></a>
<a name="880"><span class="lineNum">     880 </span>            : </a>
<a name="881"><span class="lineNum">     881 </span><span class="lineCov">        117 :     SetFeeEstimateMode(pwallet, coin_control, request.params[7], request.params[6]);</span></a>
<a name="882"><span class="lineNum">     882 </span>            : </a>
<a name="883"><span class="lineNum">     883 </span><span class="lineCov">        109 :     std::vector&lt;CRecipient&gt; recipients;</span></a>
<a name="884"><span class="lineNum">     884 </span><span class="lineCov">        109 :     ParseRecipients(sendTo, subtractFeeFromAmount, recipients);</span></a>
<a name="885"><span class="lineNum">     885 </span>            : </a>
<a name="886"><span class="lineNum">     886 </span><span class="lineCov">        109 :     return SendMoney(pwallet, coin_control, recipients, std::move(mapValue));</span></a>
<a name="887"><span class="lineNum">     887 </span><span class="lineCov">        181 : }</span></a>
<a name="888"><span class="lineNum">     888 </span>            : </a>
<a name="889"><span class="lineNum">     889 </span><span class="lineCov">        123 : static UniValue addmultisigaddress(const JSONRPCRequest&amp; request)</span></a>
<a name="890"><span class="lineNum">     890 </span>            : {</a>
<a name="891"><span class="lineNum">     891 </span><span class="lineCov">        988 :             RPCHelpMan{&quot;addmultisigaddress&quot;,</span></a>
<a name="892"><span class="lineNum">     892 </span><span class="lineCov">        123 :                 &quot;\nAdd an nrequired-to-sign multisignature address to the wallet. Requires a new wallet backup.\n&quot;</span></a>
<a name="893"><span class="lineNum">     893 </span>            :                 &quot;Each key is a Bitcoin address or hex-encoded public key.\n&quot;</a>
<a name="894"><span class="lineNum">     894 </span>            :                 &quot;This functionality is only intended for use with non-watchonly addresses.\n&quot;</a>
<a name="895"><span class="lineNum">     895 </span>            :                 &quot;See `importaddress` for watchonly p2sh address support.\n&quot;</a>
<a name="896"><span class="lineNum">     896 </span>            :                 &quot;If 'label' is specified, assign address to that label.\n&quot;,</a>
<a name="897"><span class="lineNum">     897 </span><span class="lineCov">        627 :                 {</span></a>
<a name="898"><span class="lineNum">     898 </span><span class="lineCov">        123 :                     {&quot;nrequired&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The number of required signatures out of the n keys or addresses.&quot;},</span></a>
<a name="899"><span class="lineNum">     899 </span><span class="lineCov">        246 :                     {&quot;keys&quot;, RPCArg::Type::ARR, RPCArg::Optional::NO, &quot;The bitcoin addresses or hex-encoded public keys&quot;,</span></a>
<a name="900"><span class="lineNum">     900 </span><span class="lineCov">        246 :                         {</span></a>
<a name="901"><span class="lineNum">     901 </span><span class="lineCov">        123 :                             {&quot;key&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED, &quot;bitcoin address or hex-encoded public key&quot;},</span></a>
<a name="902"><span class="lineNum">     902 </span>            :                         },</a>
<a name="903"><span class="lineNum">     903 </span>            :                         },</a>
<a name="904"><span class="lineNum">     904 </span><span class="lineCov">        123 :                     {&quot;label&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;A label to assign the addresses to.&quot;},</span></a>
<a name="905"><span class="lineNum">     905 </span><span class="lineCov">        123 :                     {&quot;address_type&quot;, RPCArg::Type::STR, /* default */ &quot;set by -addresstype&quot;, &quot;The address type to use. Options are \&quot;legacy\&quot;, \&quot;p2sh-segwit\&quot;, and \&quot;bech32\&quot;.&quot;},</span></a>
<a name="906"><span class="lineNum">     906 </span>            :                 },</a>
<a name="907"><span class="lineNum">     907 </span><span class="lineCov">        123 :                 RPCResult{</span></a>
<a name="908"><span class="lineNum">     908 </span><span class="lineCov">        123 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="909"><span class="lineNum">     909 </span><span class="lineCov">        496 :                     {</span></a>
<a name="910"><span class="lineNum">     910 </span><span class="lineCov">        123 :                         {RPCResult::Type::STR, &quot;address&quot;, &quot;The value of the new multisig address&quot;},</span></a>
<a name="911"><span class="lineNum">     911 </span><span class="lineCov">        123 :                         {RPCResult::Type::STR_HEX, &quot;redeemScript&quot;, &quot;The string value of the hex-encoded redemption script&quot;},</span></a>
<a name="912"><span class="lineNum">     912 </span><span class="lineCov">        123 :                         {RPCResult::Type::STR, &quot;descriptor&quot;, &quot;The descriptor for this multisig&quot;},</span></a>
<a name="913"><span class="lineNum">     913 </span>            :                     }</a>
<a name="914"><span class="lineNum">     914 </span>            :                 },</a>
<a name="915"><span class="lineNum">     915 </span><span class="lineCov">        123 :                 RPCExamples{</span></a>
<a name="916"><span class="lineNum">     916 </span><span class="lineCov">        123 :             &quot;\nAdd a multisig address from 2 addresses\n&quot;</span></a>
<a name="917"><span class="lineNum">     917 </span><span class="lineCov">        123 :             + HelpExampleCli(&quot;addmultisigaddress&quot;, &quot;2 \&quot;[\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;]\&quot;&quot;) +</span></a>
<a name="918"><span class="lineNum">     918 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="919"><span class="lineNum">     919 </span><span class="lineCov">        123 :             + HelpExampleRpc(&quot;addmultisigaddress&quot;, &quot;2, \&quot;[\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;]\&quot;&quot;)</span></a>
<a name="920"><span class="lineNum">     920 </span>            :                 },</a>
<a name="921"><span class="lineNum">     921 </span><span class="lineCov">        123 :             }.Check(request);</span></a>
<a name="922"><span class="lineNum">     922 </span>            : </a>
<a name="923"><span class="lineNum">     923 </span><span class="lineCov">        119 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="924"><span class="lineNum">     924 </span><span class="lineCov">        119 :     if (!wallet) return NullUniValue;</span></a>
<a name="925"><span class="lineNum">     925 </span><span class="lineCov">        119 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="926"><span class="lineNum">     926 </span>            : </a>
<a name="927"><span class="lineNum">     927 </span><span class="lineCov">        119 :     LegacyScriptPubKeyMan&amp; spk_man = EnsureLegacyScriptPubKeyMan(*pwallet);</span></a>
<a name="928"><span class="lineNum">     928 </span>            : </a>
<a name="929"><span class="lineNum">     929 </span><span class="lineCov">        118 :     LOCK2(pwallet-&gt;cs_wallet, spk_man.cs_KeyStore);</span></a>
<a name="930"><span class="lineNum">     930 </span>            : </a>
<a name="931"><span class="lineNum">     931 </span><span class="lineCov">        118 :     std::string label;</span></a>
<a name="932"><span class="lineNum">     932 </span><span class="lineCov">        118 :     if (!request.params[2].isNull())</span></a>
<a name="933"><span class="lineNum">     933 </span><span class="lineCov">         34 :         label = LabelFromValue(request.params[2]);</span></a>
<a name="934"><span class="lineNum">     934 </span>            : </a>
<a name="935"><span class="lineNum">     935 </span><span class="lineCov">        118 :     int required = request.params[0].get_int();</span></a>
<a name="936"><span class="lineNum">     936 </span>            : </a>
<a name="937"><span class="lineNum">     937 </span>            :     // Get the public keys</a>
<a name="938"><span class="lineNum">     938 </span><span class="lineCov">        118 :     const UniValue&amp; keys_or_addrs = request.params[1].get_array();</span></a>
<a name="939"><span class="lineNum">     939 </span><span class="lineCov">        118 :     std::vector&lt;CPubKey&gt; pubkeys;</span></a>
<a name="940"><span class="lineNum">     940 </span><span class="lineCov">        431 :     for (unsigned int i = 0; i &lt; keys_or_addrs.size(); ++i) {</span></a>
<a name="941"><span class="lineNum">     941 </span><span class="lineCov">        313 :         if (IsHex(keys_or_addrs[i].get_str()) &amp;&amp; (keys_or_addrs[i].get_str().length() == 66 || keys_or_addrs[i].get_str().length() == 130)) {</span></a>
<a name="942"><span class="lineNum">     942 </span><span class="lineCov">        171 :             pubkeys.push_back(HexToPubKey(keys_or_addrs[i].get_str()));</span></a>
<a name="943"><span class="lineNum">     943 </span><span class="lineCov">        171 :         } else {</span></a>
<a name="944"><span class="lineNum">     944 </span><span class="lineCov">        142 :             pubkeys.push_back(AddrToPubKey(spk_man, keys_or_addrs[i].get_str()));</span></a>
<a name="945"><span class="lineNum">     945 </span>            :         }</a>
<a name="946"><span class="lineNum">     946 </span>            :     }</a>
<a name="947"><span class="lineNum">     947 </span>            : </a>
<a name="948"><span class="lineNum">     948 </span><span class="lineCov">        116 :     OutputType output_type = pwallet-&gt;m_default_address_type;</span></a>
<a name="949"><span class="lineNum">     949 </span><span class="lineCov">        116 :     if (!request.params[3].isNull()) {</span></a>
<a name="950"><span class="lineNum">     950 </span><span class="lineCov">         42 :         if (!ParseOutputType(request.params[3].get_str(), output_type)) {</span></a>
<a name="951"><span class="lineNum">     951 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, strprintf(&quot;Unknown address type '%s'&quot;, request.params[3].get_str()));</span></a>
<a name="952"><span class="lineNum">     952 </span>            :         }</a>
<a name="953"><span class="lineNum">     953 </span>            :     }</a>
<a name="954"><span class="lineNum">     954 </span>            : </a>
<a name="955"><span class="lineNum">     955 </span>            :     // Construct using pay-to-script-hash:</a>
<a name="956"><span class="lineNum">     956 </span><span class="lineCov">        115 :     CScript inner;</span></a>
<a name="957"><span class="lineNum">     957 </span><span class="lineCov">        115 :     CTxDestination dest = AddAndGetMultisigDestination(required, pubkeys, output_type, spk_man, inner);</span></a>
<a name="958"><span class="lineNum">     958 </span><span class="lineCov">        115 :     pwallet-&gt;SetAddressBook(dest, label, &quot;send&quot;);</span></a>
<a name="959"><span class="lineNum">     959 </span>            : </a>
<a name="960"><span class="lineNum">     960 </span>            :     // Make the descriptor</a>
<a name="961"><span class="lineNum">     961 </span><span class="lineCov">        115 :     std::unique_ptr&lt;Descriptor&gt; descriptor = InferDescriptor(GetScriptForDestination(dest), spk_man);</span></a>
<a name="962"><span class="lineNum">     962 </span>            : </a>
<a name="963"><span class="lineNum">     963 </span><span class="lineCov">        115 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="964"><span class="lineNum">     964 </span><span class="lineCov">        115 :     result.pushKV(&quot;address&quot;, EncodeDestination(dest));</span></a>
<a name="965"><span class="lineNum">     965 </span><span class="lineCov">        115 :     result.pushKV(&quot;redeemScript&quot;, HexStr(inner));</span></a>
<a name="966"><span class="lineNum">     966 </span><span class="lineCov">        115 :     result.pushKV(&quot;descriptor&quot;, descriptor-&gt;ToString());</span></a>
<a name="967"><span class="lineNum">     967 </span><span class="lineCov">        115 :     return result;</span></a>
<a name="968"><span class="lineNum">     968 </span><span class="lineCov">        169 : }</span></a>
<a name="969"><span class="lineNum">     969 </span>            : </a>
<a name="970"><span class="lineNum">     970 </span><span class="lineCov">        500 : struct tallyitem</span></a>
<a name="971"><span class="lineNum">     971 </span>            : {</a>
<a name="972"><span class="lineNum">     972 </span><span class="lineCov">        250 :     CAmount nAmount{0};</span></a>
<a name="973"><span class="lineNum">     973 </span><span class="lineCov">        250 :     int nConf{std::numeric_limits&lt;int&gt;::max()};</span></a>
<a name="974"><span class="lineNum">     974 </span>            :     std::vector&lt;uint256&gt; txids;</a>
<a name="975"><span class="lineNum">     975 </span><span class="lineCov">        250 :     bool fIsWatchonly{false};</span></a>
<a name="976"><span class="lineNum">     976 </span><span class="lineCov">        500 :     tallyitem()</span></a>
<a name="977"><span class="lineNum">     977 </span><span class="lineCov">        250 :     {</span></a>
<a name="978"><span class="lineNum">     978 </span><span class="lineCov">        500 :     }</span></a>
<a name="979"><span class="lineNum">     979 </span>            : };</a>
<a name="980"><span class="lineNum">     980 </span>            : </a>
<a name="981"><span class="lineNum">     981 </span><span class="lineCov">        350 : static UniValue ListReceived(const CWallet* const pwallet, const UniValue&amp; params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(pwallet-&gt;cs_wallet)</span></a>
<a name="982"><span class="lineNum">     982 </span>            : {</a>
<a name="983"><span class="lineNum">     983 </span>            :     // Minimum confirmations</a>
<a name="984"><span class="lineNum">     984 </span>            :     int nMinDepth = 1;</a>
<a name="985"><span class="lineNum">     985 </span><span class="lineCov">        350 :     if (!params[0].isNull())</span></a>
<a name="986"><span class="lineNum">     986 </span><span class="lineCov">        337 :         nMinDepth = params[0].get_int();</span></a>
<a name="987"><span class="lineNum">     987 </span>            : </a>
<a name="988"><span class="lineNum">     988 </span>            :     // Whether to include empty labels</a>
<a name="989"><span class="lineNum">     989 </span>            :     bool fIncludeEmpty = false;</a>
<a name="990"><span class="lineNum">     990 </span><span class="lineCov">        350 :     if (!params[1].isNull())</span></a>
<a name="991"><span class="lineNum">     991 </span><span class="lineCov">         11 :         fIncludeEmpty = params[1].get_bool();</span></a>
<a name="992"><span class="lineNum">     992 </span>            : </a>
<a name="993"><span class="lineNum">     993 </span>            :     isminefilter filter = ISMINE_SPENDABLE;</a>
<a name="994"><span class="lineNum">     994 </span>            : </a>
<a name="995"><span class="lineNum">     995 </span><span class="lineCov">        350 :     if (ParseIncludeWatchonly(params[2], *pwallet)) {</span></a>
<a name="996"><span class="lineNum">     996 </span>            :         filter |= ISMINE_WATCH_ONLY;</a>
<a name="997"><span class="lineNum">     997 </span><span class="lineCov">        337 :     }</span></a>
<a name="998"><span class="lineNum">     998 </span>            : </a>
<a name="999"><span class="lineNum">     999 </span>            :     bool has_filtered_address = false;</a>
<a name="1000"><span class="lineNum">    1000 </span><span class="lineCov">        350 :     CTxDestination filtered_address = CNoDestination();</span></a>
<a name="1001"><span class="lineNum">    1001 </span><span class="lineCov">        350 :     if (!by_label &amp;&amp; params.size() &gt; 3) {</span></a>
<a name="1002"><span class="lineNum">    1002 </span><span class="lineCov">        330 :         if (!IsValidDestinationString(params[3].get_str())) {</span></a>
<a name="1003"><span class="lineNum">    1003 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_WALLET_ERROR, &quot;address_filter parameter was invalid&quot;);</span></a>
<a name="1004"><span class="lineNum">    1004 </span>            :         }</a>
<a name="1005"><span class="lineNum">    1005 </span><span class="lineCov">        329 :         filtered_address = DecodeDestination(params[3].get_str());</span></a>
<a name="1006"><span class="lineNum">    1006 </span>            :         has_filtered_address = true;</a>
<a name="1007"><span class="lineNum">    1007 </span><span class="lineCov">        329 :     }</span></a>
<a name="1008"><span class="lineNum">    1008 </span>            : </a>
<a name="1009"><span class="lineNum">    1009 </span>            :     // Tally</a>
<a name="1010"><span class="lineNum">    1010 </span><span class="lineCov">        349 :     std::map&lt;CTxDestination, tallyitem&gt; mapTally;</span></a>
<a name="1011"><span class="lineNum">    1011 </span><span class="lineCov">      18998 :     for (const std::pair&lt;const uint256, CWalletTx&gt;&amp; pairWtx : pwallet-&gt;mapWallet) {</span></a>
<a name="1012"><span class="lineNum">    1012 </span><span class="lineCov">      18649 :         const CWalletTx&amp; wtx = pairWtx.second;</span></a>
<a name="1013"><span class="lineNum">    1013 </span>            : </a>
<a name="1014"><span class="lineNum">    1014 </span><span class="lineCov">      18649 :         if (wtx.IsCoinBase() || !pwallet-&gt;chain().checkFinalTx(*wtx.tx)) {</span></a>
<a name="1015"><span class="lineNum">    1015 </span><span class="lineCov">       9106 :             continue;</span></a>
<a name="1016"><span class="lineNum">    1016 </span>            :         }</a>
<a name="1017"><span class="lineNum">    1017 </span>            : </a>
<a name="1018"><span class="lineNum">    1018 </span><span class="lineCov">       9543 :         int nDepth = wtx.GetDepthInMainChain();</span></a>
<a name="1019"><span class="lineNum">    1019 </span><span class="lineCov">       9543 :         if (nDepth &lt; nMinDepth)</span></a>
<a name="1020"><span class="lineNum">    1020 </span><span class="lineCov">          3 :             continue;</span></a>
<a name="1021"><span class="lineNum">    1021 </span>            : </a>
<a name="1022"><span class="lineNum">    1022 </span><span class="lineCov">      28620 :         for (const CTxOut&amp; txout : wtx.tx-&gt;vout)</span></a>
<a name="1023"><span class="lineNum">    1023 </span>            :         {</a>
<a name="1024"><span class="lineNum">    1024 </span><span class="lineCov">      19080 :             CTxDestination address;</span></a>
<a name="1025"><span class="lineNum">    1025 </span><span class="lineCov">      19080 :             if (!ExtractDestination(txout.scriptPubKey, address))</span></a>
<a name="1026"><span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                 continue;</span></a>
<a name="1027"><span class="lineNum">    1027 </span>            : </a>
<a name="1028"><span class="lineNum">    1028 </span><span class="lineCov">      19080 :             if (has_filtered_address &amp;&amp; !(filtered_address == address)) {</span></a>
<a name="1029"><span class="lineNum">    1029 </span><span class="lineCov">      18750 :                 continue;</span></a>
<a name="1030"><span class="lineNum">    1030 </span>            :             }</a>
<a name="1031"><span class="lineNum">    1031 </span>            : </a>
<a name="1032"><span class="lineNum">    1032 </span><span class="lineCov">        330 :             isminefilter mine = pwallet-&gt;IsMine(address);</span></a>
<a name="1033"><span class="lineNum">    1033 </span><span class="lineCov">        330 :             if(!(mine &amp; filter))</span></a>
<a name="1034"><span class="lineNum">    1034 </span><span class="lineCov">         32 :                 continue;</span></a>
<a name="1035"><span class="lineNum">    1035 </span>            : </a>
<a name="1036"><span class="lineNum">    1036 </span><span class="lineCov">        298 :             tallyitem&amp; item = mapTally[address];</span></a>
<a name="1037"><span class="lineNum">    1037 </span><span class="lineCov">        298 :             item.nAmount += txout.nValue;</span></a>
<a name="1038"><span class="lineNum">    1038 </span><span class="lineCov">        298 :             item.nConf = std::min(item.nConf, nDepth);</span></a>
<a name="1039"><span class="lineNum">    1039 </span><span class="lineCov">        298 :             item.txids.push_back(wtx.GetHash());</span></a>
<a name="1040"><span class="lineNum">    1040 </span><span class="lineCov">        298 :             if (mine &amp; ISMINE_WATCH_ONLY)</span></a>
<a name="1041"><span class="lineNum">    1041 </span><span class="lineCov">        184 :                 item.fIsWatchonly = true;</span></a>
<a name="1042"><span class="lineNum">    1042 </span><span class="lineCov">      19378 :         }</span></a>
<a name="1043"><span class="lineNum">    1043 </span><span class="lineCov">      19083 :     }</span></a>
<a name="1044"><span class="lineNum">    1044 </span>            : </a>
<a name="1045"><span class="lineNum">    1045 </span>            :     // Reply</a>
<a name="1046"><span class="lineNum">    1046 </span><span class="lineCov">        349 :     UniValue ret(UniValue::VARR);</span></a>
<a name="1047"><span class="lineNum">    1047 </span><span class="lineCov">        349 :     std::map&lt;std::string, tallyitem&gt; label_tally;</span></a>
<a name="1048"><span class="lineNum">    1048 </span>            : </a>
<a name="1049"><span class="lineNum">    1049 </span>            :     // Create m_address_book iterator</a>
<a name="1050"><span class="lineNum">    1050 </span>            :     // If we aren't filtering, go from begin() to end()</a>
<a name="1051"><span class="lineNum">    1051 </span><span class="lineCov">        349 :     auto start = pwallet-&gt;m_address_book.begin();</span></a>
<a name="1052"><span class="lineNum">    1052 </span><span class="lineCov">        349 :     auto end = pwallet-&gt;m_address_book.end();</span></a>
<a name="1053"><span class="lineNum">    1053 </span>            :     // If we are filtering, find() the applicable entry</a>
<a name="1054"><span class="lineNum">    1054 </span><span class="lineCov">        349 :     if (has_filtered_address) {</span></a>
<a name="1055"><span class="lineNum">    1055 </span><span class="lineCov">        329 :         start = pwallet-&gt;m_address_book.find(filtered_address);</span></a>
<a name="1056"><span class="lineNum">    1056 </span><span class="lineCov">        329 :         if (start != end) {</span></a>
<a name="1057"><span class="lineNum">    1057 </span><span class="lineCov">        328 :             end = std::next(start);</span></a>
<a name="1058"><span class="lineNum">    1058 </span><span class="lineCov">        328 :         }</span></a>
<a name="1059"><span class="lineNum">    1059 </span>            :     }</a>
<a name="1060"><span class="lineNum">    1060 </span>            : </a>
<a name="1061"><span class="lineNum">    1061 </span><span class="lineCov">        793 :     for (auto item_it = start; item_it != end; ++item_it)</span></a>
<a name="1062"><span class="lineNum">    1062 </span>            :     {</a>
<a name="1063"><span class="lineNum">    1063 </span><span class="lineCov">        444 :         if (item_it-&gt;second.IsChange()) continue;</span></a>
<a name="1064"><span class="lineNum">    1064 </span><span class="lineCov">        444 :         const CTxDestination&amp; address = item_it-&gt;first;</span></a>
<a name="1065"><span class="lineNum">    1065 </span><span class="lineCov">        444 :         const std::string&amp; label = item_it-&gt;second.GetLabel();</span></a>
<a name="1066"><span class="lineNum">    1066 </span><span class="lineCov">        444 :         auto it = mapTally.find(address);</span></a>
<a name="1067"><span class="lineNum">    1067 </span><span class="lineCov">        444 :         if (it == mapTally.end() &amp;&amp; !fIncludeEmpty)</span></a>
<a name="1068"><span class="lineNum">    1068 </span><span class="lineCov">        181 :             continue;</span></a>
<a name="1069"><span class="lineNum">    1069 </span>            : </a>
<a name="1070"><span class="lineNum">    1070 </span><span class="lineCov">        263 :         CAmount nAmount = 0;</span></a>
<a name="1071"><span class="lineNum">    1071 </span><span class="lineCov">        263 :         int nConf = std::numeric_limits&lt;int&gt;::max();</span></a>
<a name="1072"><span class="lineNum">    1072 </span>            :         bool fIsWatchonly = false;</a>
<a name="1073"><span class="lineNum">    1073 </span><span class="lineCov">        263 :         if (it != mapTally.end())</span></a>
<a name="1074"><span class="lineNum">    1074 </span>            :         {</a>
<a name="1075"><span class="lineNum">    1075 </span><span class="lineCov">        242 :             nAmount = (*it).second.nAmount;</span></a>
<a name="1076"><span class="lineNum">    1076 </span><span class="lineCov">        242 :             nConf = (*it).second.nConf;</span></a>
<a name="1077"><span class="lineNum">    1077 </span><span class="lineCov">        242 :             fIsWatchonly = (*it).second.fIsWatchonly;</span></a>
<a name="1078"><span class="lineNum">    1078 </span><span class="lineCov">        242 :         }</span></a>
<a name="1079"><span class="lineNum">    1079 </span>            : </a>
<a name="1080"><span class="lineNum">    1080 </span><span class="lineCov">        263 :         if (by_label)</span></a>
<a name="1081"><span class="lineNum">    1081 </span>            :         {</a>
<a name="1082"><span class="lineNum">    1082 </span><span class="lineCov">         20 :             tallyitem&amp; _item = label_tally[label];</span></a>
<a name="1083"><span class="lineNum">    1083 </span><span class="lineCov">         20 :             _item.nAmount += nAmount;</span></a>
<a name="1084"><span class="lineNum">    1084 </span><span class="lineCov">         20 :             _item.nConf = std::min(_item.nConf, nConf);</span></a>
<a name="1085"><span class="lineNum">    1085 </span><span class="lineCov">         20 :             _item.fIsWatchonly = fIsWatchonly;</span></a>
<a name="1086"><span class="lineNum">    1086 </span><span class="lineCov">         20 :         }</span></a>
<a name="1087"><span class="lineNum">    1087 </span>            :         else</a>
<a name="1088"><span class="lineNum">    1088 </span>            :         {</a>
<a name="1089"><span class="lineNum">    1089 </span><span class="lineCov">        243 :             UniValue obj(UniValue::VOBJ);</span></a>
<a name="1090"><span class="lineNum">    1090 </span><span class="lineCov">        243 :             if(fIsWatchonly)</span></a>
<a name="1091"><span class="lineNum">    1091 </span><span class="lineCov">        146 :                 obj.pushKV(&quot;involvesWatchonly&quot;, true);</span></a>
<a name="1092"><span class="lineNum">    1092 </span><span class="lineCov">        243 :             obj.pushKV(&quot;address&quot;,       EncodeDestination(address));</span></a>
<a name="1093"><span class="lineNum">    1093 </span><span class="lineCov">        243 :             obj.pushKV(&quot;amount&quot;,        ValueFromAmount(nAmount));</span></a>
<a name="1094"><span class="lineNum">    1094 </span><span class="lineCov">        243 :             obj.pushKV(&quot;confirmations&quot;, (nConf == std::numeric_limits&lt;int&gt;::max() ? 0 : nConf));</span></a>
<a name="1095"><span class="lineNum">    1095 </span><span class="lineCov">        243 :             obj.pushKV(&quot;label&quot;, label);</span></a>
<a name="1096"><span class="lineNum">    1096 </span><span class="lineCov">        243 :             UniValue transactions(UniValue::VARR);</span></a>
<a name="1097"><span class="lineNum">    1097 </span><span class="lineCov">        243 :             if (it != mapTally.end())</span></a>
<a name="1098"><span class="lineNum">    1098 </span>            :             {</a>
<a name="1099"><span class="lineNum">    1099 </span><span class="lineCov">        510 :                 for (const uint256&amp; _item : (*it).second.txids)</span></a>
<a name="1100"><span class="lineNum">    1100 </span>            :                 {</a>
<a name="1101"><span class="lineNum">    1101 </span><span class="lineCov">        282 :                     transactions.push_back(_item.GetHex());</span></a>
<a name="1102"><span class="lineNum">    1102 </span>            :                 }</a>
<a name="1103"><span class="lineNum">    1103 </span><span class="lineCov">        228 :             }</span></a>
<a name="1104"><span class="lineNum">    1104 </span><span class="lineCov">        243 :             obj.pushKV(&quot;txids&quot;, transactions);</span></a>
<a name="1105"><span class="lineNum">    1105 </span><span class="lineCov">        243 :             ret.push_back(obj);</span></a>
<a name="1106"><span class="lineNum">    1106 </span><span class="lineCov">        243 :         }</span></a>
<a name="1107"><span class="lineNum">    1107 </span><span class="lineCov">        444 :     }</span></a>
<a name="1108"><span class="lineNum">    1108 </span>            : </a>
<a name="1109"><span class="lineNum">    1109 </span><span class="lineCov">        349 :     if (by_label)</span></a>
<a name="1110"><span class="lineNum">    1110 </span>            :     {</a>
<a name="1111"><span class="lineNum">    1111 </span><span class="lineCov">         16 :         for (const auto&amp; entry : label_tally)</span></a>
<a name="1112"><span class="lineNum">    1112 </span>            :         {</a>
<a name="1113"><span class="lineNum">    1113 </span><span class="lineCov">          8 :             CAmount nAmount = entry.second.nAmount;</span></a>
<a name="1114"><span class="lineNum">    1114 </span><span class="lineCov">          8 :             int nConf = entry.second.nConf;</span></a>
<a name="1115"><span class="lineNum">    1115 </span><span class="lineCov">          8 :             UniValue obj(UniValue::VOBJ);</span></a>
<a name="1116"><span class="lineNum">    1116 </span><span class="lineCov">          8 :             if (entry.second.fIsWatchonly)</span></a>
<a name="1117"><span class="lineNum">    1117 </span><span class="lineCov">          2 :                 obj.pushKV(&quot;involvesWatchonly&quot;, true);</span></a>
<a name="1118"><span class="lineNum">    1118 </span><span class="lineCov">          8 :             obj.pushKV(&quot;amount&quot;,        ValueFromAmount(nAmount));</span></a>
<a name="1119"><span class="lineNum">    1119 </span><span class="lineCov">          8 :             obj.pushKV(&quot;confirmations&quot;, (nConf == std::numeric_limits&lt;int&gt;::max() ? 0 : nConf));</span></a>
<a name="1120"><span class="lineNum">    1120 </span><span class="lineCov">          8 :             obj.pushKV(&quot;label&quot;,         entry.first);</span></a>
<a name="1121"><span class="lineNum">    1121 </span><span class="lineCov">          8 :             ret.push_back(obj);</span></a>
<a name="1122"><span class="lineNum">    1122 </span><span class="lineCov">          8 :         }</span></a>
<a name="1123"><span class="lineNum">    1123 </span><span class="lineCov">          8 :     }</span></a>
<a name="1124"><span class="lineNum">    1124 </span>            : </a>
<a name="1125"><span class="lineNum">    1125 </span>            :     return ret;</a>
<a name="1126"><span class="lineNum">    1126 </span><span class="lineCov">        350 : }</span></a>
<a name="1127"><span class="lineNum">    1127 </span>            : </a>
<a name="1128"><span class="lineNum">    1128 </span><span class="lineCov">        346 : static UniValue listreceivedbyaddress(const JSONRPCRequest&amp; request)</span></a>
<a name="1129"><span class="lineNum">    1129 </span>            : {</a>
<a name="1130"><span class="lineNum">    1130 </span><span class="lineCov">       3807 :             RPCHelpMan{&quot;listreceivedbyaddress&quot;,</span></a>
<a name="1131"><span class="lineNum">    1131 </span><span class="lineCov">        346 :                 &quot;\nList balances by receiving address.\n&quot;,</span></a>
<a name="1132"><span class="lineNum">    1132 </span><span class="lineCov">       1734 :                 {</span></a>
<a name="1133"><span class="lineNum">    1133 </span><span class="lineCov">        346 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, /* default */ &quot;1&quot;, &quot;The minimum number of confirmations before payments are included.&quot;},</span></a>
<a name="1134"><span class="lineNum">    1134 </span><span class="lineCov">        346 :                     {&quot;include_empty&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Whether to include addresses that haven't received any payments.&quot;},</span></a>
<a name="1135"><span class="lineNum">    1135 </span><span class="lineCov">        346 :                     {&quot;include_watchonly&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Whether to include watch-only addresses (see 'importaddress')&quot;},</span></a>
<a name="1136"><span class="lineNum">    1136 </span><span class="lineCov">        346 :                     {&quot;address_filter&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;If present, only return information on this address.&quot;},</span></a>
<a name="1137"><span class="lineNum">    1137 </span>            :                 },</a>
<a name="1138"><span class="lineNum">    1138 </span><span class="lineCov">        346 :                 RPCResult{</span></a>
<a name="1139"><span class="lineNum">    1139 </span><span class="lineCov">        346 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1140"><span class="lineNum">    1140 </span><span class="lineCov">        692 :                     {</span></a>
<a name="1141"><span class="lineNum">    1141 </span><span class="lineCov">        692 :                         {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1142"><span class="lineNum">    1142 </span><span class="lineCov">       2426 :                         {</span></a>
<a name="1143"><span class="lineNum">    1143 </span><span class="lineCov">        346 :                             {RPCResult::Type::BOOL, &quot;involvesWatchonly&quot;, &quot;Only returns true if imported addresses were involved in transaction&quot;},</span></a>
<a name="1144"><span class="lineNum">    1144 </span><span class="lineCov">        346 :                             {RPCResult::Type::STR, &quot;address&quot;, &quot;The receiving address&quot;},</span></a>
<a name="1145"><span class="lineNum">    1145 </span><span class="lineCov">        346 :                             {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The total amount in &quot; + CURRENCY_UNIT + &quot; received by the address&quot;},</span></a>
<a name="1146"><span class="lineNum">    1146 </span><span class="lineCov">        346 :                             {RPCResult::Type::NUM, &quot;confirmations&quot;, &quot;The number of confirmations of the most recent transaction included&quot;},</span></a>
<a name="1147"><span class="lineNum">    1147 </span><span class="lineCov">        346 :                             {RPCResult::Type::STR, &quot;label&quot;, &quot;The label of the receiving address. The default label is \&quot;\&quot;&quot;},</span></a>
<a name="1148"><span class="lineNum">    1148 </span><span class="lineCov">        692 :                             {RPCResult::Type::ARR, &quot;txids&quot;, &quot;&quot;,</span></a>
<a name="1149"><span class="lineNum">    1149 </span><span class="lineCov">        692 :                             {</span></a>
<a name="1150"><span class="lineNum">    1150 </span><span class="lineCov">        346 :                                 {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The ids of transactions received with the address&quot;},</span></a>
<a name="1151"><span class="lineNum">    1151 </span>            :                             }},</a>
<a name="1152"><span class="lineNum">    1152 </span>            :                         }},</a>
<a name="1153"><span class="lineNum">    1153 </span>            :                     }</a>
<a name="1154"><span class="lineNum">    1154 </span>            :                 },</a>
<a name="1155"><span class="lineNum">    1155 </span><span class="lineCov">        346 :                 RPCExamples{</span></a>
<a name="1156"><span class="lineNum">    1156 </span><span class="lineCov">        346 :                     HelpExampleCli(&quot;listreceivedbyaddress&quot;, &quot;&quot;)</span></a>
<a name="1157"><span class="lineNum">    1157 </span><span class="lineCov">        346 :             + HelpExampleCli(&quot;listreceivedbyaddress&quot;, &quot;6 true&quot;)</span></a>
<a name="1158"><span class="lineNum">    1158 </span><span class="lineCov">        346 :             + HelpExampleRpc(&quot;listreceivedbyaddress&quot;, &quot;6, true, true&quot;)</span></a>
<a name="1159"><span class="lineNum">    1159 </span><span class="lineCov">        346 :             + HelpExampleRpc(&quot;listreceivedbyaddress&quot;, &quot;6, true, true, \&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;&quot;)</span></a>
<a name="1160"><span class="lineNum">    1160 </span>            :                 },</a>
<a name="1161"><span class="lineNum">    1161 </span><span class="lineCov">        346 :             }.Check(request);</span></a>
<a name="1162"><span class="lineNum">    1162 </span>            : </a>
<a name="1163"><span class="lineNum">    1163 </span><span class="lineCov">        342 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1164"><span class="lineNum">    1164 </span><span class="lineCov">        342 :     if (!wallet) return NullUniValue;</span></a>
<a name="1165"><span class="lineNum">    1165 </span><span class="lineCov">        342 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="1166"><span class="lineNum">    1166 </span>            : </a>
<a name="1167"><span class="lineNum">    1167 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1168"><span class="lineNum">    1168 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1169"><span class="lineNum">    1169 </span><span class="lineCov">        342 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="1170"><span class="lineNum">    1170 </span>            : </a>
<a name="1171"><span class="lineNum">    1171 </span><span class="lineCov">        342 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1172"><span class="lineNum">    1172 </span>            : </a>
<a name="1173"><span class="lineNum">    1173 </span><span class="lineCov">        342 :     return ListReceived(pwallet, request.params, false);</span></a>
<a name="1174"><span class="lineNum">    1174 </span><span class="lineCov">        394 : }</span></a>
<a name="1175"><span class="lineNum">    1175 </span>            : </a>
<a name="1176"><span class="lineNum">    1176 </span><span class="lineCov">         12 : static UniValue listreceivedbylabel(const JSONRPCRequest&amp; request)</span></a>
<a name="1177"><span class="lineNum">    1177 </span>            : {</a>
<a name="1178"><span class="lineNum">    1178 </span><span class="lineCov">         96 :             RPCHelpMan{&quot;listreceivedbylabel&quot;,</span></a>
<a name="1179"><span class="lineNum">    1179 </span><span class="lineCov">         12 :                 &quot;\nList received transactions by label.\n&quot;,</span></a>
<a name="1180"><span class="lineNum">    1180 </span><span class="lineCov">         52 :                 {</span></a>
<a name="1181"><span class="lineNum">    1181 </span><span class="lineCov">         12 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, /* default */ &quot;1&quot;, &quot;The minimum number of confirmations before payments are included.&quot;},</span></a>
<a name="1182"><span class="lineNum">    1182 </span><span class="lineCov">         12 :                     {&quot;include_empty&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Whether to include labels that haven't received any payments.&quot;},</span></a>
<a name="1183"><span class="lineNum">    1183 </span><span class="lineCov">         12 :                     {&quot;include_watchonly&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Whether to include watch-only addresses (see 'importaddress')&quot;},</span></a>
<a name="1184"><span class="lineNum">    1184 </span>            :                 },</a>
<a name="1185"><span class="lineNum">    1185 </span><span class="lineCov">         12 :                 RPCResult{</span></a>
<a name="1186"><span class="lineNum">    1186 </span><span class="lineCov">         12 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1187"><span class="lineNum">    1187 </span><span class="lineCov">         24 :                     {</span></a>
<a name="1188"><span class="lineNum">    1188 </span><span class="lineCov">         24 :                         {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1189"><span class="lineNum">    1189 </span><span class="lineCov">         64 :                         {</span></a>
<a name="1190"><span class="lineNum">    1190 </span><span class="lineCov">         12 :                             {RPCResult::Type::BOOL, &quot;involvesWatchonly&quot;, &quot;Only returns true if imported addresses were involved in transaction&quot;},</span></a>
<a name="1191"><span class="lineNum">    1191 </span><span class="lineCov">         12 :                             {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The total amount received by addresses with this label&quot;},</span></a>
<a name="1192"><span class="lineNum">    1192 </span><span class="lineCov">         12 :                             {RPCResult::Type::NUM, &quot;confirmations&quot;, &quot;The number of confirmations of the most recent transaction included&quot;},</span></a>
<a name="1193"><span class="lineNum">    1193 </span><span class="lineCov">         12 :                             {RPCResult::Type::STR, &quot;label&quot;, &quot;The label of the receiving address. The default label is \&quot;\&quot;&quot;},</span></a>
<a name="1194"><span class="lineNum">    1194 </span>            :                         }},</a>
<a name="1195"><span class="lineNum">    1195 </span>            :                     }</a>
<a name="1196"><span class="lineNum">    1196 </span>            :                 },</a>
<a name="1197"><span class="lineNum">    1197 </span><span class="lineCov">         12 :                 RPCExamples{</span></a>
<a name="1198"><span class="lineNum">    1198 </span><span class="lineCov">         12 :                     HelpExampleCli(&quot;listreceivedbylabel&quot;, &quot;&quot;)</span></a>
<a name="1199"><span class="lineNum">    1199 </span><span class="lineCov">         12 :             + HelpExampleCli(&quot;listreceivedbylabel&quot;, &quot;6 true&quot;)</span></a>
<a name="1200"><span class="lineNum">    1200 </span><span class="lineCov">         12 :             + HelpExampleRpc(&quot;listreceivedbylabel&quot;, &quot;6, true, true&quot;)</span></a>
<a name="1201"><span class="lineNum">    1201 </span>            :                 },</a>
<a name="1202"><span class="lineNum">    1202 </span><span class="lineCov">         12 :             }.Check(request);</span></a>
<a name="1203"><span class="lineNum">    1203 </span>            : </a>
<a name="1204"><span class="lineNum">    1204 </span><span class="lineCov">          8 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1205"><span class="lineNum">    1205 </span><span class="lineCov">          8 :     if (!wallet) return NullUniValue;</span></a>
<a name="1206"><span class="lineNum">    1206 </span><span class="lineCov">          8 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="1207"><span class="lineNum">    1207 </span>            : </a>
<a name="1208"><span class="lineNum">    1208 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1209"><span class="lineNum">    1209 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1210"><span class="lineNum">    1210 </span><span class="lineCov">          8 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="1211"><span class="lineNum">    1211 </span>            : </a>
<a name="1212"><span class="lineNum">    1212 </span><span class="lineCov">          8 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1213"><span class="lineNum">    1213 </span>            : </a>
<a name="1214"><span class="lineNum">    1214 </span><span class="lineCov">          8 :     return ListReceived(pwallet, request.params, true);</span></a>
<a name="1215"><span class="lineNum">    1215 </span><span class="lineCov">         48 : }</span></a>
<a name="1216"><span class="lineNum">    1216 </span>            : </a>
<a name="1217"><span class="lineNum">    1217 </span><span class="lineCov">       2147 : static void MaybePushAddress(UniValue &amp; entry, const CTxDestination &amp;dest)</span></a>
<a name="1218"><span class="lineNum">    1218 </span>            : {</a>
<a name="1219"><span class="lineNum">    1219 </span><span class="lineCov">       2147 :     if (IsValidDestination(dest)) {</span></a>
<a name="1220"><span class="lineNum">    1220 </span><span class="lineCov">       2146 :         entry.pushKV(&quot;address&quot;, EncodeDestination(dest));</span></a>
<a name="1221"><span class="lineNum">    1221 </span><span class="lineCov">       2146 :     }</span></a>
<a name="1222"><span class="lineNum">    1222 </span><span class="lineCov">       2147 : }</span></a>
<a name="1223"><span class="lineNum">    1223 </span>            : </a>
<a name="1224"><span class="lineNum">    1224 </span>            : /**</a>
<a name="1225"><span class="lineNum">    1225 </span>            :  * List transactions based on the given criteria.</a>
<a name="1226"><span class="lineNum">    1226 </span>            :  *</a>
<a name="1227"><span class="lineNum">    1227 </span>            :  * @param  pwallet        The wallet.</a>
<a name="1228"><span class="lineNum">    1228 </span>            :  * @param  wtx            The wallet transaction.</a>
<a name="1229"><span class="lineNum">    1229 </span>            :  * @param  nMinDepth      The minimum confirmation depth.</a>
<a name="1230"><span class="lineNum">    1230 </span>            :  * @param  fLong          Whether to include the JSON version of the transaction.</a>
<a name="1231"><span class="lineNum">    1231 </span>            :  * @param  ret            The UniValue into which the result is stored.</a>
<a name="1232"><span class="lineNum">    1232 </span>            :  * @param  filter_ismine  The &quot;is mine&quot; filter flags.</a>
<a name="1233"><span class="lineNum">    1233 </span>            :  * @param  filter_label   Optional label string to filter incoming transactions.</a>
<a name="1234"><span class="lineNum">    1234 </span>            :  */</a>
<a name="1235"><span class="lineNum">    1235 </span><span class="lineCov">      19442 : static void ListTransactions(const CWallet* const pwallet, const CWalletTx&amp; wtx, int nMinDepth, bool fLong, UniValue&amp; ret, const isminefilter&amp; filter_ismine, const std::string* filter_label) EXCLUSIVE_LOCKS_REQUIRED(pwallet-&gt;cs_wallet)</span></a>
<a name="1236"><span class="lineNum">    1236 </span>            : {</a>
<a name="1237"><span class="lineNum">    1237 </span><span class="lineCov">      19442 :     CAmount nFee;</span></a>
<a name="1238"><span class="lineNum">    1238 </span><span class="lineCov">      19442 :     std::list&lt;COutputEntry&gt; listReceived;</span></a>
<a name="1239"><span class="lineNum">    1239 </span><span class="lineCov">      19442 :     std::list&lt;COutputEntry&gt; listSent;</span></a>
<a name="1240"><span class="lineNum">    1240 </span>            : </a>
<a name="1241"><span class="lineNum">    1241 </span><span class="lineCov">      19442 :     wtx.GetAmounts(listReceived, listSent, nFee, filter_ismine);</span></a>
<a name="1242"><span class="lineNum">    1242 </span>            : </a>
<a name="1243"><span class="lineNum">    1243 </span><span class="lineCov">      19442 :     bool involvesWatchonly = wtx.IsFromMe(ISMINE_WATCH_ONLY);</span></a>
<a name="1244"><span class="lineNum">    1244 </span>            : </a>
<a name="1245"><span class="lineNum">    1245 </span>            :     // Sent</a>
<a name="1246"><span class="lineNum">    1246 </span><span class="lineCov">      19442 :     if (!filter_label)</span></a>
<a name="1247"><span class="lineNum">    1247 </span>            :     {</a>
<a name="1248"><span class="lineNum">    1248 </span><span class="lineCov">       2100 :         for (const COutputEntry&amp; s : listSent)</span></a>
<a name="1249"><span class="lineNum">    1249 </span>            :         {</a>
<a name="1250"><span class="lineNum">    1250 </span><span class="lineCov">        438 :             UniValue entry(UniValue::VOBJ);</span></a>
<a name="1251"><span class="lineNum">    1251 </span><span class="lineCov">        438 :             if (involvesWatchonly || (pwallet-&gt;IsMine(s.destination) &amp; ISMINE_WATCH_ONLY)) {</span></a>
<a name="1252"><span class="lineNum">    1252 </span><span class="lineCov">          9 :                 entry.pushKV(&quot;involvesWatchonly&quot;, true);</span></a>
<a name="1253"><span class="lineNum">    1253 </span><span class="lineCov">          9 :             }</span></a>
<a name="1254"><span class="lineNum">    1254 </span><span class="lineCov">        438 :             MaybePushAddress(entry, s.destination);</span></a>
<a name="1255"><span class="lineNum">    1255 </span><span class="lineCov">        438 :             entry.pushKV(&quot;category&quot;, &quot;send&quot;);</span></a>
<a name="1256"><span class="lineNum">    1256 </span><span class="lineCov">        438 :             entry.pushKV(&quot;amount&quot;, ValueFromAmount(-s.amount));</span></a>
<a name="1257"><span class="lineNum">    1257 </span><span class="lineCov">        438 :             const auto* address_book_entry = pwallet-&gt;FindAddressBookEntry(s.destination);</span></a>
<a name="1258"><span class="lineNum">    1258 </span><span class="lineCov">        438 :             if (address_book_entry) {</span></a>
<a name="1259"><span class="lineNum">    1259 </span><span class="lineCov">        173 :                 entry.pushKV(&quot;label&quot;, address_book_entry-&gt;GetLabel());</span></a>
<a name="1260"><span class="lineNum">    1260 </span><span class="lineCov">        173 :             }</span></a>
<a name="1261"><span class="lineNum">    1261 </span><span class="lineCov">        438 :             entry.pushKV(&quot;vout&quot;, s.vout);</span></a>
<a name="1262"><span class="lineNum">    1262 </span><span class="lineCov">        438 :             entry.pushKV(&quot;fee&quot;, ValueFromAmount(-nFee));</span></a>
<a name="1263"><span class="lineNum">    1263 </span><span class="lineCov">        438 :             if (fLong)</span></a>
<a name="1264"><span class="lineNum">    1264 </span><span class="lineCov">        221 :                 WalletTxToJSON(pwallet-&gt;chain(), wtx, entry);</span></a>
<a name="1265"><span class="lineNum">    1265 </span><span class="lineCov">        438 :             entry.pushKV(&quot;abandoned&quot;, wtx.isAbandoned());</span></a>
<a name="1266"><span class="lineNum">    1266 </span><span class="lineCov">        438 :             ret.push_back(entry);</span></a>
<a name="1267"><span class="lineNum">    1267 </span><span class="lineCov">        438 :         }</span></a>
<a name="1268"><span class="lineNum">    1268 </span><span class="lineCov">       1662 :     }</span></a>
<a name="1269"><span class="lineNum">    1269 </span>            : </a>
<a name="1270"><span class="lineNum">    1270 </span>            :     // Received</a>
<a name="1271"><span class="lineNum">    1271 </span><span class="lineCov">      19442 :     if (listReceived.size() &gt; 0 &amp;&amp; wtx.GetDepthInMainChain() &gt;= nMinDepth) {</span></a>
<a name="1272"><span class="lineNum">    1272 </span><span class="lineCov">      38400 :         for (const COutputEntry&amp; r : listReceived)</span></a>
<a name="1273"><span class="lineNum">    1273 </span>            :         {</a>
<a name="1274"><span class="lineNum">    1274 </span><span class="lineCov">      19213 :             std::string label;</span></a>
<a name="1275"><span class="lineNum">    1275 </span><span class="lineCov">      19213 :             const auto* address_book_entry = pwallet-&gt;FindAddressBookEntry(r.destination);</span></a>
<a name="1276"><span class="lineNum">    1276 </span><span class="lineCov">      19213 :             if (address_book_entry) {</span></a>
<a name="1277"><span class="lineNum">    1277 </span><span class="lineCov">      19168 :                 label = address_book_entry-&gt;GetLabel();</span></a>
<a name="1278"><span class="lineNum">    1278 </span>            :             }</a>
<a name="1279"><span class="lineNum">    1279 </span><span class="lineCov">      19213 :             if (filter_label &amp;&amp; label != *filter_label) {</span></a>
<a name="1280"><span class="lineNum">    1280 </span><span class="lineCov">      17504 :                 continue;</span></a>
<a name="1281"><span class="lineNum">    1281 </span>            :             }</a>
<a name="1282"><span class="lineNum">    1282 </span><span class="lineCov">       1709 :             UniValue entry(UniValue::VOBJ);</span></a>
<a name="1283"><span class="lineNum">    1283 </span><span class="lineCov">       1709 :             if (involvesWatchonly || (pwallet-&gt;IsMine(r.destination) &amp; ISMINE_WATCH_ONLY)) {</span></a>
<a name="1284"><span class="lineNum">    1284 </span><span class="lineCov">        201 :                 entry.pushKV(&quot;involvesWatchonly&quot;, true);</span></a>
<a name="1285"><span class="lineNum">    1285 </span><span class="lineCov">        201 :             }</span></a>
<a name="1286"><span class="lineNum">    1286 </span><span class="lineCov">       1709 :             MaybePushAddress(entry, r.destination);</span></a>
<a name="1287"><span class="lineNum">    1287 </span><span class="lineCov">       1709 :             if (wtx.IsCoinBase())</span></a>
<a name="1288"><span class="lineNum">    1288 </span>            :             {</a>
<a name="1289"><span class="lineNum">    1289 </span><span class="lineCov">       1132 :                 if (wtx.GetDepthInMainChain() &lt; 1)</span></a>
<a name="1290"><span class="lineNum">    1290 </span><span class="lineCov">        203 :                     entry.pushKV(&quot;category&quot;, &quot;orphan&quot;);</span></a>
<a name="1291"><span class="lineNum">    1291 </span><span class="lineCov">        929 :                 else if (wtx.IsImmatureCoinBase())</span></a>
<a name="1292"><span class="lineNum">    1292 </span><span class="lineCov">        677 :                     entry.pushKV(&quot;category&quot;, &quot;immature&quot;);</span></a>
<a name="1293"><span class="lineNum">    1293 </span>            :                 else</a>
<a name="1294"><span class="lineNum">    1294 </span><span class="lineCov">        252 :                     entry.pushKV(&quot;category&quot;, &quot;generate&quot;);</span></a>
<a name="1295"><span class="lineNum">    1295 </span>            :             }</a>
<a name="1296"><span class="lineNum">    1296 </span>            :             else</a>
<a name="1297"><span class="lineNum">    1297 </span>            :             {</a>
<a name="1298"><span class="lineNum">    1298 </span><span class="lineCov">        577 :                 entry.pushKV(&quot;category&quot;, &quot;receive&quot;);</span></a>
<a name="1299"><span class="lineNum">    1299 </span>            :             }</a>
<a name="1300"><span class="lineNum">    1300 </span><span class="lineCov">       1709 :             entry.pushKV(&quot;amount&quot;, ValueFromAmount(r.amount));</span></a>
<a name="1301"><span class="lineNum">    1301 </span><span class="lineCov">       1709 :             if (address_book_entry) {</span></a>
<a name="1302"><span class="lineNum">    1302 </span><span class="lineCov">       1664 :                 entry.pushKV(&quot;label&quot;, label);</span></a>
<a name="1303"><span class="lineNum">    1303 </span><span class="lineCov">       1664 :             }</span></a>
<a name="1304"><span class="lineNum">    1304 </span><span class="lineCov">       1709 :             entry.pushKV(&quot;vout&quot;, r.vout);</span></a>
<a name="1305"><span class="lineNum">    1305 </span><span class="lineCov">       1709 :             if (fLong)</span></a>
<a name="1306"><span class="lineNum">    1306 </span><span class="lineCov">       1570 :                 WalletTxToJSON(pwallet-&gt;chain(), wtx, entry);</span></a>
<a name="1307"><span class="lineNum">    1307 </span><span class="lineCov">       1709 :             ret.push_back(entry);</span></a>
<a name="1308"><span class="lineNum">    1308 </span><span class="lineCov">      19213 :         }</span></a>
<a name="1309"><span class="lineNum">    1309 </span><span class="lineCov">      19187 :     }</span></a>
<a name="1310"><span class="lineNum">    1310 </span><span class="lineCov">      19442 : }</span></a>
<a name="1311"><span class="lineNum">    1311 </span>            : </a>
<a name="1312"><span class="lineNum">    1312 </span><span class="lineCov">        673 : static const std::vector&lt;RPCResult&gt; TransactionDescriptionString()</span></a>
<a name="1313"><span class="lineNum">    1313 </span>            : {</a>
<a name="1314"><span class="lineNum">    1314 </span><span class="lineCov">      16825 :     return{{RPCResult::Type::NUM, &quot;confirmations&quot;, &quot;The number of confirmations for the transaction. Negative confirmations means the\n&quot;</span></a>
<a name="1315"><span class="lineNum">    1315 </span>            :                &quot;transaction conflicted that many blocks ago.&quot;},</a>
<a name="1316"><span class="lineNum">    1316 </span><span class="lineCov">        673 :            {RPCResult::Type::BOOL, &quot;generated&quot;, &quot;Only present if transaction only input is a coinbase one.&quot;},</span></a>
<a name="1317"><span class="lineNum">    1317 </span><span class="lineCov">        673 :            {RPCResult::Type::BOOL, &quot;trusted&quot;, &quot;Only present if we consider transaction to be trusted and so safe to spend from.&quot;},</span></a>
<a name="1318"><span class="lineNum">    1318 </span><span class="lineCov">        673 :            {RPCResult::Type::STR_HEX, &quot;blockhash&quot;, &quot;The block hash containing the transaction.&quot;},</span></a>
<a name="1319"><span class="lineNum">    1319 </span><span class="lineCov">        673 :            {RPCResult::Type::NUM, &quot;blockheight&quot;, &quot;The block height containing the transaction.&quot;},</span></a>
<a name="1320"><span class="lineNum">    1320 </span><span class="lineCov">        673 :            {RPCResult::Type::NUM, &quot;blockindex&quot;, &quot;The index of the transaction in the block that includes it.&quot;},</span></a>
<a name="1321"><span class="lineNum">    1321 </span><span class="lineCov">        673 :            {RPCResult::Type::NUM_TIME, &quot;blocktime&quot;, &quot;The block time expressed in &quot; + UNIX_EPOCH_TIME + &quot;.&quot;},</span></a>
<a name="1322"><span class="lineNum">    1322 </span><span class="lineCov">        673 :            {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The transaction id.&quot;},</span></a>
<a name="1323"><span class="lineNum">    1323 </span><span class="lineCov">       1346 :            {RPCResult::Type::ARR, &quot;walletconflicts&quot;, &quot;Conflicting transaction ids.&quot;,</span></a>
<a name="1324"><span class="lineNum">    1324 </span><span class="lineCov">       1346 :            {</span></a>
<a name="1325"><span class="lineNum">    1325 </span><span class="lineCov">        673 :                {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The transaction id.&quot;},</span></a>
<a name="1326"><span class="lineNum">    1326 </span>            :            }},</a>
<a name="1327"><span class="lineNum">    1327 </span><span class="lineCov">        673 :            {RPCResult::Type::NUM_TIME, &quot;time&quot;, &quot;The transaction time expressed in &quot; + UNIX_EPOCH_TIME + &quot;.&quot;},</span></a>
<a name="1328"><span class="lineNum">    1328 </span><span class="lineCov">        673 :            {RPCResult::Type::NUM_TIME, &quot;timereceived&quot;, &quot;The time received expressed in &quot; + UNIX_EPOCH_TIME + &quot;.&quot;},</span></a>
<a name="1329"><span class="lineNum">    1329 </span><span class="lineCov">        673 :            {RPCResult::Type::STR, &quot;comment&quot;, &quot;If a comment is associated with the transaction, only present if not empty.&quot;},</span></a>
<a name="1330"><span class="lineNum">    1330 </span><span class="lineCov">        673 :            {RPCResult::Type::STR, &quot;bip125-replaceable&quot;, &quot;(\&quot;yes|no|unknown\&quot;) Whether this transaction could be replaced due to BIP125 (replace-by-fee);\n&quot;</span></a>
<a name="1331"><span class="lineNum">    1331 </span>            :                &quot;may be unknown for unconfirmed transactions not in the mempool&quot;}};</a>
<a name="1332"><span class="lineNum">    1332 </span><span class="lineNoCov">          0 : }</span></a>
<a name="1333"><span class="lineNum">    1333 </span>            : </a>
<a name="1334"><span class="lineNum">    1334 </span><span class="lineCov">        398 : UniValue listtransactions(const JSONRPCRequest&amp; request)</span></a>
<a name="1335"><span class="lineNum">    1335 </span>            : {</a>
<a name="1336"><span class="lineNum">    1336 </span><span class="lineCov">       4776 :             RPCHelpMan{&quot;listtransactions&quot;,</span></a>
<a name="1337"><span class="lineNum">    1337 </span><span class="lineCov">        398 :                 &quot;\nIf a label name is provided, this will return only incoming transactions paying to addresses with the specified label.\n&quot;</span></a>
<a name="1338"><span class="lineNum">    1338 </span>            :                 &quot;\nReturns up to 'count' most recent transactions skipping the first 'from' transactions.\n&quot;,</a>
<a name="1339"><span class="lineNum">    1339 </span><span class="lineCov">       1994 :                 {</span></a>
<a name="1340"><span class="lineNum">    1340 </span><span class="lineCov">        398 :                     {&quot;label|dummy&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;If set, should be a valid label name to return only incoming transactions\n&quot;</span></a>
<a name="1341"><span class="lineNum">    1341 </span>            :                           &quot;with the specified label, or \&quot;*\&quot; to disable filtering and return all transactions.&quot;},</a>
<a name="1342"><span class="lineNum">    1342 </span><span class="lineCov">        398 :                     {&quot;count&quot;, RPCArg::Type::NUM, /* default */ &quot;10&quot;, &quot;The number of transactions to return&quot;},</span></a>
<a name="1343"><span class="lineNum">    1343 </span><span class="lineCov">        398 :                     {&quot;skip&quot;, RPCArg::Type::NUM, /* default */ &quot;0&quot;, &quot;The number of transactions to skip&quot;},</span></a>
<a name="1344"><span class="lineNum">    1344 </span><span class="lineCov">        398 :                     {&quot;include_watchonly&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Include transactions to watch-only addresses (see 'importaddress')&quot;},</span></a>
<a name="1345"><span class="lineNum">    1345 </span>            :                 },</a>
<a name="1346"><span class="lineNum">    1346 </span><span class="lineCov">        398 :                 RPCResult{</span></a>
<a name="1347"><span class="lineNum">    1347 </span><span class="lineCov">        398 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1348"><span class="lineNum">    1348 </span><span class="lineCov">        796 :                     {</span></a>
<a name="1349"><span class="lineNum">    1349 </span><span class="lineCov">       1194 :                         {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;, Cat(Cat&lt;std::vector&lt;RPCResult&gt;&gt;(</span></a>
<a name="1350"><span class="lineNum">    1350 </span><span class="lineCov">       3188 :                         {</span></a>
<a name="1351"><span class="lineNum">    1351 </span><span class="lineCov">        398 :                             {RPCResult::Type::BOOL, &quot;involvesWatchonly&quot;, &quot;Only returns true if imported addresses were involved in transaction.&quot;},</span></a>
<a name="1352"><span class="lineNum">    1352 </span><span class="lineCov">        398 :                             {RPCResult::Type::STR, &quot;address&quot;, &quot;The bitcoin address of the transaction.&quot;},</span></a>
<a name="1353"><span class="lineNum">    1353 </span><span class="lineCov">        398 :                             {RPCResult::Type::STR, &quot;category&quot;, &quot;The transaction category.\n&quot;</span></a>
<a name="1354"><span class="lineNum">    1354 </span>            :                                 &quot;\&quot;send\&quot;                  Transactions sent.\n&quot;</a>
<a name="1355"><span class="lineNum">    1355 </span>            :                                 &quot;\&quot;receive\&quot;               Non-coinbase transactions received.\n&quot;</a>
<a name="1356"><span class="lineNum">    1356 </span>            :                                 &quot;\&quot;generate\&quot;              Coinbase transactions received with more than 100 confirmations.\n&quot;</a>
<a name="1357"><span class="lineNum">    1357 </span>            :                                 &quot;\&quot;immature\&quot;              Coinbase transactions received with 100 or fewer confirmations.\n&quot;</a>
<a name="1358"><span class="lineNum">    1358 </span>            :                                 &quot;\&quot;orphan\&quot;                Orphaned coinbase transactions received.&quot;},</a>
<a name="1359"><span class="lineNum">    1359 </span><span class="lineCov">        398 :                             {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The amount in &quot; + CURRENCY_UNIT + &quot;. This is negative for the 'send' category, and is positive\n&quot;</span></a>
<a name="1360"><span class="lineNum">    1360 </span>            :                                 &quot;for all other categories&quot;},</a>
<a name="1361"><span class="lineNum">    1361 </span><span class="lineCov">        398 :                             {RPCResult::Type::STR, &quot;label&quot;, &quot;A comment for the address/transaction, if any&quot;},</span></a>
<a name="1362"><span class="lineNum">    1362 </span><span class="lineCov">        398 :                             {RPCResult::Type::NUM, &quot;vout&quot;, &quot;the vout value&quot;},</span></a>
<a name="1363"><span class="lineNum">    1363 </span><span class="lineCov">        398 :                             {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;The amount of the fee in &quot; + CURRENCY_UNIT + &quot;. This is negative and only available for the\n&quot;</span></a>
<a name="1364"><span class="lineNum">    1364 </span>            :                                  &quot;'send' category of transactions.&quot;},</a>
<a name="1365"><span class="lineNum">    1365 </span>            :                         },</a>
<a name="1366"><span class="lineNum">    1366 </span><span class="lineCov">        398 :                         TransactionDescriptionString()),</span></a>
<a name="1367"><span class="lineNum">    1367 </span><span class="lineCov">        796 :                         {</span></a>
<a name="1368"><span class="lineNum">    1368 </span><span class="lineCov">        398 :                             {RPCResult::Type::BOOL, &quot;abandoned&quot;, &quot;'true' if the transaction has been abandoned (inputs are respendable). Only available for the \n&quot;</span></a>
<a name="1369"><span class="lineNum">    1369 </span>            :                                  &quot;'send' category of transactions.&quot;},</a>
<a name="1370"><span class="lineNum">    1370 </span>            :                         })},</a>
<a name="1371"><span class="lineNum">    1371 </span>            :                     }</a>
<a name="1372"><span class="lineNum">    1372 </span>            :                 },</a>
<a name="1373"><span class="lineNum">    1373 </span><span class="lineCov">        398 :                 RPCExamples{</span></a>
<a name="1374"><span class="lineNum">    1374 </span><span class="lineCov">        398 :             &quot;\nList the most recent 10 transactions in the systems\n&quot;</span></a>
<a name="1375"><span class="lineNum">    1375 </span><span class="lineCov">        398 :             + HelpExampleCli(&quot;listtransactions&quot;, &quot;&quot;) +</span></a>
<a name="1376"><span class="lineNum">    1376 </span>            :             &quot;\nList transactions 100 to 120\n&quot;</a>
<a name="1377"><span class="lineNum">    1377 </span><span class="lineCov">        398 :             + HelpExampleCli(&quot;listtransactions&quot;, &quot;\&quot;*\&quot; 20 100&quot;) +</span></a>
<a name="1378"><span class="lineNum">    1378 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="1379"><span class="lineNum">    1379 </span><span class="lineCov">        398 :             + HelpExampleRpc(&quot;listtransactions&quot;, &quot;\&quot;*\&quot;, 20, 100&quot;)</span></a>
<a name="1380"><span class="lineNum">    1380 </span>            :                 },</a>
<a name="1381"><span class="lineNum">    1381 </span><span class="lineCov">        398 :             }.Check(request);</span></a>
<a name="1382"><span class="lineNum">    1382 </span>            : </a>
<a name="1383"><span class="lineNum">    1383 </span><span class="lineCov">        394 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1384"><span class="lineNum">    1384 </span><span class="lineCov">        394 :     if (!wallet) return NullUniValue;</span></a>
<a name="1385"><span class="lineNum">    1385 </span><span class="lineCov">        394 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="1386"><span class="lineNum">    1386 </span>            : </a>
<a name="1387"><span class="lineNum">    1387 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1388"><span class="lineNum">    1388 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1389"><span class="lineNum">    1389 </span><span class="lineCov">        394 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="1390"><span class="lineNum">    1390 </span>            : </a>
<a name="1391"><span class="lineNum">    1391 </span>            :     const std::string* filter_label = nullptr;</a>
<a name="1392"><span class="lineNum">    1392 </span><span class="lineCov">        394 :     if (!request.params[0].isNull() &amp;&amp; request.params[0].get_str() != &quot;*&quot;) {</span></a>
<a name="1393"><span class="lineNum">    1393 </span><span class="lineCov">        330 :         filter_label = &amp;request.params[0].get_str();</span></a>
<a name="1394"><span class="lineNum">    1394 </span><span class="lineCov">        330 :         if (filter_label-&gt;empty()) {</span></a>
<a name="1395"><span class="lineNum">    1395 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Label argument must be a valid label name or \&quot;*\&quot;.&quot;);</span></a>
<a name="1396"><span class="lineNum">    1396 </span>            :         }</a>
<a name="1397"><span class="lineNum">    1397 </span>            :     }</a>
<a name="1398"><span class="lineNum">    1398 </span>            :     int nCount = 10;</a>
<a name="1399"><span class="lineNum">    1399 </span><span class="lineCov">        394 :     if (!request.params[1].isNull())</span></a>
<a name="1400"><span class="lineNum">    1400 </span><span class="lineCov">        340 :         nCount = request.params[1].get_int();</span></a>
<a name="1401"><span class="lineNum">    1401 </span>            :     int nFrom = 0;</a>
<a name="1402"><span class="lineNum">    1402 </span><span class="lineCov">        394 :     if (!request.params[2].isNull())</span></a>
<a name="1403"><span class="lineNum">    1403 </span><span class="lineCov">          8 :         nFrom = request.params[2].get_int();</span></a>
<a name="1404"><span class="lineNum">    1404 </span><span class="lineCov">        394 :     isminefilter filter = ISMINE_SPENDABLE;</span></a>
<a name="1405"><span class="lineNum">    1405 </span>            : </a>
<a name="1406"><span class="lineNum">    1406 </span><span class="lineCov">        394 :     if (ParseIncludeWatchonly(request.params[3], *pwallet)) {</span></a>
<a name="1407"><span class="lineNum">    1407 </span><span class="lineCov">        339 :         filter |= ISMINE_WATCH_ONLY;</span></a>
<a name="1408"><span class="lineNum">    1408 </span><span class="lineCov">        339 :     }</span></a>
<a name="1409"><span class="lineNum">    1409 </span>            : </a>
<a name="1410"><span class="lineNum">    1410 </span><span class="lineCov">        394 :     if (nCount &lt; 0)</span></a>
<a name="1411"><span class="lineNum">    1411 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Negative count&quot;);</span></a>
<a name="1412"><span class="lineNum">    1412 </span><span class="lineCov">        394 :     if (nFrom &lt; 0)</span></a>
<a name="1413"><span class="lineNum">    1413 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Negative from&quot;);</span></a>
<a name="1414"><span class="lineNum">    1414 </span>            : </a>
<a name="1415"><span class="lineNum">    1415 </span><span class="lineCov">        394 :     UniValue ret(UniValue::VARR);</span></a>
<a name="1416"><span class="lineNum">    1416 </span>            : </a>
<a name="1417"><span class="lineNum">    1417 </span>            :     {</a>
<a name="1418"><span class="lineNum">    1418 </span><span class="lineCov">        394 :         LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1419"><span class="lineNum">    1419 </span>            : </a>
<a name="1420"><span class="lineNum">    1420 </span><span class="lineCov">        394 :         const CWallet::TxItems &amp; txOrdered = pwallet-&gt;wtxOrdered;</span></a>
<a name="1421"><span class="lineNum">    1421 </span>            : </a>
<a name="1422"><span class="lineNum">    1422 </span>            :         // iterate backwards until we have nCount items to return:</a>
<a name="1423"><span class="lineNum">    1423 </span><span class="lineCov">      19076 :         for (CWallet::TxItems::const_reverse_iterator it = txOrdered.rbegin(); it != txOrdered.rend(); ++it)</span></a>
<a name="1424"><span class="lineNum">    1424 </span>            :         {</a>
<a name="1425"><span class="lineNum">    1425 </span><span class="lineCov">      18682 :             CWalletTx *const pwtx = (*it).second;</span></a>
<a name="1426"><span class="lineNum">    1426 </span><span class="lineCov">      18682 :             ListTransactions(pwallet, *pwtx, 0, true, ret, filter, filter_label);</span></a>
<a name="1427"><span class="lineNum">    1427 </span><span class="lineCov">      18682 :             if ((int)ret.size() &gt;= (nCount+nFrom)) break;</span></a>
<a name="1428"><span class="lineNum">    1428 </span><span class="lineCov">      18640 :         }</span></a>
<a name="1429"><span class="lineNum">    1429 </span><span class="lineCov">        394 :     }</span></a>
<a name="1430"><span class="lineNum">    1430 </span>            : </a>
<a name="1431"><span class="lineNum">    1431 </span>            :     // ret is newest to oldest</a>
<a name="1432"><span class="lineNum">    1432 </span>            : </a>
<a name="1433"><span class="lineNum">    1433 </span><span class="lineCov">        394 :     if (nFrom &gt; (int)ret.size())</span></a>
<a name="1434"><span class="lineNum">    1434 </span><span class="lineNoCov">          0 :         nFrom = ret.size();</span></a>
<a name="1435"><span class="lineNum">    1435 </span><span class="lineCov">        394 :     if ((nFrom + nCount) &gt; (int)ret.size())</span></a>
<a name="1436"><span class="lineNum">    1436 </span><span class="lineCov">        352 :         nCount = ret.size() - nFrom;</span></a>
<a name="1437"><span class="lineNum">    1437 </span>            : </a>
<a name="1438"><span class="lineNum">    1438 </span><span class="lineCov">        394 :     const std::vector&lt;UniValue&gt;&amp; txs = ret.getValues();</span></a>
<a name="1439"><span class="lineNum">    1439 </span><span class="lineCov">        394 :     UniValue result{UniValue::VARR};</span></a>
<a name="1440"><span class="lineNum">    1440 </span><span class="lineCov">        394 :     result.push_backV({ txs.rend() - nFrom - nCount, txs.rend() - nFrom }); // Return oldest to newest</span></a>
<a name="1441"><span class="lineNum">    1441 </span><span class="lineCov">        394 :     return result;</span></a>
<a name="1442"><span class="lineNum">    1442 </span><span class="lineCov">        446 : }</span></a>
<a name="1443"><span class="lineNum">    1443 </span>            : </a>
<a name="1444"><span class="lineNum">    1444 </span><span class="lineCov">         31 : static UniValue listsinceblock(const JSONRPCRequest&amp; request)</span></a>
<a name="1445"><span class="lineNum">    1445 </span>            : {</a>
<a name="1446"><span class="lineNum">    1446 </span><span class="lineCov">        470 :             RPCHelpMan{&quot;listsinceblock&quot;,</span></a>
<a name="1447"><span class="lineNum">    1447 </span><span class="lineCov">         31 :                 &quot;\nGet all transactions in blocks since block [blockhash], or all transactions if omitted.\n&quot;</span></a>
<a name="1448"><span class="lineNum">    1448 </span>            :                 &quot;If \&quot;blockhash\&quot; is no longer a part of the main chain, transactions from the fork point onward are included.\n&quot;</a>
<a name="1449"><span class="lineNum">    1449 </span>            :                 &quot;Additionally, if include_removed is set, transactions affecting the wallet which were removed are returned in the \&quot;removed\&quot; array.\n&quot;,</a>
<a name="1450"><span class="lineNum">    1450 </span><span class="lineCov">        159 :                 {</span></a>
<a name="1451"><span class="lineNum">    1451 </span><span class="lineCov">         31 :                     {&quot;blockhash&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;If set, the block hash to list transactions since, otherwise list all transactions.&quot;},</span></a>
<a name="1452"><span class="lineNum">    1452 </span><span class="lineCov">         31 :                     {&quot;target_confirmations&quot;, RPCArg::Type::NUM, /* default */ &quot;1&quot;, &quot;Return the nth block hash from the main chain. e.g. 1 would mean the best block hash. Note: this is not used as a filter, but only affects [lastblock] in the return value&quot;},</span></a>
<a name="1453"><span class="lineNum">    1453 </span><span class="lineCov">         31 :                     {&quot;include_watchonly&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Include transactions to watch-only addresses (see 'importaddress')&quot;},</span></a>
<a name="1454"><span class="lineNum">    1454 </span><span class="lineCov">         31 :                     {&quot;include_removed&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Show transactions that were removed due to a reorg in the \&quot;removed\&quot; array\n&quot;</span></a>
<a name="1455"><span class="lineNum">    1455 </span>            :             &quot;                                                           (not guaranteed to work on pruned nodes)&quot;},</a>
<a name="1456"><span class="lineNum">    1456 </span>            :                 },</a>
<a name="1457"><span class="lineNum">    1457 </span><span class="lineCov">         31 :                 RPCResult{</span></a>
<a name="1458"><span class="lineNum">    1458 </span><span class="lineCov">         31 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1459"><span class="lineNum">    1459 </span><span class="lineCov">        160 :                     {</span></a>
<a name="1460"><span class="lineNum">    1460 </span><span class="lineCov">         62 :                         {RPCResult::Type::ARR, &quot;transactions&quot;, &quot;&quot;,</span></a>
<a name="1461"><span class="lineNum">    1461 </span><span class="lineCov">         62 :                         {</span></a>
<a name="1462"><span class="lineNum">    1462 </span><span class="lineCov">         93 :                             {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;, Cat(Cat&lt;std::vector&lt;RPCResult&gt;&gt;(</span></a>
<a name="1463"><span class="lineNum">    1463 </span><span class="lineCov">        221 :                             {</span></a>
<a name="1464"><span class="lineNum">    1464 </span><span class="lineCov">         31 :                                 {RPCResult::Type::BOOL, &quot;involvesWatchonly&quot;, &quot;Only returns true if imported addresses were involved in transaction.&quot;},</span></a>
<a name="1465"><span class="lineNum">    1465 </span><span class="lineCov">         31 :                                 {RPCResult::Type::STR, &quot;address&quot;, &quot;The bitcoin address of the transaction.&quot;},</span></a>
<a name="1466"><span class="lineNum">    1466 </span><span class="lineCov">         31 :                                 {RPCResult::Type::STR, &quot;category&quot;, &quot;The transaction category.\n&quot;</span></a>
<a name="1467"><span class="lineNum">    1467 </span>            :                                     &quot;\&quot;send\&quot;                  Transactions sent.\n&quot;</a>
<a name="1468"><span class="lineNum">    1468 </span>            :                                     &quot;\&quot;receive\&quot;               Non-coinbase transactions received.\n&quot;</a>
<a name="1469"><span class="lineNum">    1469 </span>            :                                     &quot;\&quot;generate\&quot;              Coinbase transactions received with more than 100 confirmations.\n&quot;</a>
<a name="1470"><span class="lineNum">    1470 </span>            :                                     &quot;\&quot;immature\&quot;              Coinbase transactions received with 100 or fewer confirmations.\n&quot;</a>
<a name="1471"><span class="lineNum">    1471 </span>            :                                     &quot;\&quot;orphan\&quot;                Orphaned coinbase transactions received.&quot;},</a>
<a name="1472"><span class="lineNum">    1472 </span><span class="lineCov">         31 :                                 {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The amount in &quot; + CURRENCY_UNIT + &quot;. This is negative for the 'send' category, and is positive\n&quot;</span></a>
<a name="1473"><span class="lineNum">    1473 </span>            :                                     &quot;for all other categories&quot;},</a>
<a name="1474"><span class="lineNum">    1474 </span><span class="lineCov">         31 :                                 {RPCResult::Type::NUM, &quot;vout&quot;, &quot;the vout value&quot;},</span></a>
<a name="1475"><span class="lineNum">    1475 </span><span class="lineCov">         31 :                                 {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;The amount of the fee in &quot; + CURRENCY_UNIT + &quot;. This is negative and only available for the\n&quot;</span></a>
<a name="1476"><span class="lineNum">    1476 </span>            :                                      &quot;'send' category of transactions.&quot;},</a>
<a name="1477"><span class="lineNum">    1477 </span>            :                             },</a>
<a name="1478"><span class="lineNum">    1478 </span><span class="lineCov">         31 :                             TransactionDescriptionString()),</span></a>
<a name="1479"><span class="lineNum">    1479 </span><span class="lineCov">        128 :                             {</span></a>
<a name="1480"><span class="lineNum">    1480 </span><span class="lineCov">         31 :                                 {RPCResult::Type::BOOL, &quot;abandoned&quot;, &quot;'true' if the transaction has been abandoned (inputs are respendable). Only available for the \n&quot;</span></a>
<a name="1481"><span class="lineNum">    1481 </span>            :                                      &quot;'send' category of transactions.&quot;},</a>
<a name="1482"><span class="lineNum">    1482 </span><span class="lineCov">         31 :                                 {RPCResult::Type::STR, &quot;label&quot;, &quot;A comment for the address/transaction, if any&quot;},</span></a>
<a name="1483"><span class="lineNum">    1483 </span><span class="lineCov">         31 :                                 {RPCResult::Type::STR, &quot;to&quot;, &quot;If a comment to is associated with the transaction.&quot;},</span></a>
<a name="1484"><span class="lineNum">    1484 </span>            :                             })},</a>
<a name="1485"><span class="lineNum">    1485 </span>            :                         }},</a>
<a name="1486"><span class="lineNum">    1486 </span><span class="lineCov">         62 :                         {RPCResult::Type::ARR, &quot;removed&quot;, &quot;&lt;structure is the same as \&quot;transactions\&quot; above, only present if include_removed=true&gt;\n&quot;</span></a>
<a name="1487"><span class="lineNum">    1487 </span>            :                             &quot;Note: transactions that were re-added in the active chain will appear as-is in this array, and may thus have a positive confirmation count.&quot;</a>
<a name="1488"><span class="lineNum">    1488 </span><span class="lineCov">         31 :                         , {{RPCResult::Type::ELISION, &quot;&quot;, &quot;&quot;},}},</span></a>
<a name="1489"><span class="lineNum">    1489 </span><span class="lineCov">         31 :                         {RPCResult::Type::STR_HEX, &quot;lastblock&quot;, &quot;The hash of the block (target_confirmations-1) from the best block on the main chain, or the genesis hash if the referenced block does not exist yet. This is typically used to feed back into listsinceblock the next time you call it. So you would generally use a target_confirmations of say 6, so you will be continually re-notified of transactions until they've reached 6 confirmations plus any new ones&quot;},</span></a>
<a name="1490"><span class="lineNum">    1490 </span>            :                     }</a>
<a name="1491"><span class="lineNum">    1491 </span>            :                 },</a>
<a name="1492"><span class="lineNum">    1492 </span><span class="lineCov">         31 :                 RPCExamples{</span></a>
<a name="1493"><span class="lineNum">    1493 </span><span class="lineCov">         31 :                     HelpExampleCli(&quot;listsinceblock&quot;, &quot;&quot;)</span></a>
<a name="1494"><span class="lineNum">    1494 </span><span class="lineCov">         31 :             + HelpExampleCli(&quot;listsinceblock&quot;, &quot;\&quot;000000000000000bacf66f7497b7dc45ef753ee9a7d38571037cdb1a57f663ad\&quot; 6&quot;)</span></a>
<a name="1495"><span class="lineNum">    1495 </span><span class="lineCov">         31 :             + HelpExampleRpc(&quot;listsinceblock&quot;, &quot;\&quot;000000000000000bacf66f7497b7dc45ef753ee9a7d38571037cdb1a57f663ad\&quot;, 6&quot;)</span></a>
<a name="1496"><span class="lineNum">    1496 </span>            :                 },</a>
<a name="1497"><span class="lineNum">    1497 </span><span class="lineCov">         31 :             }.Check(request);</span></a>
<a name="1498"><span class="lineNum">    1498 </span>            : </a>
<a name="1499"><span class="lineNum">    1499 </span><span class="lineCov">         27 :     std::shared_ptr&lt;CWallet&gt; const pwallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1500"><span class="lineNum">    1500 </span><span class="lineCov">         27 :     if (!pwallet) return NullUniValue;</span></a>
<a name="1501"><span class="lineNum">    1501 </span>            : </a>
<a name="1502"><span class="lineNum">    1502 </span><span class="lineCov">         27 :     const CWallet&amp; wallet = *pwallet;</span></a>
<a name="1503"><span class="lineNum">    1503 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1504"><span class="lineNum">    1504 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1505"><span class="lineNum">    1505 </span><span class="lineCov">         27 :     wallet.BlockUntilSyncedToCurrentChain();</span></a>
<a name="1506"><span class="lineNum">    1506 </span>            : </a>
<a name="1507"><span class="lineNum">    1507 </span><span class="lineCov">         27 :     LOCK(wallet.cs_wallet);</span></a>
<a name="1508"><span class="lineNum">    1508 </span>            : </a>
<a name="1509"><span class="lineNum">    1509 </span>            :     // The way the 'height' is initialized is just a workaround for the gcc bug #47679 since version 4.6.0.</a>
<a name="1510"><span class="lineNum">    1510 </span><span class="lineCov">         27 :     Optional&lt;int&gt; height = MakeOptional(false, int()); // Height of the specified block or the common ancestor, if the block provided was in a deactivated chain.</span></a>
<a name="1511"><span class="lineNum">    1511 </span><span class="lineCov">         27 :     Optional&lt;int&gt; altheight; // Height of the specified block, even if it's in a deactivated chain.</span></a>
<a name="1512"><span class="lineNum">    1512 </span><span class="lineCov">         27 :     int target_confirms = 1;</span></a>
<a name="1513"><span class="lineNum">    1513 </span><span class="lineCov">         27 :     isminefilter filter = ISMINE_SPENDABLE;</span></a>
<a name="1514"><span class="lineNum">    1514 </span>            : </a>
<a name="1515"><span class="lineNum">    1515 </span><span class="lineCov">         27 :     uint256 blockId;</span></a>
<a name="1516"><span class="lineNum">    1516 </span><span class="lineCov">         27 :     if (!request.params[0].isNull() &amp;&amp; !request.params[0].get_str().empty()) {</span></a>
<a name="1517"><span class="lineNum">    1517 </span><span class="lineCov">         17 :         blockId = ParseHashV(request.params[0], &quot;blockhash&quot;);</span></a>
<a name="1518"><span class="lineNum">    1518 </span><span class="lineCov">         15 :         height = int{};</span></a>
<a name="1519"><span class="lineNum">    1519 </span><span class="lineCov">         15 :         altheight = int{};</span></a>
<a name="1520"><span class="lineNum">    1520 </span><span class="lineCov">         15 :         if (!wallet.chain().findCommonAncestor(blockId, wallet.GetLastBlockHash(), /* ancestor out */ FoundBlock().height(*height), /* blockId out */ FoundBlock().height(*altheight))) {</span></a>
<a name="1521"><span class="lineNum">    1521 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Block not found&quot;);</span></a>
<a name="1522"><span class="lineNum">    1522 </span>            :         }</a>
<a name="1523"><span class="lineNum">    1523 </span>            :     }</a>
<a name="1524"><span class="lineNum">    1524 </span>            : </a>
<a name="1525"><span class="lineNum">    1525 </span><span class="lineCov">         23 :     if (!request.params[1].isNull()) {</span></a>
<a name="1526"><span class="lineNum">    1526 </span><span class="lineCov">          3 :         target_confirms = request.params[1].get_int();</span></a>
<a name="1527"><span class="lineNum">    1527 </span>            : </a>
<a name="1528"><span class="lineNum">    1528 </span><span class="lineCov">          3 :         if (target_confirms &lt; 1) {</span></a>
<a name="1529"><span class="lineNum">    1529 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter&quot;);</span></a>
<a name="1530"><span class="lineNum">    1530 </span>            :         }</a>
<a name="1531"><span class="lineNum">    1531 </span>            :     }</a>
<a name="1532"><span class="lineNum">    1532 </span>            : </a>
<a name="1533"><span class="lineNum">    1533 </span><span class="lineCov">         22 :     if (ParseIncludeWatchonly(request.params[2], wallet)) {</span></a>
<a name="1534"><span class="lineNum">    1534 </span><span class="lineCov">          2 :         filter |= ISMINE_WATCH_ONLY;</span></a>
<a name="1535"><span class="lineNum">    1535 </span><span class="lineCov">          2 :     }</span></a>
<a name="1536"><span class="lineNum">    1536 </span>            : </a>
<a name="1537"><span class="lineNum">    1537 </span><span class="lineCov">         22 :     bool include_removed = (request.params[3].isNull() || request.params[3].get_bool());</span></a>
<a name="1538"><span class="lineNum">    1538 </span>            : </a>
<a name="1539"><span class="lineNum">    1539 </span><span class="lineCov">         22 :     int depth = height ? wallet.GetLastBlockHeight() + 1 - *height : -1;</span></a>
<a name="1540"><span class="lineNum">    1540 </span>            : </a>
<a name="1541"><span class="lineNum">    1541 </span><span class="lineCov">         22 :     UniValue transactions(UniValue::VARR);</span></a>
<a name="1542"><span class="lineNum">    1542 </span>            : </a>
<a name="1543"><span class="lineNum">    1543 </span><span class="lineCov">        898 :     for (const std::pair&lt;const uint256, CWalletTx&gt;&amp; pairWtx : wallet.mapWallet) {</span></a>
<a name="1544"><span class="lineNum">    1544 </span><span class="lineCov">        876 :         const CWalletTx&amp; tx = pairWtx.second;</span></a>
<a name="1545"><span class="lineNum">    1545 </span>            : </a>
<a name="1546"><span class="lineNum">    1546 </span><span class="lineCov">        876 :         if (depth == -1 || abs(tx.GetDepthInMainChain()) &lt; depth) {</span></a>
<a name="1547"><span class="lineNum">    1547 </span><span class="lineCov">        521 :             ListTransactions(&amp;wallet, tx, 0, true, transactions, filter, nullptr /* filter_label */);</span></a>
<a name="1548"><span class="lineNum">    1548 </span>            :         }</a>
<a name="1549"><span class="lineNum">    1549 </span><span class="lineNoCov">          0 :     }</span></a>
<a name="1550"><span class="lineNum">    1550 </span>            : </a>
<a name="1551"><span class="lineNum">    1551 </span>            :     // when a reorg'd block is requested, we also list any relevant transactions</a>
<a name="1552"><span class="lineNum">    1552 </span>            :     // in the blocks of the chain that was detached</a>
<a name="1553"><span class="lineNum">    1553 </span><span class="lineCov">         22 :     UniValue removed(UniValue::VARR);</span></a>
<a name="1554"><span class="lineNum">    1554 </span><span class="lineCov">         34 :     while (include_removed &amp;&amp; altheight &amp;&amp; *altheight &gt; *height) {</span></a>
<a name="1555"><span class="lineNum">    1555 </span><span class="lineCov">         12 :         CBlock block;</span></a>
<a name="1556"><span class="lineNum">    1556 </span><span class="lineCov">         12 :         if (!wallet.chain().findBlock(blockId, FoundBlock().data(block)) || block.IsNull()) {</span></a>
<a name="1557"><span class="lineNum">    1557 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INTERNAL_ERROR, &quot;Can't read block from disk&quot;);</span></a>
<a name="1558"><span class="lineNum">    1558 </span>            :         }</a>
<a name="1559"><span class="lineNum">    1559 </span><span class="lineCov">         26 :         for (const CTransactionRef&amp; tx : block.vtx) {</span></a>
<a name="1560"><span class="lineNum">    1560 </span><span class="lineCov">         14 :             auto it = wallet.mapWallet.find(tx-&gt;GetHash());</span></a>
<a name="1561"><span class="lineNum">    1561 </span><span class="lineCov">         14 :             if (it != wallet.mapWallet.end()) {</span></a>
<a name="1562"><span class="lineNum">    1562 </span>            :                 // We want all transactions regardless of confirmation count to appear here,</a>
<a name="1563"><span class="lineNum">    1563 </span>            :                 // even negative confirmation ones, hence the big negative.</a>
<a name="1564"><span class="lineNum">    1564 </span><span class="lineCov">          2 :                 ListTransactions(&amp;wallet, it-&gt;second, -100000000, true, removed, filter, nullptr /* filter_label */);</span></a>
<a name="1565"><span class="lineNum">    1565 </span>            :             }</a>
<a name="1566"><span class="lineNum">    1566 </span><span class="lineCov">         14 :         }</span></a>
<a name="1567"><span class="lineNum">    1567 </span><span class="lineCov">         12 :         blockId = block.hashPrevBlock;</span></a>
<a name="1568"><span class="lineNum">    1568 </span><span class="lineCov">         12 :         --*altheight;</span></a>
<a name="1569"><span class="lineNum">    1569 </span><span class="lineCov">         12 :     }</span></a>
<a name="1570"><span class="lineNum">    1570 </span>            : </a>
<a name="1571"><span class="lineNum">    1571 </span><span class="lineCov">         22 :     uint256 lastblock;</span></a>
<a name="1572"><span class="lineNum">    1572 </span><span class="lineCov">         22 :     target_confirms = std::min(target_confirms, wallet.GetLastBlockHeight() + 1);</span></a>
<a name="1573"><span class="lineNum">    1573 </span><span class="lineCov">         22 :     CHECK_NONFATAL(wallet.chain().findAncestorByHeight(wallet.GetLastBlockHash(), wallet.GetLastBlockHeight() + 1 - target_confirms, FoundBlock().hash(lastblock)));</span></a>
<a name="1574"><span class="lineNum">    1574 </span>            : </a>
<a name="1575"><span class="lineNum">    1575 </span><span class="lineCov">         22 :     UniValue ret(UniValue::VOBJ);</span></a>
<a name="1576"><span class="lineNum">    1576 </span><span class="lineCov">         22 :     ret.pushKV(&quot;transactions&quot;, transactions);</span></a>
<a name="1577"><span class="lineNum">    1577 </span><span class="lineCov">         22 :     if (include_removed) ret.pushKV(&quot;removed&quot;, removed);</span></a>
<a name="1578"><span class="lineNum">    1578 </span><span class="lineCov">         22 :     ret.pushKV(&quot;lastblock&quot;, lastblock.GetHex());</span></a>
<a name="1579"><span class="lineNum">    1579 </span>            : </a>
<a name="1580"><span class="lineNum">    1580 </span><span class="lineCov">         22 :     return ret;</span></a>
<a name="1581"><span class="lineNum">    1581 </span><span class="lineCov">         95 : }</span></a>
<a name="1582"><span class="lineNum">    1582 </span>            : </a>
<a name="1583"><span class="lineNum">    1583 </span><span class="lineCov">        244 : static UniValue gettransaction(const JSONRPCRequest&amp; request)</span></a>
<a name="1584"><span class="lineNum">    1584 </span>            : {</a>
<a name="1585"><span class="lineNum">    1585 </span><span class="lineCov">       3663 :             RPCHelpMan{&quot;gettransaction&quot;,</span></a>
<a name="1586"><span class="lineNum">    1586 </span><span class="lineCov">        244 :                 &quot;\nGet detailed information about in-wallet transaction &lt;txid&gt;\n&quot;,</span></a>
<a name="1587"><span class="lineNum">    1587 </span><span class="lineCov">        980 :                 {</span></a>
<a name="1588"><span class="lineNum">    1588 </span><span class="lineCov">        244 :                     {&quot;txid&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The transaction id&quot;},</span></a>
<a name="1589"><span class="lineNum">    1589 </span><span class="lineCov">        488 :                     {&quot;include_watchonly&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;,</span></a>
<a name="1590"><span class="lineNum">    1590 </span><span class="lineCov">        244 :                             &quot;Whether to include watch-only addresses in balance calculation and details[]&quot;},</span></a>
<a name="1591"><span class="lineNum">    1591 </span><span class="lineCov">        488 :                     {&quot;verbose&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;,</span></a>
<a name="1592"><span class="lineNum">    1592 </span><span class="lineCov">        244 :                             &quot;Whether to include a `decoded` field containing the decoded transaction (equivalent to RPC decoderawtransaction)&quot;},</span></a>
<a name="1593"><span class="lineNum">    1593 </span>            :                 },</a>
<a name="1594"><span class="lineNum">    1594 </span><span class="lineCov">        244 :                 RPCResult{</span></a>
<a name="1595"><span class="lineNum">    1595 </span><span class="lineCov">        732 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;, Cat(Cat&lt;std::vector&lt;RPCResult&gt;&gt;(</span></a>
<a name="1596"><span class="lineNum">    1596 </span><span class="lineCov">        736 :                     {</span></a>
<a name="1597"><span class="lineNum">    1597 </span><span class="lineCov">        244 :                         {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The amount in &quot; + CURRENCY_UNIT},</span></a>
<a name="1598"><span class="lineNum">    1598 </span><span class="lineCov">        244 :                         {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;The amount of the fee in &quot; + CURRENCY_UNIT + &quot;. This is negative and only available for the\n&quot;</span></a>
<a name="1599"><span class="lineNum">    1599 </span>            :                                      &quot;'send' category of transactions.&quot;},</a>
<a name="1600"><span class="lineNum">    1600 </span>            :                     },</a>
<a name="1601"><span class="lineNum">    1601 </span><span class="lineCov">        244 :                     TransactionDescriptionString()),</span></a>
<a name="1602"><span class="lineNum">    1602 </span><span class="lineCov">        996 :                     {</span></a>
<a name="1603"><span class="lineNum">    1603 </span><span class="lineCov">        488 :                         {RPCResult::Type::ARR, &quot;details&quot;, &quot;&quot;,</span></a>
<a name="1604"><span class="lineNum">    1604 </span><span class="lineCov">        488 :                         {</span></a>
<a name="1605"><span class="lineNum">    1605 </span><span class="lineCov">        488 :                             {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="1606"><span class="lineNum">    1606 </span><span class="lineCov">       2200 :                             {</span></a>
<a name="1607"><span class="lineNum">    1607 </span><span class="lineCov">        244 :                                 {RPCResult::Type::BOOL, &quot;involvesWatchonly&quot;, &quot;Only returns true if imported addresses were involved in transaction.&quot;},</span></a>
<a name="1608"><span class="lineNum">    1608 </span><span class="lineCov">        244 :                                 {RPCResult::Type::STR, &quot;address&quot;, &quot;The bitcoin address involved in the transaction.&quot;},</span></a>
<a name="1609"><span class="lineNum">    1609 </span><span class="lineCov">        244 :                                 {RPCResult::Type::STR, &quot;category&quot;, &quot;The transaction category.\n&quot;</span></a>
<a name="1610"><span class="lineNum">    1610 </span>            :                                     &quot;\&quot;send\&quot;                  Transactions sent.\n&quot;</a>
<a name="1611"><span class="lineNum">    1611 </span>            :                                     &quot;\&quot;receive\&quot;               Non-coinbase transactions received.\n&quot;</a>
<a name="1612"><span class="lineNum">    1612 </span>            :                                     &quot;\&quot;generate\&quot;              Coinbase transactions received with more than 100 confirmations.\n&quot;</a>
<a name="1613"><span class="lineNum">    1613 </span>            :                                     &quot;\&quot;immature\&quot;              Coinbase transactions received with 100 or fewer confirmations.\n&quot;</a>
<a name="1614"><span class="lineNum">    1614 </span>            :                                     &quot;\&quot;orphan\&quot;                Orphaned coinbase transactions received.&quot;},</a>
<a name="1615"><span class="lineNum">    1615 </span><span class="lineCov">        244 :                                 {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;The amount in &quot; + CURRENCY_UNIT},</span></a>
<a name="1616"><span class="lineNum">    1616 </span><span class="lineCov">        244 :                                 {RPCResult::Type::STR, &quot;label&quot;, &quot;A comment for the address/transaction, if any&quot;},</span></a>
<a name="1617"><span class="lineNum">    1617 </span><span class="lineCov">        244 :                                 {RPCResult::Type::NUM, &quot;vout&quot;, &quot;the vout value&quot;},</span></a>
<a name="1618"><span class="lineNum">    1618 </span><span class="lineCov">        244 :                                 {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;The amount of the fee in &quot; + CURRENCY_UNIT + &quot;. This is negative and only available for the \n&quot;</span></a>
<a name="1619"><span class="lineNum">    1619 </span>            :                                     &quot;'send' category of transactions.&quot;},</a>
<a name="1620"><span class="lineNum">    1620 </span><span class="lineCov">        244 :                                 {RPCResult::Type::BOOL, &quot;abandoned&quot;, &quot;'true' if the transaction has been abandoned (inputs are respendable). Only available for the \n&quot;</span></a>
<a name="1621"><span class="lineNum">    1621 </span>            :                                      &quot;'send' category of transactions.&quot;},</a>
<a name="1622"><span class="lineNum">    1622 </span>            :                             }},</a>
<a name="1623"><span class="lineNum">    1623 </span>            :                         }},</a>
<a name="1624"><span class="lineNum">    1624 </span><span class="lineCov">        244 :                         {RPCResult::Type::STR_HEX, &quot;hex&quot;, &quot;Raw data for transaction&quot;},</span></a>
<a name="1625"><span class="lineNum">    1625 </span><span class="lineCov">        488 :                         {RPCResult::Type::OBJ, &quot;decoded&quot;, &quot;Optional, the decoded transaction (only present when `verbose` is passed)&quot;,</span></a>
<a name="1626"><span class="lineNum">    1626 </span><span class="lineCov">        488 :                         {</span></a>
<a name="1627"><span class="lineNum">    1627 </span><span class="lineCov">        244 :                             {RPCResult::Type::ELISION, &quot;&quot;, &quot;Equivalent to the RPC decoderawtransaction method, or the RPC getrawtransaction method when `verbose` is passed.&quot;},</span></a>
<a name="1628"><span class="lineNum">    1628 </span>            :                         }},</a>
<a name="1629"><span class="lineNum">    1629 </span>            :                     })</a>
<a name="1630"><span class="lineNum">    1630 </span>            :                 },</a>
<a name="1631"><span class="lineNum">    1631 </span><span class="lineCov">        244 :                 RPCExamples{</span></a>
<a name="1632"><span class="lineNum">    1632 </span><span class="lineCov">        244 :                     HelpExampleCli(&quot;gettransaction&quot;, &quot;\&quot;1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d\&quot;&quot;)</span></a>
<a name="1633"><span class="lineNum">    1633 </span><span class="lineCov">        244 :             + HelpExampleCli(&quot;gettransaction&quot;, &quot;\&quot;1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d\&quot; true&quot;)</span></a>
<a name="1634"><span class="lineNum">    1634 </span><span class="lineCov">        244 :             + HelpExampleCli(&quot;gettransaction&quot;, &quot;\&quot;1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d\&quot; false true&quot;)</span></a>
<a name="1635"><span class="lineNum">    1635 </span><span class="lineCov">        244 :             + HelpExampleRpc(&quot;gettransaction&quot;, &quot;\&quot;1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d\&quot;&quot;)</span></a>
<a name="1636"><span class="lineNum">    1636 </span>            :                 },</a>
<a name="1637"><span class="lineNum">    1637 </span><span class="lineCov">        244 :             }.Check(request);</span></a>
<a name="1638"><span class="lineNum">    1638 </span>            : </a>
<a name="1639"><span class="lineNum">    1639 </span><span class="lineCov">        240 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1640"><span class="lineNum">    1640 </span><span class="lineCov">        240 :     if (!wallet) return NullUniValue;</span></a>
<a name="1641"><span class="lineNum">    1641 </span><span class="lineCov">        240 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="1642"><span class="lineNum">    1642 </span>            : </a>
<a name="1643"><span class="lineNum">    1643 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1644"><span class="lineNum">    1644 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1645"><span class="lineNum">    1645 </span><span class="lineCov">        240 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="1646"><span class="lineNum">    1646 </span>            : </a>
<a name="1647"><span class="lineNum">    1647 </span><span class="lineCov">        240 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1648"><span class="lineNum">    1648 </span>            : </a>
<a name="1649"><span class="lineNum">    1649 </span><span class="lineCov">        240 :     uint256 hash(ParseHashV(request.params[0], &quot;txid&quot;));</span></a>
<a name="1650"><span class="lineNum">    1650 </span>            : </a>
<a name="1651"><span class="lineNum">    1651 </span><span class="lineCov">        240 :     isminefilter filter = ISMINE_SPENDABLE;</span></a>
<a name="1652"><span class="lineNum">    1652 </span>            : </a>
<a name="1653"><span class="lineNum">    1653 </span><span class="lineCov">        240 :     if (ParseIncludeWatchonly(request.params[1], *pwallet)) {</span></a>
<a name="1654"><span class="lineNum">    1654 </span><span class="lineCov">          9 :         filter |= ISMINE_WATCH_ONLY;</span></a>
<a name="1655"><span class="lineNum">    1655 </span><span class="lineCov">          9 :     }</span></a>
<a name="1656"><span class="lineNum">    1656 </span>            : </a>
<a name="1657"><span class="lineNum">    1657 </span><span class="lineCov">        240 :     bool verbose = request.params[2].isNull() ? false : request.params[2].get_bool();</span></a>
<a name="1658"><span class="lineNum">    1658 </span>            : </a>
<a name="1659"><span class="lineNum">    1659 </span><span class="lineCov">        240 :     UniValue entry(UniValue::VOBJ);</span></a>
<a name="1660"><span class="lineNum">    1660 </span><span class="lineCov">        240 :     auto it = pwallet-&gt;mapWallet.find(hash);</span></a>
<a name="1661"><span class="lineNum">    1661 </span><span class="lineCov">        240 :     if (it == pwallet-&gt;mapWallet.end()) {</span></a>
<a name="1662"><span class="lineNum">    1662 </span><span class="lineCov">          3 :         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Invalid or non-wallet transaction id&quot;);</span></a>
<a name="1663"><span class="lineNum">    1663 </span>            :     }</a>
<a name="1664"><span class="lineNum">    1664 </span><span class="lineCov">        237 :     const CWalletTx&amp; wtx = it-&gt;second;</span></a>
<a name="1665"><span class="lineNum">    1665 </span>            : </a>
<a name="1666"><span class="lineNum">    1666 </span><span class="lineCov">        237 :     CAmount nCredit = wtx.GetCredit(filter);</span></a>
<a name="1667"><span class="lineNum">    1667 </span><span class="lineCov">        237 :     CAmount nDebit = wtx.GetDebit(filter);</span></a>
<a name="1668"><span class="lineNum">    1668 </span><span class="lineCov">        237 :     CAmount nNet = nCredit - nDebit;</span></a>
<a name="1669"><span class="lineNum">    1669 </span><span class="lineCov">        237 :     CAmount nFee = (wtx.IsFromMe(filter) ? wtx.tx-&gt;GetValueOut() - nDebit : 0);</span></a>
<a name="1670"><span class="lineNum">    1670 </span>            : </a>
<a name="1671"><span class="lineNum">    1671 </span><span class="lineCov">        237 :     entry.pushKV(&quot;amount&quot;, ValueFromAmount(nNet - nFee));</span></a>
<a name="1672"><span class="lineNum">    1672 </span><span class="lineCov">        237 :     if (wtx.IsFromMe(filter))</span></a>
<a name="1673"><span class="lineNum">    1673 </span><span class="lineCov">        207 :         entry.pushKV(&quot;fee&quot;, ValueFromAmount(nFee));</span></a>
<a name="1674"><span class="lineNum">    1674 </span>            : </a>
<a name="1675"><span class="lineNum">    1675 </span><span class="lineCov">        237 :     WalletTxToJSON(pwallet-&gt;chain(), wtx, entry);</span></a>
<a name="1676"><span class="lineNum">    1676 </span>            : </a>
<a name="1677"><span class="lineNum">    1677 </span><span class="lineCov">        237 :     UniValue details(UniValue::VARR);</span></a>
<a name="1678"><span class="lineNum">    1678 </span><span class="lineCov">        237 :     ListTransactions(pwallet, wtx, 0, false, details, filter, nullptr /* filter_label */);</span></a>
<a name="1679"><span class="lineNum">    1679 </span><span class="lineCov">        237 :     entry.pushKV(&quot;details&quot;, details);</span></a>
<a name="1680"><span class="lineNum">    1680 </span>            : </a>
<a name="1681"><span class="lineNum">    1681 </span><span class="lineCov">        237 :     std::string strHex = EncodeHexTx(*wtx.tx, pwallet-&gt;chain().rpcSerializationFlags());</span></a>
<a name="1682"><span class="lineNum">    1682 </span><span class="lineCov">        237 :     entry.pushKV(&quot;hex&quot;, strHex);</span></a>
<a name="1683"><span class="lineNum">    1683 </span>            : </a>
<a name="1684"><span class="lineNum">    1684 </span><span class="lineCov">        237 :     if (verbose) {</span></a>
<a name="1685"><span class="lineNum">    1685 </span><span class="lineCov">          3 :         UniValue decoded(UniValue::VOBJ);</span></a>
<a name="1686"><span class="lineNum">    1686 </span><span class="lineCov">          3 :         TxToUniv(*wtx.tx, uint256(), decoded, false);</span></a>
<a name="1687"><span class="lineNum">    1687 </span><span class="lineCov">          3 :         entry.pushKV(&quot;decoded&quot;, decoded);</span></a>
<a name="1688"><span class="lineNum">    1688 </span><span class="lineCov">          3 :     }</span></a>
<a name="1689"><span class="lineNum">    1689 </span>            : </a>
<a name="1690"><span class="lineNum">    1690 </span><span class="lineCov">        237 :     return entry;</span></a>
<a name="1691"><span class="lineNum">    1691 </span><span class="lineCov">        304 : }</span></a>
<a name="1692"><span class="lineNum">    1692 </span>            : </a>
<a name="1693"><span class="lineNum">    1693 </span><span class="lineCov">         12 : static UniValue abandontransaction(const JSONRPCRequest&amp; request)</span></a>
<a name="1694"><span class="lineNum">    1694 </span>            : {</a>
<a name="1695"><span class="lineNum">    1695 </span><span class="lineCov">         39 :             RPCHelpMan{&quot;abandontransaction&quot;,</span></a>
<a name="1696"><span class="lineNum">    1696 </span><span class="lineCov">         12 :                 &quot;\nMark in-wallet transaction &lt;txid&gt; as abandoned\n&quot;</span></a>
<a name="1697"><span class="lineNum">    1697 </span>            :                 &quot;This will mark this transaction and all its in-wallet descendants as abandoned which will allow\n&quot;</a>
<a name="1698"><span class="lineNum">    1698 </span>            :                 &quot;for their inputs to be respent.  It can be used to replace \&quot;stuck\&quot; or evicted transactions.\n&quot;</a>
<a name="1699"><span class="lineNum">    1699 </span>            :                 &quot;It only works on transactions which are not included in a block and are not currently in the mempool.\n&quot;</a>
<a name="1700"><span class="lineNum">    1700 </span>            :                 &quot;It has no effect on transactions which are already abandoned.\n&quot;,</a>
<a name="1701"><span class="lineNum">    1701 </span><span class="lineCov">         24 :                 {</span></a>
<a name="1702"><span class="lineNum">    1702 </span><span class="lineCov">         12 :                     {&quot;txid&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The transaction id&quot;},</span></a>
<a name="1703"><span class="lineNum">    1703 </span>            :                 },</a>
<a name="1704"><span class="lineNum">    1704 </span><span class="lineCov">         12 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="1705"><span class="lineNum">    1705 </span><span class="lineCov">         12 :                 RPCExamples{</span></a>
<a name="1706"><span class="lineNum">    1706 </span><span class="lineCov">         12 :                     HelpExampleCli(&quot;abandontransaction&quot;, &quot;\&quot;1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d\&quot;&quot;)</span></a>
<a name="1707"><span class="lineNum">    1707 </span><span class="lineCov">         12 :             + HelpExampleRpc(&quot;abandontransaction&quot;, &quot;\&quot;1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d\&quot;&quot;)</span></a>
<a name="1708"><span class="lineNum">    1708 </span>            :                 },</a>
<a name="1709"><span class="lineNum">    1709 </span><span class="lineCov">         12 :             }.Check(request);</span></a>
<a name="1710"><span class="lineNum">    1710 </span>            : </a>
<a name="1711"><span class="lineNum">    1711 </span><span class="lineCov">          8 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1712"><span class="lineNum">    1712 </span><span class="lineCov">          8 :     if (!wallet) return NullUniValue;</span></a>
<a name="1713"><span class="lineNum">    1713 </span><span class="lineCov">          8 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="1714"><span class="lineNum">    1714 </span>            : </a>
<a name="1715"><span class="lineNum">    1715 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1716"><span class="lineNum">    1716 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1717"><span class="lineNum">    1717 </span><span class="lineCov">          8 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="1718"><span class="lineNum">    1718 </span>            : </a>
<a name="1719"><span class="lineNum">    1719 </span><span class="lineCov">          8 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1720"><span class="lineNum">    1720 </span>            : </a>
<a name="1721"><span class="lineNum">    1721 </span><span class="lineCov">          8 :     uint256 hash(ParseHashV(request.params[0], &quot;txid&quot;));</span></a>
<a name="1722"><span class="lineNum">    1722 </span>            : </a>
<a name="1723"><span class="lineNum">    1723 </span><span class="lineCov">          8 :     if (!pwallet-&gt;mapWallet.count(hash)) {</span></a>
<a name="1724"><span class="lineNum">    1724 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Invalid or non-wallet transaction id&quot;);</span></a>
<a name="1725"><span class="lineNum">    1725 </span>            :     }</a>
<a name="1726"><span class="lineNum">    1726 </span><span class="lineCov">          7 :     if (!pwallet-&gt;AbandonTransaction(hash)) {</span></a>
<a name="1727"><span class="lineNum">    1727 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Transaction not eligible for abandonment&quot;);</span></a>
<a name="1728"><span class="lineNum">    1728 </span>            :     }</a>
<a name="1729"><span class="lineNum">    1729 </span>            : </a>
<a name="1730"><span class="lineNum">    1730 </span><span class="lineCov">          5 :     return NullUniValue;</span></a>
<a name="1731"><span class="lineNum">    1731 </span><span class="lineCov">         24 : }</span></a>
<a name="1732"><span class="lineNum">    1732 </span>            : </a>
<a name="1733"><span class="lineNum">    1733 </span>            : </a>
<a name="1734"><span class="lineNum">    1734 </span><span class="lineCov">         32 : static UniValue backupwallet(const JSONRPCRequest&amp; request)</span></a>
<a name="1735"><span class="lineNum">    1735 </span>            : {</a>
<a name="1736"><span class="lineNum">    1736 </span><span class="lineCov">        100 :             RPCHelpMan{&quot;backupwallet&quot;,</span></a>
<a name="1737"><span class="lineNum">    1737 </span><span class="lineCov">         32 :                 &quot;\nSafely copies current wallet file to destination, which can be a directory or a path with filename.\n&quot;,</span></a>
<a name="1738"><span class="lineNum">    1738 </span><span class="lineCov">         64 :                 {</span></a>
<a name="1739"><span class="lineNum">    1739 </span><span class="lineCov">         32 :                     {&quot;destination&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The destination directory or file&quot;},</span></a>
<a name="1740"><span class="lineNum">    1740 </span>            :                 },</a>
<a name="1741"><span class="lineNum">    1741 </span><span class="lineCov">         32 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="1742"><span class="lineNum">    1742 </span><span class="lineCov">         32 :                 RPCExamples{</span></a>
<a name="1743"><span class="lineNum">    1743 </span><span class="lineCov">         32 :                     HelpExampleCli(&quot;backupwallet&quot;, &quot;\&quot;backup.dat\&quot;&quot;)</span></a>
<a name="1744"><span class="lineNum">    1744 </span><span class="lineCov">         32 :             + HelpExampleRpc(&quot;backupwallet&quot;, &quot;\&quot;backup.dat\&quot;&quot;)</span></a>
<a name="1745"><span class="lineNum">    1745 </span>            :                 },</a>
<a name="1746"><span class="lineNum">    1746 </span><span class="lineCov">         32 :             }.Check(request);</span></a>
<a name="1747"><span class="lineNum">    1747 </span>            : </a>
<a name="1748"><span class="lineNum">    1748 </span><span class="lineCov">         28 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1749"><span class="lineNum">    1749 </span><span class="lineCov">         28 :     if (!wallet) return NullUniValue;</span></a>
<a name="1750"><span class="lineNum">    1750 </span><span class="lineCov">         28 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="1751"><span class="lineNum">    1751 </span>            : </a>
<a name="1752"><span class="lineNum">    1752 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="1753"><span class="lineNum">    1753 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="1754"><span class="lineNum">    1754 </span><span class="lineCov">         28 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="1755"><span class="lineNum">    1755 </span>            : </a>
<a name="1756"><span class="lineNum">    1756 </span><span class="lineCov">         28 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1757"><span class="lineNum">    1757 </span>            : </a>
<a name="1758"><span class="lineNum">    1758 </span><span class="lineCov">         28 :     std::string strDest = request.params[0].get_str();</span></a>
<a name="1759"><span class="lineNum">    1759 </span><span class="lineCov">         28 :     if (!pwallet-&gt;BackupWallet(strDest)) {</span></a>
<a name="1760"><span class="lineNum">    1760 </span><span class="lineCov">          4 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Error: Wallet backup failed!&quot;);</span></a>
<a name="1761"><span class="lineNum">    1761 </span>            :     }</a>
<a name="1762"><span class="lineNum">    1762 </span>            : </a>
<a name="1763"><span class="lineNum">    1763 </span><span class="lineCov">         24 :     return NullUniValue;</span></a>
<a name="1764"><span class="lineNum">    1764 </span><span class="lineCov">         44 : }</span></a>
<a name="1765"><span class="lineNum">    1765 </span>            : </a>
<a name="1766"><span class="lineNum">    1766 </span>            : </a>
<a name="1767"><span class="lineNum">    1767 </span><span class="lineCov">         18 : static UniValue keypoolrefill(const JSONRPCRequest&amp; request)</span></a>
<a name="1768"><span class="lineNum">    1768 </span>            : {</a>
<a name="1769"><span class="lineNum">    1769 </span><span class="lineCov">         54 :             RPCHelpMan{&quot;keypoolrefill&quot;,</span></a>
<a name="1770"><span class="lineNum">    1770 </span><span class="lineCov">         18 :                 &quot;\nFills the keypool.&quot;+</span></a>
<a name="1771"><span class="lineNum">    1771 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="1772"><span class="lineNum">    1772 </span><span class="lineCov">         36 :                 {</span></a>
<a name="1773"><span class="lineNum">    1773 </span><span class="lineCov">         18 :                     {&quot;newsize&quot;, RPCArg::Type::NUM, /* default */ &quot;100&quot;, &quot;The new keypool size&quot;},</span></a>
<a name="1774"><span class="lineNum">    1774 </span>            :                 },</a>
<a name="1775"><span class="lineNum">    1775 </span><span class="lineCov">         18 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="1776"><span class="lineNum">    1776 </span><span class="lineCov">         18 :                 RPCExamples{</span></a>
<a name="1777"><span class="lineNum">    1777 </span><span class="lineCov">         18 :                     HelpExampleCli(&quot;keypoolrefill&quot;, &quot;&quot;)</span></a>
<a name="1778"><span class="lineNum">    1778 </span><span class="lineCov">         18 :             + HelpExampleRpc(&quot;keypoolrefill&quot;, &quot;&quot;)</span></a>
<a name="1779"><span class="lineNum">    1779 </span>            :                 },</a>
<a name="1780"><span class="lineNum">    1780 </span><span class="lineCov">         18 :             }.Check(request);</span></a>
<a name="1781"><span class="lineNum">    1781 </span>            : </a>
<a name="1782"><span class="lineNum">    1782 </span><span class="lineCov">         14 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1783"><span class="lineNum">    1783 </span><span class="lineCov">         14 :     if (!wallet) return NullUniValue;</span></a>
<a name="1784"><span class="lineNum">    1784 </span><span class="lineCov">         14 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="1785"><span class="lineNum">    1785 </span>            : </a>
<a name="1786"><span class="lineNum">    1786 </span><span class="lineCov">         14 :     if (pwallet-&gt;IsLegacy() &amp;&amp; pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></a>
<a name="1787"><span class="lineNum">    1787 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Error: Private keys are disabled for this wallet&quot;);</span></a>
<a name="1788"><span class="lineNum">    1788 </span>            :     }</a>
<a name="1789"><span class="lineNum">    1789 </span>            : </a>
<a name="1790"><span class="lineNum">    1790 </span><span class="lineCov">         14 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1791"><span class="lineNum">    1791 </span>            : </a>
<a name="1792"><span class="lineNum">    1792 </span>            :     // 0 is interpreted by TopUpKeyPool() as the default keypool size given by -keypool</a>
<a name="1793"><span class="lineNum">    1793 </span>            :     unsigned int kpSize = 0;</a>
<a name="1794"><span class="lineNum">    1794 </span><span class="lineCov">         14 :     if (!request.params[0].isNull()) {</span></a>
<a name="1795"><span class="lineNum">    1795 </span><span class="lineCov">         11 :         if (request.params[0].get_int() &lt; 0)</span></a>
<a name="1796"><span class="lineNum">    1796 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, expected valid size.&quot;);</span></a>
<a name="1797"><span class="lineNum">    1797 </span><span class="lineCov">         11 :         kpSize = (unsigned int)request.params[0].get_int();</span></a>
<a name="1798"><span class="lineNum">    1798 </span><span class="lineCov">         11 :     }</span></a>
<a name="1799"><span class="lineNum">    1799 </span>            : </a>
<a name="1800"><span class="lineNum">    1800 </span><span class="lineCov">         14 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="1801"><span class="lineNum">    1801 </span><span class="lineCov">         14 :     pwallet-&gt;TopUpKeyPool(kpSize);</span></a>
<a name="1802"><span class="lineNum">    1802 </span>            : </a>
<a name="1803"><span class="lineNum">    1803 </span><span class="lineCov">         14 :     if (pwallet-&gt;GetKeyPoolSize() &lt; kpSize) {</span></a>
<a name="1804"><span class="lineNum">    1804 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Error refreshing keypool.&quot;);</span></a>
<a name="1805"><span class="lineNum">    1805 </span>            :     }</a>
<a name="1806"><span class="lineNum">    1806 </span>            : </a>
<a name="1807"><span class="lineNum">    1807 </span><span class="lineCov">         14 :     return NullUniValue;</span></a>
<a name="1808"><span class="lineNum">    1808 </span><span class="lineCov">         30 : }</span></a>
<a name="1809"><span class="lineNum">    1809 </span>            : </a>
<a name="1810"><span class="lineNum">    1810 </span>            : </a>
<a name="1811"><span class="lineNum">    1811 </span><span class="lineCov">         57 : static UniValue walletpassphrase(const JSONRPCRequest&amp; request)</span></a>
<a name="1812"><span class="lineNum">    1812 </span>            : {</a>
<a name="1813"><span class="lineNum">    1813 </span><span class="lineCov">        242 :             RPCHelpMan{&quot;walletpassphrase&quot;,</span></a>
<a name="1814"><span class="lineNum">    1814 </span><span class="lineCov">         57 :                 &quot;\nStores the wallet decryption key in memory for 'timeout' seconds.\n&quot;</span></a>
<a name="1815"><span class="lineNum">    1815 </span>            :                 &quot;This is needed prior to performing transactions related to private keys such as sending bitcoins\n&quot;</a>
<a name="1816"><span class="lineNum">    1816 </span>            :             &quot;\nNote:\n&quot;</a>
<a name="1817"><span class="lineNum">    1817 </span>            :             &quot;Issuing the walletpassphrase command while the wallet is already unlocked will set a new unlock\n&quot;</a>
<a name="1818"><span class="lineNum">    1818 </span>            :             &quot;time that overrides the old one.\n&quot;,</a>
<a name="1819"><span class="lineNum">    1819 </span><span class="lineCov">        175 :                 {</span></a>
<a name="1820"><span class="lineNum">    1820 </span><span class="lineCov">         57 :                     {&quot;passphrase&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The wallet passphrase&quot;},</span></a>
<a name="1821"><span class="lineNum">    1821 </span><span class="lineCov">         57 :                     {&quot;timeout&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The time to keep the decryption key in seconds; capped at 100000000 (~3 years).&quot;},</span></a>
<a name="1822"><span class="lineNum">    1822 </span>            :                 },</a>
<a name="1823"><span class="lineNum">    1823 </span><span class="lineCov">         57 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="1824"><span class="lineNum">    1824 </span><span class="lineCov">         57 :                 RPCExamples{</span></a>
<a name="1825"><span class="lineNum">    1825 </span><span class="lineCov">         57 :             &quot;\nUnlock the wallet for 60 seconds\n&quot;</span></a>
<a name="1826"><span class="lineNum">    1826 </span><span class="lineCov">         57 :             + HelpExampleCli(&quot;walletpassphrase&quot;, &quot;\&quot;my pass phrase\&quot; 60&quot;) +</span></a>
<a name="1827"><span class="lineNum">    1827 </span>            :             &quot;\nLock the wallet again (before 60 seconds)\n&quot;</a>
<a name="1828"><span class="lineNum">    1828 </span><span class="lineCov">         57 :             + HelpExampleCli(&quot;walletlock&quot;, &quot;&quot;) +</span></a>
<a name="1829"><span class="lineNum">    1829 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="1830"><span class="lineNum">    1830 </span><span class="lineCov">         57 :             + HelpExampleRpc(&quot;walletpassphrase&quot;, &quot;\&quot;my pass phrase\&quot;, 60&quot;)</span></a>
<a name="1831"><span class="lineNum">    1831 </span>            :                 },</a>
<a name="1832"><span class="lineNum">    1832 </span><span class="lineCov">         57 :             }.Check(request);</span></a>
<a name="1833"><span class="lineNum">    1833 </span>            : </a>
<a name="1834"><span class="lineNum">    1834 </span><span class="lineCov">         53 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1835"><span class="lineNum">    1835 </span><span class="lineCov">         53 :     if (!wallet) return NullUniValue;</span></a>
<a name="1836"><span class="lineNum">    1836 </span><span class="lineCov">         53 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="1837"><span class="lineNum">    1837 </span>            : </a>
<a name="1838"><span class="lineNum">    1838 </span>            :     int64_t nSleepTime;</a>
<a name="1839"><span class="lineNum">    1839 </span>            :     int64_t relock_time;</a>
<a name="1840"><span class="lineNum">    1840 </span>            :     // Prevent concurrent calls to walletpassphrase with the same wallet.</a>
<a name="1841"><span class="lineNum">    1841 </span><span class="lineCov">         53 :     LOCK(pwallet-&gt;m_unlock_mutex);</span></a>
<a name="1842"><span class="lineNum">    1842 </span>            :     {</a>
<a name="1843"><span class="lineNum">    1843 </span><span class="lineCov">         53 :         LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1844"><span class="lineNum">    1844 </span>            : </a>
<a name="1845"><span class="lineNum">    1845 </span><span class="lineCov">         53 :         if (!pwallet-&gt;IsCrypted()) {</span></a>
<a name="1846"><span class="lineNum">    1846 </span><span class="lineCov">          6 :             throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, &quot;Error: running with an unencrypted wallet, but walletpassphrase was called.&quot;);</span></a>
<a name="1847"><span class="lineNum">    1847 </span>            :         }</a>
<a name="1848"><span class="lineNum">    1848 </span>            : </a>
<a name="1849"><span class="lineNum">    1849 </span>            :         // Note that the walletpassphrase is stored in request.params[0] which is not mlock()ed</a>
<a name="1850"><span class="lineNum">    1850 </span><span class="lineCov">         47 :         SecureString strWalletPass;</span></a>
<a name="1851"><span class="lineNum">    1851 </span><span class="lineCov">         47 :         strWalletPass.reserve(100);</span></a>
<a name="1852"><span class="lineNum">    1852 </span>            :         // TODO: get rid of this .c_str() by implementing SecureString::operator=(std::string)</a>
<a name="1853"><span class="lineNum">    1853 </span>            :         // Alternately, find a way to make request.params[0] mlock()'d to begin with.</a>
<a name="1854"><span class="lineNum">    1854 </span><span class="lineCov">         47 :         strWalletPass = request.params[0].get_str().c_str();</span></a>
<a name="1855"><span class="lineNum">    1855 </span>            : </a>
<a name="1856"><span class="lineNum">    1856 </span>            :         // Get the timeout</a>
<a name="1857"><span class="lineNum">    1857 </span><span class="lineCov">         47 :         nSleepTime = request.params[1].get_int64();</span></a>
<a name="1858"><span class="lineNum">    1858 </span>            :         // Timeout cannot be negative, otherwise it will relock immediately</a>
<a name="1859"><span class="lineNum">    1859 </span><span class="lineCov">         47 :         if (nSleepTime &lt; 0) {</span></a>
<a name="1860"><span class="lineNum">    1860 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Timeout cannot be negative.&quot;);</span></a>
<a name="1861"><span class="lineNum">    1861 </span>            :         }</a>
<a name="1862"><span class="lineNum">    1862 </span>            :         // Clamp timeout</a>
<a name="1863"><span class="lineNum">    1863 </span>            :         constexpr int64_t MAX_SLEEP_TIME = 100000000; // larger values trigger a macos/libevent bug?</a>
<a name="1864"><span class="lineNum">    1864 </span><span class="lineCov">         45 :         if (nSleepTime &gt; MAX_SLEEP_TIME) {</span></a>
<a name="1865"><span class="lineNum">    1865 </span>            :             nSleepTime = MAX_SLEEP_TIME;</a>
<a name="1866"><span class="lineNum">    1866 </span><span class="lineCov">          2 :         }</span></a>
<a name="1867"><span class="lineNum">    1867 </span>            : </a>
<a name="1868"><span class="lineNum">    1868 </span><span class="lineCov">         45 :         if (strWalletPass.empty()) {</span></a>
<a name="1869"><span class="lineNum">    1869 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;passphrase can not be empty&quot;);</span></a>
<a name="1870"><span class="lineNum">    1870 </span>            :         }</a>
<a name="1871"><span class="lineNum">    1871 </span>            : </a>
<a name="1872"><span class="lineNum">    1872 </span><span class="lineCov">         43 :         if (!pwallet-&gt;Unlock(strWalletPass)) {</span></a>
<a name="1873"><span class="lineNum">    1873 </span><span class="lineCov">          4 :             throw JSONRPCError(RPC_WALLET_PASSPHRASE_INCORRECT, &quot;Error: The wallet passphrase entered was incorrect.&quot;);</span></a>
<a name="1874"><span class="lineNum">    1874 </span>            :         }</a>
<a name="1875"><span class="lineNum">    1875 </span>            : </a>
<a name="1876"><span class="lineNum">    1876 </span><span class="lineCov">         39 :         pwallet-&gt;TopUpKeyPool();</span></a>
<a name="1877"><span class="lineNum">    1877 </span>            : </a>
<a name="1878"><span class="lineNum">    1878 </span><span class="lineCov">         39 :         pwallet-&gt;nRelockTime = GetTime() + nSleepTime;</span></a>
<a name="1879"><span class="lineNum">    1879 </span>            :         relock_time = pwallet-&gt;nRelockTime;</a>
<a name="1880"><span class="lineNum">    1880 </span><span class="lineCov">         53 :     }</span></a>
<a name="1881"><span class="lineNum">    1881 </span>            : </a>
<a name="1882"><span class="lineNum">    1882 </span>            :     // rpcRunLater must be called without cs_wallet held otherwise a deadlock</a>
<a name="1883"><span class="lineNum">    1883 </span>            :     // can occur. The deadlock would happen when RPCRunLater removes the</a>
<a name="1884"><span class="lineNum">    1884 </span>            :     // previous timer (and waits for the callback to finish if already running)</a>
<a name="1885"><span class="lineNum">    1885 </span>            :     // and the callback locks cs_wallet.</a>
<a name="1886"><span class="lineNum">    1886 </span><span class="lineCov">         39 :     AssertLockNotHeld(wallet-&gt;cs_wallet);</span></a>
<a name="1887"><span class="lineNum">    1887 </span>            :     // Keep a weak pointer to the wallet so that it is possible to unload the</a>
<a name="1888"><span class="lineNum">    1888 </span>            :     // wallet before the following callback is called. If a valid shared pointer</a>
<a name="1889"><span class="lineNum">    1889 </span>            :     // is acquired in the callback then the wallet is still loaded.</a>
<a name="1890"><span class="lineNum">    1890 </span><span class="lineCov">         39 :     std::weak_ptr&lt;CWallet&gt; weak_wallet = wallet;</span></a>
<a name="1891"><span class="lineNum">    1891 </span><span class="lineCov">        593 :     pwallet-&gt;chain().rpcRunLater(strprintf(&quot;lockwallet(%s)&quot;, pwallet-&gt;GetName()), [weak_wallet, relock_time] {</span></a>
<a name="1892"><span class="lineNum">    1892 </span><span class="lineCov">         14 :         if (auto shared_wallet = weak_wallet.lock()) {</span></a>
<a name="1893"><span class="lineNum">    1893 </span><span class="lineCov">          6 :             LOCK(shared_wallet-&gt;cs_wallet);</span></a>
<a name="1894"><span class="lineNum">    1894 </span>            :             // Skip if this is not the most recent rpcRunLater callback.</a>
<a name="1895"><span class="lineNum">    1895 </span><span class="lineCov">          6 :             if (shared_wallet-&gt;nRelockTime != relock_time) return;</span></a>
<a name="1896"><span class="lineNum">    1896 </span><span class="lineCov">          4 :             shared_wallet-&gt;Lock();</span></a>
<a name="1897"><span class="lineNum">    1897 </span><span class="lineCov">          4 :             shared_wallet-&gt;nRelockTime = 0;</span></a>
<a name="1898"><span class="lineNum">    1898 </span><span class="lineCov">          6 :         }</span></a>
<a name="1899"><span class="lineNum">    1899 </span><span class="lineCov">          8 :     }, nSleepTime);</span></a>
<a name="1900"><span class="lineNum">    1900 </span>            : </a>
<a name="1901"><span class="lineNum">    1901 </span><span class="lineCov">         39 :     return NullUniValue;</span></a>
<a name="1902"><span class="lineNum">    1902 </span><span class="lineCov">         87 : }</span></a>
<a name="1903"><span class="lineNum">    1903 </span>            : </a>
<a name="1904"><span class="lineNum">    1904 </span>            : </a>
<a name="1905"><span class="lineNum">    1905 </span><span class="lineCov">         10 : static UniValue walletpassphrasechange(const JSONRPCRequest&amp; request)</span></a>
<a name="1906"><span class="lineNum">    1906 </span>            : {</a>
<a name="1907"><span class="lineNum">    1907 </span><span class="lineCov">         44 :             RPCHelpMan{&quot;walletpassphrasechange&quot;,</span></a>
<a name="1908"><span class="lineNum">    1908 </span><span class="lineCov">         10 :                 &quot;\nChanges the wallet passphrase from 'oldpassphrase' to 'newpassphrase'.\n&quot;,</span></a>
<a name="1909"><span class="lineNum">    1909 </span><span class="lineCov">         34 :                 {</span></a>
<a name="1910"><span class="lineNum">    1910 </span><span class="lineCov">         10 :                     {&quot;oldpassphrase&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The current passphrase&quot;},</span></a>
<a name="1911"><span class="lineNum">    1911 </span><span class="lineCov">         10 :                     {&quot;newpassphrase&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The new passphrase&quot;},</span></a>
<a name="1912"><span class="lineNum">    1912 </span>            :                 },</a>
<a name="1913"><span class="lineNum">    1913 </span><span class="lineCov">         10 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="1914"><span class="lineNum">    1914 </span><span class="lineCov">         10 :                 RPCExamples{</span></a>
<a name="1915"><span class="lineNum">    1915 </span><span class="lineCov">         10 :                     HelpExampleCli(&quot;walletpassphrasechange&quot;, &quot;\&quot;old one\&quot; \&quot;new one\&quot;&quot;)</span></a>
<a name="1916"><span class="lineNum">    1916 </span><span class="lineCov">         10 :             + HelpExampleRpc(&quot;walletpassphrasechange&quot;, &quot;\&quot;old one\&quot;, \&quot;new one\&quot;&quot;)</span></a>
<a name="1917"><span class="lineNum">    1917 </span>            :                 },</a>
<a name="1918"><span class="lineNum">    1918 </span><span class="lineCov">         10 :             }.Check(request);</span></a>
<a name="1919"><span class="lineNum">    1919 </span>            : </a>
<a name="1920"><span class="lineNum">    1920 </span><span class="lineCov">          6 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1921"><span class="lineNum">    1921 </span><span class="lineCov">          6 :     if (!wallet) return NullUniValue;</span></a>
<a name="1922"><span class="lineNum">    1922 </span><span class="lineCov">          6 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="1923"><span class="lineNum">    1923 </span>            : </a>
<a name="1924"><span class="lineNum">    1924 </span><span class="lineCov">          6 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1925"><span class="lineNum">    1925 </span>            : </a>
<a name="1926"><span class="lineNum">    1926 </span><span class="lineCov">          6 :     if (!pwallet-&gt;IsCrypted()) {</span></a>
<a name="1927"><span class="lineNum">    1927 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, &quot;Error: running with an unencrypted wallet, but walletpassphrasechange was called.&quot;);</span></a>
<a name="1928"><span class="lineNum">    1928 </span>            :     }</a>
<a name="1929"><span class="lineNum">    1929 </span>            : </a>
<a name="1930"><span class="lineNum">    1930 </span>            :     // TODO: get rid of these .c_str() calls by implementing SecureString::operator=(std::string)</a>
<a name="1931"><span class="lineNum">    1931 </span>            :     // Alternately, find a way to make request.params[0] mlock()'d to begin with.</a>
<a name="1932"><span class="lineNum">    1932 </span><span class="lineCov">          4 :     SecureString strOldWalletPass;</span></a>
<a name="1933"><span class="lineNum">    1933 </span><span class="lineCov">          4 :     strOldWalletPass.reserve(100);</span></a>
<a name="1934"><span class="lineNum">    1934 </span><span class="lineCov">          4 :     strOldWalletPass = request.params[0].get_str().c_str();</span></a>
<a name="1935"><span class="lineNum">    1935 </span>            : </a>
<a name="1936"><span class="lineNum">    1936 </span><span class="lineCov">          4 :     SecureString strNewWalletPass;</span></a>
<a name="1937"><span class="lineNum">    1937 </span><span class="lineCov">          4 :     strNewWalletPass.reserve(100);</span></a>
<a name="1938"><span class="lineNum">    1938 </span><span class="lineCov">          4 :     strNewWalletPass = request.params[1].get_str().c_str();</span></a>
<a name="1939"><span class="lineNum">    1939 </span>            : </a>
<a name="1940"><span class="lineNum">    1940 </span><span class="lineCov">          4 :     if (strOldWalletPass.empty() || strNewWalletPass.empty()) {</span></a>
<a name="1941"><span class="lineNum">    1941 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;passphrase can not be empty&quot;);</span></a>
<a name="1942"><span class="lineNum">    1942 </span>            :     }</a>
<a name="1943"><span class="lineNum">    1943 </span>            : </a>
<a name="1944"><span class="lineNum">    1944 </span><span class="lineCov">          2 :     if (!pwallet-&gt;ChangeWalletPassphrase(strOldWalletPass, strNewWalletPass)) {</span></a>
<a name="1945"><span class="lineNum">    1945 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_PASSPHRASE_INCORRECT, &quot;Error: The wallet passphrase entered was incorrect.&quot;);</span></a>
<a name="1946"><span class="lineNum">    1946 </span>            :     }</a>
<a name="1947"><span class="lineNum">    1947 </span>            : </a>
<a name="1948"><span class="lineNum">    1948 </span><span class="lineCov">          2 :     return NullUniValue;</span></a>
<a name="1949"><span class="lineNum">    1949 </span><span class="lineCov">         30 : }</span></a>
<a name="1950"><span class="lineNum">    1950 </span>            : </a>
<a name="1951"><span class="lineNum">    1951 </span>            : </a>
<a name="1952"><span class="lineNum">    1952 </span><span class="lineCov">         15 : static UniValue walletlock(const JSONRPCRequest&amp; request)</span></a>
<a name="1953"><span class="lineNum">    1953 </span>            : {</a>
<a name="1954"><span class="lineNum">    1954 </span><span class="lineCov">         45 :             RPCHelpMan{&quot;walletlock&quot;,</span></a>
<a name="1955"><span class="lineNum">    1955 </span><span class="lineCov">         15 :                 &quot;\nRemoves the wallet encryption key from memory, locking the wallet.\n&quot;</span></a>
<a name="1956"><span class="lineNum">    1956 </span>            :                 &quot;After calling this method, you will need to call walletpassphrase again\n&quot;</a>
<a name="1957"><span class="lineNum">    1957 </span>            :                 &quot;before being able to call any methods which require the wallet to be unlocked.\n&quot;,</a>
<a name="1958"><span class="lineNum">    1958 </span><span class="lineCov">         15 :                 {},</span></a>
<a name="1959"><span class="lineNum">    1959 </span><span class="lineCov">         15 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="1960"><span class="lineNum">    1960 </span><span class="lineCov">         15 :                 RPCExamples{</span></a>
<a name="1961"><span class="lineNum">    1961 </span><span class="lineCov">         15 :             &quot;\nSet the passphrase for 2 minutes to perform a transaction\n&quot;</span></a>
<a name="1962"><span class="lineNum">    1962 </span><span class="lineCov">         15 :             + HelpExampleCli(&quot;walletpassphrase&quot;, &quot;\&quot;my pass phrase\&quot; 120&quot;) +</span></a>
<a name="1963"><span class="lineNum">    1963 </span>            :             &quot;\nPerform a send (requires passphrase set)\n&quot;</a>
<a name="1964"><span class="lineNum">    1964 </span><span class="lineCov">         15 :             + HelpExampleCli(&quot;sendtoaddress&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot; 1.0&quot;) +</span></a>
<a name="1965"><span class="lineNum">    1965 </span>            :             &quot;\nClear the passphrase since we are done before 2 minutes is up\n&quot;</a>
<a name="1966"><span class="lineNum">    1966 </span><span class="lineCov">         15 :             + HelpExampleCli(&quot;walletlock&quot;, &quot;&quot;) +</span></a>
<a name="1967"><span class="lineNum">    1967 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="1968"><span class="lineNum">    1968 </span><span class="lineCov">         15 :             + HelpExampleRpc(&quot;walletlock&quot;, &quot;&quot;)</span></a>
<a name="1969"><span class="lineNum">    1969 </span>            :                 },</a>
<a name="1970"><span class="lineNum">    1970 </span><span class="lineCov">         15 :             }.Check(request);</span></a>
<a name="1971"><span class="lineNum">    1971 </span>            : </a>
<a name="1972"><span class="lineNum">    1972 </span><span class="lineCov">         11 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="1973"><span class="lineNum">    1973 </span><span class="lineCov">         11 :     if (!wallet) return NullUniValue;</span></a>
<a name="1974"><span class="lineNum">    1974 </span><span class="lineCov">         11 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="1975"><span class="lineNum">    1975 </span>            : </a>
<a name="1976"><span class="lineNum">    1976 </span><span class="lineCov">         11 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="1977"><span class="lineNum">    1977 </span>            : </a>
<a name="1978"><span class="lineNum">    1978 </span><span class="lineCov">         11 :     if (!pwallet-&gt;IsCrypted()) {</span></a>
<a name="1979"><span class="lineNum">    1979 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, &quot;Error: running with an unencrypted wallet, but walletlock was called.&quot;);</span></a>
<a name="1980"><span class="lineNum">    1980 </span>            :     }</a>
<a name="1981"><span class="lineNum">    1981 </span>            : </a>
<a name="1982"><span class="lineNum">    1982 </span><span class="lineCov">         11 :     pwallet-&gt;Lock();</span></a>
<a name="1983"><span class="lineNum">    1983 </span><span class="lineCov">         11 :     pwallet-&gt;nRelockTime = 0;</span></a>
<a name="1984"><span class="lineNum">    1984 </span>            : </a>
<a name="1985"><span class="lineNum">    1985 </span><span class="lineCov">         11 :     return NullUniValue;</span></a>
<a name="1986"><span class="lineNum">    1986 </span><span class="lineCov">         15 : }</span></a>
<a name="1987"><span class="lineNum">    1987 </span>            : </a>
<a name="1988"><span class="lineNum">    1988 </span>            : </a>
<a name="1989"><span class="lineNum">    1989 </span><span class="lineCov">         25 : static UniValue encryptwallet(const JSONRPCRequest&amp; request)</span></a>
<a name="1990"><span class="lineNum">    1990 </span>            : {</a>
<a name="1991"><span class="lineNum">    1991 </span><span class="lineCov">         81 :             RPCHelpMan{&quot;encryptwallet&quot;,</span></a>
<a name="1992"><span class="lineNum">    1992 </span><span class="lineCov">         25 :                 &quot;\nEncrypts the wallet with 'passphrase'. This is for first time encryption.\n&quot;</span></a>
<a name="1993"><span class="lineNum">    1993 </span>            :                 &quot;After this, any calls that interact with private keys such as sending or signing \n&quot;</a>
<a name="1994"><span class="lineNum">    1994 </span>            :                 &quot;will require the passphrase to be set prior the making these calls.\n&quot;</a>
<a name="1995"><span class="lineNum">    1995 </span>            :                 &quot;Use the walletpassphrase call for this, and then walletlock call.\n&quot;</a>
<a name="1996"><span class="lineNum">    1996 </span>            :                 &quot;If the wallet is already encrypted, use the walletpassphrasechange call.\n&quot;,</a>
<a name="1997"><span class="lineNum">    1997 </span><span class="lineCov">         50 :                 {</span></a>
<a name="1998"><span class="lineNum">    1998 </span><span class="lineCov">         25 :                     {&quot;passphrase&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The pass phrase to encrypt the wallet with. It must be at least 1 character, but should be long.&quot;},</span></a>
<a name="1999"><span class="lineNum">    1999 </span>            :                 },</a>
<a name="2000"><span class="lineNum">    2000 </span><span class="lineCov">         25 :                 RPCResult{RPCResult::Type::STR, &quot;&quot;, &quot;A string with further instructions&quot;},</span></a>
<a name="2001"><span class="lineNum">    2001 </span><span class="lineCov">         25 :                 RPCExamples{</span></a>
<a name="2002"><span class="lineNum">    2002 </span><span class="lineCov">         25 :             &quot;\nEncrypt your wallet\n&quot;</span></a>
<a name="2003"><span class="lineNum">    2003 </span><span class="lineCov">         25 :             + HelpExampleCli(&quot;encryptwallet&quot;, &quot;\&quot;my pass phrase\&quot;&quot;) +</span></a>
<a name="2004"><span class="lineNum">    2004 </span>            :             &quot;\nNow set the passphrase to use the wallet, such as for signing or sending bitcoin\n&quot;</a>
<a name="2005"><span class="lineNum">    2005 </span><span class="lineCov">         25 :             + HelpExampleCli(&quot;walletpassphrase&quot;, &quot;\&quot;my pass phrase\&quot;&quot;) +</span></a>
<a name="2006"><span class="lineNum">    2006 </span>            :             &quot;\nNow we can do something like sign\n&quot;</a>
<a name="2007"><span class="lineNum">    2007 </span><span class="lineCov">         25 :             + HelpExampleCli(&quot;signmessage&quot;, &quot;\&quot;address\&quot; \&quot;test message\&quot;&quot;) +</span></a>
<a name="2008"><span class="lineNum">    2008 </span>            :             &quot;\nNow lock the wallet again by removing the passphrase\n&quot;</a>
<a name="2009"><span class="lineNum">    2009 </span><span class="lineCov">         25 :             + HelpExampleCli(&quot;walletlock&quot;, &quot;&quot;) +</span></a>
<a name="2010"><span class="lineNum">    2010 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="2011"><span class="lineNum">    2011 </span><span class="lineCov">         25 :             + HelpExampleRpc(&quot;encryptwallet&quot;, &quot;\&quot;my pass phrase\&quot;&quot;)</span></a>
<a name="2012"><span class="lineNum">    2012 </span>            :                 },</a>
<a name="2013"><span class="lineNum">    2013 </span><span class="lineCov">         25 :             }.Check(request);</span></a>
<a name="2014"><span class="lineNum">    2014 </span>            : </a>
<a name="2015"><span class="lineNum">    2015 </span><span class="lineCov">         21 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2016"><span class="lineNum">    2016 </span><span class="lineCov">         21 :     if (!wallet) return NullUniValue;</span></a>
<a name="2017"><span class="lineNum">    2017 </span><span class="lineCov">         21 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="2018"><span class="lineNum">    2018 </span>            : </a>
<a name="2019"><span class="lineNum">    2019 </span><span class="lineCov">         21 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2020"><span class="lineNum">    2020 </span>            : </a>
<a name="2021"><span class="lineNum">    2021 </span><span class="lineCov">         21 :     if (pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></a>
<a name="2022"><span class="lineNum">    2022 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_WALLET_ENCRYPTION_FAILED, &quot;Error: wallet does not contain private keys, nothing to encrypt.&quot;);</span></a>
<a name="2023"><span class="lineNum">    2023 </span>            :     }</a>
<a name="2024"><span class="lineNum">    2024 </span>            : </a>
<a name="2025"><span class="lineNum">    2025 </span><span class="lineCov">         19 :     if (pwallet-&gt;IsCrypted()) {</span></a>
<a name="2026"><span class="lineNum">    2026 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_WALLET_WRONG_ENC_STATE, &quot;Error: running with an encrypted wallet, but encryptwallet was called.&quot;);</span></a>
<a name="2027"><span class="lineNum">    2027 </span>            :     }</a>
<a name="2028"><span class="lineNum">    2028 </span>            : </a>
<a name="2029"><span class="lineNum">    2029 </span>            :     // TODO: get rid of this .c_str() by implementing SecureString::operator=(std::string)</a>
<a name="2030"><span class="lineNum">    2030 </span>            :     // Alternately, find a way to make request.params[0] mlock()'d to begin with.</a>
<a name="2031"><span class="lineNum">    2031 </span><span class="lineCov">         17 :     SecureString strWalletPass;</span></a>
<a name="2032"><span class="lineNum">    2032 </span><span class="lineCov">         17 :     strWalletPass.reserve(100);</span></a>
<a name="2033"><span class="lineNum">    2033 </span><span class="lineCov">         17 :     strWalletPass = request.params[0].get_str().c_str();</span></a>
<a name="2034"><span class="lineNum">    2034 </span>            : </a>
<a name="2035"><span class="lineNum">    2035 </span><span class="lineCov">         17 :     if (strWalletPass.empty()) {</span></a>
<a name="2036"><span class="lineNum">    2036 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;passphrase can not be empty&quot;);</span></a>
<a name="2037"><span class="lineNum">    2037 </span>            :     }</a>
<a name="2038"><span class="lineNum">    2038 </span>            : </a>
<a name="2039"><span class="lineNum">    2039 </span><span class="lineCov">         15 :     if (!pwallet-&gt;EncryptWallet(strWalletPass)) {</span></a>
<a name="2040"><span class="lineNum">    2040 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ENCRYPTION_FAILED, &quot;Error: Failed to encrypt the wallet.&quot;);</span></a>
<a name="2041"><span class="lineNum">    2041 </span>            :     }</a>
<a name="2042"><span class="lineNum">    2042 </span>            : </a>
<a name="2043"><span class="lineNum">    2043 </span><span class="lineCov">         15 :     return &quot;wallet encrypted; The keypool has been flushed and a new HD seed was generated (if you are using HD). You need to make a new backup.&quot;;</span></a>
<a name="2044"><span class="lineNum">    2044 </span><span class="lineCov">         37 : }</span></a>
<a name="2045"><span class="lineNum">    2045 </span>            : </a>
<a name="2046"><span class="lineNum">    2046 </span><span class="lineCov">         27 : static UniValue lockunspent(const JSONRPCRequest&amp; request)</span></a>
<a name="2047"><span class="lineNum">    2047 </span>            : {</a>
<a name="2048"><span class="lineNum">    2048 </span><span class="lineCov">        149 :             RPCHelpMan{&quot;lockunspent&quot;,</span></a>
<a name="2049"><span class="lineNum">    2049 </span><span class="lineCov">         27 :                 &quot;\nUpdates list of temporarily unspendable outputs.\n&quot;</span></a>
<a name="2050"><span class="lineNum">    2050 </span>            :                 &quot;Temporarily lock (unlock=false) or unlock (unlock=true) specified transaction outputs.\n&quot;</a>
<a name="2051"><span class="lineNum">    2051 </span>            :                 &quot;If no transaction outputs are specified when unlocking then all current locked transaction outputs are unlocked.\n&quot;</a>
<a name="2052"><span class="lineNum">    2052 </span>            :                 &quot;A locked transaction output will not be chosen by automatic coin selection, when spending bitcoins.\n&quot;</a>
<a name="2053"><span class="lineNum">    2053 </span>            :                 &quot;Manually selected coins are automatically unlocked.\n&quot;</a>
<a name="2054"><span class="lineNum">    2054 </span>            :                 &quot;Locks are stored in memory only. Nodes start with zero locked outputs, and the locked output list\n&quot;</a>
<a name="2055"><span class="lineNum">    2055 </span>            :                 &quot;is always cleared (by virtue of process exit) when a node stops or fails.\n&quot;</a>
<a name="2056"><span class="lineNum">    2056 </span>            :                 &quot;Also see the listunspent call\n&quot;,</a>
<a name="2057"><span class="lineNum">    2057 </span><span class="lineCov">         85 :                 {</span></a>
<a name="2058"><span class="lineNum">    2058 </span><span class="lineCov">         27 :                     {&quot;unlock&quot;, RPCArg::Type::BOOL, RPCArg::Optional::NO, &quot;Whether to unlock (true) or lock (false) the specified transactions&quot;},</span></a>
<a name="2059"><span class="lineNum">    2059 </span><span class="lineCov">         54 :                     {&quot;transactions&quot;, RPCArg::Type::ARR, /* default */ &quot;empty array&quot;, &quot;The transaction outputs and within each, the txid (string) vout (numeric).&quot;,</span></a>
<a name="2060"><span class="lineNum">    2060 </span><span class="lineCov">         54 :                         {</span></a>
<a name="2061"><span class="lineNum">    2061 </span><span class="lineCov">         54 :                             {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="2062"><span class="lineNum">    2062 </span><span class="lineCov">         85 :                                 {</span></a>
<a name="2063"><span class="lineNum">    2063 </span><span class="lineCov">         27 :                                     {&quot;txid&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The transaction id&quot;},</span></a>
<a name="2064"><span class="lineNum">    2064 </span><span class="lineCov">         27 :                                     {&quot;vout&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The output number&quot;},</span></a>
<a name="2065"><span class="lineNum">    2065 </span>            :                                 },</a>
<a name="2066"><span class="lineNum">    2066 </span>            :                             },</a>
<a name="2067"><span class="lineNum">    2067 </span>            :                         },</a>
<a name="2068"><span class="lineNum">    2068 </span>            :                     },</a>
<a name="2069"><span class="lineNum">    2069 </span>            :                 },</a>
<a name="2070"><span class="lineNum">    2070 </span><span class="lineCov">         27 :                 RPCResult{</span></a>
<a name="2071"><span class="lineNum">    2071 </span><span class="lineCov">         27 :                     RPCResult::Type::BOOL, &quot;&quot;, &quot;Whether the command was successful or not&quot;</span></a>
<a name="2072"><span class="lineNum">    2072 </span>            :                 },</a>
<a name="2073"><span class="lineNum">    2073 </span><span class="lineCov">         27 :                 RPCExamples{</span></a>
<a name="2074"><span class="lineNum">    2074 </span><span class="lineCov">         27 :             &quot;\nList the unspent transactions\n&quot;</span></a>
<a name="2075"><span class="lineNum">    2075 </span><span class="lineCov">         27 :             + HelpExampleCli(&quot;listunspent&quot;, &quot;&quot;) +</span></a>
<a name="2076"><span class="lineNum">    2076 </span>            :             &quot;\nLock an unspent transaction\n&quot;</a>
<a name="2077"><span class="lineNum">    2077 </span><span class="lineCov">         27 :             + HelpExampleCli(&quot;lockunspent&quot;, &quot;false \&quot;[{\\\&quot;txid\\\&quot;:\\\&quot;a08e6907dbbd3d809776dbfc5d82e371b764ed838b5655e72f463568df1aadf0\\\&quot;,\\\&quot;vout\\\&quot;:1}]\&quot;&quot;) +</span></a>
<a name="2078"><span class="lineNum">    2078 </span>            :             &quot;\nList the locked transactions\n&quot;</a>
<a name="2079"><span class="lineNum">    2079 </span><span class="lineCov">         27 :             + HelpExampleCli(&quot;listlockunspent&quot;, &quot;&quot;) +</span></a>
<a name="2080"><span class="lineNum">    2080 </span>            :             &quot;\nUnlock the transaction again\n&quot;</a>
<a name="2081"><span class="lineNum">    2081 </span><span class="lineCov">         27 :             + HelpExampleCli(&quot;lockunspent&quot;, &quot;true \&quot;[{\\\&quot;txid\\\&quot;:\\\&quot;a08e6907dbbd3d809776dbfc5d82e371b764ed838b5655e72f463568df1aadf0\\\&quot;,\\\&quot;vout\\\&quot;:1}]\&quot;&quot;) +</span></a>
<a name="2082"><span class="lineNum">    2082 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="2083"><span class="lineNum">    2083 </span><span class="lineCov">         27 :             + HelpExampleRpc(&quot;lockunspent&quot;, &quot;false, \&quot;[{\\\&quot;txid\\\&quot;:\\\&quot;a08e6907dbbd3d809776dbfc5d82e371b764ed838b5655e72f463568df1aadf0\\\&quot;,\\\&quot;vout\\\&quot;:1}]\&quot;&quot;)</span></a>
<a name="2084"><span class="lineNum">    2084 </span>            :                 },</a>
<a name="2085"><span class="lineNum">    2085 </span><span class="lineCov">         27 :             }.Check(request);</span></a>
<a name="2086"><span class="lineNum">    2086 </span>            : </a>
<a name="2087"><span class="lineNum">    2087 </span><span class="lineCov">         23 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2088"><span class="lineNum">    2088 </span><span class="lineCov">         23 :     if (!wallet) return NullUniValue;</span></a>
<a name="2089"><span class="lineNum">    2089 </span><span class="lineCov">         23 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="2090"><span class="lineNum">    2090 </span>            : </a>
<a name="2091"><span class="lineNum">    2091 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="2092"><span class="lineNum">    2092 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="2093"><span class="lineNum">    2093 </span><span class="lineCov">         23 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="2094"><span class="lineNum">    2094 </span>            : </a>
<a name="2095"><span class="lineNum">    2095 </span><span class="lineCov">         23 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2096"><span class="lineNum">    2096 </span>            : </a>
<a name="2097"><span class="lineNum">    2097 </span><span class="lineCov">         23 :     RPCTypeCheckArgument(request.params[0], UniValue::VBOOL);</span></a>
<a name="2098"><span class="lineNum">    2098 </span>            : </a>
<a name="2099"><span class="lineNum">    2099 </span><span class="lineCov">         23 :     bool fUnlock = request.params[0].get_bool();</span></a>
<a name="2100"><span class="lineNum">    2100 </span>            : </a>
<a name="2101"><span class="lineNum">    2101 </span><span class="lineCov">         23 :     if (request.params[1].isNull()) {</span></a>
<a name="2102"><span class="lineNum">    2102 </span><span class="lineNoCov">          0 :         if (fUnlock)</span></a>
<a name="2103"><span class="lineNum">    2103 </span><span class="lineNoCov">          0 :             pwallet-&gt;UnlockAllCoins();</span></a>
<a name="2104"><span class="lineNum">    2104 </span><span class="lineNoCov">          0 :         return true;</span></a>
<a name="2105"><span class="lineNum">    2105 </span>            :     }</a>
<a name="2106"><span class="lineNum">    2106 </span>            : </a>
<a name="2107"><span class="lineNum">    2107 </span><span class="lineCov">         23 :     RPCTypeCheckArgument(request.params[1], UniValue::VARR);</span></a>
<a name="2108"><span class="lineNum">    2108 </span>            : </a>
<a name="2109"><span class="lineNum">    2109 </span><span class="lineCov">         23 :     const UniValue&amp; output_params = request.params[1];</span></a>
<a name="2110"><span class="lineNum">    2110 </span>            : </a>
<a name="2111"><span class="lineNum">    2111 </span>            :     // Create and validate the COutPoints first.</a>
<a name="2112"><span class="lineNum">    2112 </span>            : </a>
<a name="2113"><span class="lineNum">    2113 </span><span class="lineCov">         23 :     std::vector&lt;COutPoint&gt; outputs;</span></a>
<a name="2114"><span class="lineNum">    2114 </span><span class="lineCov">         23 :     outputs.reserve(output_params.size());</span></a>
<a name="2115"><span class="lineNum">    2115 </span>            : </a>
<a name="2116"><span class="lineNum">    2116 </span><span class="lineCov">         46 :     for (unsigned int idx = 0; idx &lt; output_params.size(); idx++) {</span></a>
<a name="2117"><span class="lineNum">    2117 </span><span class="lineCov">         23 :         const UniValue&amp; o = output_params[idx].get_obj();</span></a>
<a name="2118"><span class="lineNum">    2118 </span>            : </a>
<a name="2119"><span class="lineNum">    2119 </span><span class="lineCov">         46 :         RPCTypeCheckObj(o,</span></a>
<a name="2120"><span class="lineNum">    2120 </span><span class="lineCov">         69 :             {</span></a>
<a name="2121"><span class="lineNum">    2121 </span><span class="lineCov">         23 :                 {&quot;txid&quot;, UniValueType(UniValue::VSTR)},</span></a>
<a name="2122"><span class="lineNum">    2122 </span><span class="lineCov">         23 :                 {&quot;vout&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="2123"><span class="lineNum">    2123 </span>            :             });</a>
<a name="2124"><span class="lineNum">    2124 </span>            : </a>
<a name="2125"><span class="lineNum">    2125 </span><span class="lineCov">         23 :         const uint256 txid(ParseHashO(o, &quot;txid&quot;));</span></a>
<a name="2126"><span class="lineNum">    2126 </span><span class="lineCov">         19 :         const int nOutput = find_value(o, &quot;vout&quot;).get_int();</span></a>
<a name="2127"><span class="lineNum">    2127 </span><span class="lineCov">         19 :         if (nOutput &lt; 0) {</span></a>
<a name="2128"><span class="lineNum">    2128 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, vout must be positive&quot;);</span></a>
<a name="2129"><span class="lineNum">    2129 </span>            :         }</a>
<a name="2130"><span class="lineNum">    2130 </span>            : </a>
<a name="2131"><span class="lineNum">    2131 </span><span class="lineCov">         19 :         const COutPoint outpt(txid, nOutput);</span></a>
<a name="2132"><span class="lineNum">    2132 </span>            : </a>
<a name="2133"><span class="lineNum">    2133 </span><span class="lineCov">         19 :         const auto it = pwallet-&gt;mapWallet.find(outpt.hash);</span></a>
<a name="2134"><span class="lineNum">    2134 </span><span class="lineCov">         19 :         if (it == pwallet-&gt;mapWallet.end()) {</span></a>
<a name="2135"><span class="lineNum">    2135 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, unknown transaction&quot;);</span></a>
<a name="2136"><span class="lineNum">    2136 </span>            :         }</a>
<a name="2137"><span class="lineNum">    2137 </span>            : </a>
<a name="2138"><span class="lineNum">    2138 </span><span class="lineCov">         17 :         const CWalletTx&amp; trans = it-&gt;second;</span></a>
<a name="2139"><span class="lineNum">    2139 </span>            : </a>
<a name="2140"><span class="lineNum">    2140 </span><span class="lineCov">         17 :         if (outpt.n &gt;= trans.tx-&gt;vout.size()) {</span></a>
<a name="2141"><span class="lineNum">    2141 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, vout index out of bounds&quot;);</span></a>
<a name="2142"><span class="lineNum">    2142 </span>            :         }</a>
<a name="2143"><span class="lineNum">    2143 </span>            : </a>
<a name="2144"><span class="lineNum">    2144 </span><span class="lineCov">         15 :         if (pwallet-&gt;IsSpent(outpt.hash, outpt.n)) {</span></a>
<a name="2145"><span class="lineNum">    2145 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, expected unspent output&quot;);</span></a>
<a name="2146"><span class="lineNum">    2146 </span>            :         }</a>
<a name="2147"><span class="lineNum">    2147 </span>            : </a>
<a name="2148"><span class="lineNum">    2148 </span><span class="lineCov">         13 :         const bool is_locked = pwallet-&gt;IsLockedCoin(outpt.hash, outpt.n);</span></a>
<a name="2149"><span class="lineNum">    2149 </span>            : </a>
<a name="2150"><span class="lineNum">    2150 </span><span class="lineCov">         13 :         if (fUnlock &amp;&amp; !is_locked) {</span></a>
<a name="2151"><span class="lineNum">    2151 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, expected locked output&quot;);</span></a>
<a name="2152"><span class="lineNum">    2152 </span>            :         }</a>
<a name="2153"><span class="lineNum">    2153 </span>            : </a>
<a name="2154"><span class="lineNum">    2154 </span><span class="lineCov">         11 :         if (!fUnlock &amp;&amp; is_locked) {</span></a>
<a name="2155"><span class="lineNum">    2155 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid parameter, output already locked&quot;);</span></a>
<a name="2156"><span class="lineNum">    2156 </span>            :         }</a>
<a name="2157"><span class="lineNum">    2157 </span>            : </a>
<a name="2158"><span class="lineNum">    2158 </span><span class="lineCov">          9 :         outputs.push_back(outpt);</span></a>
<a name="2159"><span class="lineNum">    2159 </span><span class="lineCov">         23 :     }</span></a>
<a name="2160"><span class="lineNum">    2160 </span>            : </a>
<a name="2161"><span class="lineNum">    2161 </span>            :     // Atomically set (un)locked status for the outputs.</a>
<a name="2162"><span class="lineNum">    2162 </span><span class="lineCov">         18 :     for (const COutPoint&amp; outpt : outputs) {</span></a>
<a name="2163"><span class="lineNum">    2163 </span><span class="lineCov">          9 :         if (fUnlock) pwallet-&gt;UnlockCoin(outpt);</span></a>
<a name="2164"><span class="lineNum">    2164 </span><span class="lineCov">          5 :         else pwallet-&gt;LockCoin(outpt);</span></a>
<a name="2165"><span class="lineNum">    2165 </span>            :     }</a>
<a name="2166"><span class="lineNum">    2166 </span>            : </a>
<a name="2167"><span class="lineNum">    2167 </span><span class="lineCov">          9 :     return true;</span></a>
<a name="2168"><span class="lineNum">    2168 </span><span class="lineCov">         85 : }</span></a>
<a name="2169"><span class="lineNum">    2169 </span>            : </a>
<a name="2170"><span class="lineNum">    2170 </span><span class="lineCov">         19 : static UniValue listlockunspent(const JSONRPCRequest&amp; request)</span></a>
<a name="2171"><span class="lineNum">    2171 </span>            : {</a>
<a name="2172"><span class="lineNum">    2172 </span><span class="lineCov">         76 :             RPCHelpMan{&quot;listlockunspent&quot;,</span></a>
<a name="2173"><span class="lineNum">    2173 </span><span class="lineCov">         19 :                 &quot;\nReturns list of temporarily unspendable outputs.\n&quot;</span></a>
<a name="2174"><span class="lineNum">    2174 </span>            :                 &quot;See the lockunspent call to lock and unlock transactions for spending.\n&quot;,</a>
<a name="2175"><span class="lineNum">    2175 </span><span class="lineCov">         19 :                 {},</span></a>
<a name="2176"><span class="lineNum">    2176 </span><span class="lineCov">         19 :                 RPCResult{</span></a>
<a name="2177"><span class="lineNum">    2177 </span><span class="lineCov">         19 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2178"><span class="lineNum">    2178 </span><span class="lineCov">         38 :                     {</span></a>
<a name="2179"><span class="lineNum">    2179 </span><span class="lineCov">         38 :                         {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2180"><span class="lineNum">    2180 </span><span class="lineCov">         61 :                         {</span></a>
<a name="2181"><span class="lineNum">    2181 </span><span class="lineCov">         19 :                             {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The transaction id locked&quot;},</span></a>
<a name="2182"><span class="lineNum">    2182 </span><span class="lineCov">         19 :                             {RPCResult::Type::NUM, &quot;vout&quot;, &quot;The vout value&quot;},</span></a>
<a name="2183"><span class="lineNum">    2183 </span>            :                         }},</a>
<a name="2184"><span class="lineNum">    2184 </span>            :                     }</a>
<a name="2185"><span class="lineNum">    2185 </span>            :                 },</a>
<a name="2186"><span class="lineNum">    2186 </span><span class="lineCov">         19 :                 RPCExamples{</span></a>
<a name="2187"><span class="lineNum">    2187 </span><span class="lineCov">         19 :             &quot;\nList the unspent transactions\n&quot;</span></a>
<a name="2188"><span class="lineNum">    2188 </span><span class="lineCov">         19 :             + HelpExampleCli(&quot;listunspent&quot;, &quot;&quot;) +</span></a>
<a name="2189"><span class="lineNum">    2189 </span>            :             &quot;\nLock an unspent transaction\n&quot;</a>
<a name="2190"><span class="lineNum">    2190 </span><span class="lineCov">         19 :             + HelpExampleCli(&quot;lockunspent&quot;, &quot;false \&quot;[{\\\&quot;txid\\\&quot;:\\\&quot;a08e6907dbbd3d809776dbfc5d82e371b764ed838b5655e72f463568df1aadf0\\\&quot;,\\\&quot;vout\\\&quot;:1}]\&quot;&quot;) +</span></a>
<a name="2191"><span class="lineNum">    2191 </span>            :             &quot;\nList the locked transactions\n&quot;</a>
<a name="2192"><span class="lineNum">    2192 </span><span class="lineCov">         19 :             + HelpExampleCli(&quot;listlockunspent&quot;, &quot;&quot;) +</span></a>
<a name="2193"><span class="lineNum">    2193 </span>            :             &quot;\nUnlock the transaction again\n&quot;</a>
<a name="2194"><span class="lineNum">    2194 </span><span class="lineCov">         19 :             + HelpExampleCli(&quot;lockunspent&quot;, &quot;true \&quot;[{\\\&quot;txid\\\&quot;:\\\&quot;a08e6907dbbd3d809776dbfc5d82e371b764ed838b5655e72f463568df1aadf0\\\&quot;,\\\&quot;vout\\\&quot;:1}]\&quot;&quot;) +</span></a>
<a name="2195"><span class="lineNum">    2195 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="2196"><span class="lineNum">    2196 </span><span class="lineCov">         19 :             + HelpExampleRpc(&quot;listlockunspent&quot;, &quot;&quot;)</span></a>
<a name="2197"><span class="lineNum">    2197 </span>            :                 },</a>
<a name="2198"><span class="lineNum">    2198 </span><span class="lineCov">         19 :             }.Check(request);</span></a>
<a name="2199"><span class="lineNum">    2199 </span>            : </a>
<a name="2200"><span class="lineNum">    2200 </span><span class="lineCov">         15 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2201"><span class="lineNum">    2201 </span><span class="lineCov">         15 :     if (!wallet) return NullUniValue;</span></a>
<a name="2202"><span class="lineNum">    2202 </span><span class="lineCov">         15 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="2203"><span class="lineNum">    2203 </span>            : </a>
<a name="2204"><span class="lineNum">    2204 </span><span class="lineCov">         15 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2205"><span class="lineNum">    2205 </span>            : </a>
<a name="2206"><span class="lineNum">    2206 </span><span class="lineCov">         15 :     std::vector&lt;COutPoint&gt; vOutpts;</span></a>
<a name="2207"><span class="lineNum">    2207 </span><span class="lineCov">         15 :     pwallet-&gt;ListLockedCoins(vOutpts);</span></a>
<a name="2208"><span class="lineNum">    2208 </span>            : </a>
<a name="2209"><span class="lineNum">    2209 </span><span class="lineCov">         15 :     UniValue ret(UniValue::VARR);</span></a>
<a name="2210"><span class="lineNum">    2210 </span>            : </a>
<a name="2211"><span class="lineNum">    2211 </span><span class="lineCov">         22 :     for (const COutPoint&amp; outpt : vOutpts) {</span></a>
<a name="2212"><span class="lineNum">    2212 </span><span class="lineCov">          7 :         UniValue o(UniValue::VOBJ);</span></a>
<a name="2213"><span class="lineNum">    2213 </span>            : </a>
<a name="2214"><span class="lineNum">    2214 </span><span class="lineCov">          7 :         o.pushKV(&quot;txid&quot;, outpt.hash.GetHex());</span></a>
<a name="2215"><span class="lineNum">    2215 </span><span class="lineCov">          7 :         o.pushKV(&quot;vout&quot;, (int)outpt.n);</span></a>
<a name="2216"><span class="lineNum">    2216 </span><span class="lineCov">          7 :         ret.push_back(o);</span></a>
<a name="2217"><span class="lineNum">    2217 </span><span class="lineCov">          7 :     }</span></a>
<a name="2218"><span class="lineNum">    2218 </span>            : </a>
<a name="2219"><span class="lineNum">    2219 </span><span class="lineCov">         15 :     return ret;</span></a>
<a name="2220"><span class="lineNum">    2220 </span><span class="lineCov">         35 : }</span></a>
<a name="2221"><span class="lineNum">    2221 </span>            : </a>
<a name="2222"><span class="lineNum">    2222 </span><span class="lineCov">         25 : static UniValue settxfee(const JSONRPCRequest&amp; request)</span></a>
<a name="2223"><span class="lineNum">    2223 </span>            : {</a>
<a name="2224"><span class="lineNum">    2224 </span><span class="lineCov">         78 :             RPCHelpMan{&quot;settxfee&quot;,</span></a>
<a name="2225"><span class="lineNum">    2225 </span><span class="lineCov">         25 :                 &quot;\nSet the transaction fee per kB for this wallet. Overrides the global -paytxfee command line parameter.\n&quot;</span></a>
<a name="2226"><span class="lineNum">    2226 </span>            :                 &quot;Can be deactivated by passing 0 as the fee. In that case automatic fee selection will be used by default.\n&quot;,</a>
<a name="2227"><span class="lineNum">    2227 </span><span class="lineCov">         50 :                 {</span></a>
<a name="2228"><span class="lineNum">    2228 </span><span class="lineCov">         25 :                     {&quot;amount&quot;, RPCArg::Type::AMOUNT, RPCArg::Optional::NO, &quot;The transaction fee in &quot; + CURRENCY_UNIT + &quot;/kB&quot;},</span></a>
<a name="2229"><span class="lineNum">    2229 </span>            :                 },</a>
<a name="2230"><span class="lineNum">    2230 </span><span class="lineCov">         25 :                 RPCResult{</span></a>
<a name="2231"><span class="lineNum">    2231 </span><span class="lineCov">         25 :                     RPCResult::Type::BOOL, &quot;&quot;, &quot;Returns true if successful&quot;</span></a>
<a name="2232"><span class="lineNum">    2232 </span>            :                 },</a>
<a name="2233"><span class="lineNum">    2233 </span><span class="lineCov">         25 :                 RPCExamples{</span></a>
<a name="2234"><span class="lineNum">    2234 </span><span class="lineCov">         25 :                     HelpExampleCli(&quot;settxfee&quot;, &quot;0.00001&quot;)</span></a>
<a name="2235"><span class="lineNum">    2235 </span><span class="lineCov">         25 :             + HelpExampleRpc(&quot;settxfee&quot;, &quot;0.00001&quot;)</span></a>
<a name="2236"><span class="lineNum">    2236 </span>            :                 },</a>
<a name="2237"><span class="lineNum">    2237 </span><span class="lineCov">         25 :             }.Check(request);</span></a>
<a name="2238"><span class="lineNum">    2238 </span>            : </a>
<a name="2239"><span class="lineNum">    2239 </span><span class="lineCov">         21 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2240"><span class="lineNum">    2240 </span><span class="lineCov">         21 :     if (!wallet) return NullUniValue;</span></a>
<a name="2241"><span class="lineNum">    2241 </span><span class="lineCov">         21 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="2242"><span class="lineNum">    2242 </span>            : </a>
<a name="2243"><span class="lineNum">    2243 </span><span class="lineCov">         21 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2244"><span class="lineNum">    2244 </span>            : </a>
<a name="2245"><span class="lineNum">    2245 </span><span class="lineCov">         21 :     CAmount nAmount = AmountFromValue(request.params[0]);</span></a>
<a name="2246"><span class="lineNum">    2246 </span><span class="lineCov">         21 :     CFeeRate tx_fee_rate(nAmount, 1000);</span></a>
<a name="2247"><span class="lineNum">    2247 </span><span class="lineCov">         21 :     CFeeRate max_tx_fee_rate(pwallet-&gt;m_default_max_tx_fee, 1000);</span></a>
<a name="2248"><span class="lineNum">    2248 </span><span class="lineCov">         21 :     if (tx_fee_rate == CFeeRate(0)) {</span></a>
<a name="2249"><span class="lineNum">    2249 </span>            :         // automatic selection</a>
<a name="2250"><span class="lineNum">    2250 </span><span class="lineCov">         18 :     } else if (tx_fee_rate &lt; pwallet-&gt;chain().relayMinFee()) {</span></a>
<a name="2251"><span class="lineNum">    2251 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;txfee cannot be less than min relay tx fee (%s)&quot;, pwallet-&gt;chain().relayMinFee().ToString()));</span></a>
<a name="2252"><span class="lineNum">    2252 </span><span class="lineCov">         17 :     } else if (tx_fee_rate &lt; pwallet-&gt;m_min_fee) {</span></a>
<a name="2253"><span class="lineNum">    2253 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;txfee cannot be less than wallet min fee (%s)&quot;, pwallet-&gt;m_min_fee.ToString()));</span></a>
<a name="2254"><span class="lineNum">    2254 </span><span class="lineCov">         16 :     } else if (tx_fee_rate &gt; max_tx_fee_rate) {</span></a>
<a name="2255"><span class="lineNum">    2255 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;txfee cannot be more than wallet max tx fee (%s)&quot;, max_tx_fee_rate.ToString()));</span></a>
<a name="2256"><span class="lineNum">    2256 </span>            :     }</a>
<a name="2257"><span class="lineNum">    2257 </span>            : </a>
<a name="2258"><span class="lineNum">    2258 </span><span class="lineCov">         18 :     pwallet-&gt;m_pay_tx_fee = tx_fee_rate;</span></a>
<a name="2259"><span class="lineNum">    2259 </span><span class="lineCov">         18 :     return true;</span></a>
<a name="2260"><span class="lineNum">    2260 </span><span class="lineCov">         37 : }</span></a>
<a name="2261"><span class="lineNum">    2261 </span>            : </a>
<a name="2262"><span class="lineNum">    2262 </span><span class="lineCov">        306 : static UniValue getbalances(const JSONRPCRequest&amp; request)</span></a>
<a name="2263"><span class="lineNum">    2263 </span>            : {</a>
<a name="2264"><span class="lineNum">    2264 </span><span class="lineCov">       2754 :     RPCHelpMan{</span></a>
<a name="2265"><span class="lineNum">    2265 </span><span class="lineCov">        306 :         &quot;getbalances&quot;,</span></a>
<a name="2266"><span class="lineNum">    2266 </span><span class="lineCov">        306 :         &quot;Returns an object with all balances in &quot; + CURRENCY_UNIT + &quot;.\n&quot;,</span></a>
<a name="2267"><span class="lineNum">    2267 </span><span class="lineCov">        306 :         {},</span></a>
<a name="2268"><span class="lineNum">    2268 </span><span class="lineCov">        306 :         RPCResult{</span></a>
<a name="2269"><span class="lineNum">    2269 </span><span class="lineCov">        306 :             RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2270"><span class="lineNum">    2270 </span><span class="lineCov">        930 :             {</span></a>
<a name="2271"><span class="lineNum">    2271 </span><span class="lineCov">        612 :                 {RPCResult::Type::OBJ, &quot;mine&quot;, &quot;balances from outputs that the wallet can sign&quot;,</span></a>
<a name="2272"><span class="lineNum">    2272 </span><span class="lineCov">       1534 :                 {</span></a>
<a name="2273"><span class="lineNum">    2273 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;trusted&quot;, &quot;trusted balance (outputs created by the wallet or confirmed outputs)&quot;},</span></a>
<a name="2274"><span class="lineNum">    2274 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;untrusted_pending&quot;, &quot;untrusted pending balance (outputs created by others that are in the mempool)&quot;},</span></a>
<a name="2275"><span class="lineNum">    2275 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;immature&quot;, &quot;balance from immature coinbase outputs&quot;},</span></a>
<a name="2276"><span class="lineNum">    2276 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;used&quot;, &quot;(only present if avoid_reuse is set) balance from coins sent to addresses that were previously spent from (potentially privacy violating)&quot;},</span></a>
<a name="2277"><span class="lineNum">    2277 </span>            :                 }},</a>
<a name="2278"><span class="lineNum">    2278 </span><span class="lineCov">        612 :                 {RPCResult::Type::OBJ, &quot;watchonly&quot;, &quot;watchonly balances (not present if wallet does not watch anything)&quot;,</span></a>
<a name="2279"><span class="lineNum">    2279 </span><span class="lineCov">       1228 :                 {</span></a>
<a name="2280"><span class="lineNum">    2280 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;trusted&quot;, &quot;trusted balance (outputs created by the wallet or confirmed outputs)&quot;},</span></a>
<a name="2281"><span class="lineNum">    2281 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;untrusted_pending&quot;, &quot;untrusted pending balance (outputs created by others that are in the mempool)&quot;},</span></a>
<a name="2282"><span class="lineNum">    2282 </span><span class="lineCov">        306 :                     {RPCResult::Type::STR_AMOUNT, &quot;immature&quot;, &quot;balance from immature coinbase outputs&quot;},</span></a>
<a name="2283"><span class="lineNum">    2283 </span>            :                 }},</a>
<a name="2284"><span class="lineNum">    2284 </span>            :             }</a>
<a name="2285"><span class="lineNum">    2285 </span>            :             },</a>
<a name="2286"><span class="lineNum">    2286 </span><span class="lineCov">        306 :         RPCExamples{</span></a>
<a name="2287"><span class="lineNum">    2287 </span><span class="lineCov">        612 :             HelpExampleCli(&quot;getbalances&quot;, &quot;&quot;) +</span></a>
<a name="2288"><span class="lineNum">    2288 </span><span class="lineCov">        306 :             HelpExampleRpc(&quot;getbalances&quot;, &quot;&quot;)},</span></a>
<a name="2289"><span class="lineNum">    2289 </span><span class="lineCov">        306 :     }.Check(request);</span></a>
<a name="2290"><span class="lineNum">    2290 </span>            : </a>
<a name="2291"><span class="lineNum">    2291 </span><span class="lineCov">        302 :     std::shared_ptr&lt;CWallet&gt; const rpc_wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2292"><span class="lineNum">    2292 </span><span class="lineCov">        302 :     if (!rpc_wallet) return NullUniValue;</span></a>
<a name="2293"><span class="lineNum">    2293 </span><span class="lineCov">        298 :     CWallet&amp; wallet = *rpc_wallet;</span></a>
<a name="2294"><span class="lineNum">    2294 </span>            : </a>
<a name="2295"><span class="lineNum">    2295 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="2296"><span class="lineNum">    2296 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="2297"><span class="lineNum">    2297 </span><span class="lineCov">        298 :     wallet.BlockUntilSyncedToCurrentChain();</span></a>
<a name="2298"><span class="lineNum">    2298 </span>            : </a>
<a name="2299"><span class="lineNum">    2299 </span><span class="lineCov">        298 :     LOCK(wallet.cs_wallet);</span></a>
<a name="2300"><span class="lineNum">    2300 </span>            : </a>
<a name="2301"><span class="lineNum">    2301 </span><span class="lineCov">        298 :     const auto bal = wallet.GetBalance();</span></a>
<a name="2302"><span class="lineNum">    2302 </span><span class="lineCov">        298 :     UniValue balances{UniValue::VOBJ};</span></a>
<a name="2303"><span class="lineNum">    2303 </span>            :     {</a>
<a name="2304"><span class="lineNum">    2304 </span><span class="lineCov">        298 :         UniValue balances_mine{UniValue::VOBJ};</span></a>
<a name="2305"><span class="lineNum">    2305 </span><span class="lineCov">        298 :         balances_mine.pushKV(&quot;trusted&quot;, ValueFromAmount(bal.m_mine_trusted));</span></a>
<a name="2306"><span class="lineNum">    2306 </span><span class="lineCov">        298 :         balances_mine.pushKV(&quot;untrusted_pending&quot;, ValueFromAmount(bal.m_mine_untrusted_pending));</span></a>
<a name="2307"><span class="lineNum">    2307 </span><span class="lineCov">        298 :         balances_mine.pushKV(&quot;immature&quot;, ValueFromAmount(bal.m_mine_immature));</span></a>
<a name="2308"><span class="lineNum">    2308 </span><span class="lineCov">        298 :         if (wallet.IsWalletFlagSet(WALLET_FLAG_AVOID_REUSE)) {</span></a>
<a name="2309"><span class="lineNum">    2309 </span>            :             // If the AVOID_REUSE flag is set, bal has been set to just the un-reused address balance. Get</a>
<a name="2310"><span class="lineNum">    2310 </span>            :             // the total balance, and then subtract bal to get the reused address balance.</a>
<a name="2311"><span class="lineNum">    2311 </span><span class="lineCov">         28 :             const auto full_bal = wallet.GetBalance(0, false);</span></a>
<a name="2312"><span class="lineNum">    2312 </span><span class="lineCov">         28 :             balances_mine.pushKV(&quot;used&quot;, ValueFromAmount(full_bal.m_mine_trusted + full_bal.m_mine_untrusted_pending - bal.m_mine_trusted - bal.m_mine_untrusted_pending));</span></a>
<a name="2313"><span class="lineNum">    2313 </span><span class="lineCov">         28 :         }</span></a>
<a name="2314"><span class="lineNum">    2314 </span><span class="lineCov">        298 :         balances.pushKV(&quot;mine&quot;, balances_mine);</span></a>
<a name="2315"><span class="lineNum">    2315 </span><span class="lineCov">        298 :     }</span></a>
<a name="2316"><span class="lineNum">    2316 </span><span class="lineCov">        298 :     auto spk_man = wallet.GetLegacyScriptPubKeyMan();</span></a>
<a name="2317"><span class="lineNum">    2317 </span><span class="lineCov">        298 :     if (spk_man &amp;&amp; spk_man-&gt;HaveWatchOnly()) {</span></a>
<a name="2318"><span class="lineNum">    2318 </span><span class="lineCov">          6 :         UniValue balances_watchonly{UniValue::VOBJ};</span></a>
<a name="2319"><span class="lineNum">    2319 </span><span class="lineCov">          6 :         balances_watchonly.pushKV(&quot;trusted&quot;, ValueFromAmount(bal.m_watchonly_trusted));</span></a>
<a name="2320"><span class="lineNum">    2320 </span><span class="lineCov">          6 :         balances_watchonly.pushKV(&quot;untrusted_pending&quot;, ValueFromAmount(bal.m_watchonly_untrusted_pending));</span></a>
<a name="2321"><span class="lineNum">    2321 </span><span class="lineCov">          6 :         balances_watchonly.pushKV(&quot;immature&quot;, ValueFromAmount(bal.m_watchonly_immature));</span></a>
<a name="2322"><span class="lineNum">    2322 </span><span class="lineCov">          6 :         balances.pushKV(&quot;watchonly&quot;, balances_watchonly);</span></a>
<a name="2323"><span class="lineNum">    2323 </span><span class="lineCov">          6 :     }</span></a>
<a name="2324"><span class="lineNum">    2324 </span><span class="lineCov">        298 :     return balances;</span></a>
<a name="2325"><span class="lineNum">    2325 </span><span class="lineCov">        326 : }</span></a>
<a name="2326"><span class="lineNum">    2326 </span>            : </a>
<a name="2327"><span class="lineNum">    2327 </span><span class="lineCov">       1086 : static UniValue getwalletinfo(const JSONRPCRequest&amp; request)</span></a>
<a name="2328"><span class="lineNum">    2328 </span>            : {</a>
<a name="2329"><span class="lineNum">    2329 </span><span class="lineCov">      20634 :     RPCHelpMan{&quot;getwalletinfo&quot;,</span></a>
<a name="2330"><span class="lineNum">    2330 </span><span class="lineCov">       1086 :                 &quot;Returns an object containing various wallet state info.\n&quot;,</span></a>
<a name="2331"><span class="lineNum">    2331 </span><span class="lineCov">       1086 :                 {},</span></a>
<a name="2332"><span class="lineNum">    2332 </span><span class="lineCov">       1086 :                 RPCResult{</span></a>
<a name="2333"><span class="lineNum">    2333 </span><span class="lineCov">       1086 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2334"><span class="lineNum">    2334 </span><span class="lineCov">       1086 :                     {</span></a>
<a name="2335"><span class="lineNum">    2335 </span><span class="lineCov">      17388 :                         {</span></a>
<a name="2336"><span class="lineNum">    2336 </span><span class="lineCov">       1086 :                         {RPCResult::Type::STR, &quot;walletname&quot;, &quot;the wallet name&quot;},</span></a>
<a name="2337"><span class="lineNum">    2337 </span><span class="lineCov">       1086 :                         {RPCResult::Type::NUM, &quot;walletversion&quot;, &quot;the wallet version&quot;},</span></a>
<a name="2338"><span class="lineNum">    2338 </span><span class="lineCov">       1086 :                         {RPCResult::Type::STR_AMOUNT, &quot;balance&quot;, &quot;DEPRECATED. Identical to getbalances().mine.trusted&quot;},</span></a>
<a name="2339"><span class="lineNum">    2339 </span><span class="lineCov">       1086 :                         {RPCResult::Type::STR_AMOUNT, &quot;unconfirmed_balance&quot;, &quot;DEPRECATED. Identical to getbalances().mine.untrusted_pending&quot;},</span></a>
<a name="2340"><span class="lineNum">    2340 </span><span class="lineCov">       1086 :                         {RPCResult::Type::STR_AMOUNT, &quot;immature_balance&quot;, &quot;DEPRECATED. Identical to getbalances().mine.immature&quot;},</span></a>
<a name="2341"><span class="lineNum">    2341 </span><span class="lineCov">       1086 :                         {RPCResult::Type::NUM, &quot;txcount&quot;, &quot;the total number of transactions in the wallet&quot;},</span></a>
<a name="2342"><span class="lineNum">    2342 </span><span class="lineCov">       1086 :                         {RPCResult::Type::NUM_TIME, &quot;keypoololdest&quot;, &quot;the &quot; + UNIX_EPOCH_TIME + &quot; of the oldest pre-generated key in the key pool. Legacy wallets only.&quot;},</span></a>
<a name="2343"><span class="lineNum">    2343 </span><span class="lineCov">       1086 :                         {RPCResult::Type::NUM, &quot;keypoolsize&quot;, &quot;how many new keys are pre-generated (only counts external keys)&quot;},</span></a>
<a name="2344"><span class="lineNum">    2344 </span><span class="lineCov">       1086 :                         {RPCResult::Type::NUM, &quot;keypoolsize_hd_internal&quot;, &quot;how many new keys are pre-generated for internal use (used for change outputs, only appears if the wallet is using this feature, otherwise external keys are used)&quot;},</span></a>
<a name="2345"><span class="lineNum">    2345 </span><span class="lineCov">       1086 :                         {RPCResult::Type::NUM_TIME, &quot;unlocked_until&quot;, /* optional */ true, &quot;the &quot; + UNIX_EPOCH_TIME + &quot; until which the wallet is unlocked for transfers, or 0 if the wallet is locked (only present for passphrase-encrypted wallets)&quot;},</span></a>
<a name="2346"><span class="lineNum">    2346 </span><span class="lineCov">       1086 :                         {RPCResult::Type::STR_AMOUNT, &quot;paytxfee&quot;, &quot;the transaction fee configuration, set in &quot; + CURRENCY_UNIT + &quot;/kB&quot;},</span></a>
<a name="2347"><span class="lineNum">    2347 </span><span class="lineCov">       1086 :                         {RPCResult::Type::STR_HEX, &quot;hdseedid&quot;, /* optional */ true, &quot;the Hash160 of the HD seed (only present when HD is enabled)&quot;},</span></a>
<a name="2348"><span class="lineNum">    2348 </span><span class="lineCov">       1086 :                         {RPCResult::Type::BOOL, &quot;private_keys_enabled&quot;, &quot;false if privatekeys are disabled for this wallet (enforced watch-only wallet)&quot;},</span></a>
<a name="2349"><span class="lineNum">    2349 </span><span class="lineCov">       1086 :                         {RPCResult::Type::BOOL, &quot;avoid_reuse&quot;, &quot;whether this wallet tracks clean/dirty coins in terms of reuse&quot;},</span></a>
<a name="2350"><span class="lineNum">    2350 </span><span class="lineCov">       2172 :                         {RPCResult::Type::OBJ, &quot;scanning&quot;, &quot;current scanning details, or false if no scan is in progress&quot;,</span></a>
<a name="2351"><span class="lineNum">    2351 </span><span class="lineCov">       3262 :                         {</span></a>
<a name="2352"><span class="lineNum">    2352 </span><span class="lineCov">       1086 :                             {RPCResult::Type::NUM, &quot;duration&quot;, &quot;elapsed seconds since scan start&quot;},</span></a>
<a name="2353"><span class="lineNum">    2353 </span><span class="lineCov">       1086 :                             {RPCResult::Type::NUM, &quot;progress&quot;, &quot;scanning progress percentage [0.0, 1.0]&quot;},</span></a>
<a name="2354"><span class="lineNum">    2354 </span>            :                         }},</a>
<a name="2355"><span class="lineNum">    2355 </span><span class="lineCov">       1086 :                         {RPCResult::Type::BOOL, &quot;descriptors&quot;, &quot;whether this wallet uses descriptors for scriptPubKey management&quot;},</span></a>
<a name="2356"><span class="lineNum">    2356 </span>            :                     }},</a>
<a name="2357"><span class="lineNum">    2357 </span>            :                 },</a>
<a name="2358"><span class="lineNum">    2358 </span><span class="lineCov">       1086 :                 RPCExamples{</span></a>
<a name="2359"><span class="lineNum">    2359 </span><span class="lineCov">       1086 :                     HelpExampleCli(&quot;getwalletinfo&quot;, &quot;&quot;)</span></a>
<a name="2360"><span class="lineNum">    2360 </span><span class="lineCov">       1086 :             + HelpExampleRpc(&quot;getwalletinfo&quot;, &quot;&quot;)</span></a>
<a name="2361"><span class="lineNum">    2361 </span>            :                 },</a>
<a name="2362"><span class="lineNum">    2362 </span><span class="lineCov">       1086 :     }.Check(request);</span></a>
<a name="2363"><span class="lineNum">    2363 </span>            : </a>
<a name="2364"><span class="lineNum">    2364 </span><span class="lineCov">       1082 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2365"><span class="lineNum">    2365 </span><span class="lineCov">       1082 :     if (!wallet) return NullUniValue;</span></a>
<a name="2366"><span class="lineNum">    2366 </span><span class="lineCov">       1068 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="2367"><span class="lineNum">    2367 </span>            : </a>
<a name="2368"><span class="lineNum">    2368 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="2369"><span class="lineNum">    2369 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="2370"><span class="lineNum">    2370 </span><span class="lineCov">       1068 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="2371"><span class="lineNum">    2371 </span>            : </a>
<a name="2372"><span class="lineNum">    2372 </span><span class="lineCov">       1068 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2373"><span class="lineNum">    2373 </span>            : </a>
<a name="2374"><span class="lineNum">    2374 </span><span class="lineCov">       1068 :     UniValue obj(UniValue::VOBJ);</span></a>
<a name="2375"><span class="lineNum">    2375 </span>            : </a>
<a name="2376"><span class="lineNum">    2376 </span><span class="lineCov">       1068 :     size_t kpExternalSize = pwallet-&gt;KeypoolCountExternalKeys();</span></a>
<a name="2377"><span class="lineNum">    2377 </span><span class="lineCov">       1068 :     const auto bal = pwallet-&gt;GetBalance();</span></a>
<a name="2378"><span class="lineNum">    2378 </span><span class="lineCov">       1068 :     int64_t kp_oldest = pwallet-&gt;GetOldestKeyPoolTime();</span></a>
<a name="2379"><span class="lineNum">    2379 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;walletname&quot;, pwallet-&gt;GetName());</span></a>
<a name="2380"><span class="lineNum">    2380 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;walletversion&quot;, pwallet-&gt;GetVersion());</span></a>
<a name="2381"><span class="lineNum">    2381 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;balance&quot;, ValueFromAmount(bal.m_mine_trusted));</span></a>
<a name="2382"><span class="lineNum">    2382 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;unconfirmed_balance&quot;, ValueFromAmount(bal.m_mine_untrusted_pending));</span></a>
<a name="2383"><span class="lineNum">    2383 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;immature_balance&quot;, ValueFromAmount(bal.m_mine_immature));</span></a>
<a name="2384"><span class="lineNum">    2384 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;txcount&quot;,       (int)pwallet-&gt;mapWallet.size());</span></a>
<a name="2385"><span class="lineNum">    2385 </span><span class="lineCov">       1068 :     if (kp_oldest &gt; 0) {</span></a>
<a name="2386"><span class="lineNum">    2386 </span><span class="lineCov">        956 :         obj.pushKV(&quot;keypoololdest&quot;, kp_oldest);</span></a>
<a name="2387"><span class="lineNum">    2387 </span><span class="lineCov">        956 :     }</span></a>
<a name="2388"><span class="lineNum">    2388 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;keypoolsize&quot;, (int64_t)kpExternalSize);</span></a>
<a name="2389"><span class="lineNum">    2389 </span>            : </a>
<a name="2390"><span class="lineNum">    2390 </span><span class="lineCov">       1068 :     LegacyScriptPubKeyMan* spk_man = pwallet-&gt;GetLegacyScriptPubKeyMan();</span></a>
<a name="2391"><span class="lineNum">    2391 </span><span class="lineCov">       1068 :     if (spk_man) {</span></a>
<a name="2392"><span class="lineNum">    2392 </span><span class="lineCov">        949 :         CKeyID seed_id = spk_man-&gt;GetHDChain().seed_id;</span></a>
<a name="2393"><span class="lineNum">    2393 </span><span class="lineCov">        949 :         if (!seed_id.IsNull()) {</span></a>
<a name="2394"><span class="lineNum">    2394 </span><span class="lineCov">        869 :             obj.pushKV(&quot;hdseedid&quot;, seed_id.GetHex());</span></a>
<a name="2395"><span class="lineNum">    2395 </span><span class="lineCov">        869 :         }</span></a>
<a name="2396"><span class="lineNum">    2396 </span><span class="lineCov">        949 :     }</span></a>
<a name="2397"><span class="lineNum">    2397 </span>            : </a>
<a name="2398"><span class="lineNum">    2398 </span><span class="lineCov">       1068 :     if (pwallet-&gt;CanSupportFeature(FEATURE_HD_SPLIT)) {</span></a>
<a name="2399"><span class="lineNum">    2399 </span><span class="lineCov">       1067 :         obj.pushKV(&quot;keypoolsize_hd_internal&quot;,   (int64_t)(pwallet-&gt;GetKeyPoolSize() - kpExternalSize));</span></a>
<a name="2400"><span class="lineNum">    2400 </span><span class="lineCov">       1067 :     }</span></a>
<a name="2401"><span class="lineNum">    2401 </span><span class="lineCov">       1068 :     if (pwallet-&gt;IsCrypted()) {</span></a>
<a name="2402"><span class="lineNum">    2402 </span><span class="lineCov">         21 :         obj.pushKV(&quot;unlocked_until&quot;, pwallet-&gt;nRelockTime);</span></a>
<a name="2403"><span class="lineNum">    2403 </span><span class="lineCov">         21 :     }</span></a>
<a name="2404"><span class="lineNum">    2404 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;paytxfee&quot;, ValueFromAmount(pwallet-&gt;m_pay_tx_fee.GetFeePerK()));</span></a>
<a name="2405"><span class="lineNum">    2405 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;private_keys_enabled&quot;, !pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS));</span></a>
<a name="2406"><span class="lineNum">    2406 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;avoid_reuse&quot;, pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_AVOID_REUSE));</span></a>
<a name="2407"><span class="lineNum">    2407 </span><span class="lineCov">       1068 :     if (pwallet-&gt;IsScanning()) {</span></a>
<a name="2408"><span class="lineNum">    2408 </span><span class="lineNoCov">          0 :         UniValue scanning(UniValue::VOBJ);</span></a>
<a name="2409"><span class="lineNum">    2409 </span><span class="lineNoCov">          0 :         scanning.pushKV(&quot;duration&quot;, pwallet-&gt;ScanningDuration() / 1000);</span></a>
<a name="2410"><span class="lineNum">    2410 </span><span class="lineNoCov">          0 :         scanning.pushKV(&quot;progress&quot;, pwallet-&gt;ScanningProgress());</span></a>
<a name="2411"><span class="lineNum">    2411 </span><span class="lineNoCov">          0 :         obj.pushKV(&quot;scanning&quot;, scanning);</span></a>
<a name="2412"><span class="lineNum">    2412 </span><span class="lineNoCov">          0 :     } else {</span></a>
<a name="2413"><span class="lineNum">    2413 </span><span class="lineCov">       1068 :         obj.pushKV(&quot;scanning&quot;, false);</span></a>
<a name="2414"><span class="lineNum">    2414 </span>            :     }</a>
<a name="2415"><span class="lineNum">    2415 </span><span class="lineCov">       1068 :     obj.pushKV(&quot;descriptors&quot;, pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));</span></a>
<a name="2416"><span class="lineNum">    2416 </span><span class="lineCov">       1068 :     return obj;</span></a>
<a name="2417"><span class="lineNum">    2417 </span><span class="lineCov">       1088 : }</span></a>
<a name="2418"><span class="lineNum">    2418 </span>            : </a>
<a name="2419"><span class="lineNum">    2419 </span><span class="lineCov">         12 : static UniValue listwalletdir(const JSONRPCRequest&amp; request)</span></a>
<a name="2420"><span class="lineNum">    2420 </span>            : {</a>
<a name="2421"><span class="lineNum">    2421 </span><span class="lineCov">         36 :             RPCHelpMan{&quot;listwalletdir&quot;,</span></a>
<a name="2422"><span class="lineNum">    2422 </span><span class="lineCov">         12 :                 &quot;Returns a list of wallets in the wallet directory.\n&quot;,</span></a>
<a name="2423"><span class="lineNum">    2423 </span><span class="lineCov">         12 :                 {},</span></a>
<a name="2424"><span class="lineNum">    2424 </span><span class="lineCov">         12 :                 RPCResult{</span></a>
<a name="2425"><span class="lineNum">    2425 </span><span class="lineCov">         12 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2426"><span class="lineNum">    2426 </span><span class="lineCov">         24 :                     {</span></a>
<a name="2427"><span class="lineNum">    2427 </span><span class="lineCov">         24 :                         {RPCResult::Type::ARR, &quot;wallets&quot;, &quot;&quot;,</span></a>
<a name="2428"><span class="lineNum">    2428 </span><span class="lineCov">         24 :                         {</span></a>
<a name="2429"><span class="lineNum">    2429 </span><span class="lineCov">         24 :                             {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2430"><span class="lineNum">    2430 </span><span class="lineCov">         24 :                             {</span></a>
<a name="2431"><span class="lineNum">    2431 </span><span class="lineCov">         12 :                                 {RPCResult::Type::STR, &quot;name&quot;, &quot;The wallet name&quot;},</span></a>
<a name="2432"><span class="lineNum">    2432 </span>            :                             }},</a>
<a name="2433"><span class="lineNum">    2433 </span>            :                         }},</a>
<a name="2434"><span class="lineNum">    2434 </span>            :                     }</a>
<a name="2435"><span class="lineNum">    2435 </span>            :                 },</a>
<a name="2436"><span class="lineNum">    2436 </span><span class="lineCov">         12 :                 RPCExamples{</span></a>
<a name="2437"><span class="lineNum">    2437 </span><span class="lineCov">         12 :                     HelpExampleCli(&quot;listwalletdir&quot;, &quot;&quot;)</span></a>
<a name="2438"><span class="lineNum">    2438 </span><span class="lineCov">         12 :             + HelpExampleRpc(&quot;listwalletdir&quot;, &quot;&quot;)</span></a>
<a name="2439"><span class="lineNum">    2439 </span>            :                 },</a>
<a name="2440"><span class="lineNum">    2440 </span><span class="lineCov">         12 :             }.Check(request);</span></a>
<a name="2441"><span class="lineNum">    2441 </span>            : </a>
<a name="2442"><span class="lineNum">    2442 </span><span class="lineCov">          8 :     UniValue wallets(UniValue::VARR);</span></a>
<a name="2443"><span class="lineNum">    2443 </span><span class="lineCov">         70 :     for (const auto&amp; path : ListWalletDir()) {</span></a>
<a name="2444"><span class="lineNum">    2444 </span><span class="lineCov">         62 :         UniValue wallet(UniValue::VOBJ);</span></a>
<a name="2445"><span class="lineNum">    2445 </span><span class="lineCov">         62 :         wallet.pushKV(&quot;name&quot;, path.string());</span></a>
<a name="2446"><span class="lineNum">    2446 </span><span class="lineCov">         62 :         wallets.push_back(wallet);</span></a>
<a name="2447"><span class="lineNum">    2447 </span><span class="lineCov">         62 :     }</span></a>
<a name="2448"><span class="lineNum">    2448 </span>            : </a>
<a name="2449"><span class="lineNum">    2449 </span><span class="lineCov">          8 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="2450"><span class="lineNum">    2450 </span><span class="lineCov">          8 :     result.pushKV(&quot;wallets&quot;, wallets);</span></a>
<a name="2451"><span class="lineNum">    2451 </span>            :     return result;</a>
<a name="2452"><span class="lineNum">    2452 </span><span class="lineCov">         36 : }</span></a>
<a name="2453"><span class="lineNum">    2453 </span>            : </a>
<a name="2454"><span class="lineNum">    2454 </span><span class="lineCov">         66 : static UniValue listwallets(const JSONRPCRequest&amp; request)</span></a>
<a name="2455"><span class="lineNum">    2455 </span>            : {</a>
<a name="2456"><span class="lineNum">    2456 </span><span class="lineCov">        198 :             RPCHelpMan{&quot;listwallets&quot;,</span></a>
<a name="2457"><span class="lineNum">    2457 </span><span class="lineCov">         66 :                 &quot;Returns a list of currently loaded wallets.\n&quot;</span></a>
<a name="2458"><span class="lineNum">    2458 </span>            :                 &quot;For full information on the wallet, use \&quot;getwalletinfo\&quot;\n&quot;,</a>
<a name="2459"><span class="lineNum">    2459 </span><span class="lineCov">         66 :                 {},</span></a>
<a name="2460"><span class="lineNum">    2460 </span><span class="lineCov">         66 :                 RPCResult{</span></a>
<a name="2461"><span class="lineNum">    2461 </span><span class="lineCov">         66 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2462"><span class="lineNum">    2462 </span><span class="lineCov">        132 :                     {</span></a>
<a name="2463"><span class="lineNum">    2463 </span><span class="lineCov">         66 :                         {RPCResult::Type::STR, &quot;walletname&quot;, &quot;the wallet name&quot;},</span></a>
<a name="2464"><span class="lineNum">    2464 </span>            :                     }</a>
<a name="2465"><span class="lineNum">    2465 </span>            :                 },</a>
<a name="2466"><span class="lineNum">    2466 </span><span class="lineCov">         66 :                 RPCExamples{</span></a>
<a name="2467"><span class="lineNum">    2467 </span><span class="lineCov">         66 :                     HelpExampleCli(&quot;listwallets&quot;, &quot;&quot;)</span></a>
<a name="2468"><span class="lineNum">    2468 </span><span class="lineCov">         66 :             + HelpExampleRpc(&quot;listwallets&quot;, &quot;&quot;)</span></a>
<a name="2469"><span class="lineNum">    2469 </span>            :                 },</a>
<a name="2470"><span class="lineNum">    2470 </span><span class="lineCov">         66 :             }.Check(request);</span></a>
<a name="2471"><span class="lineNum">    2471 </span>            : </a>
<a name="2472"><span class="lineNum">    2472 </span><span class="lineCov">         62 :     UniValue obj(UniValue::VARR);</span></a>
<a name="2473"><span class="lineNum">    2473 </span>            : </a>
<a name="2474"><span class="lineNum">    2474 </span><span class="lineCov">        259 :     for (const std::shared_ptr&lt;CWallet&gt;&amp; wallet : GetWallets()) {</span></a>
<a name="2475"><span class="lineNum">    2475 </span><span class="lineCov">        197 :         LOCK(wallet-&gt;cs_wallet);</span></a>
<a name="2476"><span class="lineNum">    2476 </span><span class="lineCov">        197 :         obj.push_back(wallet-&gt;GetName());</span></a>
<a name="2477"><span class="lineNum">    2477 </span><span class="lineCov">        197 :     }</span></a>
<a name="2478"><span class="lineNum">    2478 </span>            : </a>
<a name="2479"><span class="lineNum">    2479 </span>            :     return obj;</a>
<a name="2480"><span class="lineNum">    2480 </span><span class="lineCov">         74 : }</span></a>
<a name="2481"><span class="lineNum">    2481 </span>            : </a>
<a name="2482"><span class="lineNum">    2482 </span><span class="lineCov">        139 : static UniValue loadwallet(const JSONRPCRequest&amp; request)</span></a>
<a name="2483"><span class="lineNum">    2483 </span>            : {</a>
<a name="2484"><span class="lineNum">    2484 </span><span class="lineCov">        717 :             RPCHelpMan{&quot;loadwallet&quot;,</span></a>
<a name="2485"><span class="lineNum">    2485 </span><span class="lineCov">        139 :                 &quot;\nLoads a wallet from a wallet file or directory.&quot;</span></a>
<a name="2486"><span class="lineNum">    2486 </span>            :                 &quot;\nNote that all wallet command-line options used when starting bitcoind will be&quot;</a>
<a name="2487"><span class="lineNum">    2487 </span>            :                 &quot;\napplied to the new wallet (eg -rescan, etc).\n&quot;,</a>
<a name="2488"><span class="lineNum">    2488 </span><span class="lineCov">        421 :                 {</span></a>
<a name="2489"><span class="lineNum">    2489 </span><span class="lineCov">        139 :                     {&quot;filename&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The wallet directory or .dat file.&quot;},</span></a>
<a name="2490"><span class="lineNum">    2490 </span><span class="lineCov">        139 :                     {&quot;load_on_startup&quot;, RPCArg::Type::BOOL, /* default */ &quot;null&quot;, &quot;Save wallet name to persistent settings and load on startup. True to add wallet to startup list, false to remove, null to leave unchanged.&quot;},</span></a>
<a name="2491"><span class="lineNum">    2491 </span>            :                 },</a>
<a name="2492"><span class="lineNum">    2492 </span><span class="lineCov">        139 :                 RPCResult{</span></a>
<a name="2493"><span class="lineNum">    2493 </span><span class="lineCov">        139 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2494"><span class="lineNum">    2494 </span><span class="lineCov">        421 :                     {</span></a>
<a name="2495"><span class="lineNum">    2495 </span><span class="lineCov">        139 :                         {RPCResult::Type::STR, &quot;name&quot;, &quot;The wallet name if loaded successfully.&quot;},</span></a>
<a name="2496"><span class="lineNum">    2496 </span><span class="lineCov">        139 :                         {RPCResult::Type::STR, &quot;warning&quot;, &quot;Warning message if wallet was not loaded cleanly.&quot;},</span></a>
<a name="2497"><span class="lineNum">    2497 </span>            :                     }</a>
<a name="2498"><span class="lineNum">    2498 </span>            :                 },</a>
<a name="2499"><span class="lineNum">    2499 </span><span class="lineCov">        139 :                 RPCExamples{</span></a>
<a name="2500"><span class="lineNum">    2500 </span><span class="lineCov">        139 :                     HelpExampleCli(&quot;loadwallet&quot;, &quot;\&quot;test.dat\&quot;&quot;)</span></a>
<a name="2501"><span class="lineNum">    2501 </span><span class="lineCov">        139 :             + HelpExampleRpc(&quot;loadwallet&quot;, &quot;\&quot;test.dat\&quot;&quot;)</span></a>
<a name="2502"><span class="lineNum">    2502 </span>            :                 },</a>
<a name="2503"><span class="lineNum">    2503 </span><span class="lineCov">        139 :             }.Check(request);</span></a>
<a name="2504"><span class="lineNum">    2504 </span>            : </a>
<a name="2505"><span class="lineNum">    2505 </span><span class="lineCov">        135 :     WalletContext&amp; context = EnsureWalletContext(request.context);</span></a>
<a name="2506"><span class="lineNum">    2506 </span><span class="lineCov">        135 :     const std::string name(request.params[0].get_str());</span></a>
<a name="2507"><span class="lineNum">    2507 </span>            : </a>
<a name="2508"><span class="lineNum">    2508 </span><span class="lineCov">        135 :     DatabaseOptions options;</span></a>
<a name="2509"><span class="lineNum">    2509 </span><span class="lineCov">        135 :     DatabaseStatus status;</span></a>
<a name="2510"><span class="lineNum">    2510 </span><span class="lineCov">        135 :     options.require_existing = true;</span></a>
<a name="2511"><span class="lineNum">    2511 </span><span class="lineCov">        135 :     bilingual_str error;</span></a>
<a name="2512"><span class="lineNum">    2512 </span><span class="lineCov">        135 :     std::vector&lt;bilingual_str&gt; warnings;</span></a>
<a name="2513"><span class="lineNum">    2513 </span><span class="lineCov">        135 :     Optional&lt;bool&gt; load_on_start = request.params[1].isNull() ? nullopt : Optional&lt;bool&gt;(request.params[1].get_bool());</span></a>
<a name="2514"><span class="lineNum">    2514 </span><span class="lineCov">        135 :     std::shared_ptr&lt;CWallet&gt; const wallet = LoadWallet(*context.chain, name, load_on_start, options, status, error, warnings);</span></a>
<a name="2515"><span class="lineNum">    2515 </span><span class="lineCov">        135 :     if (!wallet) {</span></a>
<a name="2516"><span class="lineNum">    2516 </span>            :         // Map bad format to not found, since bad format is returned when the</a>
<a name="2517"><span class="lineNum">    2517 </span>            :         // wallet directory exists, but doesn't contain a data file.</a>
<a name="2518"><span class="lineNum">    2518 </span><span class="lineCov">         22 :         RPCErrorCode code = status == DatabaseStatus::FAILED_NOT_FOUND || status == DatabaseStatus::FAILED_BAD_FORMAT ? RPC_WALLET_NOT_FOUND : RPC_WALLET_ERROR;</span></a>
<a name="2519"><span class="lineNum">    2519 </span><span class="lineCov">         22 :         throw JSONRPCError(code, error.original);</span></a>
<a name="2520"><span class="lineNum">    2520 </span><span class="lineCov">         22 :     }</span></a>
<a name="2521"><span class="lineNum">    2521 </span>            : </a>
<a name="2522"><span class="lineNum">    2522 </span><span class="lineCov">        113 :     UniValue obj(UniValue::VOBJ);</span></a>
<a name="2523"><span class="lineNum">    2523 </span><span class="lineCov">        113 :     obj.pushKV(&quot;name&quot;, wallet-&gt;GetName());</span></a>
<a name="2524"><span class="lineNum">    2524 </span><span class="lineCov">        113 :     obj.pushKV(&quot;warning&quot;, Join(warnings, Untranslated(&quot;\n&quot;)).original);</span></a>
<a name="2525"><span class="lineNum">    2525 </span>            : </a>
<a name="2526"><span class="lineNum">    2526 </span>            :     return obj;</a>
<a name="2527"><span class="lineNum">    2527 </span><span class="lineCov">        163 : }</span></a>
<a name="2528"><span class="lineNum">    2528 </span>            : </a>
<a name="2529"><span class="lineNum">    2529 </span><span class="lineCov">         14 : static UniValue setwalletflag(const JSONRPCRequest&amp; request)</span></a>
<a name="2530"><span class="lineNum">    2530 </span>            : {</a>
<a name="2531"><span class="lineNum">    2531 </span><span class="lineCov">         14 :             std::string flags = &quot;&quot;;</span></a>
<a name="2532"><span class="lineNum">    2532 </span><span class="lineCov">         84 :             for (auto&amp; it : WALLET_FLAG_MAP)</span></a>
<a name="2533"><span class="lineNum">    2533 </span><span class="lineCov">         70 :                 if (it.second &amp; MUTABLE_WALLET_FLAGS)</span></a>
<a name="2534"><span class="lineNum">    2534 </span><span class="lineCov">         14 :                     flags += (flags == &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + it.first;</span></a>
<a name="2535"><span class="lineNum">    2535 </span><span class="lineCov">         84 :             RPCHelpMan{&quot;setwalletflag&quot;,</span></a>
<a name="2536"><span class="lineNum">    2536 </span><span class="lineCov">         14 :                 &quot;\nChange the state of the given wallet flag for a wallet.\n&quot;,</span></a>
<a name="2537"><span class="lineNum">    2537 </span><span class="lineCov">         46 :                 {</span></a>
<a name="2538"><span class="lineNum">    2538 </span><span class="lineCov">         14 :                     {&quot;flag&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The name of the flag to change. Current available flags: &quot; + flags},</span></a>
<a name="2539"><span class="lineNum">    2539 </span><span class="lineCov">         14 :                     {&quot;value&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;The new state.&quot;},</span></a>
<a name="2540"><span class="lineNum">    2540 </span>            :                 },</a>
<a name="2541"><span class="lineNum">    2541 </span><span class="lineCov">         14 :                 RPCResult{</span></a>
<a name="2542"><span class="lineNum">    2542 </span><span class="lineCov">         14 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2543"><span class="lineNum">    2543 </span><span class="lineCov">         60 :                     {</span></a>
<a name="2544"><span class="lineNum">    2544 </span><span class="lineCov">         14 :                         {RPCResult::Type::STR, &quot;flag_name&quot;, &quot;The name of the flag that was modified&quot;},</span></a>
<a name="2545"><span class="lineNum">    2545 </span><span class="lineCov">         14 :                         {RPCResult::Type::BOOL, &quot;flag_state&quot;, &quot;The new state of the flag&quot;},</span></a>
<a name="2546"><span class="lineNum">    2546 </span><span class="lineCov">         14 :                         {RPCResult::Type::STR, &quot;warnings&quot;, &quot;Any warnings associated with the change&quot;},</span></a>
<a name="2547"><span class="lineNum">    2547 </span>            :                     }</a>
<a name="2548"><span class="lineNum">    2548 </span>            :                 },</a>
<a name="2549"><span class="lineNum">    2549 </span><span class="lineCov">         14 :                 RPCExamples{</span></a>
<a name="2550"><span class="lineNum">    2550 </span><span class="lineCov">         14 :                     HelpExampleCli(&quot;setwalletflag&quot;, &quot;avoid_reuse&quot;)</span></a>
<a name="2551"><span class="lineNum">    2551 </span><span class="lineCov">         14 :                   + HelpExampleRpc(&quot;setwalletflag&quot;, &quot;\&quot;avoid_reuse\&quot;&quot;)</span></a>
<a name="2552"><span class="lineNum">    2552 </span>            :                 },</a>
<a name="2553"><span class="lineNum">    2553 </span><span class="lineCov">         14 :             }.Check(request);</span></a>
<a name="2554"><span class="lineNum">    2554 </span>            : </a>
<a name="2555"><span class="lineNum">    2555 </span><span class="lineCov">         10 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2556"><span class="lineNum">    2556 </span><span class="lineCov">         10 :     if (!wallet) return NullUniValue;</span></a>
<a name="2557"><span class="lineNum">    2557 </span><span class="lineCov">         10 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="2558"><span class="lineNum">    2558 </span>            : </a>
<a name="2559"><span class="lineNum">    2559 </span><span class="lineCov">         10 :     std::string flag_str = request.params[0].get_str();</span></a>
<a name="2560"><span class="lineNum">    2560 </span><span class="lineCov">         10 :     bool value = request.params[1].isNull() || request.params[1].get_bool();</span></a>
<a name="2561"><span class="lineNum">    2561 </span>            : </a>
<a name="2562"><span class="lineNum">    2562 </span><span class="lineCov">         10 :     if (!WALLET_FLAG_MAP.count(flag_str)) {</span></a>
<a name="2563"><span class="lineNum">    2563 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Unknown wallet flag: %s&quot;, flag_str));</span></a>
<a name="2564"><span class="lineNum">    2564 </span>            :     }</a>
<a name="2565"><span class="lineNum">    2565 </span>            : </a>
<a name="2566"><span class="lineNum">    2566 </span><span class="lineCov">         10 :     auto flag = WALLET_FLAG_MAP.at(flag_str);</span></a>
<a name="2567"><span class="lineNum">    2567 </span>            : </a>
<a name="2568"><span class="lineNum">    2568 </span><span class="lineCov">         10 :     if (!(flag &amp; MUTABLE_WALLET_FLAGS)) {</span></a>
<a name="2569"><span class="lineNum">    2569 </span><span class="lineCov">          4 :         throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Wallet flag is immutable: %s&quot;, flag_str));</span></a>
<a name="2570"><span class="lineNum">    2570 </span>            :     }</a>
<a name="2571"><span class="lineNum">    2571 </span>            : </a>
<a name="2572"><span class="lineNum">    2572 </span><span class="lineCov">          6 :     UniValue res(UniValue::VOBJ);</span></a>
<a name="2573"><span class="lineNum">    2573 </span>            : </a>
<a name="2574"><span class="lineNum">    2574 </span><span class="lineCov">          6 :     if (pwallet-&gt;IsWalletFlagSet(flag) == value) {</span></a>
<a name="2575"><span class="lineNum">    2575 </span><span class="lineCov">          4 :         throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Wallet flag is already set to %s: %s&quot;, value ? &quot;true&quot; : &quot;false&quot;, flag_str));</span></a>
<a name="2576"><span class="lineNum">    2576 </span>            :     }</a>
<a name="2577"><span class="lineNum">    2577 </span>            : </a>
<a name="2578"><span class="lineNum">    2578 </span><span class="lineCov">          2 :     res.pushKV(&quot;flag_name&quot;, flag_str);</span></a>
<a name="2579"><span class="lineNum">    2579 </span><span class="lineCov">          2 :     res.pushKV(&quot;flag_state&quot;, value);</span></a>
<a name="2580"><span class="lineNum">    2580 </span>            : </a>
<a name="2581"><span class="lineNum">    2581 </span><span class="lineCov">          2 :     if (value) {</span></a>
<a name="2582"><span class="lineNum">    2582 </span><span class="lineCov">          2 :         pwallet-&gt;SetWalletFlag(flag);</span></a>
<a name="2583"><span class="lineNum">    2583 </span>            :     } else {</a>
<a name="2584"><span class="lineNum">    2584 </span><span class="lineNoCov">          0 :         pwallet-&gt;UnsetWalletFlag(flag);</span></a>
<a name="2585"><span class="lineNum">    2585 </span>            :     }</a>
<a name="2586"><span class="lineNum">    2586 </span>            : </a>
<a name="2587"><span class="lineNum">    2587 </span><span class="lineCov">          2 :     if (flag &amp;&amp; value &amp;&amp; WALLET_FLAG_CAVEATS.count(flag)) {</span></a>
<a name="2588"><span class="lineNum">    2588 </span><span class="lineCov">          2 :         res.pushKV(&quot;warnings&quot;, WALLET_FLAG_CAVEATS.at(flag));</span></a>
<a name="2589"><span class="lineNum">    2589 </span><span class="lineCov">          2 :     }</span></a>
<a name="2590"><span class="lineNum">    2590 </span>            : </a>
<a name="2591"><span class="lineNum">    2591 </span><span class="lineCov">          2 :     return res;</span></a>
<a name="2592"><span class="lineNum">    2592 </span><span class="lineCov">         38 : }</span></a>
<a name="2593"><span class="lineNum">    2593 </span>            : </a>
<a name="2594"><span class="lineNum">    2594 </span><span class="lineCov">        368 : static UniValue createwallet(const JSONRPCRequest&amp; request)</span></a>
<a name="2595"><span class="lineNum">    2595 </span>            : {</a>
<a name="2596"><span class="lineNum">    2596 </span><span class="lineCov">       3684 :     RPCHelpMan{</span></a>
<a name="2597"><span class="lineNum">    2597 </span><span class="lineCov">        368 :         &quot;createwallet&quot;,</span></a>
<a name="2598"><span class="lineNum">    2598 </span><span class="lineCov">        368 :         &quot;\nCreates and loads a new wallet.\n&quot;,</span></a>
<a name="2599"><span class="lineNum">    2599 </span><span class="lineCov">       2948 :         {</span></a>
<a name="2600"><span class="lineNum">    2600 </span><span class="lineCov">        368 :             {&quot;wallet_name&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The name for the new wallet. If this is a path, the wallet will be created at the path location.&quot;},</span></a>
<a name="2601"><span class="lineNum">    2601 </span><span class="lineCov">        368 :             {&quot;disable_private_keys&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Disable the possibility of private keys (only watchonlys are possible in this mode).&quot;},</span></a>
<a name="2602"><span class="lineNum">    2602 </span><span class="lineCov">        368 :             {&quot;blank&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Create a blank wallet. A blank wallet has no keys or HD seed. One can be set using sethdseed.&quot;},</span></a>
<a name="2603"><span class="lineNum">    2603 </span><span class="lineCov">        368 :             {&quot;passphrase&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED, &quot;Encrypt the wallet with this passphrase.&quot;},</span></a>
<a name="2604"><span class="lineNum">    2604 </span><span class="lineCov">        368 :             {&quot;avoid_reuse&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Keep track of coin reuse, and treat dirty and clean coins differently with privacy considerations in mind.&quot;},</span></a>
<a name="2605"><span class="lineNum">    2605 </span><span class="lineCov">        368 :             {&quot;descriptors&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Create a native descriptor wallet. The wallet will use descriptors internally to handle address creation&quot;},</span></a>
<a name="2606"><span class="lineNum">    2606 </span><span class="lineCov">        368 :             {&quot;load_on_startup&quot;, RPCArg::Type::BOOL, /* default */ &quot;null&quot;, &quot;Save wallet name to persistent settings and load on startup. True to add wallet to startup list, false to remove, null to leave unchanged.&quot;},</span></a>
<a name="2607"><span class="lineNum">    2607 </span>            :         },</a>
<a name="2608"><span class="lineNum">    2608 </span><span class="lineCov">        368 :         RPCResult{</span></a>
<a name="2609"><span class="lineNum">    2609 </span><span class="lineCov">        368 :             RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2610"><span class="lineNum">    2610 </span><span class="lineCov">       1108 :             {</span></a>
<a name="2611"><span class="lineNum">    2611 </span><span class="lineCov">        368 :                 {RPCResult::Type::STR, &quot;name&quot;, &quot;The wallet name if created successfully. If the wallet was created using a full path, the wallet_name will be the full path.&quot;},</span></a>
<a name="2612"><span class="lineNum">    2612 </span><span class="lineCov">        368 :                 {RPCResult::Type::STR, &quot;warning&quot;, &quot;Warning message if wallet was not loaded cleanly.&quot;},</span></a>
<a name="2613"><span class="lineNum">    2613 </span>            :             }</a>
<a name="2614"><span class="lineNum">    2614 </span>            :         },</a>
<a name="2615"><span class="lineNum">    2615 </span><span class="lineCov">        368 :         RPCExamples{</span></a>
<a name="2616"><span class="lineNum">    2616 </span><span class="lineCov">        368 :             HelpExampleCli(&quot;createwallet&quot;, &quot;\&quot;testwallet\&quot;&quot;)</span></a>
<a name="2617"><span class="lineNum">    2617 </span><span class="lineCov">        368 :             + HelpExampleRpc(&quot;createwallet&quot;, &quot;\&quot;testwallet\&quot;&quot;)</span></a>
<a name="2618"><span class="lineNum">    2618 </span>            :         },</a>
<a name="2619"><span class="lineNum">    2619 </span><span class="lineCov">        368 :     }.Check(request);</span></a>
<a name="2620"><span class="lineNum">    2620 </span>            : </a>
<a name="2621"><span class="lineNum">    2621 </span><span class="lineCov">        364 :     WalletContext&amp; context = EnsureWalletContext(request.context);</span></a>
<a name="2622"><span class="lineNum">    2622 </span>            :     uint64_t flags = 0;</a>
<a name="2623"><span class="lineNum">    2623 </span><span class="lineCov">        364 :     if (!request.params[1].isNull() &amp;&amp; request.params[1].get_bool()) {</span></a>
<a name="2624"><span class="lineNum">    2624 </span>            :         flags |= WALLET_FLAG_DISABLE_PRIVATE_KEYS;</a>
<a name="2625"><span class="lineNum">    2625 </span><span class="lineCov">         31 :     }</span></a>
<a name="2626"><span class="lineNum">    2626 </span>            : </a>
<a name="2627"><span class="lineNum">    2627 </span><span class="lineCov">        364 :     if (!request.params[2].isNull() &amp;&amp; request.params[2].get_bool()) {</span></a>
<a name="2628"><span class="lineNum">    2628 </span><span class="lineCov">         24 :         flags |= WALLET_FLAG_BLANK_WALLET;</span></a>
<a name="2629"><span class="lineNum">    2629 </span><span class="lineCov">         24 :     }</span></a>
<a name="2630"><span class="lineNum">    2630 </span><span class="lineCov">        364 :     SecureString passphrase;</span></a>
<a name="2631"><span class="lineNum">    2631 </span><span class="lineCov">        364 :     passphrase.reserve(100);</span></a>
<a name="2632"><span class="lineNum">    2632 </span><span class="lineCov">        364 :     std::vector&lt;bilingual_str&gt; warnings;</span></a>
<a name="2633"><span class="lineNum">    2633 </span><span class="lineCov">        364 :     if (!request.params[3].isNull()) {</span></a>
<a name="2634"><span class="lineNum">    2634 </span><span class="lineCov">        361 :         passphrase = request.params[3].get_str().c_str();</span></a>
<a name="2635"><span class="lineNum">    2635 </span><span class="lineCov">        361 :         if (passphrase.empty()) {</span></a>
<a name="2636"><span class="lineNum">    2636 </span>            :             // Empty string means unencrypted</a>
<a name="2637"><span class="lineNum">    2637 </span><span class="lineCov">        354 :             warnings.emplace_back(Untranslated(&quot;Empty string given as passphrase, wallet will not be encrypted.&quot;));</span></a>
<a name="2638"><span class="lineNum">    2638 </span><span class="lineCov">        354 :         }</span></a>
<a name="2639"><span class="lineNum">    2639 </span>            :     }</a>
<a name="2640"><span class="lineNum">    2640 </span>            : </a>
<a name="2641"><span class="lineNum">    2641 </span><span class="lineCov">        364 :     if (!request.params[4].isNull() &amp;&amp; request.params[4].get_bool()) {</span></a>
<a name="2642"><span class="lineNum">    2642 </span><span class="lineCov">          2 :         flags |= WALLET_FLAG_AVOID_REUSE;</span></a>
<a name="2643"><span class="lineNum">    2643 </span><span class="lineCov">          2 :     }</span></a>
<a name="2644"><span class="lineNum">    2644 </span><span class="lineCov">        364 :     if (!request.params[5].isNull() &amp;&amp; request.params[5].get_bool()) {</span></a>
<a name="2645"><span class="lineNum">    2645 </span><span class="lineCov">         43 :         flags |= WALLET_FLAG_DESCRIPTORS;</span></a>
<a name="2646"><span class="lineNum">    2646 </span><span class="lineCov">         43 :         warnings.emplace_back(Untranslated(&quot;Wallet is an experimental descriptor wallet&quot;));</span></a>
<a name="2647"><span class="lineNum">    2647 </span><span class="lineCov">         43 :     }</span></a>
<a name="2648"><span class="lineNum">    2648 </span>            : </a>
<a name="2649"><span class="lineNum">    2649 </span><span class="lineCov">        364 :     DatabaseOptions options;</span></a>
<a name="2650"><span class="lineNum">    2650 </span><span class="lineCov">        364 :     DatabaseStatus status;</span></a>
<a name="2651"><span class="lineNum">    2651 </span><span class="lineCov">        364 :     options.require_create = true;</span></a>
<a name="2652"><span class="lineNum">    2652 </span><span class="lineCov">        364 :     options.create_flags = flags;</span></a>
<a name="2653"><span class="lineNum">    2653 </span><span class="lineCov">        364 :     options.create_passphrase = passphrase;</span></a>
<a name="2654"><span class="lineNum">    2654 </span><span class="lineCov">        364 :     bilingual_str error;</span></a>
<a name="2655"><span class="lineNum">    2655 </span><span class="lineCov">        364 :     Optional&lt;bool&gt; load_on_start = request.params[6].isNull() ? nullopt : Optional&lt;bool&gt;(request.params[6].get_bool());</span></a>
<a name="2656"><span class="lineNum">    2656 </span><span class="lineCov">        364 :     std::shared_ptr&lt;CWallet&gt; wallet = CreateWallet(*context.chain, request.params[0].get_str(), load_on_start, options, status, error, warnings);</span></a>
<a name="2657"><span class="lineNum">    2657 </span><span class="lineCov">        364 :     if (!wallet) {</span></a>
<a name="2658"><span class="lineNum">    2658 </span><span class="lineCov">          4 :         RPCErrorCode code = status == DatabaseStatus::FAILED_ENCRYPT ? RPC_WALLET_ENCRYPTION_FAILED : RPC_WALLET_ERROR;</span></a>
<a name="2659"><span class="lineNum">    2659 </span><span class="lineCov">          4 :         throw JSONRPCError(code, error.original);</span></a>
<a name="2660"><span class="lineNum">    2660 </span><span class="lineCov">          4 :     }</span></a>
<a name="2661"><span class="lineNum">    2661 </span>            : </a>
<a name="2662"><span class="lineNum">    2662 </span><span class="lineCov">        360 :     UniValue obj(UniValue::VOBJ);</span></a>
<a name="2663"><span class="lineNum">    2663 </span><span class="lineCov">        360 :     obj.pushKV(&quot;name&quot;, wallet-&gt;GetName());</span></a>
<a name="2664"><span class="lineNum">    2664 </span><span class="lineCov">        360 :     obj.pushKV(&quot;warning&quot;, Join(warnings, Untranslated(&quot;\n&quot;)).original);</span></a>
<a name="2665"><span class="lineNum">    2665 </span>            : </a>
<a name="2666"><span class="lineNum">    2666 </span>            :     return obj;</a>
<a name="2667"><span class="lineNum">    2667 </span><span class="lineCov">        412 : }</span></a>
<a name="2668"><span class="lineNum">    2668 </span>            : </a>
<a name="2669"><span class="lineNum">    2669 </span><span class="lineCov">        131 : static UniValue unloadwallet(const JSONRPCRequest&amp; request)</span></a>
<a name="2670"><span class="lineNum">    2670 </span>            : {</a>
<a name="2671"><span class="lineNum">    2671 </span><span class="lineCov">        532 :             RPCHelpMan{&quot;unloadwallet&quot;,</span></a>
<a name="2672"><span class="lineNum">    2672 </span><span class="lineCov">        131 :                 &quot;Unloads the wallet referenced by the request endpoint otherwise unloads the wallet specified in the argument.\n&quot;</span></a>
<a name="2673"><span class="lineNum">    2673 </span>            :                 &quot;Specifying the wallet name on a wallet endpoint is invalid.&quot;,</a>
<a name="2674"><span class="lineNum">    2674 </span><span class="lineCov">        397 :                 {</span></a>
<a name="2675"><span class="lineNum">    2675 </span><span class="lineCov">        131 :                     {&quot;wallet_name&quot;, RPCArg::Type::STR, /* default */ &quot;the wallet name from the RPC request&quot;, &quot;The name of the wallet to unload.&quot;},</span></a>
<a name="2676"><span class="lineNum">    2676 </span><span class="lineCov">        131 :                     {&quot;load_on_startup&quot;, RPCArg::Type::BOOL, /* default */ &quot;null&quot;, &quot;Save wallet name to persistent settings and load on startup. True to add wallet to startup list, false to remove, null to leave unchanged.&quot;},</span></a>
<a name="2677"><span class="lineNum">    2677 </span>            :                 },</a>
<a name="2678"><span class="lineNum">    2678 </span><span class="lineCov">        262 :                 RPCResult{RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;, {</span></a>
<a name="2679"><span class="lineNum">    2679 </span><span class="lineCov">        131 :                     {RPCResult::Type::STR, &quot;warning&quot;, &quot;Warning message if wallet was not unloaded cleanly.&quot;},</span></a>
<a name="2680"><span class="lineNum">    2680 </span>            :                 }},</a>
<a name="2681"><span class="lineNum">    2681 </span><span class="lineCov">        131 :                 RPCExamples{</span></a>
<a name="2682"><span class="lineNum">    2682 </span><span class="lineCov">        131 :                     HelpExampleCli(&quot;unloadwallet&quot;, &quot;wallet_name&quot;)</span></a>
<a name="2683"><span class="lineNum">    2683 </span><span class="lineCov">        131 :             + HelpExampleRpc(&quot;unloadwallet&quot;, &quot;wallet_name&quot;)</span></a>
<a name="2684"><span class="lineNum">    2684 </span>            :                 },</a>
<a name="2685"><span class="lineNum">    2685 </span><span class="lineCov">        131 :             }.Check(request);</span></a>
<a name="2686"><span class="lineNum">    2686 </span>            : </a>
<a name="2687"><span class="lineNum">    2687 </span><span class="lineCov">        127 :     std::string wallet_name;</span></a>
<a name="2688"><span class="lineNum">    2688 </span><span class="lineCov">        127 :     if (GetWalletNameFromJSONRPCRequest(request, wallet_name)) {</span></a>
<a name="2689"><span class="lineNum">    2689 </span><span class="lineCov">         35 :         if (!request.params[0].isNull()) {</span></a>
<a name="2690"><span class="lineNum">    2690 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Cannot unload the requested wallet&quot;);</span></a>
<a name="2691"><span class="lineNum">    2691 </span>            :         }</a>
<a name="2692"><span class="lineNum">    2692 </span>            :     } else {</a>
<a name="2693"><span class="lineNum">    2693 </span><span class="lineCov">         92 :         wallet_name = request.params[0].get_str();</span></a>
<a name="2694"><span class="lineNum">    2694 </span>            :     }</a>
<a name="2695"><span class="lineNum">    2695 </span>            : </a>
<a name="2696"><span class="lineNum">    2696 </span><span class="lineCov">        123 :     std::shared_ptr&lt;CWallet&gt; wallet = GetWallet(wallet_name);</span></a>
<a name="2697"><span class="lineNum">    2697 </span><span class="lineCov">        123 :     if (!wallet) {</span></a>
<a name="2698"><span class="lineNum">    2698 </span><span class="lineCov">          4 :         throw JSONRPCError(RPC_WALLET_NOT_FOUND, &quot;Requested wallet does not exist or is not loaded&quot;);</span></a>
<a name="2699"><span class="lineNum">    2699 </span>            :     }</a>
<a name="2700"><span class="lineNum">    2700 </span>            : </a>
<a name="2701"><span class="lineNum">    2701 </span>            :     // Release the &quot;main&quot; shared pointer and prevent further notifications.</a>
<a name="2702"><span class="lineNum">    2702 </span>            :     // Note that any attempt to load the same wallet would fail until the wallet</a>
<a name="2703"><span class="lineNum">    2703 </span>            :     // is destroyed (see CheckUniqueFileid).</a>
<a name="2704"><span class="lineNum">    2704 </span><span class="lineCov">        119 :     std::vector&lt;bilingual_str&gt; warnings;</span></a>
<a name="2705"><span class="lineNum">    2705 </span><span class="lineCov">        119 :     Optional&lt;bool&gt; load_on_start = request.params[1].isNull() ? nullopt : Optional&lt;bool&gt;(request.params[1].get_bool());</span></a>
<a name="2706"><span class="lineNum">    2706 </span><span class="lineCov">        119 :     if (!RemoveWallet(wallet, load_on_start, warnings)) {</span></a>
<a name="2707"><span class="lineNum">    2707 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_MISC_ERROR, &quot;Requested wallet already unloaded&quot;);</span></a>
<a name="2708"><span class="lineNum">    2708 </span>            :     }</a>
<a name="2709"><span class="lineNum">    2709 </span>            : </a>
<a name="2710"><span class="lineNum">    2710 </span><span class="lineCov">        119 :     UnloadWallet(std::move(wallet));</span></a>
<a name="2711"><span class="lineNum">    2711 </span>            : </a>
<a name="2712"><span class="lineNum">    2712 </span><span class="lineCov">        119 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="2713"><span class="lineNum">    2713 </span><span class="lineCov">        119 :     result.pushKV(&quot;warning&quot;, Join(warnings, Untranslated(&quot;\n&quot;)).original);</span></a>
<a name="2714"><span class="lineNum">    2714 </span>            :     return result;</a>
<a name="2715"><span class="lineNum">    2715 </span><span class="lineCov">        155 : }</span></a>
<a name="2716"><span class="lineNum">    2716 </span>            : </a>
<a name="2717"><span class="lineNum">    2717 </span><span class="lineCov">        399 : static UniValue listunspent(const JSONRPCRequest&amp; request)</span></a>
<a name="2718"><span class="lineNum">    2718 </span>            : {</a>
<a name="2719"><span class="lineNum">    2719 </span><span class="lineCov">       9177 :     RPCHelpMan{</span></a>
<a name="2720"><span class="lineNum">    2720 </span><span class="lineCov">        399 :                 &quot;listunspent&quot;,</span></a>
<a name="2721"><span class="lineNum">    2721 </span><span class="lineCov">        399 :                 &quot;\nReturns array of unspent transaction outputs\n&quot;</span></a>
<a name="2722"><span class="lineNum">    2722 </span>            :                 &quot;with between minconf and maxconf (inclusive) confirmations.\n&quot;</a>
<a name="2723"><span class="lineNum">    2723 </span>            :                 &quot;Optionally filter to only include txouts paid to specified addresses.\n&quot;,</a>
<a name="2724"><span class="lineNum">    2724 </span><span class="lineCov">       2406 :                 {</span></a>
<a name="2725"><span class="lineNum">    2725 </span><span class="lineCov">        399 :                     {&quot;minconf&quot;, RPCArg::Type::NUM, /* default */ &quot;1&quot;, &quot;The minimum confirmations to filter&quot;},</span></a>
<a name="2726"><span class="lineNum">    2726 </span><span class="lineCov">        399 :                     {&quot;maxconf&quot;, RPCArg::Type::NUM, /* default */ &quot;9999999&quot;, &quot;The maximum confirmations to filter&quot;},</span></a>
<a name="2727"><span class="lineNum">    2727 </span><span class="lineCov">        798 :                     {&quot;addresses&quot;, RPCArg::Type::ARR, /* default */ &quot;empty array&quot;, &quot;The bitcoin addresses to filter&quot;,</span></a>
<a name="2728"><span class="lineNum">    2728 </span><span class="lineCov">        798 :                         {</span></a>
<a name="2729"><span class="lineNum">    2729 </span><span class="lineCov">        399 :                             {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED, &quot;bitcoin address&quot;},</span></a>
<a name="2730"><span class="lineNum">    2730 </span>            :                         },</a>
<a name="2731"><span class="lineNum">    2731 </span>            :                     },</a>
<a name="2732"><span class="lineNum">    2732 </span><span class="lineCov">        399 :                     {&quot;include_unsafe&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Include outputs that are not safe to spend\n&quot;</span></a>
<a name="2733"><span class="lineNum">    2733 </span>            :             &quot;                  See description of \&quot;safe\&quot; attribute below.&quot;},</a>
<a name="2734"><span class="lineNum">    2734 </span><span class="lineCov">        798 :                     {&quot;query_options&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;JSON with query options&quot;,</span></a>
<a name="2735"><span class="lineNum">    2735 </span><span class="lineCov">       1999 :                         {</span></a>
<a name="2736"><span class="lineNum">    2736 </span><span class="lineCov">        399 :                             {&quot;minimumAmount&quot;, RPCArg::Type::AMOUNT, /* default */ &quot;0&quot;, &quot;Minimum value of each UTXO in &quot; + CURRENCY_UNIT + &quot;&quot;},</span></a>
<a name="2737"><span class="lineNum">    2737 </span><span class="lineCov">        399 :                             {&quot;maximumAmount&quot;, RPCArg::Type::AMOUNT, /* default */ &quot;unlimited&quot;, &quot;Maximum value of each UTXO in &quot; + CURRENCY_UNIT + &quot;&quot;},</span></a>
<a name="2738"><span class="lineNum">    2738 </span><span class="lineCov">        399 :                             {&quot;maximumCount&quot;, RPCArg::Type::NUM, /* default */ &quot;unlimited&quot;, &quot;Maximum number of UTXOs&quot;},</span></a>
<a name="2739"><span class="lineNum">    2739 </span><span class="lineCov">        399 :                             {&quot;minimumSumAmount&quot;, RPCArg::Type::AMOUNT, /* default */ &quot;unlimited&quot;, &quot;Minimum sum value of all UTXOs in &quot; + CURRENCY_UNIT + &quot;&quot;},</span></a>
<a name="2740"><span class="lineNum">    2740 </span>            :                         },</a>
<a name="2741"><span class="lineNum">    2741 </span><span class="lineCov">        399 :                         &quot;query_options&quot;},</span></a>
<a name="2742"><span class="lineNum">    2742 </span>            :                 },</a>
<a name="2743"><span class="lineNum">    2743 </span><span class="lineCov">        399 :                 RPCResult{</span></a>
<a name="2744"><span class="lineNum">    2744 </span><span class="lineCov">        399 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2745"><span class="lineNum">    2745 </span><span class="lineCov">        798 :                     {</span></a>
<a name="2746"><span class="lineNum">    2746 </span><span class="lineCov">        798 :                         {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="2747"><span class="lineNum">    2747 </span><span class="lineCov">       5989 :                         {</span></a>
<a name="2748"><span class="lineNum">    2748 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;the transaction id&quot;},</span></a>
<a name="2749"><span class="lineNum">    2749 </span><span class="lineCov">        399 :                             {RPCResult::Type::NUM, &quot;vout&quot;, &quot;the vout value&quot;},</span></a>
<a name="2750"><span class="lineNum">    2750 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR, &quot;address&quot;, &quot;the bitcoin address&quot;},</span></a>
<a name="2751"><span class="lineNum">    2751 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR, &quot;label&quot;, &quot;The associated label, or \&quot;\&quot; for the default label&quot;},</span></a>
<a name="2752"><span class="lineNum">    2752 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR, &quot;scriptPubKey&quot;, &quot;the script key&quot;},</span></a>
<a name="2753"><span class="lineNum">    2753 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR_AMOUNT, &quot;amount&quot;, &quot;the transaction output amount in &quot; + CURRENCY_UNIT},</span></a>
<a name="2754"><span class="lineNum">    2754 </span><span class="lineCov">        399 :                             {RPCResult::Type::NUM, &quot;confirmations&quot;, &quot;The number of confirmations&quot;},</span></a>
<a name="2755"><span class="lineNum">    2755 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR_HEX, &quot;redeemScript&quot;, &quot;The redeemScript if scriptPubKey is P2SH&quot;},</span></a>
<a name="2756"><span class="lineNum">    2756 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR, &quot;witnessScript&quot;, &quot;witnessScript if the scriptPubKey is P2WSH or P2SH-P2WSH&quot;},</span></a>
<a name="2757"><span class="lineNum">    2757 </span><span class="lineCov">        399 :                             {RPCResult::Type::BOOL, &quot;spendable&quot;, &quot;Whether we have the private keys to spend this output&quot;},</span></a>
<a name="2758"><span class="lineNum">    2758 </span><span class="lineCov">        399 :                             {RPCResult::Type::BOOL, &quot;solvable&quot;, &quot;Whether we know how to spend this output, ignoring the lack of keys&quot;},</span></a>
<a name="2759"><span class="lineNum">    2759 </span><span class="lineCov">        399 :                             {RPCResult::Type::BOOL, &quot;reused&quot;, &quot;(only present if avoid_reuse is set) Whether this output is reused/dirty (sent to an address that was previously spent from)&quot;},</span></a>
<a name="2760"><span class="lineNum">    2760 </span><span class="lineCov">        399 :                             {RPCResult::Type::STR, &quot;desc&quot;, &quot;(only when solvable) A descriptor for spending this output&quot;},</span></a>
<a name="2761"><span class="lineNum">    2761 </span><span class="lineCov">        399 :                             {RPCResult::Type::BOOL, &quot;safe&quot;, &quot;Whether this output is considered safe to spend. Unconfirmed transactions\n&quot;</span></a>
<a name="2762"><span class="lineNum">    2762 </span>            :                                                             &quot;from outside keys and unconfirmed replacement transactions are considered unsafe\n&quot;</a>
<a name="2763"><span class="lineNum">    2763 </span>            :                                                             &quot;and are not eligible for spending by fundrawtransaction and sendtoaddress.&quot;},</a>
<a name="2764"><span class="lineNum">    2764 </span>            :                         }},</a>
<a name="2765"><span class="lineNum">    2765 </span>            :                     }</a>
<a name="2766"><span class="lineNum">    2766 </span>            :                 },</a>
<a name="2767"><span class="lineNum">    2767 </span><span class="lineCov">        399 :                 RPCExamples{</span></a>
<a name="2768"><span class="lineNum">    2768 </span><span class="lineCov">        399 :                     HelpExampleCli(&quot;listunspent&quot;, &quot;&quot;)</span></a>
<a name="2769"><span class="lineNum">    2769 </span><span class="lineCov">        399 :             + HelpExampleCli(&quot;listunspent&quot;, &quot;6 9999999 \&quot;[\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;]\&quot;&quot;)</span></a>
<a name="2770"><span class="lineNum">    2770 </span><span class="lineCov">        399 :             + HelpExampleRpc(&quot;listunspent&quot;, &quot;6, 9999999 \&quot;[\\\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\\\&quot;,\\\&quot;&quot; + EXAMPLE_ADDRESS[1] + &quot;\\\&quot;]\&quot;&quot;)</span></a>
<a name="2771"><span class="lineNum">    2771 </span><span class="lineCov">        399 :             + HelpExampleCli(&quot;listunspent&quot;, &quot;6 9999999 '[]' true '{ \&quot;minimumAmount\&quot;: 0.005 }'&quot;)</span></a>
<a name="2772"><span class="lineNum">    2772 </span><span class="lineCov">        399 :             + HelpExampleRpc(&quot;listunspent&quot;, &quot;6, 9999999, [] , true, { \&quot;minimumAmount\&quot;: 0.005 } &quot;)</span></a>
<a name="2773"><span class="lineNum">    2773 </span>            :                 },</a>
<a name="2774"><span class="lineNum">    2774 </span><span class="lineCov">        399 :             }.Check(request);</span></a>
<a name="2775"><span class="lineNum">    2775 </span>            : </a>
<a name="2776"><span class="lineNum">    2776 </span><span class="lineCov">        395 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="2777"><span class="lineNum">    2777 </span><span class="lineCov">        395 :     if (!wallet) return NullUniValue;</span></a>
<a name="2778"><span class="lineNum">    2778 </span><span class="lineCov">        395 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="2779"><span class="lineNum">    2779 </span>            : </a>
<a name="2780"><span class="lineNum">    2780 </span>            :     int nMinDepth = 1;</a>
<a name="2781"><span class="lineNum">    2781 </span><span class="lineCov">        395 :     if (!request.params[0].isNull()) {</span></a>
<a name="2782"><span class="lineNum">    2782 </span><span class="lineCov">         55 :         RPCTypeCheckArgument(request.params[0], UniValue::VNUM);</span></a>
<a name="2783"><span class="lineNum">    2783 </span><span class="lineCov">         55 :         nMinDepth = request.params[0].get_int();</span></a>
<a name="2784"><span class="lineNum">    2784 </span><span class="lineCov">         55 :     }</span></a>
<a name="2785"><span class="lineNum">    2785 </span>            : </a>
<a name="2786"><span class="lineNum">    2786 </span>            :     int nMaxDepth = 9999999;</a>
<a name="2787"><span class="lineNum">    2787 </span><span class="lineCov">        395 :     if (!request.params[1].isNull()) {</span></a>
<a name="2788"><span class="lineNum">    2788 </span><span class="lineCov">         10 :         RPCTypeCheckArgument(request.params[1], UniValue::VNUM);</span></a>
<a name="2789"><span class="lineNum">    2789 </span><span class="lineCov">         10 :         nMaxDepth = request.params[1].get_int();</span></a>
<a name="2790"><span class="lineNum">    2790 </span><span class="lineCov">         10 :     }</span></a>
<a name="2791"><span class="lineNum">    2791 </span>            : </a>
<a name="2792"><span class="lineNum">    2792 </span><span class="lineCov">        395 :     std::set&lt;CTxDestination&gt; destinations;</span></a>
<a name="2793"><span class="lineNum">    2793 </span><span class="lineCov">        395 :     if (!request.params[2].isNull()) {</span></a>
<a name="2794"><span class="lineNum">    2794 </span><span class="lineCov">          5 :         RPCTypeCheckArgument(request.params[2], UniValue::VARR);</span></a>
<a name="2795"><span class="lineNum">    2795 </span><span class="lineCov">          5 :         UniValue inputs = request.params[2].get_array();</span></a>
<a name="2796"><span class="lineNum">    2796 </span><span class="lineCov">         10 :         for (unsigned int idx = 0; idx &lt; inputs.size(); idx++) {</span></a>
<a name="2797"><span class="lineNum">    2797 </span><span class="lineCov">          5 :             const UniValue&amp; input = inputs[idx];</span></a>
<a name="2798"><span class="lineNum">    2798 </span><span class="lineCov">          5 :             CTxDestination dest = DecodeDestination(input.get_str());</span></a>
<a name="2799"><span class="lineNum">    2799 </span><span class="lineCov">          5 :             if (!IsValidDestination(dest)) {</span></a>
<a name="2800"><span class="lineNum">    2800 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(&quot;Invalid Bitcoin address: &quot;) + input.get_str());</span></a>
<a name="2801"><span class="lineNum">    2801 </span>            :             }</a>
<a name="2802"><span class="lineNum">    2802 </span><span class="lineCov">          5 :             if (!destinations.insert(dest).second) {</span></a>
<a name="2803"><span class="lineNum">    2803 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(&quot;Invalid parameter, duplicated address: &quot;) + input.get_str());</span></a>
<a name="2804"><span class="lineNum">    2804 </span>            :             }</a>
<a name="2805"><span class="lineNum">    2805 </span><span class="lineCov">          5 :         }</span></a>
<a name="2806"><span class="lineNum">    2806 </span><span class="lineCov">          5 :     }</span></a>
<a name="2807"><span class="lineNum">    2807 </span>            : </a>
<a name="2808"><span class="lineNum">    2808 </span>            :     bool include_unsafe = true;</a>
<a name="2809"><span class="lineNum">    2809 </span><span class="lineCov">        395 :     if (!request.params[3].isNull()) {</span></a>
<a name="2810"><span class="lineNum">    2810 </span><span class="lineCov">          3 :         RPCTypeCheckArgument(request.params[3], UniValue::VBOOL);</span></a>
<a name="2811"><span class="lineNum">    2811 </span><span class="lineCov">          3 :         include_unsafe = request.params[3].get_bool();</span></a>
<a name="2812"><span class="lineNum">    2812 </span><span class="lineCov">          3 :     }</span></a>
<a name="2813"><span class="lineNum">    2813 </span>            : </a>
<a name="2814"><span class="lineNum">    2814 </span><span class="lineCov">        395 :     CAmount nMinimumAmount = 0;</span></a>
<a name="2815"><span class="lineNum">    2815 </span><span class="lineCov">        395 :     CAmount nMaximumAmount = MAX_MONEY;</span></a>
<a name="2816"><span class="lineNum">    2816 </span><span class="lineCov">        395 :     CAmount nMinimumSumAmount = MAX_MONEY;</span></a>
<a name="2817"><span class="lineNum">    2817 </span>            :     uint64_t nMaximumCount = 0;</a>
<a name="2818"><span class="lineNum">    2818 </span>            : </a>
<a name="2819"><span class="lineNum">    2819 </span><span class="lineCov">        395 :     if (!request.params[4].isNull()) {</span></a>
<a name="2820"><span class="lineNum">    2820 </span><span class="lineCov">         81 :         const UniValue&amp; options = request.params[4].get_obj();</span></a>
<a name="2821"><span class="lineNum">    2821 </span>            : </a>
<a name="2822"><span class="lineNum">    2822 </span><span class="lineCov">        324 :         RPCTypeCheckObj(options,</span></a>
<a name="2823"><span class="lineNum">    2823 </span><span class="lineCov">        405 :             {</span></a>
<a name="2824"><span class="lineNum">    2824 </span><span class="lineCov">         81 :                 {&quot;minimumAmount&quot;, UniValueType()},</span></a>
<a name="2825"><span class="lineNum">    2825 </span><span class="lineCov">         81 :                 {&quot;maximumAmount&quot;, UniValueType()},</span></a>
<a name="2826"><span class="lineNum">    2826 </span><span class="lineCov">         81 :                 {&quot;minimumSumAmount&quot;, UniValueType()},</span></a>
<a name="2827"><span class="lineNum">    2827 </span><span class="lineCov">         81 :                 {&quot;maximumCount&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="2828"><span class="lineNum">    2828 </span>            :             },</a>
<a name="2829"><span class="lineNum">    2829 </span>            :             true, true);</a>
<a name="2830"><span class="lineNum">    2830 </span>            : </a>
<a name="2831"><span class="lineNum">    2831 </span><span class="lineCov">         81 :         if (options.exists(&quot;minimumAmount&quot;))</span></a>
<a name="2832"><span class="lineNum">    2832 </span><span class="lineCov">         81 :             nMinimumAmount = AmountFromValue(options[&quot;minimumAmount&quot;]);</span></a>
<a name="2833"><span class="lineNum">    2833 </span>            : </a>
<a name="2834"><span class="lineNum">    2834 </span><span class="lineCov">         81 :         if (options.exists(&quot;maximumAmount&quot;))</span></a>
<a name="2835"><span class="lineNum">    2835 </span><span class="lineNoCov">          0 :             nMaximumAmount = AmountFromValue(options[&quot;maximumAmount&quot;]);</span></a>
<a name="2836"><span class="lineNum">    2836 </span>            : </a>
<a name="2837"><span class="lineNum">    2837 </span><span class="lineCov">         81 :         if (options.exists(&quot;minimumSumAmount&quot;))</span></a>
<a name="2838"><span class="lineNum">    2838 </span><span class="lineNoCov">          0 :             nMinimumSumAmount = AmountFromValue(options[&quot;minimumSumAmount&quot;]);</span></a>
<a name="2839"><span class="lineNum">    2839 </span>            : </a>
<a name="2840"><span class="lineNum">    2840 </span><span class="lineCov">         81 :         if (options.exists(&quot;maximumCount&quot;))</span></a>
<a name="2841"><span class="lineNum">    2841 </span><span class="lineNoCov">          0 :             nMaximumCount = options[&quot;maximumCount&quot;].get_int64();</span></a>
<a name="2842"><span class="lineNum">    2842 </span><span class="lineCov">         81 :     }</span></a>
<a name="2843"><span class="lineNum">    2843 </span>            : </a>
<a name="2844"><span class="lineNum">    2844 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="2845"><span class="lineNum">    2845 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="2846"><span class="lineNum">    2846 </span><span class="lineCov">        395 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="2847"><span class="lineNum">    2847 </span>            : </a>
<a name="2848"><span class="lineNum">    2848 </span><span class="lineCov">        395 :     UniValue results(UniValue::VARR);</span></a>
<a name="2849"><span class="lineNum">    2849 </span><span class="lineCov">        395 :     std::vector&lt;COutput&gt; vecOutputs;</span></a>
<a name="2850"><span class="lineNum">    2850 </span>            :     {</a>
<a name="2851"><span class="lineNum">    2851 </span><span class="lineCov">        395 :         CCoinControl cctl;</span></a>
<a name="2852"><span class="lineNum">    2852 </span><span class="lineCov">        395 :         cctl.m_avoid_address_reuse = false;</span></a>
<a name="2853"><span class="lineNum">    2853 </span><span class="lineCov">        395 :         cctl.m_min_depth = nMinDepth;</span></a>
<a name="2854"><span class="lineNum">    2854 </span><span class="lineCov">        395 :         cctl.m_max_depth = nMaxDepth;</span></a>
<a name="2855"><span class="lineNum">    2855 </span><span class="lineCov">        395 :         LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2856"><span class="lineNum">    2856 </span><span class="lineCov">        395 :         pwallet-&gt;AvailableCoins(vecOutputs, !include_unsafe, &amp;cctl, nMinimumAmount, nMaximumAmount, nMinimumSumAmount, nMaximumCount);</span></a>
<a name="2857"><span class="lineNum">    2857 </span><span class="lineCov">        395 :     }</span></a>
<a name="2858"><span class="lineNum">    2858 </span>            : </a>
<a name="2859"><span class="lineNum">    2859 </span><span class="lineCov">        395 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="2860"><span class="lineNum">    2860 </span>            : </a>
<a name="2861"><span class="lineNum">    2861 </span><span class="lineCov">        395 :     const bool avoid_reuse = pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_AVOID_REUSE);</span></a>
<a name="2862"><span class="lineNum">    2862 </span>            : </a>
<a name="2863"><span class="lineNum">    2863 </span><span class="lineCov">      29911 :     for (const COutput&amp; out : vecOutputs) {</span></a>
<a name="2864"><span class="lineNum">    2864 </span><span class="lineCov">      29516 :         CTxDestination address;</span></a>
<a name="2865"><span class="lineNum">    2865 </span><span class="lineCov">      29516 :         const CScript&amp; scriptPubKey = out.tx-&gt;tx-&gt;vout[out.i].scriptPubKey;</span></a>
<a name="2866"><span class="lineNum">    2866 </span><span class="lineCov">      29516 :         bool fValidAddress = ExtractDestination(scriptPubKey, address);</span></a>
<a name="2867"><span class="lineNum">    2867 </span><span class="lineCov">      29516 :         bool reused = avoid_reuse &amp;&amp; pwallet-&gt;IsSpentKey(out.tx-&gt;GetHash(), out.i);</span></a>
<a name="2868"><span class="lineNum">    2868 </span>            : </a>
<a name="2869"><span class="lineNum">    2869 </span><span class="lineCov">      29516 :         if (destinations.size() &amp;&amp; (!fValidAddress || !destinations.count(address)))</span></a>
<a name="2870"><span class="lineNum">    2870 </span><span class="lineCov">        363 :             continue;</span></a>
<a name="2871"><span class="lineNum">    2871 </span>            : </a>
<a name="2872"><span class="lineNum">    2872 </span><span class="lineCov">      29153 :         UniValue entry(UniValue::VOBJ);</span></a>
<a name="2873"><span class="lineNum">    2873 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;txid&quot;, out.tx-&gt;GetHash().GetHex());</span></a>
<a name="2874"><span class="lineNum">    2874 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;vout&quot;, out.i);</span></a>
<a name="2875"><span class="lineNum">    2875 </span>            : </a>
<a name="2876"><span class="lineNum">    2876 </span><span class="lineCov">      29153 :         if (fValidAddress) {</span></a>
<a name="2877"><span class="lineNum">    2877 </span><span class="lineCov">      28966 :             entry.pushKV(&quot;address&quot;, EncodeDestination(address));</span></a>
<a name="2878"><span class="lineNum">    2878 </span>            : </a>
<a name="2879"><span class="lineNum">    2879 </span><span class="lineCov">      28966 :             const auto* address_book_entry = pwallet-&gt;FindAddressBookEntry(address);</span></a>
<a name="2880"><span class="lineNum">    2880 </span><span class="lineCov">      28966 :             if (address_book_entry) {</span></a>
<a name="2881"><span class="lineNum">    2881 </span><span class="lineCov">      28049 :                 entry.pushKV(&quot;label&quot;, address_book_entry-&gt;GetLabel());</span></a>
<a name="2882"><span class="lineNum">    2882 </span><span class="lineCov">      28049 :             }</span></a>
<a name="2883"><span class="lineNum">    2883 </span>            : </a>
<a name="2884"><span class="lineNum">    2884 </span><span class="lineCov">      28966 :             std::unique_ptr&lt;SigningProvider&gt; provider = pwallet-&gt;GetSolvingProvider(scriptPubKey);</span></a>
<a name="2885"><span class="lineNum">    2885 </span><span class="lineCov">      28966 :             if (provider) {</span></a>
<a name="2886"><span class="lineNum">    2886 </span><span class="lineCov">      28966 :                 if (scriptPubKey.IsPayToScriptHash()) {</span></a>
<a name="2887"><span class="lineNum">    2887 </span><span class="lineCov">       1070 :                     const CScriptID&amp; hash = CScriptID(boost::get&lt;ScriptHash&gt;(address));</span></a>
<a name="2888"><span class="lineNum">    2888 </span><span class="lineCov">       1070 :                     CScript redeemScript;</span></a>
<a name="2889"><span class="lineNum">    2889 </span><span class="lineCov">       1070 :                     if (provider-&gt;GetCScript(hash, redeemScript)) {</span></a>
<a name="2890"><span class="lineNum">    2890 </span><span class="lineCov">       1044 :                         entry.pushKV(&quot;redeemScript&quot;, HexStr(redeemScript));</span></a>
<a name="2891"><span class="lineNum">    2891 </span>            :                         // Now check if the redeemScript is actually a P2WSH script</a>
<a name="2892"><span class="lineNum">    2892 </span><span class="lineCov">       1044 :                         CTxDestination witness_destination;</span></a>
<a name="2893"><span class="lineNum">    2893 </span><span class="lineCov">       1044 :                         if (redeemScript.IsPayToWitnessScriptHash()) {</span></a>
<a name="2894"><span class="lineNum">    2894 </span><span class="lineCov">        339 :                             bool extracted = ExtractDestination(redeemScript, witness_destination);</span></a>
<a name="2895"><span class="lineNum">    2895 </span><span class="lineCov">        339 :                             CHECK_NONFATAL(extracted);</span></a>
<a name="2896"><span class="lineNum">    2896 </span>            :                             // Also return the witness script</a>
<a name="2897"><span class="lineNum">    2897 </span><span class="lineCov">        339 :                             const WitnessV0ScriptHash&amp; whash = boost::get&lt;WitnessV0ScriptHash&gt;(witness_destination);</span></a>
<a name="2898"><span class="lineNum">    2898 </span><span class="lineCov">        339 :                             CScriptID id;</span></a>
<a name="2899"><span class="lineNum">    2899 </span><span class="lineCov">        339 :                             CRIPEMD160().Write(whash.begin(), whash.size()).Finalize(id.begin());</span></a>
<a name="2900"><span class="lineNum">    2900 </span><span class="lineCov">        339 :                             CScript witnessScript;</span></a>
<a name="2901"><span class="lineNum">    2901 </span><span class="lineCov">        339 :                             if (provider-&gt;GetCScript(id, witnessScript)) {</span></a>
<a name="2902"><span class="lineNum">    2902 </span><span class="lineCov">        339 :                                 entry.pushKV(&quot;witnessScript&quot;, HexStr(witnessScript));</span></a>
<a name="2903"><span class="lineNum">    2903 </span><span class="lineCov">        339 :                             }</span></a>
<a name="2904"><span class="lineNum">    2904 </span><span class="lineCov">        339 :                         }</span></a>
<a name="2905"><span class="lineNum">    2905 </span><span class="lineCov">       1044 :                     }</span></a>
<a name="2906"><span class="lineNum">    2906 </span><span class="lineCov">      28966 :                 } else if (scriptPubKey.IsPayToWitnessScriptHash()) {</span></a>
<a name="2907"><span class="lineNum">    2907 </span><span class="lineCov">        485 :                     const WitnessV0ScriptHash&amp; whash = boost::get&lt;WitnessV0ScriptHash&gt;(address);</span></a>
<a name="2908"><span class="lineNum">    2908 </span><span class="lineCov">        485 :                     CScriptID id;</span></a>
<a name="2909"><span class="lineNum">    2909 </span><span class="lineCov">        485 :                     CRIPEMD160().Write(whash.begin(), whash.size()).Finalize(id.begin());</span></a>
<a name="2910"><span class="lineNum">    2910 </span><span class="lineCov">        485 :                     CScript witnessScript;</span></a>
<a name="2911"><span class="lineNum">    2911 </span><span class="lineCov">        485 :                     if (provider-&gt;GetCScript(id, witnessScript)) {</span></a>
<a name="2912"><span class="lineNum">    2912 </span><span class="lineCov">        484 :                         entry.pushKV(&quot;witnessScript&quot;, HexStr(witnessScript));</span></a>
<a name="2913"><span class="lineNum">    2913 </span><span class="lineCov">        484 :                     }</span></a>
<a name="2914"><span class="lineNum">    2914 </span><span class="lineCov">        485 :                 }</span></a>
<a name="2915"><span class="lineNum">    2915 </span>            :             }</a>
<a name="2916"><span class="lineNum">    2916 </span><span class="lineCov">      28966 :         }</span></a>
<a name="2917"><span class="lineNum">    2917 </span>            : </a>
<a name="2918"><span class="lineNum">    2918 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;scriptPubKey&quot;, HexStr(scriptPubKey));</span></a>
<a name="2919"><span class="lineNum">    2919 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;amount&quot;, ValueFromAmount(out.tx-&gt;tx-&gt;vout[out.i].nValue));</span></a>
<a name="2920"><span class="lineNum">    2920 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;confirmations&quot;, out.nDepth);</span></a>
<a name="2921"><span class="lineNum">    2921 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;spendable&quot;, out.fSpendable);</span></a>
<a name="2922"><span class="lineNum">    2922 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;solvable&quot;, out.fSolvable);</span></a>
<a name="2923"><span class="lineNum">    2923 </span><span class="lineCov">      29153 :         if (out.fSolvable) {</span></a>
<a name="2924"><span class="lineNum">    2924 </span><span class="lineCov">      29025 :             std::unique_ptr&lt;SigningProvider&gt; provider = pwallet-&gt;GetSolvingProvider(scriptPubKey);</span></a>
<a name="2925"><span class="lineNum">    2925 </span><span class="lineCov">      29025 :             if (provider) {</span></a>
<a name="2926"><span class="lineNum">    2926 </span><span class="lineCov">      29025 :                 auto descriptor = InferDescriptor(scriptPubKey, *provider);</span></a>
<a name="2927"><span class="lineNum">    2927 </span><span class="lineCov">      29025 :                 entry.pushKV(&quot;desc&quot;, descriptor-&gt;ToString());</span></a>
<a name="2928"><span class="lineNum">    2928 </span><span class="lineCov">      29025 :             }</span></a>
<a name="2929"><span class="lineNum">    2929 </span><span class="lineCov">      29025 :         }</span></a>
<a name="2930"><span class="lineNum">    2930 </span><span class="lineCov">      29153 :         if (avoid_reuse) entry.pushKV(&quot;reused&quot;, reused);</span></a>
<a name="2931"><span class="lineNum">    2931 </span><span class="lineCov">      29153 :         entry.pushKV(&quot;safe&quot;, out.fSafe);</span></a>
<a name="2932"><span class="lineNum">    2932 </span><span class="lineCov">      29153 :         results.push_back(entry);</span></a>
<a name="2933"><span class="lineNum">    2933 </span><span class="lineCov">      29516 :     }</span></a>
<a name="2934"><span class="lineNum">    2934 </span>            : </a>
<a name="2935"><span class="lineNum">    2935 </span><span class="lineCov">        395 :     return results;</span></a>
<a name="2936"><span class="lineNum">    2936 </span><span class="lineCov">        475 : }</span></a>
<a name="2937"><span class="lineNum">    2937 </span>            : </a>
<a name="2938"><span class="lineNum">    2938 </span><span class="lineCov">        164 : void FundTransaction(CWallet* const pwallet, CMutableTransaction&amp; tx, CAmount&amp; fee_out, int&amp; change_position, UniValue options, CCoinControl&amp; coinControl)</span></a>
<a name="2939"><span class="lineNum">    2939 </span>            : {</a>
<a name="2940"><span class="lineNum">    2940 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="2941"><span class="lineNum">    2941 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="2942"><span class="lineNum">    2942 </span><span class="lineCov">        164 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="2943"><span class="lineNum">    2943 </span>            : </a>
<a name="2944"><span class="lineNum">    2944 </span><span class="lineCov">        164 :     change_position = -1;</span></a>
<a name="2945"><span class="lineNum">    2945 </span>            :     bool lockUnspents = false;</a>
<a name="2946"><span class="lineNum">    2946 </span><span class="lineCov">        164 :     UniValue subtractFeeFromOutputs;</span></a>
<a name="2947"><span class="lineNum">    2947 </span><span class="lineCov">        164 :     std::set&lt;int&gt; setSubtractFeeFromOutputs;</span></a>
<a name="2948"><span class="lineNum">    2948 </span>            : </a>
<a name="2949"><span class="lineNum">    2949 </span><span class="lineCov">        164 :     if (!options.isNull()) {</span></a>
<a name="2950"><span class="lineNum">    2950 </span><span class="lineCov">        107 :       if (options.type() == UniValue::VBOOL) {</span></a>
<a name="2951"><span class="lineNum">    2951 </span>            :         // backward compatibility bool only fallback</a>
<a name="2952"><span class="lineNum">    2952 </span><span class="lineCov">          1 :         coinControl.fAllowWatchOnly = options.get_bool();</span></a>
<a name="2953"><span class="lineNum">    2953 </span><span class="lineCov">          1 :       }</span></a>
<a name="2954"><span class="lineNum">    2954 </span>            :       else {</a>
<a name="2955"><span class="lineNum">    2955 </span><span class="lineCov">        106 :         RPCTypeCheckArgument(options, UniValue::VOBJ);</span></a>
<a name="2956"><span class="lineNum">    2956 </span><span class="lineCov">       2120 :         RPCTypeCheckObj(options,</span></a>
<a name="2957"><span class="lineNum">    2957 </span><span class="lineCov">       2228 :             {</span></a>
<a name="2958"><span class="lineNum">    2958 </span><span class="lineCov">        106 :                 {&quot;add_inputs&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2959"><span class="lineNum">    2959 </span><span class="lineCov">        106 :                 {&quot;add_to_wallet&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2960"><span class="lineNum">    2960 </span><span class="lineCov">        106 :                 {&quot;changeAddress&quot;, UniValueType(UniValue::VSTR)},</span></a>
<a name="2961"><span class="lineNum">    2961 </span><span class="lineCov">        106 :                 {&quot;change_address&quot;, UniValueType(UniValue::VSTR)},</span></a>
<a name="2962"><span class="lineNum">    2962 </span><span class="lineCov">        106 :                 {&quot;changePosition&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="2963"><span class="lineNum">    2963 </span><span class="lineCov">        106 :                 {&quot;change_position&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="2964"><span class="lineNum">    2964 </span><span class="lineCov">        106 :                 {&quot;change_type&quot;, UniValueType(UniValue::VSTR)},</span></a>
<a name="2965"><span class="lineNum">    2965 </span><span class="lineCov">        106 :                 {&quot;includeWatching&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2966"><span class="lineNum">    2966 </span><span class="lineCov">        106 :                 {&quot;include_watching&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2967"><span class="lineNum">    2967 </span><span class="lineCov">        106 :                 {&quot;inputs&quot;, UniValueType(UniValue::VARR)},</span></a>
<a name="2968"><span class="lineNum">    2968 </span><span class="lineCov">        106 :                 {&quot;lockUnspents&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2969"><span class="lineNum">    2969 </span><span class="lineCov">        106 :                 {&quot;lock_unspents&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2970"><span class="lineNum">    2970 </span><span class="lineCov">        106 :                 {&quot;locktime&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="2971"><span class="lineNum">    2971 </span><span class="lineCov">        106 :                 {&quot;feeRate&quot;, UniValueType()}, // will be checked below,</span></a>
<a name="2972"><span class="lineNum">    2972 </span><span class="lineCov">        106 :                 {&quot;psbt&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2973"><span class="lineNum">    2973 </span><span class="lineCov">        106 :                 {&quot;subtractFeeFromOutputs&quot;, UniValueType(UniValue::VARR)},</span></a>
<a name="2974"><span class="lineNum">    2974 </span><span class="lineCov">        106 :                 {&quot;subtract_fee_from_outputs&quot;, UniValueType(UniValue::VARR)},</span></a>
<a name="2975"><span class="lineNum">    2975 </span><span class="lineCov">        106 :                 {&quot;replaceable&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="2976"><span class="lineNum">    2976 </span><span class="lineCov">        106 :                 {&quot;conf_target&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="2977"><span class="lineNum">    2977 </span><span class="lineCov">        106 :                 {&quot;estimate_mode&quot;, UniValueType(UniValue::VSTR)},</span></a>
<a name="2978"><span class="lineNum">    2978 </span>            :             },</a>
<a name="2979"><span class="lineNum">    2979 </span>            :             true, true);</a>
<a name="2980"><span class="lineNum">    2980 </span>            : </a>
<a name="2981"><span class="lineNum">    2981 </span><span class="lineCov">        104 :         if (options.exists(&quot;add_inputs&quot;) ) {</span></a>
<a name="2982"><span class="lineNum">    2982 </span><span class="lineCov">         23 :             coinControl.m_add_inputs = options[&quot;add_inputs&quot;].get_bool();</span></a>
<a name="2983"><span class="lineNum">    2983 </span><span class="lineCov">         23 :         }</span></a>
<a name="2984"><span class="lineNum">    2984 </span>            : </a>
<a name="2985"><span class="lineNum">    2985 </span><span class="lineCov">        104 :         if (options.exists(&quot;changeAddress&quot;) || options.exists(&quot;change_address&quot;)) {</span></a>
<a name="2986"><span class="lineNum">    2986 </span><span class="lineCov">         21 :             const std::string change_address_str = (options.exists(&quot;change_address&quot;) ? options[&quot;change_address&quot;] : options[&quot;changeAddress&quot;]).get_str();</span></a>
<a name="2987"><span class="lineNum">    2987 </span><span class="lineCov">         21 :             CTxDestination dest = DecodeDestination(change_address_str);</span></a>
<a name="2988"><span class="lineNum">    2988 </span>            : </a>
<a name="2989"><span class="lineNum">    2989 </span><span class="lineCov">         21 :             if (!IsValidDestination(dest)) {</span></a>
<a name="2990"><span class="lineNum">    2990 </span><span class="lineCov">          2 :                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Change address must be a valid bitcoin address&quot;);</span></a>
<a name="2991"><span class="lineNum">    2991 </span>            :             }</a>
<a name="2992"><span class="lineNum">    2992 </span>            : </a>
<a name="2993"><span class="lineNum">    2993 </span><span class="lineCov">         19 :             coinControl.destChange = dest;</span></a>
<a name="2994"><span class="lineNum">    2994 </span><span class="lineCov">         21 :         }</span></a>
<a name="2995"><span class="lineNum">    2995 </span>            : </a>
<a name="2996"><span class="lineNum">    2996 </span><span class="lineCov">        102 :         if (options.exists(&quot;changePosition&quot;) || options.exists(&quot;change_position&quot;)) {</span></a>
<a name="2997"><span class="lineNum">    2997 </span><span class="lineCov">          7 :             change_position = (options.exists(&quot;change_position&quot;) ? options[&quot;change_position&quot;] : options[&quot;changePosition&quot;]).get_int();</span></a>
<a name="2998"><span class="lineNum">    2998 </span><span class="lineCov">          7 :         }</span></a>
<a name="2999"><span class="lineNum">    2999 </span>            : </a>
<a name="3000"><span class="lineNum">    3000 </span><span class="lineCov">        102 :         if (options.exists(&quot;change_type&quot;)) {</span></a>
<a name="3001"><span class="lineNum">    3001 </span><span class="lineCov">          4 :             if (options.exists(&quot;changeAddress&quot;) || options.exists(&quot;change_address&quot;)) {</span></a>
<a name="3002"><span class="lineNum">    3002 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Cannot specify both change address and address type options&quot;);</span></a>
<a name="3003"><span class="lineNum">    3003 </span>            :             }</a>
<a name="3004"><span class="lineNum">    3004 </span><span class="lineCov">          4 :             OutputType out_type;</span></a>
<a name="3005"><span class="lineNum">    3005 </span><span class="lineCov">          4 :             if (!ParseOutputType(options[&quot;change_type&quot;].get_str(), out_type)) {</span></a>
<a name="3006"><span class="lineNum">    3006 </span><span class="lineCov">          1 :                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, strprintf(&quot;Unknown change type '%s'&quot;, options[&quot;change_type&quot;].get_str()));</span></a>
<a name="3007"><span class="lineNum">    3007 </span>            :             }</a>
<a name="3008"><span class="lineNum">    3008 </span><span class="lineCov">          2 :             coinControl.m_change_type.emplace(out_type);</span></a>
<a name="3009"><span class="lineNum">    3009 </span><span class="lineCov">          4 :         }</span></a>
<a name="3010"><span class="lineNum">    3010 </span>            : </a>
<a name="3011"><span class="lineNum">    3011 </span><span class="lineCov">        100 :         const UniValue include_watching_option = options.exists(&quot;include_watching&quot;) ? options[&quot;include_watching&quot;] : options[&quot;includeWatching&quot;];</span></a>
<a name="3012"><span class="lineNum">    3012 </span><span class="lineCov">        100 :         coinControl.fAllowWatchOnly = ParseIncludeWatchonly(include_watching_option, *pwallet);</span></a>
<a name="3013"><span class="lineNum">    3013 </span>            : </a>
<a name="3014"><span class="lineNum">    3014 </span><span class="lineCov">        100 :         if (options.exists(&quot;lockUnspents&quot;) || options.exists(&quot;lock_unspents&quot;)) {</span></a>
<a name="3015"><span class="lineNum">    3015 </span><span class="lineCov">          7 :             lockUnspents = (options.exists(&quot;lock_unspents&quot;) ? options[&quot;lock_unspents&quot;] : options[&quot;lockUnspents&quot;]).get_bool();</span></a>
<a name="3016"><span class="lineNum">    3016 </span><span class="lineCov">          7 :         }</span></a>
<a name="3017"><span class="lineNum">    3017 </span>            : </a>
<a name="3018"><span class="lineNum">    3018 </span><span class="lineCov">        100 :         if (options.exists(&quot;feeRate&quot;))</span></a>
<a name="3019"><span class="lineNum">    3019 </span>            :         {</a>
<a name="3020"><span class="lineNum">    3020 </span><span class="lineCov">         27 :             if (options.exists(&quot;conf_target&quot;)) {</span></a>
<a name="3021"><span class="lineNum">    3021 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Cannot specify both conf_target and feeRate&quot;);</span></a>
<a name="3022"><span class="lineNum">    3022 </span>            :             }</a>
<a name="3023"><span class="lineNum">    3023 </span><span class="lineCov">         27 :             if (options.exists(&quot;estimate_mode&quot;)) {</span></a>
<a name="3024"><span class="lineNum">    3024 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Cannot specify both estimate_mode and feeRate&quot;);</span></a>
<a name="3025"><span class="lineNum">    3025 </span>            :             }</a>
<a name="3026"><span class="lineNum">    3026 </span><span class="lineCov">         27 :             coinControl.m_feerate = CFeeRate(AmountFromValue(options[&quot;feeRate&quot;]));</span></a>
<a name="3027"><span class="lineNum">    3027 </span><span class="lineCov">         27 :             coinControl.fOverrideFeeRate = true;</span></a>
<a name="3028"><span class="lineNum">    3028 </span><span class="lineCov">         27 :         }</span></a>
<a name="3029"><span class="lineNum">    3029 </span>            : </a>
<a name="3030"><span class="lineNum">    3030 </span><span class="lineCov">        100 :         if (options.exists(&quot;subtractFeeFromOutputs&quot;) || options.exists(&quot;subtract_fee_from_outputs&quot;) )</span></a>
<a name="3031"><span class="lineNum">    3031 </span><span class="lineCov">         17 :             subtractFeeFromOutputs = (options.exists(&quot;subtract_fee_from_outputs&quot;) ? options[&quot;subtract_fee_from_outputs&quot;] : options[&quot;subtractFeeFromOutputs&quot;]).get_array();</span></a>
<a name="3032"><span class="lineNum">    3032 </span>            : </a>
<a name="3033"><span class="lineNum">    3033 </span><span class="lineCov">        100 :         if (options.exists(&quot;replaceable&quot;)) {</span></a>
<a name="3034"><span class="lineNum">    3034 </span><span class="lineCov">          8 :             coinControl.m_signal_bip125_rbf = options[&quot;replaceable&quot;].get_bool();</span></a>
<a name="3035"><span class="lineNum">    3035 </span><span class="lineCov">          8 :         }</span></a>
<a name="3036"><span class="lineNum">    3036 </span><span class="lineCov">        100 :         SetFeeEstimateMode(pwallet, coinControl, options[&quot;estimate_mode&quot;], options[&quot;conf_target&quot;]);</span></a>
<a name="3037"><span class="lineNum">    3037 </span><span class="lineCov">        100 :       }</span></a>
<a name="3038"><span class="lineNum">    3038 </span>            :     } else {</a>
<a name="3039"><span class="lineNum">    3039 </span>            :         // if options is null and not a bool</a>
<a name="3040"><span class="lineNum">    3040 </span><span class="lineCov">         57 :         coinControl.fAllowWatchOnly = ParseIncludeWatchonly(NullUniValue, *pwallet);</span></a>
<a name="3041"><span class="lineNum">    3041 </span>            :     }</a>
<a name="3042"><span class="lineNum">    3042 </span>            : </a>
<a name="3043"><span class="lineNum">    3043 </span><span class="lineCov">        157 :     if (tx.vout.size() == 0)</span></a>
<a name="3044"><span class="lineNum">    3044 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;TX must have at least one output&quot;);</span></a>
<a name="3045"><span class="lineNum">    3045 </span>            : </a>
<a name="3046"><span class="lineNum">    3046 </span><span class="lineCov">        157 :     if (change_position != -1 &amp;&amp; (change_position &lt; 0 || (unsigned int)change_position &gt; tx.vout.size()))</span></a>
<a name="3047"><span class="lineNum">    3047 </span><span class="lineCov">          1 :         throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;changePosition out of bounds&quot;);</span></a>
<a name="3048"><span class="lineNum">    3048 </span>            : </a>
<a name="3049"><span class="lineNum">    3049 </span><span class="lineCov">        174 :     for (unsigned int idx = 0; idx &lt; subtractFeeFromOutputs.size(); idx++) {</span></a>
<a name="3050"><span class="lineNum">    3050 </span><span class="lineCov">         18 :         int pos = subtractFeeFromOutputs[idx].get_int();</span></a>
<a name="3051"><span class="lineNum">    3051 </span><span class="lineCov">         18 :         if (setSubtractFeeFromOutputs.count(pos))</span></a>
<a name="3052"><span class="lineNum">    3052 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Invalid parameter, duplicated position: %d&quot;, pos));</span></a>
<a name="3053"><span class="lineNum">    3053 </span><span class="lineCov">         18 :         if (pos &lt; 0)</span></a>
<a name="3054"><span class="lineNum">    3054 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Invalid parameter, negative position: %d&quot;, pos));</span></a>
<a name="3055"><span class="lineNum">    3055 </span><span class="lineCov">         18 :         if (pos &gt;= int(tx.vout.size()))</span></a>
<a name="3056"><span class="lineNum">    3056 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Invalid parameter, position too large: %d&quot;, pos));</span></a>
<a name="3057"><span class="lineNum">    3057 </span><span class="lineCov">         18 :         setSubtractFeeFromOutputs.insert(pos);</span></a>
<a name="3058"><span class="lineNum">    3058 </span><span class="lineCov">         18 :     }</span></a>
<a name="3059"><span class="lineNum">    3059 </span>            : </a>
<a name="3060"><span class="lineNum">    3060 </span><span class="lineCov">        156 :     bilingual_str error;</span></a>
<a name="3061"><span class="lineNum">    3061 </span>            : </a>
<a name="3062"><span class="lineNum">    3062 </span><span class="lineCov">        156 :     if (!pwallet-&gt;FundTransaction(tx, fee_out, change_position, error, lockUnspents, setSubtractFeeFromOutputs, coinControl)) {</span></a>
<a name="3063"><span class="lineNum">    3063 </span><span class="lineCov">         28 :         throw JSONRPCError(RPC_WALLET_ERROR, error.original);</span></a>
<a name="3064"><span class="lineNum">    3064 </span>            :     }</a>
<a name="3065"><span class="lineNum">    3065 </span><span class="lineCov">        173 : }</span></a>
<a name="3066"><span class="lineNum">    3066 </span>            : </a>
<a name="3067"><span class="lineNum">    3067 </span><span class="lineCov">         82 : static UniValue fundrawtransaction(const JSONRPCRequest&amp; request)</span></a>
<a name="3068"><span class="lineNum">    3068 </span>            : {</a>
<a name="3069"><span class="lineNum">    3069 </span><span class="lineCov">       1413 :     RPCHelpMan{&quot;fundrawtransaction&quot;,</span></a>
<a name="3070"><span class="lineNum">    3070 </span><span class="lineCov">         82 :                 &quot;\nIf the transaction has no inputs, they will be automatically selected to meet its out value.\n&quot;</span></a>
<a name="3071"><span class="lineNum">    3071 </span>            :                 &quot;It will add at most one change output to the outputs.\n&quot;</a>
<a name="3072"><span class="lineNum">    3072 </span>            :                 &quot;No existing outputs will be modified unless \&quot;subtractFeeFromOutputs\&quot; is specified.\n&quot;</a>
<a name="3073"><span class="lineNum">    3073 </span>            :                 &quot;Note that inputs which were signed may need to be resigned after completion since in/outputs have been added.\n&quot;</a>
<a name="3074"><span class="lineNum">    3074 </span>            :                 &quot;The inputs added will not be signed, use signrawtransactionwithkey\n&quot;</a>
<a name="3075"><span class="lineNum">    3075 </span>            :                 &quot; or signrawtransactionwithwallet for that.\n&quot;</a>
<a name="3076"><span class="lineNum">    3076 </span>            :                 &quot;Note that all existing inputs must have their previous output transaction be in the wallet.\n&quot;</a>
<a name="3077"><span class="lineNum">    3077 </span>            :                 &quot;Note that all inputs selected must be of standard form and P2SH scripts must be\n&quot;</a>
<a name="3078"><span class="lineNum">    3078 </span>            :                 &quot;in the wallet using importaddress or addmultisigaddress (to calculate fees).\n&quot;</a>
<a name="3079"><span class="lineNum">    3079 </span>            :                 &quot;You can see whether this is the case by checking the \&quot;solvable\&quot; field in the listunspent output.\n&quot;</a>
<a name="3080"><span class="lineNum">    3080 </span>            :                 &quot;Only pay-to-pubkey, multisig, and P2SH versions thereof are currently supported for watch-only\n&quot;,</a>
<a name="3081"><span class="lineNum">    3081 </span><span class="lineCov">        348 :                 {</span></a>
<a name="3082"><span class="lineNum">    3082 </span><span class="lineCov">         82 :                     {&quot;hexstring&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The hex string of the raw transaction&quot;},</span></a>
<a name="3083"><span class="lineNum">    3083 </span><span class="lineCov">        164 :                     {&quot;options&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;for backward compatibility: passing in a true instead of an object will result in {\&quot;includeWatching\&quot;:true}&quot;,</span></a>
<a name="3084"><span class="lineNum">    3084 </span><span class="lineCov">        996 :                         {</span></a>
<a name="3085"><span class="lineNum">    3085 </span><span class="lineCov">         82 :                             {&quot;add_inputs&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;For a transaction with existing inputs, automatically include more if they are not enough.&quot;},</span></a>
<a name="3086"><span class="lineNum">    3086 </span><span class="lineCov">         82 :                             {&quot;changeAddress&quot;, RPCArg::Type::STR, /* default */ &quot;pool address&quot;, &quot;The bitcoin address to receive the change&quot;},</span></a>
<a name="3087"><span class="lineNum">    3087 </span><span class="lineCov">         82 :                             {&quot;changePosition&quot;, RPCArg::Type::NUM, /* default */ &quot;random&quot;, &quot;The index of the change output&quot;},</span></a>
<a name="3088"><span class="lineNum">    3088 </span><span class="lineCov">         82 :                             {&quot;change_type&quot;, RPCArg::Type::STR, /* default */ &quot;set by -changetype&quot;, &quot;The output type to use. Only valid if changeAddress is not specified. Options are \&quot;legacy\&quot;, \&quot;p2sh-segwit\&quot;, and \&quot;bech32\&quot;.&quot;},</span></a>
<a name="3089"><span class="lineNum">    3089 </span><span class="lineCov">         82 :                             {&quot;includeWatching&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Also select inputs which are watch only.\n&quot;</span></a>
<a name="3090"><span class="lineNum">    3090 </span>            :                                                           &quot;Only solvable inputs can be used. Watch-only destinations are solvable if the public key and/or output script was imported,\n&quot;</a>
<a name="3091"><span class="lineNum">    3091 </span>            :                                                           &quot;e.g. with 'importpubkey' or 'importmulti' with the 'pubkeys' or 'desc' field.&quot;},</a>
<a name="3092"><span class="lineNum">    3092 </span><span class="lineCov">         82 :                             {&quot;lockUnspents&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Lock selected unspent outputs&quot;},</span></a>
<a name="3093"><span class="lineNum">    3093 </span><span class="lineCov">         82 :                             {&quot;feeRate&quot;, RPCArg::Type::AMOUNT, /* default */ &quot;not set: makes wallet determine the fee&quot;, &quot;Set a specific fee rate in &quot; + CURRENCY_UNIT + &quot;/kB&quot;},</span></a>
<a name="3094"><span class="lineNum">    3094 </span><span class="lineCov">        164 :                             {&quot;subtractFeeFromOutputs&quot;, RPCArg::Type::ARR, /* default */ &quot;empty array&quot;, &quot;The integers.\n&quot;</span></a>
<a name="3095"><span class="lineNum">    3095 </span>            :                             &quot;                              The fee will be equally deducted from the amount of each specified output.\n&quot;</a>
<a name="3096"><span class="lineNum">    3096 </span>            :                             &quot;                              Those recipients will receive less bitcoins than you enter in their corresponding amount field.\n&quot;</a>
<a name="3097"><span class="lineNum">    3097 </span>            :                             &quot;                              If no outputs are specified here, the sender pays the fee.&quot;,</a>
<a name="3098"><span class="lineNum">    3098 </span><span class="lineCov">        164 :                                 {</span></a>
<a name="3099"><span class="lineNum">    3099 </span><span class="lineCov">         82 :                                     {&quot;vout_index&quot;, RPCArg::Type::NUM, RPCArg::Optional::OMITTED, &quot;The zero-based output index, before a change output is added.&quot;},</span></a>
<a name="3100"><span class="lineNum">    3100 </span>            :                                 },</a>
<a name="3101"><span class="lineNum">    3101 </span>            :                             },</a>
<a name="3102"><span class="lineNum">    3102 </span><span class="lineCov">         82 :                             {&quot;replaceable&quot;, RPCArg::Type::BOOL, /* default */ &quot;wallet default&quot;, &quot;Marks this transaction as BIP125 replaceable.\n&quot;</span></a>
<a name="3103"><span class="lineNum">    3103 </span>            :                             &quot;                              Allows this transaction to be replaced by a transaction with higher fees&quot;},</a>
<a name="3104"><span class="lineNum">    3104 </span><span class="lineCov">         82 :                             {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;wallet default&quot;, &quot;Confirmation target (in blocks), or fee rate (for &quot; + CURRENCY_UNIT + &quot;/kB or &quot; + CURRENCY_ATOM + &quot;/B estimate modes)&quot;},</span></a>
<a name="3105"><span class="lineNum">    3105 </span><span class="lineCov">        164 :                             {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="3106"><span class="lineNum">    3106 </span><span class="lineCov">         82 :                             &quot;       \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="3107"><span class="lineNum">    3107 </span>            :                         },</a>
<a name="3108"><span class="lineNum">    3108 </span><span class="lineCov">         82 :                         &quot;options&quot;},</span></a>
<a name="3109"><span class="lineNum">    3109 </span><span class="lineCov">         82 :                     {&quot;iswitness&quot;, RPCArg::Type::BOOL, /* default */ &quot;depends on heuristic tests&quot;, &quot;Whether the transaction hex is a serialized witness transaction.\n&quot;</span></a>
<a name="3110"><span class="lineNum">    3110 </span>            :                         &quot;If iswitness is not present, heuristic tests will be used in decoding.\n&quot;</a>
<a name="3111"><span class="lineNum">    3111 </span>            :                         &quot;If true, only witness deserialization will be tried.\n&quot;</a>
<a name="3112"><span class="lineNum">    3112 </span>            :                         &quot;If false, only non-witness deserialization will be tried.\n&quot;</a>
<a name="3113"><span class="lineNum">    3113 </span>            :                         &quot;This boolean should reflect whether the transaction has inputs\n&quot;</a>
<a name="3114"><span class="lineNum">    3114 </span>            :                         &quot;(e.g. fully valid, or on-chain transactions), if known by the caller.&quot;</a>
<a name="3115"><span class="lineNum">    3115 </span>            :                     },</a>
<a name="3116"><span class="lineNum">    3116 </span>            :                 },</a>
<a name="3117"><span class="lineNum">    3117 </span><span class="lineCov">         82 :                 RPCResult{</span></a>
<a name="3118"><span class="lineNum">    3118 </span><span class="lineCov">         82 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3119"><span class="lineNum">    3119 </span><span class="lineCov">        332 :                     {</span></a>
<a name="3120"><span class="lineNum">    3120 </span><span class="lineCov">         82 :                         {RPCResult::Type::STR_HEX, &quot;hex&quot;, &quot;The resulting raw transaction (hex-encoded string)&quot;},</span></a>
<a name="3121"><span class="lineNum">    3121 </span><span class="lineCov">         82 :                         {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;Fee in &quot; + CURRENCY_UNIT + &quot; the resulting transaction pays&quot;},</span></a>
<a name="3122"><span class="lineNum">    3122 </span><span class="lineCov">         82 :                         {RPCResult::Type::NUM, &quot;changepos&quot;, &quot;The position of the added change output, or -1&quot;},</span></a>
<a name="3123"><span class="lineNum">    3123 </span>            :                     }</a>
<a name="3124"><span class="lineNum">    3124 </span>            :                                 },</a>
<a name="3125"><span class="lineNum">    3125 </span><span class="lineCov">         82 :                                 RPCExamples{</span></a>
<a name="3126"><span class="lineNum">    3126 </span><span class="lineCov">         82 :                             &quot;\nCreate a transaction with no inputs\n&quot;</span></a>
<a name="3127"><span class="lineNum">    3127 </span><span class="lineCov">         82 :                             + HelpExampleCli(&quot;createrawtransaction&quot;, &quot;\&quot;[]\&quot; \&quot;{\\\&quot;myaddress\\\&quot;:0.01}\&quot;&quot;) +</span></a>
<a name="3128"><span class="lineNum">    3128 </span>            :                             &quot;\nAdd sufficient unsigned inputs to meet the output value\n&quot;</a>
<a name="3129"><span class="lineNum">    3129 </span><span class="lineCov">         82 :                             + HelpExampleCli(&quot;fundrawtransaction&quot;, &quot;\&quot;rawtransactionhex\&quot;&quot;) +</span></a>
<a name="3130"><span class="lineNum">    3130 </span>            :                             &quot;\nSign the transaction\n&quot;</a>
<a name="3131"><span class="lineNum">    3131 </span><span class="lineCov">         82 :                             + HelpExampleCli(&quot;signrawtransactionwithwallet&quot;, &quot;\&quot;fundedtransactionhex\&quot;&quot;) +</span></a>
<a name="3132"><span class="lineNum">    3132 </span>            :                             &quot;\nSend the transaction\n&quot;</a>
<a name="3133"><span class="lineNum">    3133 </span><span class="lineCov">         82 :                             + HelpExampleCli(&quot;sendrawtransaction&quot;, &quot;\&quot;signedtransactionhex\&quot;&quot;)</span></a>
<a name="3134"><span class="lineNum">    3134 </span>            :                                 },</a>
<a name="3135"><span class="lineNum">    3135 </span><span class="lineCov">         82 :     }.Check(request);</span></a>
<a name="3136"><span class="lineNum">    3136 </span>            : </a>
<a name="3137"><span class="lineNum">    3137 </span><span class="lineCov">         78 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3138"><span class="lineNum">    3138 </span><span class="lineCov">         78 :     if (!wallet) return NullUniValue;</span></a>
<a name="3139"><span class="lineNum">    3139 </span><span class="lineCov">         78 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="3140"><span class="lineNum">    3140 </span>            : </a>
<a name="3141"><span class="lineNum">    3141 </span><span class="lineCov">         78 :     RPCTypeCheck(request.params, {UniValue::VSTR, UniValueType(), UniValue::VBOOL});</span></a>
<a name="3142"><span class="lineNum">    3142 </span>            : </a>
<a name="3143"><span class="lineNum">    3143 </span>            :     // parse hex string from parameter</a>
<a name="3144"><span class="lineNum">    3144 </span><span class="lineCov">         78 :     CMutableTransaction tx;</span></a>
<a name="3145"><span class="lineNum">    3145 </span><span class="lineCov">         78 :     bool try_witness = request.params[2].isNull() ? true : request.params[2].get_bool();</span></a>
<a name="3146"><span class="lineNum">    3146 </span><span class="lineCov">         78 :     bool try_no_witness = request.params[2].isNull() ? true : !request.params[2].get_bool();</span></a>
<a name="3147"><span class="lineNum">    3147 </span><span class="lineCov">         78 :     if (!DecodeHexTx(tx, request.params[0].get_str(), try_no_witness, try_witness)) {</span></a>
<a name="3148"><span class="lineNum">    3148 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_DESERIALIZATION_ERROR, &quot;TX decode failed&quot;);</span></a>
<a name="3149"><span class="lineNum">    3149 </span>            :     }</a>
<a name="3150"><span class="lineNum">    3150 </span>            : </a>
<a name="3151"><span class="lineNum">    3151 </span><span class="lineCov">         78 :     CAmount fee;</span></a>
<a name="3152"><span class="lineNum">    3152 </span><span class="lineCov">         78 :     int change_position;</span></a>
<a name="3153"><span class="lineNum">    3153 </span><span class="lineCov">         78 :     CCoinControl coin_control;</span></a>
<a name="3154"><span class="lineNum">    3154 </span>            :     // Automatically select (additional) coins. Can be overridden by options.add_inputs.</a>
<a name="3155"><span class="lineNum">    3155 </span><span class="lineCov">         78 :     coin_control.m_add_inputs = true;</span></a>
<a name="3156"><span class="lineNum">    3156 </span><span class="lineCov">         78 :     FundTransaction(pwallet, tx, fee, change_position, request.params[1], coin_control);</span></a>
<a name="3157"><span class="lineNum">    3157 </span>            : </a>
<a name="3158"><span class="lineNum">    3158 </span><span class="lineCov">         59 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="3159"><span class="lineNum">    3159 </span><span class="lineCov">         59 :     result.pushKV(&quot;hex&quot;, EncodeHexTx(CTransaction(tx)));</span></a>
<a name="3160"><span class="lineNum">    3160 </span><span class="lineCov">         59 :     result.pushKV(&quot;fee&quot;, ValueFromAmount(fee));</span></a>
<a name="3161"><span class="lineNum">    3161 </span><span class="lineCov">         59 :     result.pushKV(&quot;changepos&quot;, change_position);</span></a>
<a name="3162"><span class="lineNum">    3162 </span>            : </a>
<a name="3163"><span class="lineNum">    3163 </span><span class="lineCov">         59 :     return result;</span></a>
<a name="3164"><span class="lineNum">    3164 </span><span class="lineCov">        170 : }</span></a>
<a name="3165"><span class="lineNum">    3165 </span>            : </a>
<a name="3166"><span class="lineNum">    3166 </span><span class="lineCov">       1653 : UniValue signrawtransactionwithwallet(const JSONRPCRequest&amp; request)</span></a>
<a name="3167"><span class="lineNum">    3167 </span>            : {</a>
<a name="3168"><span class="lineNum">    3168 </span><span class="lineCov">      26460 :             RPCHelpMan{&quot;signrawtransactionwithwallet&quot;,</span></a>
<a name="3169"><span class="lineNum">    3169 </span>            :                 &quot;\nSign inputs for raw transaction (serialized, hex-encoded).\n&quot;</a>
<a name="3170"><span class="lineNum">    3170 </span>            :                 &quot;The second optional argument (may be null) is an array of previous transaction outputs that\n&quot;</a>
<a name="3171"><span class="lineNum">    3171 </span><span class="lineCov">       1653 :                 &quot;this transaction depends on but may not yet be in the block chain.&quot; +</span></a>
<a name="3172"><span class="lineNum">    3172 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="3173"><span class="lineNum">    3173 </span><span class="lineCov">       6632 :                 {</span></a>
<a name="3174"><span class="lineNum">    3174 </span><span class="lineCov">       1653 :                     {&quot;hexstring&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The transaction hex string&quot;},</span></a>
<a name="3175"><span class="lineNum">    3175 </span><span class="lineCov">       3306 :                     {&quot;prevtxs&quot;, RPCArg::Type::ARR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;The previous dependent transaction outputs&quot;,</span></a>
<a name="3176"><span class="lineNum">    3176 </span><span class="lineCov">       3306 :                         {</span></a>
<a name="3177"><span class="lineNum">    3177 </span><span class="lineCov">       3306 :                             {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="3178"><span class="lineNum">    3178 </span><span class="lineCov">      11575 :                                 {</span></a>
<a name="3179"><span class="lineNum">    3179 </span><span class="lineCov">       1653 :                                     {&quot;txid&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The transaction id&quot;},</span></a>
<a name="3180"><span class="lineNum">    3180 </span><span class="lineCov">       1653 :                                     {&quot;vout&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The output number&quot;},</span></a>
<a name="3181"><span class="lineNum">    3181 </span><span class="lineCov">       1653 :                                     {&quot;scriptPubKey&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;script key&quot;},</span></a>
<a name="3182"><span class="lineNum">    3182 </span><span class="lineCov">       1653 :                                     {&quot;redeemScript&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::OMITTED, &quot;(required for P2SH) redeem script&quot;},</span></a>
<a name="3183"><span class="lineNum">    3183 </span><span class="lineCov">       1653 :                                     {&quot;witnessScript&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::OMITTED, &quot;(required for P2WSH or P2SH-P2WSH) witness script&quot;},</span></a>
<a name="3184"><span class="lineNum">    3184 </span><span class="lineCov">       1653 :                                     {&quot;amount&quot;, RPCArg::Type::AMOUNT, RPCArg::Optional::OMITTED, &quot;(required for Segwit inputs) the amount spent&quot;},</span></a>
<a name="3185"><span class="lineNum">    3185 </span>            :                                 },</a>
<a name="3186"><span class="lineNum">    3186 </span>            :                             },</a>
<a name="3187"><span class="lineNum">    3187 </span>            :                         },</a>
<a name="3188"><span class="lineNum">    3188 </span>            :                     },</a>
<a name="3189"><span class="lineNum">    3189 </span><span class="lineCov">       1653 :                     {&quot;sighashtype&quot;, RPCArg::Type::STR, /* default */ &quot;ALL&quot;, &quot;The signature hash type. Must be one of\n&quot;</span></a>
<a name="3190"><span class="lineNum">    3190 </span>            :             &quot;       \&quot;ALL\&quot;\n&quot;</a>
<a name="3191"><span class="lineNum">    3191 </span>            :             &quot;       \&quot;NONE\&quot;\n&quot;</a>
<a name="3192"><span class="lineNum">    3192 </span>            :             &quot;       \&quot;SINGLE\&quot;\n&quot;</a>
<a name="3193"><span class="lineNum">    3193 </span>            :             &quot;       \&quot;ALL|ANYONECANPAY\&quot;\n&quot;</a>
<a name="3194"><span class="lineNum">    3194 </span>            :             &quot;       \&quot;NONE|ANYONECANPAY\&quot;\n&quot;</a>
<a name="3195"><span class="lineNum">    3195 </span>            :             &quot;       \&quot;SINGLE|ANYONECANPAY\&quot;&quot;},</a>
<a name="3196"><span class="lineNum">    3196 </span>            :                 },</a>
<a name="3197"><span class="lineNum">    3197 </span><span class="lineCov">       1653 :                 RPCResult{</span></a>
<a name="3198"><span class="lineNum">    3198 </span><span class="lineCov">       1653 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3199"><span class="lineNum">    3199 </span><span class="lineCov">       6616 :                     {</span></a>
<a name="3200"><span class="lineNum">    3200 </span><span class="lineCov">       1653 :                         {RPCResult::Type::STR_HEX, &quot;hex&quot;, &quot;The hex-encoded raw transaction with signature(s)&quot;},</span></a>
<a name="3201"><span class="lineNum">    3201 </span><span class="lineCov">       1653 :                         {RPCResult::Type::BOOL, &quot;complete&quot;, &quot;If the transaction has a complete set of signatures&quot;},</span></a>
<a name="3202"><span class="lineNum">    3202 </span><span class="lineCov">       3306 :                         {RPCResult::Type::ARR, &quot;errors&quot;, /* optional */ true, &quot;Script verification errors (if there are any)&quot;,</span></a>
<a name="3203"><span class="lineNum">    3203 </span><span class="lineCov">       3306 :                         {</span></a>
<a name="3204"><span class="lineNum">    3204 </span><span class="lineCov">       3306 :                             {RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3205"><span class="lineNum">    3205 </span><span class="lineCov">       9922 :                             {</span></a>
<a name="3206"><span class="lineNum">    3206 </span><span class="lineCov">       1653 :                                 {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The hash of the referenced, previous transaction&quot;},</span></a>
<a name="3207"><span class="lineNum">    3207 </span><span class="lineCov">       1653 :                                 {RPCResult::Type::NUM, &quot;vout&quot;, &quot;The index of the output to spent and used as input&quot;},</span></a>
<a name="3208"><span class="lineNum">    3208 </span><span class="lineCov">       1653 :                                 {RPCResult::Type::STR_HEX, &quot;scriptSig&quot;, &quot;The hex-encoded signature script&quot;},</span></a>
<a name="3209"><span class="lineNum">    3209 </span><span class="lineCov">       1653 :                                 {RPCResult::Type::NUM, &quot;sequence&quot;, &quot;Script sequence number&quot;},</span></a>
<a name="3210"><span class="lineNum">    3210 </span><span class="lineCov">       1653 :                                 {RPCResult::Type::STR, &quot;error&quot;, &quot;Verification or signing error related to the input&quot;},</span></a>
<a name="3211"><span class="lineNum">    3211 </span>            :                             }},</a>
<a name="3212"><span class="lineNum">    3212 </span>            :                         }},</a>
<a name="3213"><span class="lineNum">    3213 </span>            :                     }</a>
<a name="3214"><span class="lineNum">    3214 </span>            :                 },</a>
<a name="3215"><span class="lineNum">    3215 </span><span class="lineCov">       1653 :                 RPCExamples{</span></a>
<a name="3216"><span class="lineNum">    3216 </span><span class="lineCov">       1653 :                     HelpExampleCli(&quot;signrawtransactionwithwallet&quot;, &quot;\&quot;myhex\&quot;&quot;)</span></a>
<a name="3217"><span class="lineNum">    3217 </span><span class="lineCov">       1653 :             + HelpExampleRpc(&quot;signrawtransactionwithwallet&quot;, &quot;\&quot;myhex\&quot;&quot;)</span></a>
<a name="3218"><span class="lineNum">    3218 </span>            :                 },</a>
<a name="3219"><span class="lineNum">    3219 </span><span class="lineCov">       1653 :             }.Check(request);</span></a>
<a name="3220"><span class="lineNum">    3220 </span>            : </a>
<a name="3221"><span class="lineNum">    3221 </span><span class="lineCov">       1649 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3222"><span class="lineNum">    3222 </span><span class="lineCov">       1649 :     if (!wallet) return NullUniValue;</span></a>
<a name="3223"><span class="lineNum">    3223 </span><span class="lineCov">       1649 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="3224"><span class="lineNum">    3224 </span>            : </a>
<a name="3225"><span class="lineNum">    3225 </span><span class="lineCov">       1649 :     RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VARR, UniValue::VSTR}, true);</span></a>
<a name="3226"><span class="lineNum">    3226 </span>            : </a>
<a name="3227"><span class="lineNum">    3227 </span><span class="lineCov">       1649 :     CMutableTransaction mtx;</span></a>
<a name="3228"><span class="lineNum">    3228 </span><span class="lineCov">       1649 :     if (!DecodeHexTx(mtx, request.params[0].get_str(), true)) {</span></a>
<a name="3229"><span class="lineNum">    3229 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_DESERIALIZATION_ERROR, &quot;TX decode failed&quot;);</span></a>
<a name="3230"><span class="lineNum">    3230 </span>            :     }</a>
<a name="3231"><span class="lineNum">    3231 </span>            : </a>
<a name="3232"><span class="lineNum">    3232 </span>            :     // Sign the transaction</a>
<a name="3233"><span class="lineNum">    3233 </span><span class="lineCov">       1649 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="3234"><span class="lineNum">    3234 </span><span class="lineCov">       1649 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="3235"><span class="lineNum">    3235 </span>            : </a>
<a name="3236"><span class="lineNum">    3236 </span>            :     // Fetch previous transactions (inputs):</a>
<a name="3237"><span class="lineNum">    3237 </span><span class="lineCov">       1648 :     std::map&lt;COutPoint, Coin&gt; coins;</span></a>
<a name="3238"><span class="lineNum">    3238 </span><span class="lineCov">      10218 :     for (const CTxIn&amp; txin : mtx.vin) {</span></a>
<a name="3239"><span class="lineNum">    3239 </span><span class="lineCov">       8570 :         coins[txin.prevout]; // Create empty map entry keyed by prevout.</span></a>
<a name="3240"><span class="lineNum">    3240 </span>            :     }</a>
<a name="3241"><span class="lineNum">    3241 </span><span class="lineCov">       1648 :     pwallet-&gt;chain().findCoins(coins);</span></a>
<a name="3242"><span class="lineNum">    3242 </span>            : </a>
<a name="3243"><span class="lineNum">    3243 </span>            :     // Parse the prevtxs array</a>
<a name="3244"><span class="lineNum">    3244 </span><span class="lineCov">       1648 :     ParsePrevouts(request.params[1], nullptr, coins);</span></a>
<a name="3245"><span class="lineNum">    3245 </span>            : </a>
<a name="3246"><span class="lineNum">    3246 </span><span class="lineCov">       1639 :     int nHashType = ParseSighashString(request.params[2]);</span></a>
<a name="3247"><span class="lineNum">    3247 </span>            : </a>
<a name="3248"><span class="lineNum">    3248 </span>            :     // Script verification errors</a>
<a name="3249"><span class="lineNum">    3249 </span><span class="lineCov">       1639 :     std::map&lt;int, std::string&gt; input_errors;</span></a>
<a name="3250"><span class="lineNum">    3250 </span>            : </a>
<a name="3251"><span class="lineNum">    3251 </span><span class="lineCov">       1639 :     bool complete = pwallet-&gt;SignTransaction(mtx, coins, nHashType, input_errors);</span></a>
<a name="3252"><span class="lineNum">    3252 </span><span class="lineCov">       1639 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="3253"><span class="lineNum">    3253 </span><span class="lineCov">       1639 :     SignTransactionResultToJSON(mtx, complete, coins, input_errors, result);</span></a>
<a name="3254"><span class="lineNum">    3254 </span><span class="lineCov">       1637 :     return result;</span></a>
<a name="3255"><span class="lineNum">    3255 </span><span class="lineCov">       1741 : }</span></a>
<a name="3256"><span class="lineNum">    3256 </span>            : </a>
<a name="3257"><span class="lineNum">    3257 </span><span class="lineCov">        117 : static UniValue bumpfee(const JSONRPCRequest&amp; request)</span></a>
<a name="3258"><span class="lineNum">    3258 </span>            : {</a>
<a name="3259"><span class="lineNum">    3259 </span><span class="lineCov">        117 :     bool want_psbt = request.strMethod == &quot;psbtbumpfee&quot;;</span></a>
<a name="3260"><span class="lineNum">    3260 </span>            : </a>
<a name="3261"><span class="lineNum">    3261 </span><span class="lineCov">       1053 :     RPCHelpMan{request.strMethod,</span></a>
<a name="3262"><span class="lineNum">    3262 </span><span class="lineCov">        117 :         &quot;\nBumps the fee of an opt-in-RBF transaction T, replacing it with a new transaction B.\n&quot;</span></a>
<a name="3263"><span class="lineNum">    3263 </span><span class="lineCov">        117 :         + std::string(want_psbt ? &quot;Returns a PSBT instead of creating and signing a new transaction.\n&quot; : &quot;&quot;) +</span></a>
<a name="3264"><span class="lineNum">    3264 </span>            :         &quot;An opt-in RBF transaction with the given txid must be in the wallet.\n&quot;</a>
<a name="3265"><span class="lineNum">    3265 </span>            :         &quot;The command will pay the additional fee by reducing change outputs or adding inputs when necessary. It may add a new change output if one does not already exist.\n&quot;</a>
<a name="3266"><span class="lineNum">    3266 </span>            :         &quot;All inputs in the original transaction will be included in the replacement transaction.\n&quot;</a>
<a name="3267"><span class="lineNum">    3267 </span>            :         &quot;The command will fail if the wallet or mempool contains a transaction that spends one of T's outputs.\n&quot;</a>
<a name="3268"><span class="lineNum">    3268 </span>            :         &quot;By default, the new fee will be calculated automatically using estimatesmartfee.\n&quot;</a>
<a name="3269"><span class="lineNum">    3269 </span>            :         &quot;The user can specify a confirmation target for estimatesmartfee.\n&quot;</a>
<a name="3270"><span class="lineNum">    3270 </span><span class="lineCov">        117 :         &quot;Alternatively, the user can specify a fee_rate (&quot; + CURRENCY_UNIT + &quot; per kB) for the new transaction.\n&quot;</span></a>
<a name="3271"><span class="lineNum">    3271 </span>            :         &quot;At a minimum, the new fee rate must be high enough to pay an additional new relay fee (incrementalfee\n&quot;</a>
<a name="3272"><span class="lineNum">    3272 </span>            :         &quot;returned by getnetworkinfo) to enter the node's mempool.\n&quot;,</a>
<a name="3273"><span class="lineNum">    3273 </span><span class="lineCov">        359 :         {</span></a>
<a name="3274"><span class="lineNum">    3274 </span><span class="lineCov">        117 :             {&quot;txid&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The txid to be bumped&quot;},</span></a>
<a name="3275"><span class="lineNum">    3275 </span><span class="lineCov">        234 :             {&quot;options&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;&quot;,</span></a>
<a name="3276"><span class="lineNum">    3276 </span><span class="lineCov">        593 :                 {</span></a>
<a name="3277"><span class="lineNum">    3277 </span><span class="lineCov">        117 :                     {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;wallet default&quot;, &quot;Confirmation target (in blocks)&quot;},</span></a>
<a name="3278"><span class="lineNum">    3278 </span><span class="lineCov">        234 :                     {&quot;fee_rate&quot;, RPCArg::Type::NUM, /* default */ &quot;fall back to 'conf_target'&quot;, &quot;fee rate (NOT total fee) to pay, in &quot; + CURRENCY_UNIT + &quot; per kB\n&quot;</span></a>
<a name="3279"><span class="lineNum">    3279 </span>            :     &quot;                         Specify a fee rate instead of relying on the built-in fee estimator.\n&quot;</a>
<a name="3280"><span class="lineNum">    3280 </span><span class="lineCov">        117 :                              &quot;Must be at least 0.0001 &quot; + CURRENCY_UNIT + &quot; per kB higher than the current transaction fee rate.\n&quot;},</span></a>
<a name="3281"><span class="lineNum">    3281 </span><span class="lineCov">        117 :                     {&quot;replaceable&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Whether the new transaction should still be\n&quot;</span></a>
<a name="3282"><span class="lineNum">    3282 </span>            :     &quot;                         marked bip-125 replaceable. If true, the sequence numbers in the transaction will\n&quot;</a>
<a name="3283"><span class="lineNum">    3283 </span>            :     &quot;                         be left unchanged from the original. If false, any input sequence numbers in the\n&quot;</a>
<a name="3284"><span class="lineNum">    3284 </span>            :     &quot;                         original transaction that were less than 0xfffffffe will be increased to 0xfffffffe\n&quot;</a>
<a name="3285"><span class="lineNum">    3285 </span>            :     &quot;                         so the new transaction will not be explicitly bip-125 replaceable (though it may\n&quot;</a>
<a name="3286"><span class="lineNum">    3286 </span>            :     &quot;                         still be replaceable in practice, for example if it has unconfirmed ancestors which\n&quot;</a>
<a name="3287"><span class="lineNum">    3287 </span>            :     &quot;                         are replaceable).&quot;},</a>
<a name="3288"><span class="lineNum">    3288 </span><span class="lineCov">        234 :                     {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="3289"><span class="lineNum">    3289 </span><span class="lineCov">        117 :     &quot;         \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="3290"><span class="lineNum">    3290 </span>            :                 },</a>
<a name="3291"><span class="lineNum">    3291 </span><span class="lineCov">        117 :                 &quot;options&quot;},</span></a>
<a name="3292"><span class="lineNum">    3292 </span>            :         },</a>
<a name="3293"><span class="lineNum">    3293 </span><span class="lineCov">        117 :         RPCResult{</span></a>
<a name="3294"><span class="lineNum">    3294 </span><span class="lineCov">        351 :             RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;, Cat(Cat&lt;std::vector&lt;RPCResult&gt;&gt;(</span></a>
<a name="3295"><span class="lineNum">    3295 </span><span class="lineCov">        234 :             {</span></a>
<a name="3296"><span class="lineNum">    3296 </span><span class="lineCov">        117 :                 {RPCResult::Type::STR, &quot;psbt&quot;, &quot;The base64-encoded unsigned PSBT of the new transaction.&quot; + std::string(want_psbt ? &quot;&quot; : &quot; Only returned when wallet private keys are disabled. (DEPRECATED)&quot;)},</span></a>
<a name="3297"><span class="lineNum">    3297 </span>            :             },</a>
<a name="3298"><span class="lineNum">    3298 </span><span class="lineCov">        117 :             want_psbt ? std::vector&lt;RPCResult&gt;{} : std::vector&lt;RPCResult&gt;{{RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The id of the new transaction. Only returned when wallet private keys are enabled.&quot;}}</span></a>
<a name="3299"><span class="lineNum">    3299 </span>            :             ),</a>
<a name="3300"><span class="lineNum">    3300 </span><span class="lineCov">        476 :             {</span></a>
<a name="3301"><span class="lineNum">    3301 </span><span class="lineCov">        117 :                 {RPCResult::Type::STR_AMOUNT, &quot;origfee&quot;, &quot;The fee of the replaced transaction.&quot;},</span></a>
<a name="3302"><span class="lineNum">    3302 </span><span class="lineCov">        117 :                 {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;The fee of the new transaction.&quot;},</span></a>
<a name="3303"><span class="lineNum">    3303 </span><span class="lineCov">        234 :                 {RPCResult::Type::ARR, &quot;errors&quot;, &quot;Errors encountered during processing (may be empty).&quot;,</span></a>
<a name="3304"><span class="lineNum">    3304 </span><span class="lineCov">        234 :                 {</span></a>
<a name="3305"><span class="lineNum">    3305 </span><span class="lineCov">        117 :                     {RPCResult::Type::STR, &quot;&quot;, &quot;&quot;},</span></a>
<a name="3306"><span class="lineNum">    3306 </span>            :                 }},</a>
<a name="3307"><span class="lineNum">    3307 </span>            :             })</a>
<a name="3308"><span class="lineNum">    3308 </span>            :         },</a>
<a name="3309"><span class="lineNum">    3309 </span><span class="lineCov">        117 :         RPCExamples{</span></a>
<a name="3310"><span class="lineNum">    3310 </span><span class="lineCov">        234 :     &quot;\nBump the fee, get the new transaction\'s&quot; + std::string(want_psbt ? &quot;psbt&quot; : &quot;txid&quot;) + &quot;\n&quot; +</span></a>
<a name="3311"><span class="lineNum">    3311 </span><span class="lineCov">        117 :             HelpExampleCli(request.strMethod, &quot;&lt;txid&gt;&quot;)</span></a>
<a name="3312"><span class="lineNum">    3312 </span>            :         },</a>
<a name="3313"><span class="lineNum">    3313 </span><span class="lineCov">        117 :     }.Check(request);</span></a>
<a name="3314"><span class="lineNum">    3314 </span>            : </a>
<a name="3315"><span class="lineNum">    3315 </span><span class="lineCov">        109 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3316"><span class="lineNum">    3316 </span><span class="lineCov">        109 :     if (!wallet) return NullUniValue;</span></a>
<a name="3317"><span class="lineNum">    3317 </span><span class="lineCov">        109 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="3318"><span class="lineNum">    3318 </span>            : </a>
<a name="3319"><span class="lineNum">    3319 </span><span class="lineCov">        109 :     if (pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) &amp;&amp; !want_psbt) {</span></a>
<a name="3320"><span class="lineNum">    3320 </span><span class="lineCov">          2 :         if (!pwallet-&gt;chain().rpcEnableDeprecated(&quot;bumpfee&quot;)) {</span></a>
<a name="3321"><span class="lineNum">    3321 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_METHOD_DEPRECATED, &quot;Using bumpfee with wallets that have private keys disabled is deprecated. Use psbtbumpfee instead or restart bitcoind with -deprecatedrpc=bumpfee. This functionality will be removed in 0.22&quot;);</span></a>
<a name="3322"><span class="lineNum">    3322 </span>            :         }</a>
<a name="3323"><span class="lineNum">    3323 </span>            :         want_psbt = true;</a>
<a name="3324"><span class="lineNum">    3324 </span><span class="lineCov">          1 :     }</span></a>
<a name="3325"><span class="lineNum">    3325 </span>            : </a>
<a name="3326"><span class="lineNum">    3326 </span><span class="lineCov">        108 :     RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VOBJ});</span></a>
<a name="3327"><span class="lineNum">    3327 </span><span class="lineCov">        108 :     uint256 hash(ParseHashV(request.params[0], &quot;txid&quot;));</span></a>
<a name="3328"><span class="lineNum">    3328 </span>            : </a>
<a name="3329"><span class="lineNum">    3329 </span><span class="lineCov">        108 :     CCoinControl coin_control;</span></a>
<a name="3330"><span class="lineNum">    3330 </span><span class="lineCov">        108 :     coin_control.fAllowWatchOnly = pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS);</span></a>
<a name="3331"><span class="lineNum">    3331 </span>            :     // optional parameters</a>
<a name="3332"><span class="lineNum">    3332 </span><span class="lineCov">        108 :     coin_control.m_signal_bip125_rbf = true;</span></a>
<a name="3333"><span class="lineNum">    3333 </span>            : </a>
<a name="3334"><span class="lineNum">    3334 </span><span class="lineCov">        108 :     if (!request.params[1].isNull()) {</span></a>
<a name="3335"><span class="lineNum">    3335 </span><span class="lineCov">         21 :         UniValue options = request.params[1];</span></a>
<a name="3336"><span class="lineNum">    3336 </span><span class="lineCov">        105 :         RPCTypeCheckObj(options,</span></a>
<a name="3337"><span class="lineNum">    3337 </span><span class="lineCov">        129 :             {</span></a>
<a name="3338"><span class="lineNum">    3338 </span><span class="lineCov">         21 :                 {&quot;confTarget&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="3339"><span class="lineNum">    3339 </span><span class="lineCov">         21 :                 {&quot;conf_target&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="3340"><span class="lineNum">    3340 </span><span class="lineCov">         21 :                 {&quot;fee_rate&quot;, UniValueType(UniValue::VNUM)},</span></a>
<a name="3341"><span class="lineNum">    3341 </span><span class="lineCov">         21 :                 {&quot;replaceable&quot;, UniValueType(UniValue::VBOOL)},</span></a>
<a name="3342"><span class="lineNum">    3342 </span><span class="lineCov">         21 :                 {&quot;estimate_mode&quot;, UniValueType(UniValue::VSTR)},</span></a>
<a name="3343"><span class="lineNum">    3343 </span>            :             },</a>
<a name="3344"><span class="lineNum">    3344 </span>            :             true, true);</a>
<a name="3345"><span class="lineNum">    3345 </span>            : </a>
<a name="3346"><span class="lineNum">    3346 </span><span class="lineCov">         18 :         if (options.exists(&quot;confTarget&quot;) &amp;&amp; options.exists(&quot;conf_target&quot;)) {</span></a>
<a name="3347"><span class="lineNum">    3347 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;confTarget and conf_target options should not both be set. Use conf_target (confTarget is deprecated).&quot;);</span></a>
<a name="3348"><span class="lineNum">    3348 </span>            :         }</a>
<a name="3349"><span class="lineNum">    3349 </span>            : </a>
<a name="3350"><span class="lineNum">    3350 </span><span class="lineCov">         17 :         auto conf_target = options.exists(&quot;confTarget&quot;) ? options[&quot;confTarget&quot;] : options[&quot;conf_target&quot;];</span></a>
<a name="3351"><span class="lineNum">    3351 </span>            : </a>
<a name="3352"><span class="lineNum">    3352 </span><span class="lineCov">         17 :         if (!conf_target.isNull()) {</span></a>
<a name="3353"><span class="lineNum">    3353 </span><span class="lineCov">          2 :             if (options.exists(&quot;fee_rate&quot;)) {</span></a>
<a name="3354"><span class="lineNum">    3354 </span><span class="lineCov">          2 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;conf_target can't be set with fee_rate. Please provide either a confirmation target in blocks for automatic fee estimation, or an explicit fee rate.&quot;);</span></a>
<a name="3355"><span class="lineNum">    3355 </span>            :             }</a>
<a name="3356"><span class="lineNum">    3356 </span><span class="lineNoCov">          0 :             coin_control.m_confirm_target = ParseConfirmTarget(conf_target, pwallet-&gt;chain().estimateMaxBlocks());</span></a>
<a name="3357"><span class="lineNum">    3357 </span><span class="lineCov">         15 :         } else if (options.exists(&quot;fee_rate&quot;)) {</span></a>
<a name="3358"><span class="lineNum">    3358 </span><span class="lineCov">         13 :             CFeeRate fee_rate(AmountFromValue(options[&quot;fee_rate&quot;]));</span></a>
<a name="3359"><span class="lineNum">    3359 </span><span class="lineCov">         12 :             if (fee_rate &lt;= CFeeRate(0)) {</span></a>
<a name="3360"><span class="lineNum">    3360 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(&quot;Invalid fee_rate %s (must be greater than 0)&quot;, fee_rate.ToString()));</span></a>
<a name="3361"><span class="lineNum">    3361 </span>            :             }</a>
<a name="3362"><span class="lineNum">    3362 </span><span class="lineCov">         12 :             coin_control.m_feerate = fee_rate;</span></a>
<a name="3363"><span class="lineNum">    3363 </span><span class="lineCov">         13 :         }</span></a>
<a name="3364"><span class="lineNum">    3364 </span>            : </a>
<a name="3365"><span class="lineNum">    3365 </span><span class="lineCov">         14 :         if (options.exists(&quot;replaceable&quot;)) {</span></a>
<a name="3366"><span class="lineNum">    3366 </span><span class="lineCov">          1 :             coin_control.m_signal_bip125_rbf = options[&quot;replaceable&quot;].get_bool();</span></a>
<a name="3367"><span class="lineNum">    3367 </span><span class="lineCov">          1 :         }</span></a>
<a name="3368"><span class="lineNum">    3368 </span><span class="lineCov">         14 :         SetFeeEstimateMode(pwallet, coin_control, options[&quot;estimate_mode&quot;], conf_target);</span></a>
<a name="3369"><span class="lineNum">    3369 </span><span class="lineCov">         21 :     }</span></a>
<a name="3370"><span class="lineNum">    3370 </span>            : </a>
<a name="3371"><span class="lineNum">    3371 </span>            :     // Make sure the results are valid at least up to the most recent block</a>
<a name="3372"><span class="lineNum">    3372 </span>            :     // the user could have gotten from another RPC command prior to now</a>
<a name="3373"><span class="lineNum">    3373 </span><span class="lineCov">         99 :     pwallet-&gt;BlockUntilSyncedToCurrentChain();</span></a>
<a name="3374"><span class="lineNum">    3374 </span>            : </a>
<a name="3375"><span class="lineNum">    3375 </span><span class="lineCov">         99 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="3376"><span class="lineNum">    3376 </span><span class="lineCov">         99 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="3377"><span class="lineNum">    3377 </span>            : </a>
<a name="3378"><span class="lineNum">    3378 </span>            : </a>
<a name="3379"><span class="lineNum">    3379 </span><span class="lineCov">         98 :     std::vector&lt;bilingual_str&gt; errors;</span></a>
<a name="3380"><span class="lineNum">    3380 </span><span class="lineCov">         98 :     CAmount old_fee;</span></a>
<a name="3381"><span class="lineNum">    3381 </span><span class="lineCov">         98 :     CAmount new_fee;</span></a>
<a name="3382"><span class="lineNum">    3382 </span><span class="lineCov">         98 :     CMutableTransaction mtx;</span></a>
<a name="3383"><span class="lineNum">    3383 </span>            :     feebumper::Result res;</a>
<a name="3384"><span class="lineNum">    3384 </span>            :     // Targeting feerate bump.</a>
<a name="3385"><span class="lineNum">    3385 </span><span class="lineCov">         98 :     res = feebumper::CreateRateBumpTransaction(*pwallet, hash, coin_control, errors, old_fee, new_fee, mtx);</span></a>
<a name="3386"><span class="lineNum">    3386 </span><span class="lineCov">         98 :     if (res != feebumper::Result::OK) {</span></a>
<a name="3387"><span class="lineNum">    3387 </span><span class="lineCov">          9 :         switch(res) {</span></a>
<a name="3388"><span class="lineNum">    3388 </span>            :             case feebumper::Result::INVALID_ADDRESS_OR_KEY:</a>
<a name="3389"><span class="lineNum">    3389 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, errors[0].original);</span></a>
<a name="3390"><span class="lineNum">    3390 </span>            :                 break;</a>
<a name="3391"><span class="lineNum">    3391 </span>            :             case feebumper::Result::INVALID_REQUEST:</a>
<a name="3392"><span class="lineNum">    3392 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_REQUEST, errors[0].original);</span></a>
<a name="3393"><span class="lineNum">    3393 </span>            :                 break;</a>
<a name="3394"><span class="lineNum">    3394 </span>            :             case feebumper::Result::INVALID_PARAMETER:</a>
<a name="3395"><span class="lineNum">    3395 </span><span class="lineCov">          2 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, errors[0].original);</span></a>
<a name="3396"><span class="lineNum">    3396 </span>            :                 break;</a>
<a name="3397"><span class="lineNum">    3397 </span>            :             case feebumper::Result::WALLET_ERROR:</a>
<a name="3398"><span class="lineNum">    3398 </span><span class="lineCov">          7 :                 throw JSONRPCError(RPC_WALLET_ERROR, errors[0].original);</span></a>
<a name="3399"><span class="lineNum">    3399 </span>            :                 break;</a>
<a name="3400"><span class="lineNum">    3400 </span>            :             default:</a>
<a name="3401"><span class="lineNum">    3401 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_MISC_ERROR, errors[0].original);</span></a>
<a name="3402"><span class="lineNum">    3402 </span>            :                 break;</a>
<a name="3403"><span class="lineNum">    3403 </span>            :         }</a>
<a name="3404"><span class="lineNum">    3404 </span>            :     }</a>
<a name="3405"><span class="lineNum">    3405 </span>            : </a>
<a name="3406"><span class="lineNum">    3406 </span><span class="lineCov">         89 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="3407"><span class="lineNum">    3407 </span>            : </a>
<a name="3408"><span class="lineNum">    3408 </span>            :     // If wallet private keys are enabled, return the new transaction id,</a>
<a name="3409"><span class="lineNum">    3409 </span>            :     // otherwise return the base64-encoded unsigned PSBT of the new transaction.</a>
<a name="3410"><span class="lineNum">    3410 </span><span class="lineCov">         89 :     if (!want_psbt) {</span></a>
<a name="3411"><span class="lineNum">    3411 </span><span class="lineCov">         85 :         if (!feebumper::SignTransaction(*pwallet, mtx)) {</span></a>
<a name="3412"><span class="lineNum">    3412 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_WALLET_ERROR, &quot;Can't sign transaction.&quot;);</span></a>
<a name="3413"><span class="lineNum">    3413 </span>            :         }</a>
<a name="3414"><span class="lineNum">    3414 </span>            : </a>
<a name="3415"><span class="lineNum">    3415 </span><span class="lineCov">         85 :         uint256 txid;</span></a>
<a name="3416"><span class="lineNum">    3416 </span><span class="lineCov">         85 :         if (feebumper::CommitTransaction(*pwallet, hash, std::move(mtx), errors, txid) != feebumper::Result::OK) {</span></a>
<a name="3417"><span class="lineNum">    3417 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_WALLET_ERROR, errors[0].original);</span></a>
<a name="3418"><span class="lineNum">    3418 </span>            :         }</a>
<a name="3419"><span class="lineNum">    3419 </span>            : </a>
<a name="3420"><span class="lineNum">    3420 </span><span class="lineCov">         85 :         result.pushKV(&quot;txid&quot;, txid.GetHex());</span></a>
<a name="3421"><span class="lineNum">    3421 </span><span class="lineCov">         85 :     } else {</span></a>
<a name="3422"><span class="lineNum">    3422 </span><span class="lineCov">          4 :         PartiallySignedTransaction psbtx(mtx);</span></a>
<a name="3423"><span class="lineNum">    3423 </span><span class="lineCov">          4 :         bool complete = false;</span></a>
<a name="3424"><span class="lineNum">    3424 </span><span class="lineCov">          4 :         const TransactionError err = pwallet-&gt;FillPSBT(psbtx, complete, SIGHASH_ALL, false /* sign */, true /* bip32derivs */);</span></a>
<a name="3425"><span class="lineNum">    3425 </span><span class="lineCov">          4 :         CHECK_NONFATAL(err == TransactionError::OK);</span></a>
<a name="3426"><span class="lineNum">    3426 </span><span class="lineCov">          4 :         CHECK_NONFATAL(!complete);</span></a>
<a name="3427"><span class="lineNum">    3427 </span><span class="lineCov">          4 :         CDataStream ssTx(SER_NETWORK, PROTOCOL_VERSION);</span></a>
<a name="3428"><span class="lineNum">    3428 </span><span class="lineCov">          4 :         ssTx &lt;&lt; psbtx;</span></a>
<a name="3429"><span class="lineNum">    3429 </span><span class="lineCov">          4 :         result.pushKV(&quot;psbt&quot;, EncodeBase64(ssTx.str()));</span></a>
<a name="3430"><span class="lineNum">    3430 </span><span class="lineCov">          4 :     }</span></a>
<a name="3431"><span class="lineNum">    3431 </span>            : </a>
<a name="3432"><span class="lineNum">    3432 </span><span class="lineCov">         89 :     result.pushKV(&quot;origfee&quot;, ValueFromAmount(old_fee));</span></a>
<a name="3433"><span class="lineNum">    3433 </span><span class="lineCov">         89 :     result.pushKV(&quot;fee&quot;, ValueFromAmount(new_fee));</span></a>
<a name="3434"><span class="lineNum">    3434 </span><span class="lineCov">         89 :     UniValue result_errors(UniValue::VARR);</span></a>
<a name="3435"><span class="lineNum">    3435 </span><span class="lineCov">         89 :     for (const bilingual_str&amp; error : errors) {</span></a>
<a name="3436"><span class="lineNum">    3436 </span><span class="lineNoCov">          0 :         result_errors.push_back(error.original);</span></a>
<a name="3437"><span class="lineNum">    3437 </span>            :     }</a>
<a name="3438"><span class="lineNum">    3438 </span><span class="lineCov">         89 :     result.pushKV(&quot;errors&quot;, result_errors);</span></a>
<a name="3439"><span class="lineNum">    3439 </span>            : </a>
<a name="3440"><span class="lineNum">    3440 </span><span class="lineCov">         89 :     return result;</span></a>
<a name="3441"><span class="lineNum">    3441 </span><span class="lineCov">        273 : }</span></a>
<a name="3442"><span class="lineNum">    3442 </span>            : </a>
<a name="3443"><span class="lineNum">    3443 </span><span class="lineCov">          7 : static UniValue psbtbumpfee(const JSONRPCRequest&amp; request)</span></a>
<a name="3444"><span class="lineNum">    3444 </span>            : {</a>
<a name="3445"><span class="lineNum">    3445 </span><span class="lineCov">          7 :     return bumpfee(request);</span></a>
<a name="3446"><span class="lineNum">    3446 </span>            : }</a>
<a name="3447"><span class="lineNum">    3447 </span>            : </a>
<a name="3448"><span class="lineNum">    3448 </span><span class="lineCov">         11 : UniValue rescanblockchain(const JSONRPCRequest&amp; request)</span></a>
<a name="3449"><span class="lineNum">    3449 </span>            : {</a>
<a name="3450"><span class="lineNum">    3450 </span><span class="lineCov">         55 :             RPCHelpMan{&quot;rescanblockchain&quot;,</span></a>
<a name="3451"><span class="lineNum">    3451 </span><span class="lineCov">         11 :                 &quot;\nRescan the local blockchain for wallet related transactions.\n&quot;</span></a>
<a name="3452"><span class="lineNum">    3452 </span>            :                 &quot;Note: Use \&quot;getwalletinfo\&quot; to query the scanning progress.\n&quot;,</a>
<a name="3453"><span class="lineNum">    3453 </span><span class="lineCov">         37 :                 {</span></a>
<a name="3454"><span class="lineNum">    3454 </span><span class="lineCov">         11 :                     {&quot;start_height&quot;, RPCArg::Type::NUM, /* default */ &quot;0&quot;, &quot;block height where the rescan should start&quot;},</span></a>
<a name="3455"><span class="lineNum">    3455 </span><span class="lineCov">         11 :                     {&quot;stop_height&quot;, RPCArg::Type::NUM, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;the last block height that should be scanned. If none is provided it will rescan up to the tip at return time of this call.&quot;},</span></a>
<a name="3456"><span class="lineNum">    3456 </span>            :                 },</a>
<a name="3457"><span class="lineNum">    3457 </span><span class="lineCov">         11 :                 RPCResult{</span></a>
<a name="3458"><span class="lineNum">    3458 </span><span class="lineCov">         11 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3459"><span class="lineNum">    3459 </span><span class="lineCov">         37 :                     {</span></a>
<a name="3460"><span class="lineNum">    3460 </span><span class="lineCov">         11 :                         {RPCResult::Type::NUM, &quot;start_height&quot;, &quot;The block height where the rescan started (the requested height or 0)&quot;},</span></a>
<a name="3461"><span class="lineNum">    3461 </span><span class="lineCov">         11 :                         {RPCResult::Type::NUM, &quot;stop_height&quot;, &quot;The height of the last rescanned block. May be null in rare cases if there was a reorg and the call didn't scan any blocks because they were already scanned in the background.&quot;},</span></a>
<a name="3462"><span class="lineNum">    3462 </span>            :                     }</a>
<a name="3463"><span class="lineNum">    3463 </span>            :                 },</a>
<a name="3464"><span class="lineNum">    3464 </span><span class="lineCov">         11 :                 RPCExamples{</span></a>
<a name="3465"><span class="lineNum">    3465 </span><span class="lineCov">         11 :                     HelpExampleCli(&quot;rescanblockchain&quot;, &quot;100000 120000&quot;)</span></a>
<a name="3466"><span class="lineNum">    3466 </span><span class="lineCov">         11 :             + HelpExampleRpc(&quot;rescanblockchain&quot;, &quot;100000, 120000&quot;)</span></a>
<a name="3467"><span class="lineNum">    3467 </span>            :                 },</a>
<a name="3468"><span class="lineNum">    3468 </span><span class="lineCov">         11 :             }.Check(request);</span></a>
<a name="3469"><span class="lineNum">    3469 </span>            : </a>
<a name="3470"><span class="lineNum">    3470 </span><span class="lineCov">          7 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3471"><span class="lineNum">    3471 </span><span class="lineCov">          7 :     if (!wallet) return NullUniValue;</span></a>
<a name="3472"><span class="lineNum">    3472 </span><span class="lineCov">          7 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="3473"><span class="lineNum">    3473 </span>            : </a>
<a name="3474"><span class="lineNum">    3474 </span><span class="lineCov">          7 :     WalletRescanReserver reserver(*pwallet);</span></a>
<a name="3475"><span class="lineNum">    3475 </span><span class="lineCov">          7 :     if (!reserver.reserve()) {</span></a>
<a name="3476"><span class="lineNum">    3476 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Wallet is currently rescanning. Abort existing rescan or wait.&quot;);</span></a>
<a name="3477"><span class="lineNum">    3477 </span>            :     }</a>
<a name="3478"><span class="lineNum">    3478 </span>            : </a>
<a name="3479"><span class="lineNum">    3479 </span>            :     int start_height = 0;</a>
<a name="3480"><span class="lineNum">    3480 </span><span class="lineCov">          7 :     Optional&lt;int&gt; stop_height;</span></a>
<a name="3481"><span class="lineNum">    3481 </span><span class="lineCov">          7 :     uint256 start_block;</span></a>
<a name="3482"><span class="lineNum">    3482 </span>            :     {</a>
<a name="3483"><span class="lineNum">    3483 </span><span class="lineCov">          7 :         LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="3484"><span class="lineNum">    3484 </span><span class="lineCov">          7 :         int tip_height = pwallet-&gt;GetLastBlockHeight();</span></a>
<a name="3485"><span class="lineNum">    3485 </span>            : </a>
<a name="3486"><span class="lineNum">    3486 </span><span class="lineCov">          7 :         if (!request.params[0].isNull()) {</span></a>
<a name="3487"><span class="lineNum">    3487 </span><span class="lineCov">          2 :             start_height = request.params[0].get_int();</span></a>
<a name="3488"><span class="lineNum">    3488 </span><span class="lineCov">          2 :             if (start_height &lt; 0 || start_height &gt; tip_height) {</span></a>
<a name="3489"><span class="lineNum">    3489 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid start_height&quot;);</span></a>
<a name="3490"><span class="lineNum">    3490 </span>            :             }</a>
<a name="3491"><span class="lineNum">    3491 </span>            :         }</a>
<a name="3492"><span class="lineNum">    3492 </span>            : </a>
<a name="3493"><span class="lineNum">    3493 </span><span class="lineCov">          7 :         if (!request.params[1].isNull()) {</span></a>
<a name="3494"><span class="lineNum">    3494 </span><span class="lineCov">          2 :             stop_height = request.params[1].get_int();</span></a>
<a name="3495"><span class="lineNum">    3495 </span><span class="lineCov">          2 :             if (*stop_height &lt; 0 || *stop_height &gt; tip_height) {</span></a>
<a name="3496"><span class="lineNum">    3496 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Invalid stop_height&quot;);</span></a>
<a name="3497"><span class="lineNum">    3497 </span><span class="lineCov">          2 :             } else if (*stop_height &lt; start_height) {</span></a>
<a name="3498"><span class="lineNum">    3498 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;stop_height must be greater than start_height&quot;);</span></a>
<a name="3499"><span class="lineNum">    3499 </span>            :             }</a>
<a name="3500"><span class="lineNum">    3500 </span>            :         }</a>
<a name="3501"><span class="lineNum">    3501 </span>            : </a>
<a name="3502"><span class="lineNum">    3502 </span>            :         // We can't rescan beyond non-pruned blocks, stop and throw an error</a>
<a name="3503"><span class="lineNum">    3503 </span><span class="lineCov">          7 :         if (!pwallet-&gt;chain().hasBlocks(pwallet-&gt;GetLastBlockHash(), start_height, stop_height)) {</span></a>
<a name="3504"><span class="lineNum">    3504 </span><span class="lineNoCov">          0 :             throw JSONRPCError(RPC_MISC_ERROR, &quot;Can't rescan beyond pruned data. Use RPC call getblockchaininfo to determine your pruned height.&quot;);</span></a>
<a name="3505"><span class="lineNum">    3505 </span>            :         }</a>
<a name="3506"><span class="lineNum">    3506 </span>            : </a>
<a name="3507"><span class="lineNum">    3507 </span><span class="lineCov">          7 :         CHECK_NONFATAL(pwallet-&gt;chain().findAncestorByHeight(pwallet-&gt;GetLastBlockHash(), start_height, FoundBlock().hash(start_block)));</span></a>
<a name="3508"><span class="lineNum">    3508 </span><span class="lineCov">          7 :     }</span></a>
<a name="3509"><span class="lineNum">    3509 </span>            : </a>
<a name="3510"><span class="lineNum">    3510 </span><span class="lineCov">          7 :     CWallet::ScanResult result =</span></a>
<a name="3511"><span class="lineNum">    3511 </span><span class="lineCov">          7 :         pwallet-&gt;ScanForWalletTransactions(start_block, start_height, stop_height, reserver, true /* fUpdate */);</span></a>
<a name="3512"><span class="lineNum">    3512 </span><span class="lineCov">          7 :     switch (result.status) {</span></a>
<a name="3513"><span class="lineNum">    3513 </span>            :     case CWallet::ScanResult::SUCCESS:</a>
<a name="3514"><span class="lineNum">    3514 </span>            :         break;</a>
<a name="3515"><span class="lineNum">    3515 </span>            :     case CWallet::ScanResult::FAILURE:</a>
<a name="3516"><span class="lineNum">    3516 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_MISC_ERROR, &quot;Rescan failed. Potentially corrupted data files.&quot;);</span></a>
<a name="3517"><span class="lineNum">    3517 </span>            :     case CWallet::ScanResult::USER_ABORT:</a>
<a name="3518"><span class="lineNum">    3518 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_MISC_ERROR, &quot;Rescan aborted.&quot;);</span></a>
<a name="3519"><span class="lineNum">    3519 </span>            :         // no default case, so the compiler can warn about missing cases</a>
<a name="3520"><span class="lineNum">    3520 </span>            :     }</a>
<a name="3521"><span class="lineNum">    3521 </span><span class="lineCov">          7 :     UniValue response(UniValue::VOBJ);</span></a>
<a name="3522"><span class="lineNum">    3522 </span><span class="lineCov">          7 :     response.pushKV(&quot;start_height&quot;, start_height);</span></a>
<a name="3523"><span class="lineNum">    3523 </span><span class="lineCov">          7 :     response.pushKV(&quot;stop_height&quot;, result.last_scanned_height ? *result.last_scanned_height : UniValue());</span></a>
<a name="3524"><span class="lineNum">    3524 </span><span class="lineCov">          7 :     return response;</span></a>
<a name="3525"><span class="lineNum">    3525 </span><span class="lineCov">         35 : }</span></a>
<a name="3526"><span class="lineNum">    3526 </span>            : </a>
<a name="3527"><span class="lineNum">    3527 </span>            : class DescribeWalletAddressVisitor : public boost::static_visitor&lt;UniValue&gt;</a>
<a name="3528"><span class="lineNum">    3528 </span>            : {</a>
<a name="3529"><span class="lineNum">    3529 </span>            : public:</a>
<a name="3530"><span class="lineNum">    3530 </span>            :     const SigningProvider * const provider;</a>
<a name="3531"><span class="lineNum">    3531 </span>            : </a>
<a name="3532"><span class="lineNum">    3532 </span><span class="lineCov">        291 :     void ProcessSubScript(const CScript&amp; subscript, UniValue&amp; obj) const</span></a>
<a name="3533"><span class="lineNum">    3533 </span>            :     {</a>
<a name="3534"><span class="lineNum">    3534 </span>            :         // Always present: script type and redeemscript</a>
<a name="3535"><span class="lineNum">    3535 </span><span class="lineCov">        291 :         std::vector&lt;std::vector&lt;unsigned char&gt;&gt; solutions_data;</span></a>
<a name="3536"><span class="lineNum">    3536 </span><span class="lineCov">        291 :         TxoutType which_type = Solver(subscript, solutions_data);</span></a>
<a name="3537"><span class="lineNum">    3537 </span><span class="lineCov">        291 :         obj.pushKV(&quot;script&quot;, GetTxnOutputType(which_type));</span></a>
<a name="3538"><span class="lineNum">    3538 </span><span class="lineCov">        291 :         obj.pushKV(&quot;hex&quot;, HexStr(subscript));</span></a>
<a name="3539"><span class="lineNum">    3539 </span>            : </a>
<a name="3540"><span class="lineNum">    3540 </span><span class="lineCov">        291 :         CTxDestination embedded;</span></a>
<a name="3541"><span class="lineNum">    3541 </span><span class="lineCov">        291 :         if (ExtractDestination(subscript, embedded)) {</span></a>
<a name="3542"><span class="lineNum">    3542 </span>            :             // Only when the script corresponds to an address.</a>
<a name="3543"><span class="lineNum">    3543 </span><span class="lineCov">        161 :             UniValue subobj(UniValue::VOBJ);</span></a>
<a name="3544"><span class="lineNum">    3544 </span><span class="lineCov">        161 :             UniValue detail = DescribeAddress(embedded);</span></a>
<a name="3545"><span class="lineNum">    3545 </span><span class="lineCov">        161 :             subobj.pushKVs(detail);</span></a>
<a name="3546"><span class="lineNum">    3546 </span><span class="lineCov">        161 :             UniValue wallet_detail = boost::apply_visitor(*this, embedded);</span></a>
<a name="3547"><span class="lineNum">    3547 </span><span class="lineCov">        161 :             subobj.pushKVs(wallet_detail);</span></a>
<a name="3548"><span class="lineNum">    3548 </span><span class="lineCov">        161 :             subobj.pushKV(&quot;address&quot;, EncodeDestination(embedded));</span></a>
<a name="3549"><span class="lineNum">    3549 </span><span class="lineCov">        161 :             subobj.pushKV(&quot;scriptPubKey&quot;, HexStr(subscript));</span></a>
<a name="3550"><span class="lineNum">    3550 </span>            :             // Always report the pubkey at the top level, so that `getnewaddress()['pubkey']` always works.</a>
<a name="3551"><span class="lineNum">    3551 </span><span class="lineCov">        161 :             if (subobj.exists(&quot;pubkey&quot;)) obj.pushKV(&quot;pubkey&quot;, subobj[&quot;pubkey&quot;]);</span></a>
<a name="3552"><span class="lineNum">    3552 </span><span class="lineCov">        161 :             obj.pushKV(&quot;embedded&quot;, std::move(subobj));</span></a>
<a name="3553"><span class="lineNum">    3553 </span><span class="lineCov">        291 :         } else if (which_type == TxoutType::MULTISIG) {</span></a>
<a name="3554"><span class="lineNum">    3554 </span>            :             // Also report some information on multisig scripts (which do not have a corresponding address).</a>
<a name="3555"><span class="lineNum">    3555 </span>            :             // TODO: abstract out the common functionality between this logic and ExtractDestinations.</a>
<a name="3556"><span class="lineNum">    3556 </span><span class="lineCov">        130 :             obj.pushKV(&quot;sigsrequired&quot;, solutions_data[0][0]);</span></a>
<a name="3557"><span class="lineNum">    3557 </span><span class="lineCov">        130 :             UniValue pubkeys(UniValue::VARR);</span></a>
<a name="3558"><span class="lineNum">    3558 </span><span class="lineCov">        450 :             for (size_t i = 1; i &lt; solutions_data.size() - 1; ++i) {</span></a>
<a name="3559"><span class="lineNum">    3559 </span><span class="lineCov">        320 :                 CPubKey key(solutions_data[i].begin(), solutions_data[i].end());</span></a>
<a name="3560"><span class="lineNum">    3560 </span><span class="lineCov">        320 :                 pubkeys.push_back(HexStr(key));</span></a>
<a name="3561"><span class="lineNum">    3561 </span><span class="lineCov">        320 :             }</span></a>
<a name="3562"><span class="lineNum">    3562 </span><span class="lineCov">        130 :             obj.pushKV(&quot;pubkeys&quot;, std::move(pubkeys));</span></a>
<a name="3563"><span class="lineNum">    3563 </span><span class="lineCov">        130 :         }</span></a>
<a name="3564"><span class="lineNum">    3564 </span><span class="lineCov">        291 :     }</span></a>
<a name="3565"><span class="lineNum">    3565 </span>            : </a>
<a name="3566"><span class="lineNum">    3566 </span><span class="lineCov">       1898 :     explicit DescribeWalletAddressVisitor(const SigningProvider* _provider) : provider(_provider) {}</span></a>
<a name="3567"><span class="lineNum">    3567 </span>            : </a>
<a name="3568"><span class="lineNum">    3568 </span><span class="lineNoCov">          0 :     UniValue operator()(const CNoDestination&amp; dest) const { return UniValue(UniValue::VOBJ); }</span></a>
<a name="3569"><span class="lineNum">    3569 </span>            : </a>
<a name="3570"><span class="lineNum">    3570 </span><span class="lineCov">        194 :     UniValue operator()(const PKHash&amp; pkhash) const</span></a>
<a name="3571"><span class="lineNum">    3571 </span>            :     {</a>
<a name="3572"><span class="lineNum">    3572 </span><span class="lineCov">        194 :         CKeyID keyID{ToKeyID(pkhash)};</span></a>
<a name="3573"><span class="lineNum">    3573 </span><span class="lineCov">        194 :         UniValue obj(UniValue::VOBJ);</span></a>
<a name="3574"><span class="lineNum">    3574 </span><span class="lineCov">        194 :         CPubKey vchPubKey;</span></a>
<a name="3575"><span class="lineNum">    3575 </span><span class="lineCov">        194 :         if (provider &amp;&amp; provider-&gt;GetPubKey(keyID, vchPubKey)) {</span></a>
<a name="3576"><span class="lineNum">    3576 </span><span class="lineCov">        175 :             obj.pushKV(&quot;pubkey&quot;, HexStr(vchPubKey));</span></a>
<a name="3577"><span class="lineNum">    3577 </span><span class="lineCov">        175 :             obj.pushKV(&quot;iscompressed&quot;, vchPubKey.IsCompressed());</span></a>
<a name="3578"><span class="lineNum">    3578 </span><span class="lineCov">        175 :         }</span></a>
<a name="3579"><span class="lineNum">    3579 </span>            :         return obj;</a>
<a name="3580"><span class="lineNum">    3580 </span><span class="lineCov">        194 :     }</span></a>
<a name="3581"><span class="lineNum">    3581 </span>            : </a>
<a name="3582"><span class="lineNum">    3582 </span><span class="lineCov">        220 :     UniValue operator()(const ScriptHash&amp; scripthash) const</span></a>
<a name="3583"><span class="lineNum">    3583 </span>            :     {</a>
<a name="3584"><span class="lineNum">    3584 </span><span class="lineCov">        220 :         CScriptID scriptID(scripthash);</span></a>
<a name="3585"><span class="lineNum">    3585 </span><span class="lineCov">        220 :         UniValue obj(UniValue::VOBJ);</span></a>
<a name="3586"><span class="lineNum">    3586 </span><span class="lineCov">        220 :         CScript subscript;</span></a>
<a name="3587"><span class="lineNum">    3587 </span><span class="lineCov">        220 :         if (provider &amp;&amp; provider-&gt;GetCScript(scriptID, subscript)) {</span></a>
<a name="3588"><span class="lineNum">    3588 </span><span class="lineCov">        213 :             ProcessSubScript(subscript, obj);</span></a>
<a name="3589"><span class="lineNum">    3589 </span>            :         }</a>
<a name="3590"><span class="lineNum">    3590 </span>            :         return obj;</a>
<a name="3591"><span class="lineNum">    3591 </span><span class="lineCov">        220 :     }</span></a>
<a name="3592"><span class="lineNum">    3592 </span>            : </a>
<a name="3593"><span class="lineNum">    3593 </span><span class="lineCov">        598 :     UniValue operator()(const WitnessV0KeyHash&amp; id) const</span></a>
<a name="3594"><span class="lineNum">    3594 </span>            :     {</a>
<a name="3595"><span class="lineNum">    3595 </span><span class="lineCov">        598 :         UniValue obj(UniValue::VOBJ);</span></a>
<a name="3596"><span class="lineNum">    3596 </span><span class="lineCov">        598 :         CPubKey pubkey;</span></a>
<a name="3597"><span class="lineNum">    3597 </span><span class="lineCov">        598 :         if (provider &amp;&amp; provider-&gt;GetPubKey(ToKeyID(id), pubkey)) {</span></a>
<a name="3598"><span class="lineNum">    3598 </span><span class="lineCov">        549 :             obj.pushKV(&quot;pubkey&quot;, HexStr(pubkey));</span></a>
<a name="3599"><span class="lineNum">    3599 </span><span class="lineCov">        549 :         }</span></a>
<a name="3600"><span class="lineNum">    3600 </span>            :         return obj;</a>
<a name="3601"><span class="lineNum">    3601 </span><span class="lineCov">        598 :     }</span></a>
<a name="3602"><span class="lineNum">    3602 </span>            : </a>
<a name="3603"><span class="lineNum">    3603 </span><span class="lineCov">         98 :     UniValue operator()(const WitnessV0ScriptHash&amp; id) const</span></a>
<a name="3604"><span class="lineNum">    3604 </span>            :     {</a>
<a name="3605"><span class="lineNum">    3605 </span><span class="lineCov">         98 :         UniValue obj(UniValue::VOBJ);</span></a>
<a name="3606"><span class="lineNum">    3606 </span><span class="lineCov">         98 :         CScript subscript;</span></a>
<a name="3607"><span class="lineNum">    3607 </span><span class="lineCov">         98 :         CRIPEMD160 hasher;</span></a>
<a name="3608"><span class="lineNum">    3608 </span><span class="lineCov">         98 :         uint160 hash;</span></a>
<a name="3609"><span class="lineNum">    3609 </span><span class="lineCov">         98 :         hasher.Write(id.begin(), 32).Finalize(hash.begin());</span></a>
<a name="3610"><span class="lineNum">    3610 </span><span class="lineCov">         98 :         if (provider &amp;&amp; provider-&gt;GetCScript(CScriptID(hash), subscript)) {</span></a>
<a name="3611"><span class="lineNum">    3611 </span><span class="lineCov">         78 :             ProcessSubScript(subscript, obj);</span></a>
<a name="3612"><span class="lineNum">    3612 </span>            :         }</a>
<a name="3613"><span class="lineNum">    3613 </span>            :         return obj;</a>
<a name="3614"><span class="lineNum">    3614 </span><span class="lineCov">         98 :     }</span></a>
<a name="3615"><span class="lineNum">    3615 </span>            : </a>
<a name="3616"><span class="lineNum">    3616 </span><span class="lineNoCov">          0 :     UniValue operator()(const WitnessUnknown&amp; id) const { return UniValue(UniValue::VOBJ); }</span></a>
<a name="3617"><span class="lineNum">    3617 </span>            : };</a>
<a name="3618"><span class="lineNum">    3618 </span>            : </a>
<a name="3619"><span class="lineNum">    3619 </span><span class="lineCov">        949 : static UniValue DescribeWalletAddress(const CWallet* const pwallet, const CTxDestination&amp; dest)</span></a>
<a name="3620"><span class="lineNum">    3620 </span>            : {</a>
<a name="3621"><span class="lineNum">    3621 </span><span class="lineCov">        949 :     UniValue ret(UniValue::VOBJ);</span></a>
<a name="3622"><span class="lineNum">    3622 </span><span class="lineCov">        949 :     UniValue detail = DescribeAddress(dest);</span></a>
<a name="3623"><span class="lineNum">    3623 </span><span class="lineCov">        949 :     CScript script = GetScriptForDestination(dest);</span></a>
<a name="3624"><span class="lineNum">    3624 </span><span class="lineCov">        949 :     std::unique_ptr&lt;SigningProvider&gt; provider = nullptr;</span></a>
<a name="3625"><span class="lineNum">    3625 </span><span class="lineCov">        949 :     if (pwallet) {</span></a>
<a name="3626"><span class="lineNum">    3626 </span><span class="lineCov">        949 :         provider = pwallet-&gt;GetSolvingProvider(script);</span></a>
<a name="3627"><span class="lineNum">    3627 </span><span class="lineCov">        949 :     }</span></a>
<a name="3628"><span class="lineNum">    3628 </span><span class="lineCov">        949 :     ret.pushKVs(detail);</span></a>
<a name="3629"><span class="lineNum">    3629 </span><span class="lineCov">        949 :     ret.pushKVs(boost::apply_visitor(DescribeWalletAddressVisitor(provider.get()), dest));</span></a>
<a name="3630"><span class="lineNum">    3630 </span>            :     return ret;</a>
<a name="3631"><span class="lineNum">    3631 </span><span class="lineCov">        949 : }</span></a>
<a name="3632"><span class="lineNum">    3632 </span>            : </a>
<a name="3633"><span class="lineNum">    3633 </span>            : /** Convert CAddressBookData to JSON record.  */</a>
<a name="3634"><span class="lineNum">    3634 </span><span class="lineCov">        144 : static UniValue AddressBookDataToJSON(const CAddressBookData&amp; data, const bool verbose)</span></a>
<a name="3635"><span class="lineNum">    3635 </span>            : {</a>
<a name="3636"><span class="lineNum">    3636 </span><span class="lineCov">        144 :     UniValue ret(UniValue::VOBJ);</span></a>
<a name="3637"><span class="lineNum">    3637 </span><span class="lineCov">        144 :     if (verbose) {</span></a>
<a name="3638"><span class="lineNum">    3638 </span><span class="lineNoCov">          0 :         ret.pushKV(&quot;name&quot;, data.GetLabel());</span></a>
<a name="3639"><span class="lineNum">    3639 </span><span class="lineNoCov">          0 :     }</span></a>
<a name="3640"><span class="lineNum">    3640 </span><span class="lineCov">        144 :     ret.pushKV(&quot;purpose&quot;, data.purpose);</span></a>
<a name="3641"><span class="lineNum">    3641 </span>            :     return ret;</a>
<a name="3642"><span class="lineNum">    3642 </span><span class="lineCov">        144 : }</span></a>
<a name="3643"><span class="lineNum">    3643 </span>            : </a>
<a name="3644"><span class="lineNum">    3644 </span><span class="lineCov">        955 : UniValue getaddressinfo(const JSONRPCRequest&amp; request)</span></a>
<a name="3645"><span class="lineNum">    3645 </span>            : {</a>
<a name="3646"><span class="lineNum">    3646 </span><span class="lineCov">      23877 :             RPCHelpMan{&quot;getaddressinfo&quot;,</span></a>
<a name="3647"><span class="lineNum">    3647 </span><span class="lineCov">        955 :                 &quot;\nReturn information about the given bitcoin address.\n&quot;</span></a>
<a name="3648"><span class="lineNum">    3648 </span>            :                 &quot;Some of the information will only be present if the address is in the active wallet.\n&quot;,</a>
<a name="3649"><span class="lineNum">    3649 </span><span class="lineCov">       1910 :                 {</span></a>
<a name="3650"><span class="lineNum">    3650 </span><span class="lineCov">        955 :                     {&quot;address&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The bitcoin address for which to get information.&quot;},</span></a>
<a name="3651"><span class="lineNum">    3651 </span>            :                 },</a>
<a name="3652"><span class="lineNum">    3652 </span><span class="lineCov">        955 :                 RPCResult{</span></a>
<a name="3653"><span class="lineNum">    3653 </span><span class="lineCov">        955 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3654"><span class="lineNum">    3654 </span><span class="lineCov">      22940 :                     {</span></a>
<a name="3655"><span class="lineNum">    3655 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR, &quot;address&quot;, &quot;The bitcoin address validated.&quot;},</span></a>
<a name="3656"><span class="lineNum">    3656 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR_HEX, &quot;scriptPubKey&quot;, &quot;The hex-encoded scriptPubKey generated by the address.&quot;},</span></a>
<a name="3657"><span class="lineNum">    3657 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;ismine&quot;, &quot;If the address is yours.&quot;},</span></a>
<a name="3658"><span class="lineNum">    3658 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;iswatchonly&quot;, &quot;If the address is watchonly.&quot;},</span></a>
<a name="3659"><span class="lineNum">    3659 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;solvable&quot;, &quot;If we know how to spend coins sent to this address, ignoring the possible lack of private keys.&quot;},</span></a>
<a name="3660"><span class="lineNum">    3660 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR, &quot;desc&quot;, /* optional */ true, &quot;A descriptor for spending coins sent to this address (only when solvable).&quot;},</span></a>
<a name="3661"><span class="lineNum">    3661 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;isscript&quot;, &quot;If the key is a script.&quot;},</span></a>
<a name="3662"><span class="lineNum">    3662 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;ischange&quot;, &quot;If the address was used for change output.&quot;},</span></a>
<a name="3663"><span class="lineNum">    3663 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;iswitness&quot;, &quot;If the address is a witness address.&quot;},</span></a>
<a name="3664"><span class="lineNum">    3664 </span><span class="lineCov">        955 :                         {RPCResult::Type::NUM, &quot;witness_version&quot;, /* optional */ true, &quot;The version number of the witness program.&quot;},</span></a>
<a name="3665"><span class="lineNum">    3665 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR_HEX, &quot;witness_program&quot;, /* optional */ true, &quot;The hex value of the witness program.&quot;},</span></a>
<a name="3666"><span class="lineNum">    3666 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR, &quot;script&quot;, /* optional */ true, &quot;The output script type. Only if isscript is true and the redeemscript is known. Possible\n&quot;</span></a>
<a name="3667"><span class="lineNum">    3667 </span>            :             &quot;                                                         types: nonstandard, pubkey, pubkeyhash, scripthash, multisig, nulldata, witness_v0_keyhash,\n&quot;</a>
<a name="3668"><span class="lineNum">    3668 </span>            :                             &quot;witness_v0_scripthash, witness_unknown.&quot;},</a>
<a name="3669"><span class="lineNum">    3669 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR_HEX, &quot;hex&quot;, /* optional */ true, &quot;The redeemscript for the p2sh address.&quot;},</span></a>
<a name="3670"><span class="lineNum">    3670 </span><span class="lineCov">       1910 :                         {RPCResult::Type::ARR, &quot;pubkeys&quot;, /* optional */ true, &quot;Array of pubkeys associated with the known redeemscript (only if script is multisig).&quot;,</span></a>
<a name="3671"><span class="lineNum">    3671 </span><span class="lineCov">       1910 :                         {</span></a>
<a name="3672"><span class="lineNum">    3672 </span><span class="lineCov">        955 :                             {RPCResult::Type::STR, &quot;pubkey&quot;, &quot;&quot;},</span></a>
<a name="3673"><span class="lineNum">    3673 </span>            :                         }},</a>
<a name="3674"><span class="lineNum">    3674 </span><span class="lineCov">        955 :                         {RPCResult::Type::NUM, &quot;sigsrequired&quot;, /* optional */ true, &quot;The number of signatures required to spend multisig output (only if script is multisig).&quot;},</span></a>
<a name="3675"><span class="lineNum">    3675 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR_HEX, &quot;pubkey&quot;, /* optional */ true, &quot;The hex value of the raw public key for single-key addresses (possibly embedded in P2SH or P2WSH).&quot;},</span></a>
<a name="3676"><span class="lineNum">    3676 </span><span class="lineCov">       1910 :                         {RPCResult::Type::OBJ, &quot;embedded&quot;, /* optional */ true, &quot;Information about the address embedded in P2SH or P2WSH, if relevant and known.&quot;,</span></a>
<a name="3677"><span class="lineNum">    3677 </span><span class="lineCov">       1910 :                         {</span></a>
<a name="3678"><span class="lineNum">    3678 </span><span class="lineCov">        955 :                             {RPCResult::Type::ELISION, &quot;&quot;, &quot;Includes all getaddressinfo output fields for the embedded address, excluding metadata (timestamp, hdkeypath, hdseedid)\n&quot;</span></a>
<a name="3679"><span class="lineNum">    3679 </span>            :                             &quot;and relation to the wallet (ismine, iswatchonly).&quot;},</a>
<a name="3680"><span class="lineNum">    3680 </span>            :                         }},</a>
<a name="3681"><span class="lineNum">    3681 </span><span class="lineCov">        955 :                         {RPCResult::Type::BOOL, &quot;iscompressed&quot;, /* optional */ true, &quot;If the pubkey is compressed.&quot;},</span></a>
<a name="3682"><span class="lineNum">    3682 </span><span class="lineCov">        955 :                         {RPCResult::Type::NUM_TIME, &quot;timestamp&quot;, /* optional */ true, &quot;The creation time of the key, if available, expressed in &quot; + UNIX_EPOCH_TIME + &quot;.&quot;},</span></a>
<a name="3683"><span class="lineNum">    3683 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR, &quot;hdkeypath&quot;, /* optional */ true, &quot;The HD keypath, if the key is HD and available.&quot;},</span></a>
<a name="3684"><span class="lineNum">    3684 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR_HEX, &quot;hdseedid&quot;, /* optional */ true, &quot;The Hash160 of the HD seed.&quot;},</span></a>
<a name="3685"><span class="lineNum">    3685 </span><span class="lineCov">        955 :                         {RPCResult::Type::STR_HEX, &quot;hdmasterfingerprint&quot;, /* optional */ true, &quot;The fingerprint of the master key.&quot;},</span></a>
<a name="3686"><span class="lineNum">    3686 </span><span class="lineCov">       1910 :                         {RPCResult::Type::ARR, &quot;labels&quot;, &quot;Array of labels associated with the address. Currently limited to one label but returned\n&quot;</span></a>
<a name="3687"><span class="lineNum">    3687 </span>            :                             &quot;as an array to keep the API stable if multiple labels are enabled in the future.&quot;,</a>
<a name="3688"><span class="lineNum">    3688 </span><span class="lineCov">       1910 :                         {</span></a>
<a name="3689"><span class="lineNum">    3689 </span><span class="lineCov">        955 :                             {RPCResult::Type::STR, &quot;label name&quot;, &quot;Label name (defaults to \&quot;\&quot;).&quot;},</span></a>
<a name="3690"><span class="lineNum">    3690 </span>            :                         }},</a>
<a name="3691"><span class="lineNum">    3691 </span>            :                     }</a>
<a name="3692"><span class="lineNum">    3692 </span>            :                 },</a>
<a name="3693"><span class="lineNum">    3693 </span><span class="lineCov">        955 :                 RPCExamples{</span></a>
<a name="3694"><span class="lineNum">    3694 </span><span class="lineCov">       1910 :                     HelpExampleCli(&quot;getaddressinfo&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;&quot;) +</span></a>
<a name="3695"><span class="lineNum">    3695 </span><span class="lineCov">        955 :                     HelpExampleRpc(&quot;getaddressinfo&quot;, &quot;\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;&quot;)</span></a>
<a name="3696"><span class="lineNum">    3696 </span>            :                 },</a>
<a name="3697"><span class="lineNum">    3697 </span><span class="lineCov">        955 :             }.Check(request);</span></a>
<a name="3698"><span class="lineNum">    3698 </span>            : </a>
<a name="3699"><span class="lineNum">    3699 </span><span class="lineCov">        951 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3700"><span class="lineNum">    3700 </span><span class="lineCov">        951 :     if (!wallet) return NullUniValue;</span></a>
<a name="3701"><span class="lineNum">    3701 </span><span class="lineCov">        951 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="3702"><span class="lineNum">    3702 </span>            : </a>
<a name="3703"><span class="lineNum">    3703 </span><span class="lineCov">        951 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="3704"><span class="lineNum">    3704 </span>            : </a>
<a name="3705"><span class="lineNum">    3705 </span><span class="lineCov">        951 :     UniValue ret(UniValue::VOBJ);</span></a>
<a name="3706"><span class="lineNum">    3706 </span><span class="lineCov">        951 :     CTxDestination dest = DecodeDestination(request.params[0].get_str());</span></a>
<a name="3707"><span class="lineNum">    3707 </span>            :     // Make sure the destination is valid</a>
<a name="3708"><span class="lineNum">    3708 </span><span class="lineCov">        951 :     if (!IsValidDestination(dest)) {</span></a>
<a name="3709"><span class="lineNum">    3709 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Invalid address&quot;);</span></a>
<a name="3710"><span class="lineNum">    3710 </span>            :     }</a>
<a name="3711"><span class="lineNum">    3711 </span>            : </a>
<a name="3712"><span class="lineNum">    3712 </span><span class="lineCov">        949 :     std::string currentAddress = EncodeDestination(dest);</span></a>
<a name="3713"><span class="lineNum">    3713 </span><span class="lineCov">        949 :     ret.pushKV(&quot;address&quot;, currentAddress);</span></a>
<a name="3714"><span class="lineNum">    3714 </span>            : </a>
<a name="3715"><span class="lineNum">    3715 </span><span class="lineCov">        949 :     CScript scriptPubKey = GetScriptForDestination(dest);</span></a>
<a name="3716"><span class="lineNum">    3716 </span><span class="lineCov">        949 :     ret.pushKV(&quot;scriptPubKey&quot;, HexStr(scriptPubKey));</span></a>
<a name="3717"><span class="lineNum">    3717 </span>            : </a>
<a name="3718"><span class="lineNum">    3718 </span><span class="lineCov">        949 :     std::unique_ptr&lt;SigningProvider&gt; provider = pwallet-&gt;GetSolvingProvider(scriptPubKey);</span></a>
<a name="3719"><span class="lineNum">    3719 </span>            : </a>
<a name="3720"><span class="lineNum">    3720 </span><span class="lineCov">        949 :     isminetype mine = pwallet-&gt;IsMine(dest);</span></a>
<a name="3721"><span class="lineNum">    3721 </span><span class="lineCov">        949 :     ret.pushKV(&quot;ismine&quot;, bool(mine &amp; ISMINE_SPENDABLE));</span></a>
<a name="3722"><span class="lineNum">    3722 </span>            : </a>
<a name="3723"><span class="lineNum">    3723 </span><span class="lineCov">        949 :     bool solvable = provider &amp;&amp; IsSolvable(*provider, scriptPubKey);</span></a>
<a name="3724"><span class="lineNum">    3724 </span><span class="lineCov">        949 :     ret.pushKV(&quot;solvable&quot;, solvable);</span></a>
<a name="3725"><span class="lineNum">    3725 </span>            : </a>
<a name="3726"><span class="lineNum">    3726 </span><span class="lineCov">        949 :     if (solvable) {</span></a>
<a name="3727"><span class="lineNum">    3727 </span><span class="lineCov">        854 :        ret.pushKV(&quot;desc&quot;, InferDescriptor(scriptPubKey, *provider)-&gt;ToString());</span></a>
<a name="3728"><span class="lineNum">    3728 </span><span class="lineCov">        854 :     }</span></a>
<a name="3729"><span class="lineNum">    3729 </span>            : </a>
<a name="3730"><span class="lineNum">    3730 </span><span class="lineCov">        949 :     ret.pushKV(&quot;iswatchonly&quot;, bool(mine &amp; ISMINE_WATCH_ONLY));</span></a>
<a name="3731"><span class="lineNum">    3731 </span>            : </a>
<a name="3732"><span class="lineNum">    3732 </span><span class="lineCov">        949 :     UniValue detail = DescribeWalletAddress(pwallet, dest);</span></a>
<a name="3733"><span class="lineNum">    3733 </span><span class="lineCov">        949 :     ret.pushKVs(detail);</span></a>
<a name="3734"><span class="lineNum">    3734 </span>            : </a>
<a name="3735"><span class="lineNum">    3735 </span><span class="lineCov">        949 :     ret.pushKV(&quot;ischange&quot;, pwallet-&gt;IsChange(scriptPubKey));</span></a>
<a name="3736"><span class="lineNum">    3736 </span>            : </a>
<a name="3737"><span class="lineNum">    3737 </span><span class="lineCov">        949 :     ScriptPubKeyMan* spk_man = pwallet-&gt;GetScriptPubKeyMan(scriptPubKey);</span></a>
<a name="3738"><span class="lineNum">    3738 </span><span class="lineCov">        949 :     if (spk_man) {</span></a>
<a name="3739"><span class="lineNum">    3739 </span><span class="lineCov">       1616 :         if (const std::unique_ptr&lt;CKeyMetadata&gt; meta = spk_man-&gt;GetMetadata(dest)) {</span></a>
<a name="3740"><span class="lineNum">    3740 </span><span class="lineCov">        745 :             ret.pushKV(&quot;timestamp&quot;, meta-&gt;nCreateTime);</span></a>
<a name="3741"><span class="lineNum">    3741 </span><span class="lineCov">        745 :             if (meta-&gt;has_key_origin) {</span></a>
<a name="3742"><span class="lineNum">    3742 </span><span class="lineCov">        691 :                 ret.pushKV(&quot;hdkeypath&quot;, WriteHDKeypath(meta-&gt;key_origin.path));</span></a>
<a name="3743"><span class="lineNum">    3743 </span><span class="lineCov">        691 :                 ret.pushKV(&quot;hdseedid&quot;, meta-&gt;hd_seed_id.GetHex());</span></a>
<a name="3744"><span class="lineNum">    3744 </span><span class="lineCov">        691 :                 ret.pushKV(&quot;hdmasterfingerprint&quot;, HexStr(meta-&gt;key_origin.fingerprint));</span></a>
<a name="3745"><span class="lineNum">    3745 </span><span class="lineCov">        691 :             }</span></a>
<a name="3746"><span class="lineNum">    3746 </span>            :         }</a>
<a name="3747"><span class="lineNum">    3747 </span><span class="lineCov">        871 :     }</span></a>
<a name="3748"><span class="lineNum">    3748 </span>            : </a>
<a name="3749"><span class="lineNum">    3749 </span>            :     // Return a `labels` array containing the label associated with the address,</a>
<a name="3750"><span class="lineNum">    3750 </span>            :     // equivalent to the `label` field above. Currently only one label can be</a>
<a name="3751"><span class="lineNum">    3751 </span>            :     // associated with an address, but we return an array so the API remains</a>
<a name="3752"><span class="lineNum">    3752 </span>            :     // stable if we allow multiple labels to be associated with an address in</a>
<a name="3753"><span class="lineNum">    3753 </span>            :     // the future.</a>
<a name="3754"><span class="lineNum">    3754 </span><span class="lineCov">        949 :     UniValue labels(UniValue::VARR);</span></a>
<a name="3755"><span class="lineNum">    3755 </span><span class="lineCov">        949 :     const auto* address_book_entry = pwallet-&gt;FindAddressBookEntry(dest);</span></a>
<a name="3756"><span class="lineNum">    3756 </span><span class="lineCov">        949 :     if (address_book_entry) {</span></a>
<a name="3757"><span class="lineNum">    3757 </span><span class="lineCov">        798 :         labels.push_back(address_book_entry-&gt;GetLabel());</span></a>
<a name="3758"><span class="lineNum">    3758 </span>            :     }</a>
<a name="3759"><span class="lineNum">    3759 </span><span class="lineCov">        949 :     ret.pushKV(&quot;labels&quot;, std::move(labels));</span></a>
<a name="3760"><span class="lineNum">    3760 </span>            : </a>
<a name="3761"><span class="lineNum">    3761 </span><span class="lineCov">        949 :     return ret;</span></a>
<a name="3762"><span class="lineNum">    3762 </span><span class="lineCov">        999 : }</span></a>
<a name="3763"><span class="lineNum">    3763 </span>            : </a>
<a name="3764"><span class="lineNum">    3764 </span><span class="lineCov">         83 : static UniValue getaddressesbylabel(const JSONRPCRequest&amp; request)</span></a>
<a name="3765"><span class="lineNum">    3765 </span>            : {</a>
<a name="3766"><span class="lineNum">    3766 </span><span class="lineCov">        259 :             RPCHelpMan{&quot;getaddressesbylabel&quot;,</span></a>
<a name="3767"><span class="lineNum">    3767 </span><span class="lineCov">         83 :                 &quot;\nReturns the list of addresses assigned the specified label.\n&quot;,</span></a>
<a name="3768"><span class="lineNum">    3768 </span><span class="lineCov">        166 :                 {</span></a>
<a name="3769"><span class="lineNum">    3769 </span><span class="lineCov">         83 :                     {&quot;label&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The label.&quot;},</span></a>
<a name="3770"><span class="lineNum">    3770 </span>            :                 },</a>
<a name="3771"><span class="lineNum">    3771 </span><span class="lineCov">         83 :                 RPCResult{</span></a>
<a name="3772"><span class="lineNum">    3772 </span><span class="lineCov">         83 :                     RPCResult::Type::OBJ_DYN, &quot;&quot;, &quot;json object with addresses as keys&quot;,</span></a>
<a name="3773"><span class="lineNum">    3773 </span><span class="lineCov">        166 :                     {</span></a>
<a name="3774"><span class="lineNum">    3774 </span><span class="lineCov">        166 :                         {RPCResult::Type::OBJ, &quot;address&quot;, &quot;json object with information about address&quot;,</span></a>
<a name="3775"><span class="lineNum">    3775 </span><span class="lineCov">        166 :                         {</span></a>
<a name="3776"><span class="lineNum">    3776 </span><span class="lineCov">         83 :                             {RPCResult::Type::STR, &quot;purpose&quot;, &quot;Purpose of address (\&quot;send\&quot; for sending address, \&quot;receive\&quot; for receiving address)&quot;},</span></a>
<a name="3777"><span class="lineNum">    3777 </span>            :                         }},</a>
<a name="3778"><span class="lineNum">    3778 </span>            :                     }</a>
<a name="3779"><span class="lineNum">    3779 </span>            :                 },</a>
<a name="3780"><span class="lineNum">    3780 </span><span class="lineCov">         83 :                 RPCExamples{</span></a>
<a name="3781"><span class="lineNum">    3781 </span><span class="lineCov">         83 :                     HelpExampleCli(&quot;getaddressesbylabel&quot;, &quot;\&quot;tabby\&quot;&quot;)</span></a>
<a name="3782"><span class="lineNum">    3782 </span><span class="lineCov">         83 :             + HelpExampleRpc(&quot;getaddressesbylabel&quot;, &quot;\&quot;tabby\&quot;&quot;)</span></a>
<a name="3783"><span class="lineNum">    3783 </span>            :                 },</a>
<a name="3784"><span class="lineNum">    3784 </span><span class="lineCov">         83 :             }.Check(request);</span></a>
<a name="3785"><span class="lineNum">    3785 </span>            : </a>
<a name="3786"><span class="lineNum">    3786 </span><span class="lineCov">         79 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3787"><span class="lineNum">    3787 </span><span class="lineCov">         79 :     if (!wallet) return NullUniValue;</span></a>
<a name="3788"><span class="lineNum">    3788 </span><span class="lineCov">         79 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="3789"><span class="lineNum">    3789 </span>            : </a>
<a name="3790"><span class="lineNum">    3790 </span><span class="lineCov">         79 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="3791"><span class="lineNum">    3791 </span>            : </a>
<a name="3792"><span class="lineNum">    3792 </span><span class="lineCov">         79 :     std::string label = LabelFromValue(request.params[0]);</span></a>
<a name="3793"><span class="lineNum">    3793 </span>            : </a>
<a name="3794"><span class="lineNum">    3794 </span>            :     // Find all addresses that have the given label</a>
<a name="3795"><span class="lineNum">    3795 </span><span class="lineCov">         79 :     UniValue ret(UniValue::VOBJ);</span></a>
<a name="3796"><span class="lineNum">    3796 </span><span class="lineCov">         79 :     std::set&lt;std::string&gt; addresses;</span></a>
<a name="3797"><span class="lineNum">    3797 </span><span class="lineCov">       1468 :     for (const std::pair&lt;const CTxDestination, CAddressBookData&gt;&amp; item : pwallet-&gt;m_address_book) {</span></a>
<a name="3798"><span class="lineNum">    3798 </span><span class="lineCov">       1389 :         if (item.second.IsChange()) continue;</span></a>
<a name="3799"><span class="lineNum">    3799 </span><span class="lineCov">       1389 :         if (item.second.GetLabel() == label) {</span></a>
<a name="3800"><span class="lineNum">    3800 </span><span class="lineCov">        144 :             std::string address = EncodeDestination(item.first);</span></a>
<a name="3801"><span class="lineNum">    3801 </span>            :             // CWallet::m_address_book is not expected to contain duplicate</a>
<a name="3802"><span class="lineNum">    3802 </span>            :             // address strings, but build a separate set as a precaution just in</a>
<a name="3803"><span class="lineNum">    3803 </span>            :             // case it does.</a>
<a name="3804"><span class="lineNum">    3804 </span><span class="lineCov">        144 :             bool unique = addresses.emplace(address).second;</span></a>
<a name="3805"><span class="lineNum">    3805 </span><span class="lineCov">        144 :             CHECK_NONFATAL(unique);</span></a>
<a name="3806"><span class="lineNum">    3806 </span>            :             // UniValue::pushKV checks if the key exists in O(N)</a>
<a name="3807"><span class="lineNum">    3807 </span>            :             // and since duplicate addresses are unexpected (checked with</a>
<a name="3808"><span class="lineNum">    3808 </span>            :             // std::set in O(log(N))), UniValue::__pushKV is used instead,</a>
<a name="3809"><span class="lineNum">    3809 </span>            :             // which currently is O(1).</a>
<a name="3810"><span class="lineNum">    3810 </span><span class="lineCov">        144 :             ret.__pushKV(address, AddressBookDataToJSON(item.second, false));</span></a>
<a name="3811"><span class="lineNum">    3811 </span><span class="lineCov">        144 :         }</span></a>
<a name="3812"><span class="lineNum">    3812 </span><span class="lineCov">       1389 :     }</span></a>
<a name="3813"><span class="lineNum">    3813 </span>            : </a>
<a name="3814"><span class="lineNum">    3814 </span><span class="lineCov">         79 :     if (ret.empty()) {</span></a>
<a name="3815"><span class="lineNum">    3815 </span><span class="lineCov">         10 :         throw JSONRPCError(RPC_WALLET_INVALID_LABEL_NAME, std::string(&quot;No addresses with label &quot; + label));</span></a>
<a name="3816"><span class="lineNum">    3816 </span>            :     }</a>
<a name="3817"><span class="lineNum">    3817 </span>            : </a>
<a name="3818"><span class="lineNum">    3818 </span><span class="lineCov">         69 :     return ret;</span></a>
<a name="3819"><span class="lineNum">    3819 </span><span class="lineCov">        111 : }</span></a>
<a name="3820"><span class="lineNum">    3820 </span>            : </a>
<a name="3821"><span class="lineNum">    3821 </span><span class="lineCov">         77 : static UniValue listlabels(const JSONRPCRequest&amp; request)</span></a>
<a name="3822"><span class="lineNum">    3822 </span>            : {</a>
<a name="3823"><span class="lineNum">    3823 </span><span class="lineCov">        231 :             RPCHelpMan{&quot;listlabels&quot;,</span></a>
<a name="3824"><span class="lineNum">    3824 </span><span class="lineCov">         77 :                 &quot;\nReturns the list of all labels, or labels that are assigned to addresses with a specific purpose.\n&quot;,</span></a>
<a name="3825"><span class="lineNum">    3825 </span><span class="lineCov">        154 :                 {</span></a>
<a name="3826"><span class="lineNum">    3826 </span><span class="lineCov">         77 :                     {&quot;purpose&quot;, RPCArg::Type::STR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;Address purpose to list labels for ('send','receive'). An empty string is the same as not providing this argument.&quot;},</span></a>
<a name="3827"><span class="lineNum">    3827 </span>            :                 },</a>
<a name="3828"><span class="lineNum">    3828 </span><span class="lineCov">         77 :                 RPCResult{</span></a>
<a name="3829"><span class="lineNum">    3829 </span><span class="lineCov">         77 :                     RPCResult::Type::ARR, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3830"><span class="lineNum">    3830 </span><span class="lineCov">        154 :                     {</span></a>
<a name="3831"><span class="lineNum">    3831 </span><span class="lineCov">         77 :                         {RPCResult::Type::STR, &quot;label&quot;, &quot;Label name&quot;},</span></a>
<a name="3832"><span class="lineNum">    3832 </span>            :                     }</a>
<a name="3833"><span class="lineNum">    3833 </span>            :                 },</a>
<a name="3834"><span class="lineNum">    3834 </span><span class="lineCov">         77 :                 RPCExamples{</span></a>
<a name="3835"><span class="lineNum">    3835 </span><span class="lineCov">         77 :             &quot;\nList all labels\n&quot;</span></a>
<a name="3836"><span class="lineNum">    3836 </span><span class="lineCov">         77 :             + HelpExampleCli(&quot;listlabels&quot;, &quot;&quot;) +</span></a>
<a name="3837"><span class="lineNum">    3837 </span>            :             &quot;\nList labels that have receiving addresses\n&quot;</a>
<a name="3838"><span class="lineNum">    3838 </span><span class="lineCov">         77 :             + HelpExampleCli(&quot;listlabels&quot;, &quot;receive&quot;) +</span></a>
<a name="3839"><span class="lineNum">    3839 </span>            :             &quot;\nList labels that have sending addresses\n&quot;</a>
<a name="3840"><span class="lineNum">    3840 </span><span class="lineCov">         77 :             + HelpExampleCli(&quot;listlabels&quot;, &quot;send&quot;) +</span></a>
<a name="3841"><span class="lineNum">    3841 </span>            :             &quot;\nAs a JSON-RPC call\n&quot;</a>
<a name="3842"><span class="lineNum">    3842 </span><span class="lineCov">         77 :             + HelpExampleRpc(&quot;listlabels&quot;, &quot;receive&quot;)</span></a>
<a name="3843"><span class="lineNum">    3843 </span>            :                 },</a>
<a name="3844"><span class="lineNum">    3844 </span><span class="lineCov">         77 :             }.Check(request);</span></a>
<a name="3845"><span class="lineNum">    3845 </span>            : </a>
<a name="3846"><span class="lineNum">    3846 </span><span class="lineCov">         73 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3847"><span class="lineNum">    3847 </span><span class="lineCov">         73 :     if (!wallet) return NullUniValue;</span></a>
<a name="3848"><span class="lineNum">    3848 </span><span class="lineCov">         73 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="3849"><span class="lineNum">    3849 </span>            : </a>
<a name="3850"><span class="lineNum">    3850 </span><span class="lineCov">         73 :     LOCK(pwallet-&gt;cs_wallet);</span></a>
<a name="3851"><span class="lineNum">    3851 </span>            : </a>
<a name="3852"><span class="lineNum">    3852 </span><span class="lineCov">         73 :     std::string purpose;</span></a>
<a name="3853"><span class="lineNum">    3853 </span><span class="lineCov">         73 :     if (!request.params[0].isNull()) {</span></a>
<a name="3854"><span class="lineNum">    3854 </span><span class="lineNoCov">          0 :         purpose = request.params[0].get_str();</span></a>
<a name="3855"><span class="lineNum">    3855 </span>            :     }</a>
<a name="3856"><span class="lineNum">    3856 </span>            : </a>
<a name="3857"><span class="lineNum">    3857 </span>            :     // Add to a set to sort by label name, then insert into Univalue array</a>
<a name="3858"><span class="lineNum">    3858 </span><span class="lineCov">         73 :     std::set&lt;std::string&gt; label_set;</span></a>
<a name="3859"><span class="lineNum">    3859 </span><span class="lineCov">       1350 :     for (const std::pair&lt;const CTxDestination, CAddressBookData&gt;&amp; entry : pwallet-&gt;m_address_book) {</span></a>
<a name="3860"><span class="lineNum">    3860 </span><span class="lineCov">       1277 :         if (entry.second.IsChange()) continue;</span></a>
<a name="3861"><span class="lineNum">    3861 </span><span class="lineCov">       1277 :         if (purpose.empty() || entry.second.purpose == purpose) {</span></a>
<a name="3862"><span class="lineNum">    3862 </span><span class="lineCov">       1277 :             label_set.insert(entry.second.GetLabel());</span></a>
<a name="3863"><span class="lineNum">    3863 </span><span class="lineCov">       1277 :         }</span></a>
<a name="3864"><span class="lineNum">    3864 </span><span class="lineCov">       1277 :     }</span></a>
<a name="3865"><span class="lineNum">    3865 </span>            : </a>
<a name="3866"><span class="lineNum">    3866 </span><span class="lineCov">         73 :     UniValue ret(UniValue::VARR);</span></a>
<a name="3867"><span class="lineNum">    3867 </span><span class="lineCov">        490 :     for (const std::string&amp; name : label_set) {</span></a>
<a name="3868"><span class="lineNum">    3868 </span><span class="lineCov">        417 :         ret.push_back(name);</span></a>
<a name="3869"><span class="lineNum">    3869 </span><span class="lineNoCov">          0 :     }</span></a>
<a name="3870"><span class="lineNum">    3870 </span>            : </a>
<a name="3871"><span class="lineNum">    3871 </span><span class="lineCov">         73 :     return ret;</span></a>
<a name="3872"><span class="lineNum">    3872 </span><span class="lineCov">         97 : }</span></a>
<a name="3873"><span class="lineNum">    3873 </span>            : </a>
<a name="3874"><span class="lineNum">    3874 </span><span class="lineCov">       2137 : static RPCHelpMan send()</span></a>
<a name="3875"><span class="lineNum">    3875 </span>            : {</a>
<a name="3876"><span class="lineNum">    3876 </span><span class="lineCov">      51288 :     return RPCHelpMan{&quot;send&quot;,</span></a>
<a name="3877"><span class="lineNum">    3877 </span><span class="lineCov">       2137 :         &quot;\nSend a transaction.\n&quot;,</span></a>
<a name="3878"><span class="lineNum">    3878 </span><span class="lineCov">      10685 :         {</span></a>
<a name="3879"><span class="lineNum">    3879 </span><span class="lineCov">       4274 :             {&quot;outputs&quot;, RPCArg::Type::ARR, RPCArg::Optional::NO, &quot;a json array with outputs (key-value pairs), where none of the keys are duplicated.\n&quot;</span></a>
<a name="3880"><span class="lineNum">    3880 </span>            :                     &quot;That is, each address can only appear once and there can only be one 'data' object.\n&quot;</a>
<a name="3881"><span class="lineNum">    3881 </span>            :                     &quot;For convenience, a dictionary, which holds the key-value pairs directly, is also accepted.&quot;,</a>
<a name="3882"><span class="lineNum">    3882 </span><span class="lineCov">       6411 :                 {</span></a>
<a name="3883"><span class="lineNum">    3883 </span><span class="lineCov">       4274 :                     {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="3884"><span class="lineNum">    3884 </span><span class="lineCov">       4274 :                         {</span></a>
<a name="3885"><span class="lineNum">    3885 </span><span class="lineCov">       2137 :                             {&quot;address&quot;, RPCArg::Type::AMOUNT, RPCArg::Optional::NO, &quot;A key-value pair. The key (string) is the bitcoin address, the value (float or string) is the amount in &quot; + CURRENCY_UNIT + &quot;&quot;},</span></a>
<a name="3886"><span class="lineNum">    3886 </span>            :                         },</a>
<a name="3887"><span class="lineNum">    3887 </span>            :                         },</a>
<a name="3888"><span class="lineNum">    3888 </span><span class="lineCov">       4274 :                     {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="3889"><span class="lineNum">    3889 </span><span class="lineCov">       4274 :                         {</span></a>
<a name="3890"><span class="lineNum">    3890 </span><span class="lineCov">       2137 :                             {&quot;data&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;A key-value pair. The key must be \&quot;data\&quot;, the value is hex-encoded data&quot;},</span></a>
<a name="3891"><span class="lineNum">    3891 </span>            :                         },</a>
<a name="3892"><span class="lineNum">    3892 </span>            :                     },</a>
<a name="3893"><span class="lineNum">    3893 </span>            :                 },</a>
<a name="3894"><span class="lineNum">    3894 </span>            :             },</a>
<a name="3895"><span class="lineNum">    3895 </span><span class="lineCov">       2137 :             {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;wallet default&quot;, &quot;Confirmation target (in blocks), or fee rate (for &quot; + CURRENCY_UNIT + &quot;/kB or &quot; + CURRENCY_ATOM + &quot;/B estimate modes)&quot;},</span></a>
<a name="3896"><span class="lineNum">    3896 </span><span class="lineCov">       4274 :             {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="3897"><span class="lineNum">    3897 </span><span class="lineCov">       2137 :                         &quot;       \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="3898"><span class="lineNum">    3898 </span><span class="lineCov">       4274 :             {&quot;options&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;&quot;,</span></a>
<a name="3899"><span class="lineNum">    3899 </span><span class="lineCov">      32055 :                 {</span></a>
<a name="3900"><span class="lineNum">    3900 </span><span class="lineCov">       2137 :                     {&quot;add_inputs&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;If inputs are specified, automatically include more if they are not enough.&quot;},</span></a>
<a name="3901"><span class="lineNum">    3901 </span><span class="lineCov">       2137 :                     {&quot;add_to_wallet&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;When false, returns a serialized transaction which will not be added to the wallet or broadcast&quot;},</span></a>
<a name="3902"><span class="lineNum">    3902 </span><span class="lineCov">       2137 :                     {&quot;change_address&quot;, RPCArg::Type::STR_HEX, /* default */ &quot;pool address&quot;, &quot;The bitcoin address to receive the change&quot;},</span></a>
<a name="3903"><span class="lineNum">    3903 </span><span class="lineCov">       2137 :                     {&quot;change_position&quot;, RPCArg::Type::NUM, /* default */ &quot;random&quot;, &quot;The index of the change output&quot;},</span></a>
<a name="3904"><span class="lineNum">    3904 </span><span class="lineCov">       2137 :                     {&quot;change_type&quot;, RPCArg::Type::STR, /* default */ &quot;set by -changetype&quot;, &quot;The output type to use. Only valid if change_address is not specified. Options are \&quot;legacy\&quot;, \&quot;p2sh-segwit\&quot;, and \&quot;bech32\&quot;.&quot;},</span></a>
<a name="3905"><span class="lineNum">    3905 </span><span class="lineCov">       2137 :                     {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;wallet default&quot;, &quot;Confirmation target (in blocks), or fee rate (for &quot; + CURRENCY_UNIT + &quot;/kB or &quot; + CURRENCY_ATOM + &quot;/B estimate modes)&quot;},</span></a>
<a name="3906"><span class="lineNum">    3906 </span><span class="lineCov">       4274 :                     {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="3907"><span class="lineNum">    3907 </span><span class="lineCov">       2137 :             &quot;       \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="3908"><span class="lineNum">    3908 </span><span class="lineCov">       2137 :                     {&quot;include_watching&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Also select inputs which are watch only.\n&quot;</span></a>
<a name="3909"><span class="lineNum">    3909 </span>            :                                           &quot;Only solvable inputs can be used. Watch-only destinations are solvable if the public key and/or output script was imported,\n&quot;</a>
<a name="3910"><span class="lineNum">    3910 </span>            :                                           &quot;e.g. with 'importpubkey' or 'importmulti' with the 'pubkeys' or 'desc' field.&quot;},</a>
<a name="3911"><span class="lineNum">    3911 </span><span class="lineCov">       4274 :                     {&quot;inputs&quot;, RPCArg::Type::ARR, /* default */ &quot;empty array&quot;, &quot;Specify inputs instead of adding them automatically. A json array of json objects&quot;,</span></a>
<a name="3912"><span class="lineNum">    3912 </span><span class="lineCov">       8548 :                         {</span></a>
<a name="3913"><span class="lineNum">    3913 </span><span class="lineCov">       2137 :                             {&quot;txid&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The transaction id&quot;},</span></a>
<a name="3914"><span class="lineNum">    3914 </span><span class="lineCov">       2137 :                             {&quot;vout&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The output number&quot;},</span></a>
<a name="3915"><span class="lineNum">    3915 </span><span class="lineCov">       2137 :                             {&quot;sequence&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The sequence number&quot;},</span></a>
<a name="3916"><span class="lineNum">    3916 </span>            :                         },</a>
<a name="3917"><span class="lineNum">    3917 </span>            :                     },</a>
<a name="3918"><span class="lineNum">    3918 </span><span class="lineCov">       2137 :                     {&quot;locktime&quot;, RPCArg::Type::NUM, /* default */ &quot;0&quot;, &quot;Raw locktime. Non-0 value also locktime-activates inputs&quot;},</span></a>
<a name="3919"><span class="lineNum">    3919 </span><span class="lineCov">       2137 :                     {&quot;lock_unspents&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Lock selected unspent outputs&quot;},</span></a>
<a name="3920"><span class="lineNum">    3920 </span><span class="lineCov">       2137 :                     {&quot;psbt&quot;, RPCArg::Type::BOOL,  /* default */ &quot;automatic&quot;, &quot;Always return a PSBT, implies add_to_wallet=false.&quot;},</span></a>
<a name="3921"><span class="lineNum">    3921 </span><span class="lineCov">       4274 :                     {&quot;subtract_fee_from_outputs&quot;, RPCArg::Type::ARR, /* default */ &quot;empty array&quot;, &quot;A json array of integers.\n&quot;</span></a>
<a name="3922"><span class="lineNum">    3922 </span>            :                     &quot;The fee will be equally deducted from the amount of each specified output.\n&quot;</a>
<a name="3923"><span class="lineNum">    3923 </span>            :                     &quot;Those recipients will receive less bitcoins than you enter in their corresponding amount field.\n&quot;</a>
<a name="3924"><span class="lineNum">    3924 </span>            :                     &quot;If no outputs are specified here, the sender pays the fee.&quot;,</a>
<a name="3925"><span class="lineNum">    3925 </span><span class="lineCov">       4274 :                         {</span></a>
<a name="3926"><span class="lineNum">    3926 </span><span class="lineCov">       2137 :                             {&quot;vout_index&quot;, RPCArg::Type::NUM, RPCArg::Optional::OMITTED, &quot;The zero-based output index, before a change output is added.&quot;},</span></a>
<a name="3927"><span class="lineNum">    3927 </span>            :                         },</a>
<a name="3928"><span class="lineNum">    3928 </span>            :                     },</a>
<a name="3929"><span class="lineNum">    3929 </span><span class="lineCov">       2137 :                     {&quot;replaceable&quot;, RPCArg::Type::BOOL, /* default */ &quot;wallet default&quot;, &quot;Marks this transaction as BIP125 replaceable.\n&quot;</span></a>
<a name="3930"><span class="lineNum">    3930 </span>            :                     &quot;                              Allows this transaction to be replaced by a transaction with higher fees&quot;},</a>
<a name="3931"><span class="lineNum">    3931 </span>            :                 },</a>
<a name="3932"><span class="lineNum">    3932 </span><span class="lineCov">       2137 :                 &quot;options&quot;},</span></a>
<a name="3933"><span class="lineNum">    3933 </span>            :         },</a>
<a name="3934"><span class="lineNum">    3934 </span><span class="lineCov">       2137 :         RPCResult{</span></a>
<a name="3935"><span class="lineNum">    3935 </span><span class="lineCov">       2137 :             RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="3936"><span class="lineNum">    3936 </span><span class="lineCov">      10685 :                 {</span></a>
<a name="3937"><span class="lineNum">    3937 </span><span class="lineCov">       2137 :                     {RPCResult::Type::BOOL, &quot;complete&quot;, &quot;If the transaction has a complete set of signatures&quot;},</span></a>
<a name="3938"><span class="lineNum">    3938 </span><span class="lineCov">       2137 :                     {RPCResult::Type::STR_HEX, &quot;txid&quot;, &quot;The transaction id for the send. Only 1 transaction is created regardless of the number of addresses.&quot;},</span></a>
<a name="3939"><span class="lineNum">    3939 </span><span class="lineCov">       2137 :                     {RPCResult::Type::STR_HEX, &quot;hex&quot;, &quot;If add_to_wallet is false, the hex-encoded raw transaction with signature(s)&quot;},</span></a>
<a name="3940"><span class="lineNum">    3940 </span><span class="lineCov">       2137 :                     {RPCResult::Type::STR, &quot;psbt&quot;, &quot;If more signatures are needed, or if add_to_wallet is false, the base64-encoded (partially) signed transaction&quot;}</span></a>
<a name="3941"><span class="lineNum">    3941 </span>            :                 }</a>
<a name="3942"><span class="lineNum">    3942 </span>            :         },</a>
<a name="3943"><span class="lineNum">    3943 </span><span class="lineCov">       4274 :         RPCExamples{&quot;&quot;</span></a>
<a name="3944"><span class="lineNum">    3944 </span>            :         &quot;\nSend with a fee rate of 1 satoshi per byte\n&quot;</a>
<a name="3945"><span class="lineNum">    3945 </span><span class="lineCov">       2137 :         + HelpExampleCli(&quot;send&quot;, &quot;'{\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;: 0.1}' 1 sat/b\n&quot; +</span></a>
<a name="3946"><span class="lineNum">    3946 </span>            :             &quot;\nCreate a transaction that should confirm the next block, with a specific input, and return result without adding to wallet or broadcasting to the network\n&quot;)</a>
<a name="3947"><span class="lineNum">    3947 </span><span class="lineCov">       2137 :         + HelpExampleCli(&quot;send&quot;, &quot;'{\&quot;&quot; + EXAMPLE_ADDRESS[0] + &quot;\&quot;: 0.1}' 1 economical '{\&quot;add_to_wallet\&quot;: false, \&quot;inputs\&quot;: [{\&quot;txid\&quot;:\&quot;a08e6907dbbd3d809776dbfc5d82e371b764ed838b5655e72f463568df1aadf0\&quot;, \&quot;vout\&quot;:1}]}'&quot;)</span></a>
<a name="3948"><span class="lineNum">    3948 </span>            :         },</a>
<a name="3949"><span class="lineNum">    3949 </span><span class="lineCov">       2170 :         [&amp;](const RPCHelpMan&amp; self, const JSONRPCRequest&amp; request) -&gt; UniValue</span></a>
<a name="3950"><span class="lineNum">    3950 </span>            :         {</a>
<a name="3951"><span class="lineNum">    3951 </span><span class="lineCov">         42 :             RPCTypeCheck(request.params, {</span></a>
<a name="3952"><span class="lineNum">    3952 </span><span class="lineCov">         33 :                 UniValueType(), // ARR or OBJ, checked later</span></a>
<a name="3953"><span class="lineNum">    3953 </span><span class="lineCov">         33 :                 UniValue::VNUM,</span></a>
<a name="3954"><span class="lineNum">    3954 </span><span class="lineCov">         33 :                 UniValue::VSTR,</span></a>
<a name="3955"><span class="lineNum">    3955 </span><span class="lineCov">         33 :                 UniValue::VOBJ</span></a>
<a name="3956"><span class="lineNum">    3956 </span>            :                 }, true</a>
<a name="3957"><span class="lineNum">    3957 </span>            :             );</a>
<a name="3958"><span class="lineNum">    3958 </span>            : </a>
<a name="3959"><span class="lineNum">    3959 </span><span class="lineCov">         33 :             std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="3960"><span class="lineNum">    3960 </span><span class="lineCov">         33 :             if (!wallet) return NullUniValue;</span></a>
<a name="3961"><span class="lineNum">    3961 </span><span class="lineCov">         33 :             CWallet* const pwallet = wallet.get();</span></a>
<a name="3962"><span class="lineNum">    3962 </span>            : </a>
<a name="3963"><span class="lineNum">    3963 </span><span class="lineCov">         33 :             UniValue options = request.params[3];</span></a>
<a name="3964"><span class="lineNum">    3964 </span><span class="lineCov">         33 :             if (options.exists(&quot;feeRate&quot;) || options.exists(&quot;fee_rate&quot;) || options.exists(&quot;estimate_mode&quot;) || options.exists(&quot;conf_target&quot;)) {</span></a>
<a name="3965"><span class="lineNum">    3965 </span><span class="lineCov">          6 :                 if (!request.params[1].isNull() || !request.params[2].isNull()) {</span></a>
<a name="3966"><span class="lineNum">    3966 </span><span class="lineCov">          1 :                     throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Use either conf_target and estimate_mode or the options dictionary to control fee rate&quot;);</span></a>
<a name="3967"><span class="lineNum">    3967 </span>            :                 }</a>
<a name="3968"><span class="lineNum">    3968 </span>            :             } else {</a>
<a name="3969"><span class="lineNum">    3969 </span><span class="lineCov">         27 :                 options.pushKV(&quot;conf_target&quot;, request.params[1]);</span></a>
<a name="3970"><span class="lineNum">    3970 </span><span class="lineCov">         27 :                 options.pushKV(&quot;estimate_mode&quot;, request.params[2]);</span></a>
<a name="3971"><span class="lineNum">    3971 </span>            :             }</a>
<a name="3972"><span class="lineNum">    3972 </span><span class="lineCov">         32 :             if (!options[&quot;conf_target&quot;].isNull() &amp;&amp; (options[&quot;estimate_mode&quot;].isNull() || (options[&quot;estimate_mode&quot;].get_str() == &quot;unset&quot;))) {</span></a>
<a name="3973"><span class="lineNum">    3973 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Specify estimate_mode&quot;);</span></a>
<a name="3974"><span class="lineNum">    3974 </span>            :             }</a>
<a name="3975"><span class="lineNum">    3975 </span><span class="lineCov">         32 :             if (options.exists(&quot;changeAddress&quot;)) {</span></a>
<a name="3976"><span class="lineNum">    3976 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Use change_address&quot;);</span></a>
<a name="3977"><span class="lineNum">    3977 </span>            :             }</a>
<a name="3978"><span class="lineNum">    3978 </span><span class="lineCov">         32 :             if (options.exists(&quot;changePosition&quot;)) {</span></a>
<a name="3979"><span class="lineNum">    3979 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Use change_position&quot;);</span></a>
<a name="3980"><span class="lineNum">    3980 </span>            :             }</a>
<a name="3981"><span class="lineNum">    3981 </span><span class="lineCov">         32 :             if (options.exists(&quot;includeWatching&quot;)) {</span></a>
<a name="3982"><span class="lineNum">    3982 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Use include_watching&quot;);</span></a>
<a name="3983"><span class="lineNum">    3983 </span>            :             }</a>
<a name="3984"><span class="lineNum">    3984 </span><span class="lineCov">         32 :             if (options.exists(&quot;lockUnspents&quot;)) {</span></a>
<a name="3985"><span class="lineNum">    3985 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Use lock_unspents&quot;);</span></a>
<a name="3986"><span class="lineNum">    3986 </span>            :             }</a>
<a name="3987"><span class="lineNum">    3987 </span><span class="lineCov">         32 :             if (options.exists(&quot;subtractFeeFromOutputs&quot;)) {</span></a>
<a name="3988"><span class="lineNum">    3988 </span><span class="lineNoCov">          0 :                 throw JSONRPCError(RPC_INVALID_PARAMETER, &quot;Use subtract_fee_from_outputs&quot;);</span></a>
<a name="3989"><span class="lineNum">    3989 </span>            :             }</a>
<a name="3990"><span class="lineNum">    3990 </span>            : </a>
<a name="3991"><span class="lineNum">    3991 </span><span class="lineCov">         32 :             const bool psbt_opt_in = options.exists(&quot;psbt&quot;) &amp;&amp; options[&quot;psbt&quot;].get_bool();</span></a>
<a name="3992"><span class="lineNum">    3992 </span>            : </a>
<a name="3993"><span class="lineNum">    3993 </span><span class="lineCov">         32 :             CAmount fee;</span></a>
<a name="3994"><span class="lineNum">    3994 </span><span class="lineCov">         32 :             int change_position;</span></a>
<a name="3995"><span class="lineNum">    3995 </span><span class="lineCov">         32 :             bool rbf = pwallet-&gt;m_signal_rbf;</span></a>
<a name="3996"><span class="lineNum">    3996 </span><span class="lineCov">         32 :             if (options.exists(&quot;replaceable&quot;)) {</span></a>
<a name="3997"><span class="lineNum">    3997 </span><span class="lineCov">          2 :                 rbf = options[&quot;add_to_wallet&quot;].get_bool();</span></a>
<a name="3998"><span class="lineNum">    3998 </span><span class="lineCov">          2 :             }</span></a>
<a name="3999"><span class="lineNum">    3999 </span><span class="lineCov">         32 :             CMutableTransaction rawTx = ConstructTransaction(options[&quot;inputs&quot;], request.params[0], options[&quot;locktime&quot;], rbf);</span></a>
<a name="4000"><span class="lineNum">    4000 </span><span class="lineCov">         31 :             CCoinControl coin_control;</span></a>
<a name="4001"><span class="lineNum">    4001 </span>            :             // Automatically select coins, unless at least one is manually selected. Can</a>
<a name="4002"><span class="lineNum">    4002 </span>            :             // be overriden by options.add_inputs.</a>
<a name="4003"><span class="lineNum">    4003 </span><span class="lineCov">         31 :             coin_control.m_add_inputs = rawTx.vin.size() == 0;</span></a>
<a name="4004"><span class="lineNum">    4004 </span><span class="lineCov">         31 :             FundTransaction(pwallet, rawTx, fee, change_position, options, coin_control);</span></a>
<a name="4005"><span class="lineNum">    4005 </span>            : </a>
<a name="4006"><span class="lineNum">    4006 </span>            :             bool add_to_wallet = true;</a>
<a name="4007"><span class="lineNum">    4007 </span><span class="lineCov">         24 :             if (options.exists(&quot;add_to_wallet&quot;)) {</span></a>
<a name="4008"><span class="lineNum">    4008 </span><span class="lineCov">         16 :                 add_to_wallet = options[&quot;add_to_wallet&quot;].get_bool();</span></a>
<a name="4009"><span class="lineNum">    4009 </span><span class="lineCov">         16 :             }</span></a>
<a name="4010"><span class="lineNum">    4010 </span>            : </a>
<a name="4011"><span class="lineNum">    4011 </span>            :             // Make a blank psbt</a>
<a name="4012"><span class="lineNum">    4012 </span><span class="lineCov">         24 :             PartiallySignedTransaction psbtx(rawTx);</span></a>
<a name="4013"><span class="lineNum">    4013 </span>            : </a>
<a name="4014"><span class="lineNum">    4014 </span>            :             // Fill transaction with out data and sign</a>
<a name="4015"><span class="lineNum">    4015 </span><span class="lineCov">         24 :             bool complete = true;</span></a>
<a name="4016"><span class="lineNum">    4016 </span><span class="lineCov">         24 :             const TransactionError err = pwallet-&gt;FillPSBT(psbtx, complete, SIGHASH_ALL, true, false);</span></a>
<a name="4017"><span class="lineNum">    4017 </span><span class="lineCov">         24 :             if (err != TransactionError::OK) {</span></a>
<a name="4018"><span class="lineNum">    4018 </span><span class="lineNoCov">          0 :                 throw JSONRPCTransactionError(err);</span></a>
<a name="4019"><span class="lineNum">    4019 </span>            :             }</a>
<a name="4020"><span class="lineNum">    4020 </span>            : </a>
<a name="4021"><span class="lineNum">    4021 </span><span class="lineCov">         24 :             CMutableTransaction mtx;</span></a>
<a name="4022"><span class="lineNum">    4022 </span><span class="lineCov">         24 :             complete = FinalizeAndExtractPSBT(psbtx, mtx);</span></a>
<a name="4023"><span class="lineNum">    4023 </span>            : </a>
<a name="4024"><span class="lineNum">    4024 </span><span class="lineCov">         24 :             UniValue result(UniValue::VOBJ);</span></a>
<a name="4025"><span class="lineNum">    4025 </span>            : </a>
<a name="4026"><span class="lineNum">    4026 </span>            :             // Serialize the PSBT</a>
<a name="4027"><span class="lineNum">    4027 </span><span class="lineCov">         24 :             CDataStream ssTx(SER_NETWORK, PROTOCOL_VERSION);</span></a>
<a name="4028"><span class="lineNum">    4028 </span><span class="lineCov">         24 :             ssTx &lt;&lt; psbtx;</span></a>
<a name="4029"><span class="lineNum">    4029 </span><span class="lineCov">         24 :             const std::string result_str = EncodeBase64(ssTx.str());</span></a>
<a name="4030"><span class="lineNum">    4030 </span>            : </a>
<a name="4031"><span class="lineNum">    4031 </span><span class="lineCov">         24 :             if (psbt_opt_in || !complete || !add_to_wallet) {</span></a>
<a name="4032"><span class="lineNum">    4032 </span><span class="lineCov">         18 :                 result.pushKV(&quot;psbt&quot;, result_str);</span></a>
<a name="4033"><span class="lineNum">    4033 </span><span class="lineCov">         18 :             }</span></a>
<a name="4034"><span class="lineNum">    4034 </span>            : </a>
<a name="4035"><span class="lineNum">    4035 </span><span class="lineCov">         24 :             if (complete) {</span></a>
<a name="4036"><span class="lineNum">    4036 </span><span class="lineCov">         21 :                 std::string err_string;</span></a>
<a name="4037"><span class="lineNum">    4037 </span><span class="lineCov">         21 :                 std::string hex = EncodeHexTx(CTransaction(mtx));</span></a>
<a name="4038"><span class="lineNum">    4038 </span><span class="lineCov">         21 :                 CTransactionRef tx(MakeTransactionRef(std::move(mtx)));</span></a>
<a name="4039"><span class="lineNum">    4039 </span><span class="lineCov">         21 :                 result.pushKV(&quot;txid&quot;, tx-&gt;GetHash().GetHex());</span></a>
<a name="4040"><span class="lineNum">    4040 </span><span class="lineCov">         21 :                 if (add_to_wallet &amp;&amp; !psbt_opt_in) {</span></a>
<a name="4041"><span class="lineNum">    4041 </span><span class="lineCov">          6 :                     pwallet-&gt;CommitTransaction(tx, {}, {} /* orderForm */);</span></a>
<a name="4042"><span class="lineNum">    4042 </span><span class="lineCov">          6 :                 } else {</span></a>
<a name="4043"><span class="lineNum">    4043 </span><span class="lineCov">         15 :                     result.pushKV(&quot;hex&quot;, hex);</span></a>
<a name="4044"><span class="lineNum">    4044 </span>            :                 }</a>
<a name="4045"><span class="lineNum">    4045 </span><span class="lineCov">         21 :             }</span></a>
<a name="4046"><span class="lineNum">    4046 </span><span class="lineCov">         24 :             result.pushKV(&quot;complete&quot;, complete);</span></a>
<a name="4047"><span class="lineNum">    4047 </span>            : </a>
<a name="4048"><span class="lineNum">    4048 </span><span class="lineCov">         24 :             return result;</span></a>
<a name="4049"><span class="lineNum">    4049 </span><span class="lineCov">         33 :         }</span></a>
<a name="4050"><span class="lineNum">    4050 </span>            :     };</a>
<a name="4051"><span class="lineNum">    4051 </span><span class="lineNoCov">          0 : }</span></a>
<a name="4052"><span class="lineNum">    4052 </span>            : </a>
<a name="4053"><span class="lineNum">    4053 </span><span class="lineCov">         23 : UniValue sethdseed(const JSONRPCRequest&amp; request)</span></a>
<a name="4054"><span class="lineNum">    4054 </span>            : {</a>
<a name="4055"><span class="lineNum">    4055 </span><span class="lineCov">         98 :             RPCHelpMan{&quot;sethdseed&quot;,</span></a>
<a name="4056"><span class="lineNum">    4056 </span>            :                 &quot;\nSet or generate a new HD wallet seed. Non-HD wallets will not be upgraded to being a HD wallet. Wallets that are already\n&quot;</a>
<a name="4057"><span class="lineNum">    4057 </span>            :                 &quot;HD will have a new HD seed set so that new keys added to the keypool will be derived from this new seed.\n&quot;</a>
<a name="4058"><span class="lineNum">    4058 </span><span class="lineCov">         23 :                 &quot;\nNote that you will need to MAKE A NEW BACKUP of your wallet after setting the HD wallet seed.&quot; +</span></a>
<a name="4059"><span class="lineNum">    4059 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="4060"><span class="lineNum">    4060 </span><span class="lineCov">         74 :                 {</span></a>
<a name="4061"><span class="lineNum">    4061 </span><span class="lineCov">         23 :                     {&quot;newkeypool&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Whether to flush old unused addresses, including change addresses, from the keypool and regenerate it.\n&quot;</span></a>
<a name="4062"><span class="lineNum">    4062 </span>            :             &quot;                             If true, the next address from getnewaddress and change address from getrawchangeaddress will be from this new seed.\n&quot;</a>
<a name="4063"><span class="lineNum">    4063 </span>            :             &quot;                             If false, addresses (including change addresses if the wallet already had HD Chain Split enabled) from the existing\n&quot;</a>
<a name="4064"><span class="lineNum">    4064 </span>            :             &quot;                             keypool will be used until it has been depleted.&quot;},</a>
<a name="4065"><span class="lineNum">    4065 </span><span class="lineCov">         23 :                     {&quot;seed&quot;, RPCArg::Type::STR, /* default */ &quot;random seed&quot;, &quot;The WIF private key to use as the new HD seed.\n&quot;</span></a>
<a name="4066"><span class="lineNum">    4066 </span>            :             &quot;                             The seed value can be retrieved using the dumpwallet command. It is the private key marked hdseed=1&quot;},</a>
<a name="4067"><span class="lineNum">    4067 </span>            :                 },</a>
<a name="4068"><span class="lineNum">    4068 </span><span class="lineCov">         23 :                 RPCResult{RPCResult::Type::NONE, &quot;&quot;, &quot;&quot;},</span></a>
<a name="4069"><span class="lineNum">    4069 </span><span class="lineCov">         23 :                 RPCExamples{</span></a>
<a name="4070"><span class="lineNum">    4070 </span><span class="lineCov">         23 :                     HelpExampleCli(&quot;sethdseed&quot;, &quot;&quot;)</span></a>
<a name="4071"><span class="lineNum">    4071 </span><span class="lineCov">         23 :             + HelpExampleCli(&quot;sethdseed&quot;, &quot;false&quot;)</span></a>
<a name="4072"><span class="lineNum">    4072 </span><span class="lineCov">         23 :             + HelpExampleCli(&quot;sethdseed&quot;, &quot;true \&quot;wifkey\&quot;&quot;)</span></a>
<a name="4073"><span class="lineNum">    4073 </span><span class="lineCov">         23 :             + HelpExampleRpc(&quot;sethdseed&quot;, &quot;true, \&quot;wifkey\&quot;&quot;)</span></a>
<a name="4074"><span class="lineNum">    4074 </span>            :                 },</a>
<a name="4075"><span class="lineNum">    4075 </span><span class="lineCov">         23 :             }.Check(request);</span></a>
<a name="4076"><span class="lineNum">    4076 </span>            : </a>
<a name="4077"><span class="lineNum">    4077 </span><span class="lineCov">         18 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="4078"><span class="lineNum">    4078 </span><span class="lineCov">         18 :     if (!wallet) return NullUniValue;</span></a>
<a name="4079"><span class="lineNum">    4079 </span><span class="lineCov">         18 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="4080"><span class="lineNum">    4080 </span>            : </a>
<a name="4081"><span class="lineNum">    4081 </span><span class="lineCov">         18 :     LegacyScriptPubKeyMan&amp; spk_man = EnsureLegacyScriptPubKeyMan(*pwallet, true);</span></a>
<a name="4082"><span class="lineNum">    4082 </span>            : </a>
<a name="4083"><span class="lineNum">    4083 </span><span class="lineCov">         17 :     if (pwallet-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></a>
<a name="4084"><span class="lineNum">    4084 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Cannot set a HD seed to a wallet with private keys disabled&quot;);</span></a>
<a name="4085"><span class="lineNum">    4085 </span>            :     }</a>
<a name="4086"><span class="lineNum">    4086 </span>            : </a>
<a name="4087"><span class="lineNum">    4087 </span><span class="lineCov">         17 :     LOCK2(pwallet-&gt;cs_wallet, spk_man.cs_KeyStore);</span></a>
<a name="4088"><span class="lineNum">    4088 </span>            : </a>
<a name="4089"><span class="lineNum">    4089 </span>            :     // Do not do anything to non-HD wallets</a>
<a name="4090"><span class="lineNum">    4090 </span><span class="lineCov">         17 :     if (!pwallet-&gt;CanSupportFeature(FEATURE_HD)) {</span></a>
<a name="4091"><span class="lineNum">    4091 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, &quot;Cannot set a HD seed on a non-HD wallet. Use the upgradewallet RPC in order to upgrade a non-HD wallet to HD&quot;);</span></a>
<a name="4092"><span class="lineNum">    4092 </span>            :     }</a>
<a name="4093"><span class="lineNum">    4093 </span>            : </a>
<a name="4094"><span class="lineNum">    4094 </span><span class="lineCov">         17 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="4095"><span class="lineNum">    4095 </span>            : </a>
<a name="4096"><span class="lineNum">    4096 </span>            :     bool flush_key_pool = true;</a>
<a name="4097"><span class="lineNum">    4097 </span><span class="lineCov">         17 :     if (!request.params[0].isNull()) {</span></a>
<a name="4098"><span class="lineNum">    4098 </span><span class="lineCov">         11 :         flush_key_pool = request.params[0].get_bool();</span></a>
<a name="4099"><span class="lineNum">    4099 </span><span class="lineCov">         10 :     }</span></a>
<a name="4100"><span class="lineNum">    4100 </span>            : </a>
<a name="4101"><span class="lineNum">    4101 </span><span class="lineCov">         16 :     CPubKey master_pub_key;</span></a>
<a name="4102"><span class="lineNum">    4102 </span><span class="lineCov">         16 :     if (request.params[1].isNull()) {</span></a>
<a name="4103"><span class="lineNum">    4103 </span><span class="lineCov">          7 :         master_pub_key = spk_man.GenerateNewSeed();</span></a>
<a name="4104"><span class="lineNum">    4104 </span><span class="lineCov">          7 :     } else {</span></a>
<a name="4105"><span class="lineNum">    4105 </span><span class="lineCov">          9 :         CKey key = DecodeSecret(request.params[1].get_str());</span></a>
<a name="4106"><span class="lineNum">    4106 </span><span class="lineCov">          8 :         if (!key.IsValid()) {</span></a>
<a name="4107"><span class="lineNum">    4107 </span><span class="lineCov">          1 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Invalid private key&quot;);</span></a>
<a name="4108"><span class="lineNum">    4108 </span>            :         }</a>
<a name="4109"><span class="lineNum">    4109 </span>            : </a>
<a name="4110"><span class="lineNum">    4110 </span><span class="lineCov">          7 :         if (HaveKey(spk_man, key)) {</span></a>
<a name="4111"><span class="lineNum">    4111 </span><span class="lineCov">          2 :             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, &quot;Already have this key (either as an HD seed or as a loose private key)&quot;);</span></a>
<a name="4112"><span class="lineNum">    4112 </span>            :         }</a>
<a name="4113"><span class="lineNum">    4113 </span>            : </a>
<a name="4114"><span class="lineNum">    4114 </span><span class="lineCov">          5 :         master_pub_key = spk_man.DeriveNewSeed(key);</span></a>
<a name="4115"><span class="lineNum">    4115 </span><span class="lineCov">          9 :     }</span></a>
<a name="4116"><span class="lineNum">    4116 </span>            : </a>
<a name="4117"><span class="lineNum">    4117 </span><span class="lineCov">         12 :     spk_man.SetHDSeed(master_pub_key);</span></a>
<a name="4118"><span class="lineNum">    4118 </span><span class="lineCov">         12 :     if (flush_key_pool) spk_man.NewKeyPool();</span></a>
<a name="4119"><span class="lineNum">    4119 </span>            : </a>
<a name="4120"><span class="lineNum">    4120 </span><span class="lineCov">         12 :     return NullUniValue;</span></a>
<a name="4121"><span class="lineNum">    4121 </span><span class="lineCov">         47 : }</span></a>
<a name="4122"><span class="lineNum">    4122 </span>            : </a>
<a name="4123"><span class="lineNum">    4123 </span><span class="lineCov">        119 : UniValue walletprocesspsbt(const JSONRPCRequest&amp; request)</span></a>
<a name="4124"><span class="lineNum">    4124 </span>            : {</a>
<a name="4125"><span class="lineNum">    4125 </span><span class="lineCov">        837 :             RPCHelpMan{&quot;walletprocesspsbt&quot;,</span></a>
<a name="4126"><span class="lineNum">    4126 </span>            :                 &quot;\nUpdate a PSBT with input information from our wallet and then sign inputs\n&quot;</a>
<a name="4127"><span class="lineNum">    4127 </span><span class="lineCov">        119 :                 &quot;that we can sign for.&quot; +</span></a>
<a name="4128"><span class="lineNum">    4128 </span>            :         HELP_REQUIRING_PASSPHRASE,</a>
<a name="4129"><span class="lineNum">    4129 </span><span class="lineCov">        599 :                 {</span></a>
<a name="4130"><span class="lineNum">    4130 </span><span class="lineCov">        119 :                     {&quot;psbt&quot;, RPCArg::Type::STR, RPCArg::Optional::NO, &quot;The transaction base64 string&quot;},</span></a>
<a name="4131"><span class="lineNum">    4131 </span><span class="lineCov">        119 :                     {&quot;sign&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Also sign the transaction when updating&quot;},</span></a>
<a name="4132"><span class="lineNum">    4132 </span><span class="lineCov">        119 :                     {&quot;sighashtype&quot;, RPCArg::Type::STR, /* default */ &quot;ALL&quot;, &quot;The signature hash type to sign with if not specified by the PSBT. Must be one of\n&quot;</span></a>
<a name="4133"><span class="lineNum">    4133 </span>            :             &quot;       \&quot;ALL\&quot;\n&quot;</a>
<a name="4134"><span class="lineNum">    4134 </span>            :             &quot;       \&quot;NONE\&quot;\n&quot;</a>
<a name="4135"><span class="lineNum">    4135 </span>            :             &quot;       \&quot;SINGLE\&quot;\n&quot;</a>
<a name="4136"><span class="lineNum">    4136 </span>            :             &quot;       \&quot;ALL|ANYONECANPAY\&quot;\n&quot;</a>
<a name="4137"><span class="lineNum">    4137 </span>            :             &quot;       \&quot;NONE|ANYONECANPAY\&quot;\n&quot;</a>
<a name="4138"><span class="lineNum">    4138 </span>            :             &quot;       \&quot;SINGLE|ANYONECANPAY\&quot;&quot;},</a>
<a name="4139"><span class="lineNum">    4139 </span><span class="lineCov">        119 :                     {&quot;bip32derivs&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Include BIP 32 derivation paths for public keys if we know them&quot;},</span></a>
<a name="4140"><span class="lineNum">    4140 </span>            :                 },</a>
<a name="4141"><span class="lineNum">    4141 </span><span class="lineCov">        119 :                 RPCResult{</span></a>
<a name="4142"><span class="lineNum">    4142 </span><span class="lineCov">        119 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="4143"><span class="lineNum">    4143 </span><span class="lineCov">        361 :                     {</span></a>
<a name="4144"><span class="lineNum">    4144 </span><span class="lineCov">        119 :                         {RPCResult::Type::STR, &quot;psbt&quot;, &quot;The base64-encoded partially signed transaction&quot;},</span></a>
<a name="4145"><span class="lineNum">    4145 </span><span class="lineCov">        119 :                         {RPCResult::Type::BOOL, &quot;complete&quot;, &quot;If the transaction has a complete set of signatures&quot;},</span></a>
<a name="4146"><span class="lineNum">    4146 </span>            :                     }</a>
<a name="4147"><span class="lineNum">    4147 </span>            :                 },</a>
<a name="4148"><span class="lineNum">    4148 </span><span class="lineCov">        119 :                 RPCExamples{</span></a>
<a name="4149"><span class="lineNum">    4149 </span><span class="lineCov">        119 :                     HelpExampleCli(&quot;walletprocesspsbt&quot;, &quot;\&quot;psbt\&quot;&quot;)</span></a>
<a name="4150"><span class="lineNum">    4150 </span>            :                 },</a>
<a name="4151"><span class="lineNum">    4151 </span><span class="lineCov">        119 :             }.Check(request);</span></a>
<a name="4152"><span class="lineNum">    4152 </span>            : </a>
<a name="4153"><span class="lineNum">    4153 </span><span class="lineCov">        115 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="4154"><span class="lineNum">    4154 </span><span class="lineCov">        115 :     if (!wallet) return NullUniValue;</span></a>
<a name="4155"><span class="lineNum">    4155 </span><span class="lineCov">        115 :     const CWallet* const pwallet = wallet.get();</span></a>
<a name="4156"><span class="lineNum">    4156 </span>            : </a>
<a name="4157"><span class="lineNum">    4157 </span><span class="lineCov">        115 :     RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VBOOL, UniValue::VSTR});</span></a>
<a name="4158"><span class="lineNum">    4158 </span>            : </a>
<a name="4159"><span class="lineNum">    4159 </span>            :     // Unserialize the transaction</a>
<a name="4160"><span class="lineNum">    4160 </span><span class="lineCov">        115 :     PartiallySignedTransaction psbtx;</span></a>
<a name="4161"><span class="lineNum">    4161 </span><span class="lineCov">        115 :     std::string error;</span></a>
<a name="4162"><span class="lineNum">    4162 </span><span class="lineCov">        115 :     if (!DecodeBase64PSBT(psbtx, request.params[0].get_str(), error)) {</span></a>
<a name="4163"><span class="lineNum">    4163 </span><span class="lineCov">          2 :         throw JSONRPCError(RPC_DESERIALIZATION_ERROR, strprintf(&quot;TX decode failed %s&quot;, error));</span></a>
<a name="4164"><span class="lineNum">    4164 </span>            :     }</a>
<a name="4165"><span class="lineNum">    4165 </span>            : </a>
<a name="4166"><span class="lineNum">    4166 </span>            :     // Get the sighash type</a>
<a name="4167"><span class="lineNum">    4167 </span><span class="lineCov">        113 :     int nHashType = ParseSighashString(request.params[2]);</span></a>
<a name="4168"><span class="lineNum">    4168 </span>            : </a>
<a name="4169"><span class="lineNum">    4169 </span>            :     // Fill transaction with our data and also sign</a>
<a name="4170"><span class="lineNum">    4170 </span><span class="lineCov">        113 :     bool sign = request.params[1].isNull() ? true : request.params[1].get_bool();</span></a>
<a name="4171"><span class="lineNum">    4171 </span><span class="lineCov">        113 :     bool bip32derivs = request.params[3].isNull() ? true : request.params[3].get_bool();</span></a>
<a name="4172"><span class="lineNum">    4172 </span><span class="lineCov">        113 :     bool complete = true;</span></a>
<a name="4173"><span class="lineNum">    4173 </span><span class="lineCov">        113 :     const TransactionError err = pwallet-&gt;FillPSBT(psbtx, complete, nHashType, sign, bip32derivs);</span></a>
<a name="4174"><span class="lineNum">    4174 </span><span class="lineCov">        113 :     if (err != TransactionError::OK) {</span></a>
<a name="4175"><span class="lineNum">    4175 </span><span class="lineCov">          2 :         throw JSONRPCTransactionError(err);</span></a>
<a name="4176"><span class="lineNum">    4176 </span>            :     }</a>
<a name="4177"><span class="lineNum">    4177 </span>            : </a>
<a name="4178"><span class="lineNum">    4178 </span><span class="lineCov">        111 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="4179"><span class="lineNum">    4179 </span><span class="lineCov">        111 :     CDataStream ssTx(SER_NETWORK, PROTOCOL_VERSION);</span></a>
<a name="4180"><span class="lineNum">    4180 </span><span class="lineCov">        111 :     ssTx &lt;&lt; psbtx;</span></a>
<a name="4181"><span class="lineNum">    4181 </span><span class="lineCov">        111 :     result.pushKV(&quot;psbt&quot;, EncodeBase64(ssTx.str()));</span></a>
<a name="4182"><span class="lineNum">    4182 </span><span class="lineCov">        111 :     result.pushKV(&quot;complete&quot;, complete);</span></a>
<a name="4183"><span class="lineNum">    4183 </span>            : </a>
<a name="4184"><span class="lineNum">    4184 </span><span class="lineCov">        111 :     return result;</span></a>
<a name="4185"><span class="lineNum">    4185 </span><span class="lineCov">        153 : }</span></a>
<a name="4186"><span class="lineNum">    4186 </span>            : </a>
<a name="4187"><span class="lineNum">    4187 </span><span class="lineCov">         59 : UniValue walletcreatefundedpsbt(const JSONRPCRequest&amp; request)</span></a>
<a name="4188"><span class="lineNum">    4188 </span>            : {</a>
<a name="4189"><span class="lineNum">    4189 </span><span class="lineCov">       1308 :             RPCHelpMan{&quot;walletcreatefundedpsbt&quot;,</span></a>
<a name="4190"><span class="lineNum">    4190 </span><span class="lineCov">         59 :                 &quot;\nCreates and funds a transaction in the Partially Signed Transaction format.\n&quot;</span></a>
<a name="4191"><span class="lineNum">    4191 </span>            :                 &quot;Implements the Creator and Updater roles.\n&quot;,</a>
<a name="4192"><span class="lineNum">    4192 </span><span class="lineCov">        414 :                 {</span></a>
<a name="4193"><span class="lineNum">    4193 </span><span class="lineCov">        118 :                     {&quot;inputs&quot;, RPCArg::Type::ARR, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;Leave empty to add inputs automatically. See add_inputs option.&quot;,</span></a>
<a name="4194"><span class="lineNum">    4194 </span><span class="lineCov">        118 :                         {</span></a>
<a name="4195"><span class="lineNum">    4195 </span><span class="lineCov">        118 :                             {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="4196"><span class="lineNum">    4196 </span><span class="lineCov">        240 :                                 {</span></a>
<a name="4197"><span class="lineNum">    4197 </span><span class="lineCov">         59 :                                     {&quot;txid&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;The transaction id&quot;},</span></a>
<a name="4198"><span class="lineNum">    4198 </span><span class="lineCov">         59 :                                     {&quot;vout&quot;, RPCArg::Type::NUM, RPCArg::Optional::NO, &quot;The output number&quot;},</span></a>
<a name="4199"><span class="lineNum">    4199 </span><span class="lineCov">         59 :                                     {&quot;sequence&quot;, RPCArg::Type::NUM, /* default */ &quot;depends on the value of the 'locktime' and 'options.replaceable' arguments&quot;, &quot;The sequence number&quot;},</span></a>
<a name="4200"><span class="lineNum">    4200 </span>            :                                 },</a>
<a name="4201"><span class="lineNum">    4201 </span>            :                             },</a>
<a name="4202"><span class="lineNum">    4202 </span>            :                         },</a>
<a name="4203"><span class="lineNum">    4203 </span>            :                         },</a>
<a name="4204"><span class="lineNum">    4204 </span><span class="lineCov">        118 :                     {&quot;outputs&quot;, RPCArg::Type::ARR, RPCArg::Optional::NO, &quot;The outputs (key-value pairs), where none of the keys are duplicated.\n&quot;</span></a>
<a name="4205"><span class="lineNum">    4205 </span>            :                             &quot;That is, each address can only appear once and there can only be one 'data' object.\n&quot;</a>
<a name="4206"><span class="lineNum">    4206 </span>            :                             &quot;For compatibility reasons, a dictionary, which holds the key-value pairs directly, is also\n&quot;</a>
<a name="4207"><span class="lineNum">    4207 </span>            :                             &quot;                             accepted as second parameter.&quot;,</a>
<a name="4208"><span class="lineNum">    4208 </span><span class="lineCov">        189 :                         {</span></a>
<a name="4209"><span class="lineNum">    4209 </span><span class="lineCov">        118 :                             {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="4210"><span class="lineNum">    4210 </span><span class="lineCov">        118 :                                 {</span></a>
<a name="4211"><span class="lineNum">    4211 </span><span class="lineCov">         59 :                                     {&quot;address&quot;, RPCArg::Type::AMOUNT, RPCArg::Optional::NO, &quot;A key-value pair. The key (string) is the bitcoin address, the value (float or string) is the amount in &quot; + CURRENCY_UNIT + &quot;&quot;},</span></a>
<a name="4212"><span class="lineNum">    4212 </span>            :                                 },</a>
<a name="4213"><span class="lineNum">    4213 </span>            :                                 },</a>
<a name="4214"><span class="lineNum">    4214 </span><span class="lineCov">        118 :                             {&quot;&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED, &quot;&quot;,</span></a>
<a name="4215"><span class="lineNum">    4215 </span><span class="lineCov">        118 :                                 {</span></a>
<a name="4216"><span class="lineNum">    4216 </span><span class="lineCov">         59 :                                     {&quot;data&quot;, RPCArg::Type::STR_HEX, RPCArg::Optional::NO, &quot;A key-value pair. The key must be \&quot;data\&quot;, the value is hex-encoded data&quot;},</span></a>
<a name="4217"><span class="lineNum">    4217 </span>            :                                 },</a>
<a name="4218"><span class="lineNum">    4218 </span>            :                             },</a>
<a name="4219"><span class="lineNum">    4219 </span>            :                         },</a>
<a name="4220"><span class="lineNum">    4220 </span>            :                     },</a>
<a name="4221"><span class="lineNum">    4221 </span><span class="lineCov">         59 :                     {&quot;locktime&quot;, RPCArg::Type::NUM, /* default */ &quot;0&quot;, &quot;Raw locktime. Non-0 value also locktime-activates inputs&quot;},</span></a>
<a name="4222"><span class="lineNum">    4222 </span><span class="lineCov">        118 :                     {&quot;options&quot;, RPCArg::Type::OBJ, RPCArg::Optional::OMITTED_NAMED_ARG, &quot;&quot;,</span></a>
<a name="4223"><span class="lineNum">    4223 </span><span class="lineCov">        720 :                         {</span></a>
<a name="4224"><span class="lineNum">    4224 </span><span class="lineCov">         59 :                             {&quot;add_inputs&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;If inputs are specified, automatically include more if they are not enough.&quot;},</span></a>
<a name="4225"><span class="lineNum">    4225 </span><span class="lineCov">         59 :                             {&quot;changeAddress&quot;, RPCArg::Type::STR_HEX, /* default */ &quot;pool address&quot;, &quot;The bitcoin address to receive the change&quot;},</span></a>
<a name="4226"><span class="lineNum">    4226 </span><span class="lineCov">         59 :                             {&quot;changePosition&quot;, RPCArg::Type::NUM, /* default */ &quot;random&quot;, &quot;The index of the change output&quot;},</span></a>
<a name="4227"><span class="lineNum">    4227 </span><span class="lineCov">         59 :                             {&quot;change_type&quot;, RPCArg::Type::STR, /* default */ &quot;set by -changetype&quot;, &quot;The output type to use. Only valid if changeAddress is not specified. Options are \&quot;legacy\&quot;, \&quot;p2sh-segwit\&quot;, and \&quot;bech32\&quot;.&quot;},</span></a>
<a name="4228"><span class="lineNum">    4228 </span><span class="lineCov">         59 :                             {&quot;includeWatching&quot;, RPCArg::Type::BOOL, /* default */ &quot;true for watch-only wallets, otherwise false&quot;, &quot;Also select inputs which are watch only&quot;},</span></a>
<a name="4229"><span class="lineNum">    4229 </span><span class="lineCov">         59 :                             {&quot;lockUnspents&quot;, RPCArg::Type::BOOL, /* default */ &quot;false&quot;, &quot;Lock selected unspent outputs&quot;},</span></a>
<a name="4230"><span class="lineNum">    4230 </span><span class="lineCov">         59 :                             {&quot;feeRate&quot;, RPCArg::Type::AMOUNT, /* default */ &quot;not set: makes wallet determine the fee&quot;, &quot;Set a specific fee rate in &quot; + CURRENCY_UNIT + &quot;/kB&quot;},</span></a>
<a name="4231"><span class="lineNum">    4231 </span><span class="lineCov">        118 :                             {&quot;subtractFeeFromOutputs&quot;, RPCArg::Type::ARR, /* default */ &quot;empty array&quot;, &quot;The outputs to subtract the fee from.\n&quot;</span></a>
<a name="4232"><span class="lineNum">    4232 </span>            :                             &quot;                              The fee will be equally deducted from the amount of each specified output.\n&quot;</a>
<a name="4233"><span class="lineNum">    4233 </span>            :                             &quot;                              Those recipients will receive less bitcoins than you enter in their corresponding amount field.\n&quot;</a>
<a name="4234"><span class="lineNum">    4234 </span>            :                             &quot;                              If no outputs are specified here, the sender pays the fee.&quot;,</a>
<a name="4235"><span class="lineNum">    4235 </span><span class="lineCov">        118 :                                 {</span></a>
<a name="4236"><span class="lineNum">    4236 </span><span class="lineCov">         59 :                                     {&quot;vout_index&quot;, RPCArg::Type::NUM, RPCArg::Optional::OMITTED, &quot;The zero-based output index, before a change output is added.&quot;},</span></a>
<a name="4237"><span class="lineNum">    4237 </span>            :                                 },</a>
<a name="4238"><span class="lineNum">    4238 </span>            :                             },</a>
<a name="4239"><span class="lineNum">    4239 </span><span class="lineCov">         59 :                             {&quot;replaceable&quot;, RPCArg::Type::BOOL, /* default */ &quot;wallet default&quot;, &quot;Marks this transaction as BIP125 replaceable.\n&quot;</span></a>
<a name="4240"><span class="lineNum">    4240 </span>            :                             &quot;                              Allows this transaction to be replaced by a transaction with higher fees&quot;},</a>
<a name="4241"><span class="lineNum">    4241 </span><span class="lineCov">         59 :                             {&quot;conf_target&quot;, RPCArg::Type::NUM, /* default */ &quot;fall back to wallet's confirmation target (txconfirmtarget)&quot;, &quot;Confirmation target (in blocks)&quot;},</span></a>
<a name="4242"><span class="lineNum">    4242 </span><span class="lineCov">        118 :                             {&quot;estimate_mode&quot;, RPCArg::Type::STR, /* default */ &quot;unset&quot;, std::string() + &quot;The fee estimate mode, must be one of (case insensitive):\n&quot;</span></a>
<a name="4243"><span class="lineNum">    4243 </span><span class="lineCov">         59 :                             &quot;         \&quot;&quot; + FeeModes(&quot;\&quot;\n\&quot;&quot;) + &quot;\&quot;&quot;},</span></a>
<a name="4244"><span class="lineNum">    4244 </span>            :                         },</a>
<a name="4245"><span class="lineNum">    4245 </span><span class="lineCov">         59 :                         &quot;options&quot;},</span></a>
<a name="4246"><span class="lineNum">    4246 </span><span class="lineCov">         59 :                     {&quot;bip32derivs&quot;, RPCArg::Type::BOOL, /* default */ &quot;true&quot;, &quot;Include BIP 32 derivation paths for public keys if we know them&quot;},</span></a>
<a name="4247"><span class="lineNum">    4247 </span>            :                 },</a>
<a name="4248"><span class="lineNum">    4248 </span><span class="lineCov">         59 :                 RPCResult{</span></a>
<a name="4249"><span class="lineNum">    4249 </span><span class="lineCov">         59 :                     RPCResult::Type::OBJ, &quot;&quot;, &quot;&quot;,</span></a>
<a name="4250"><span class="lineNum">    4250 </span><span class="lineCov">        240 :                     {</span></a>
<a name="4251"><span class="lineNum">    4251 </span><span class="lineCov">         59 :                         {RPCResult::Type::STR, &quot;psbt&quot;, &quot;The resulting raw transaction (base64-encoded string)&quot;},</span></a>
<a name="4252"><span class="lineNum">    4252 </span><span class="lineCov">         59 :                         {RPCResult::Type::STR_AMOUNT, &quot;fee&quot;, &quot;Fee in &quot; + CURRENCY_UNIT + &quot; the resulting transaction pays&quot;},</span></a>
<a name="4253"><span class="lineNum">    4253 </span><span class="lineCov">         59 :                         {RPCResult::Type::NUM, &quot;changepos&quot;, &quot;The position of the added change output, or -1&quot;},</span></a>
<a name="4254"><span class="lineNum">    4254 </span>            :                     }</a>
<a name="4255"><span class="lineNum">    4255 </span>            :                                 },</a>
<a name="4256"><span class="lineNum">    4256 </span><span class="lineCov">         59 :                                 RPCExamples{</span></a>
<a name="4257"><span class="lineNum">    4257 </span>            :                             &quot;\nCreate a transaction with no inputs\n&quot;</a>
<a name="4258"><span class="lineNum">    4258 </span><span class="lineCov">         59 :                             + HelpExampleCli(&quot;walletcreatefundedpsbt&quot;, &quot;\&quot;[{\\\&quot;txid\\\&quot;:\\\&quot;myid\\\&quot;,\\\&quot;vout\\\&quot;:0}]\&quot; \&quot;[{\\\&quot;data\\\&quot;:\\\&quot;00010203\\\&quot;}]\&quot;&quot;)</span></a>
<a name="4259"><span class="lineNum">    4259 </span>            :                                 },</a>
<a name="4260"><span class="lineNum">    4260 </span><span class="lineCov">         59 :                             }.Check(request);</span></a>
<a name="4261"><span class="lineNum">    4261 </span>            : </a>
<a name="4262"><span class="lineNum">    4262 </span><span class="lineCov">         55 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="4263"><span class="lineNum">    4263 </span><span class="lineCov">         55 :     if (!wallet) return NullUniValue;</span></a>
<a name="4264"><span class="lineNum">    4264 </span><span class="lineCov">         55 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="4265"><span class="lineNum">    4265 </span>            : </a>
<a name="4266"><span class="lineNum">    4266 </span><span class="lineCov">         55 :     RPCTypeCheck(request.params, {</span></a>
<a name="4267"><span class="lineNum">    4267 </span><span class="lineCov">         55 :         UniValue::VARR,</span></a>
<a name="4268"><span class="lineNum">    4268 </span><span class="lineCov">         55 :         UniValueType(), // ARR or OBJ, checked later</span></a>
<a name="4269"><span class="lineNum">    4269 </span><span class="lineCov">         55 :         UniValue::VNUM,</span></a>
<a name="4270"><span class="lineNum">    4270 </span><span class="lineCov">         55 :         UniValue::VOBJ,</span></a>
<a name="4271"><span class="lineNum">    4271 </span><span class="lineCov">         55 :         UniValue::VBOOL</span></a>
<a name="4272"><span class="lineNum">    4272 </span>            :         }, true</a>
<a name="4273"><span class="lineNum">    4273 </span>            :     );</a>
<a name="4274"><span class="lineNum">    4274 </span>            : </a>
<a name="4275"><span class="lineNum">    4275 </span><span class="lineCov">         55 :     CAmount fee;</span></a>
<a name="4276"><span class="lineNum">    4276 </span><span class="lineCov">         55 :     int change_position;</span></a>
<a name="4277"><span class="lineNum">    4277 </span><span class="lineCov">         55 :     bool rbf = pwallet-&gt;m_signal_rbf;</span></a>
<a name="4278"><span class="lineNum">    4278 </span><span class="lineCov">         55 :     const UniValue &amp;replaceable_arg = request.params[3][&quot;replaceable&quot;];</span></a>
<a name="4279"><span class="lineNum">    4279 </span><span class="lineCov">         55 :     if (!replaceable_arg.isNull()) {</span></a>
<a name="4280"><span class="lineNum">    4280 </span><span class="lineCov">          4 :         RPCTypeCheckArgument(replaceable_arg, UniValue::VBOOL);</span></a>
<a name="4281"><span class="lineNum">    4281 </span><span class="lineCov">          4 :         rbf = replaceable_arg.isTrue();</span></a>
<a name="4282"><span class="lineNum">    4282 </span><span class="lineCov">          4 :     }</span></a>
<a name="4283"><span class="lineNum">    4283 </span><span class="lineCov">         55 :     CMutableTransaction rawTx = ConstructTransaction(request.params[0], request.params[1], request.params[2], rbf);</span></a>
<a name="4284"><span class="lineNum">    4284 </span><span class="lineCov">         55 :     CCoinControl coin_control;</span></a>
<a name="4285"><span class="lineNum">    4285 </span>            :     // Automatically select coins, unless at least one is manually selected. Can</a>
<a name="4286"><span class="lineNum">    4286 </span>            :     // be overridden by options.add_inputs.</a>
<a name="4287"><span class="lineNum">    4287 </span><span class="lineCov">         55 :     coin_control.m_add_inputs = rawTx.vin.size() == 0;</span></a>
<a name="4288"><span class="lineNum">    4288 </span><span class="lineCov">         55 :     FundTransaction(pwallet, rawTx, fee, change_position, request.params[3], coin_control);</span></a>
<a name="4289"><span class="lineNum">    4289 </span>            : </a>
<a name="4290"><span class="lineNum">    4290 </span>            :     // Make a blank psbt</a>
<a name="4291"><span class="lineNum">    4291 </span><span class="lineCov">         45 :     PartiallySignedTransaction psbtx(rawTx);</span></a>
<a name="4292"><span class="lineNum">    4292 </span>            : </a>
<a name="4293"><span class="lineNum">    4293 </span>            :     // Fill transaction with out data but don't sign</a>
<a name="4294"><span class="lineNum">    4294 </span><span class="lineCov">         45 :     bool bip32derivs = request.params[4].isNull() ? true : request.params[4].get_bool();</span></a>
<a name="4295"><span class="lineNum">    4295 </span><span class="lineCov">         45 :     bool complete = true;</span></a>
<a name="4296"><span class="lineNum">    4296 </span><span class="lineCov">         45 :     const TransactionError err = pwallet-&gt;FillPSBT(psbtx, complete, 1, false, bip32derivs);</span></a>
<a name="4297"><span class="lineNum">    4297 </span><span class="lineCov">         45 :     if (err != TransactionError::OK) {</span></a>
<a name="4298"><span class="lineNum">    4298 </span><span class="lineNoCov">          0 :         throw JSONRPCTransactionError(err);</span></a>
<a name="4299"><span class="lineNum">    4299 </span>            :     }</a>
<a name="4300"><span class="lineNum">    4300 </span>            : </a>
<a name="4301"><span class="lineNum">    4301 </span>            :     // Serialize the PSBT</a>
<a name="4302"><span class="lineNum">    4302 </span><span class="lineCov">         45 :     CDataStream ssTx(SER_NETWORK, PROTOCOL_VERSION);</span></a>
<a name="4303"><span class="lineNum">    4303 </span><span class="lineCov">         45 :     ssTx &lt;&lt; psbtx;</span></a>
<a name="4304"><span class="lineNum">    4304 </span>            : </a>
<a name="4305"><span class="lineNum">    4305 </span><span class="lineCov">         45 :     UniValue result(UniValue::VOBJ);</span></a>
<a name="4306"><span class="lineNum">    4306 </span><span class="lineCov">         45 :     result.pushKV(&quot;psbt&quot;, EncodeBase64(ssTx.str()));</span></a>
<a name="4307"><span class="lineNum">    4307 </span><span class="lineCov">         45 :     result.pushKV(&quot;fee&quot;, ValueFromAmount(fee));</span></a>
<a name="4308"><span class="lineNum">    4308 </span><span class="lineCov">         45 :     result.pushKV(&quot;changepos&quot;, change_position);</span></a>
<a name="4309"><span class="lineNum">    4309 </span><span class="lineCov">         45 :     return result;</span></a>
<a name="4310"><span class="lineNum">    4310 </span><span class="lineCov">        227 : }</span></a>
<a name="4311"><span class="lineNum">    4311 </span>            : </a>
<a name="4312"><span class="lineNum">    4312 </span><span class="lineCov">          6 : static UniValue upgradewallet(const JSONRPCRequest&amp; request)</span></a>
<a name="4313"><span class="lineNum">    4313 </span>            : {</a>
<a name="4314"><span class="lineNum">    4314 </span><span class="lineCov">         18 :     RPCHelpMan{&quot;upgradewallet&quot;,</span></a>
<a name="4315"><span class="lineNum">    4315 </span><span class="lineCov">          6 :         &quot;\nUpgrade the wallet. Upgrades to the latest version if no version number is specified\n&quot;</span></a>
<a name="4316"><span class="lineNum">    4316 </span>            :         &quot;New keys may be generated and a new wallet backup will need to be made.&quot;,</a>
<a name="4317"><span class="lineNum">    4317 </span><span class="lineCov">         12 :         {</span></a>
<a name="4318"><span class="lineNum">    4318 </span><span class="lineCov">          6 :             {&quot;version&quot;, RPCArg::Type::NUM, /* default */ strprintf(&quot;%d&quot;, FEATURE_LATEST), &quot;The version number to upgrade to. Default is the latest wallet version&quot;}</span></a>
<a name="4319"><span class="lineNum">    4319 </span>            :         },</a>
<a name="4320"><span class="lineNum">    4320 </span><span class="lineCov">          6 :         RPCResults{},</span></a>
<a name="4321"><span class="lineNum">    4321 </span><span class="lineCov">          6 :         RPCExamples{</span></a>
<a name="4322"><span class="lineNum">    4322 </span><span class="lineCov">          6 :             HelpExampleCli(&quot;upgradewallet&quot;, &quot;169900&quot;)</span></a>
<a name="4323"><span class="lineNum">    4323 </span><span class="lineCov">          6 :             + HelpExampleRpc(&quot;upgradewallet&quot;, &quot;169900&quot;)</span></a>
<a name="4324"><span class="lineNum">    4324 </span>            :         }</a>
<a name="4325"><span class="lineNum">    4325 </span><span class="lineCov">          6 :     }.Check(request);</span></a>
<a name="4326"><span class="lineNum">    4326 </span>            : </a>
<a name="4327"><span class="lineNum">    4327 </span><span class="lineCov">          2 :     std::shared_ptr&lt;CWallet&gt; const wallet = GetWalletForJSONRPCRequest(request);</span></a>
<a name="4328"><span class="lineNum">    4328 </span><span class="lineCov">          2 :     if (!wallet) return NullUniValue;</span></a>
<a name="4329"><span class="lineNum">    4329 </span><span class="lineCov">          2 :     CWallet* const pwallet = wallet.get();</span></a>
<a name="4330"><span class="lineNum">    4330 </span>            : </a>
<a name="4331"><span class="lineNum">    4331 </span><span class="lineCov">          2 :     RPCTypeCheck(request.params, {UniValue::VNUM}, true);</span></a>
<a name="4332"><span class="lineNum">    4332 </span>            : </a>
<a name="4333"><span class="lineNum">    4333 </span><span class="lineCov">          2 :     EnsureWalletIsUnlocked(pwallet);</span></a>
<a name="4334"><span class="lineNum">    4334 </span>            : </a>
<a name="4335"><span class="lineNum">    4335 </span>            :     int version = 0;</a>
<a name="4336"><span class="lineNum">    4336 </span><span class="lineCov">          2 :     if (!request.params[0].isNull()) {</span></a>
<a name="4337"><span class="lineNum">    4337 </span><span class="lineCov">          1 :         version = request.params[0].get_int();</span></a>
<a name="4338"><span class="lineNum">    4338 </span><span class="lineCov">          1 :     }</span></a>
<a name="4339"><span class="lineNum">    4339 </span>            : </a>
<a name="4340"><span class="lineNum">    4340 </span><span class="lineCov">          2 :     bilingual_str error;</span></a>
<a name="4341"><span class="lineNum">    4341 </span><span class="lineCov">          2 :     std::vector&lt;bilingual_str&gt; warnings;</span></a>
<a name="4342"><span class="lineNum">    4342 </span><span class="lineCov">          2 :     if (!pwallet-&gt;UpgradeWallet(version, error, warnings)) {</span></a>
<a name="4343"><span class="lineNum">    4343 </span><span class="lineNoCov">          0 :         throw JSONRPCError(RPC_WALLET_ERROR, error.original);</span></a>
<a name="4344"><span class="lineNum">    4344 </span>            :     }</a>
<a name="4345"><span class="lineNum">    4345 </span><span class="lineCov">          2 :     return error.original;</span></a>
<a name="4346"><span class="lineNum">    4346 </span><span class="lineCov">         18 : }</span></a>
<a name="4347"><span class="lineNum">    4347 </span>            : </a>
<a name="4348"><span class="lineNum">    4348 </span>            : RPCHelpMan abortrescan();</a>
<a name="4349"><span class="lineNum">    4349 </span>            : RPCHelpMan dumpprivkey();</a>
<a name="4350"><span class="lineNum">    4350 </span>            : RPCHelpMan importprivkey();</a>
<a name="4351"><span class="lineNum">    4351 </span>            : RPCHelpMan importaddress();</a>
<a name="4352"><span class="lineNum">    4352 </span>            : RPCHelpMan importpubkey();</a>
<a name="4353"><span class="lineNum">    4353 </span>            : RPCHelpMan dumpwallet();</a>
<a name="4354"><span class="lineNum">    4354 </span>            : RPCHelpMan importwallet();</a>
<a name="4355"><span class="lineNum">    4355 </span>            : RPCHelpMan importprunedfunds();</a>
<a name="4356"><span class="lineNum">    4356 </span>            : RPCHelpMan removeprunedfunds();</a>
<a name="4357"><span class="lineNum">    4357 </span>            : RPCHelpMan importmulti();</a>
<a name="4358"><span class="lineNum">    4358 </span>            : RPCHelpMan importdescriptors();</a>
<a name="4359"><span class="lineNum">    4359 </span>            : </a>
<a name="4360"><span class="lineNum">    4360 </span><span class="lineCov">        531 : Span&lt;const CRPCCommand&gt; GetWalletRPCCommands()</span></a>
<a name="4361"><span class="lineNum">    4361 </span>            : {</a>
<a name="4362"><span class="lineNum">    4362 </span>            : // clang-format off</a>
<a name="4363"><span class="lineNum">    4363 </span><span class="lineCov">       1056 : static const CRPCCommand commands[] =</span></a>
<a name="4364"><span class="lineNum">    4364 </span><span class="lineCov">       6825 : { //  category              name                                actor (function)                argNames</span></a>
<a name="4365"><span class="lineNum">    4365 </span>            :     //  --------------------- ------------------------          -----------------------         ----------</a>
<a name="4366"><span class="lineNum">    4366 </span><span class="lineCov">        525 :     { &quot;rawtransactions&quot;,    &quot;fundrawtransaction&quot;,               &amp;fundrawtransaction,            {&quot;hexstring&quot;,&quot;options&quot;,&quot;iswitness&quot;} },</span></a>
<a name="4367"><span class="lineNum">    4367 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;abandontransaction&quot;,               &amp;abandontransaction,            {&quot;txid&quot;} },</span></a>
<a name="4368"><span class="lineNum">    4368 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;abortrescan&quot;,                      &amp;abortrescan,                   {} },</span></a>
<a name="4369"><span class="lineNum">    4369 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;addmultisigaddress&quot;,               &amp;addmultisigaddress,            {&quot;nrequired&quot;,&quot;keys&quot;,&quot;label&quot;,&quot;address_type&quot;} },</span></a>
<a name="4370"><span class="lineNum">    4370 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;backupwallet&quot;,                     &amp;backupwallet,                  {&quot;destination&quot;} },</span></a>
<a name="4371"><span class="lineNum">    4371 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;bumpfee&quot;,                          &amp;bumpfee,                       {&quot;txid&quot;, &quot;options&quot;} },</span></a>
<a name="4372"><span class="lineNum">    4372 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;psbtbumpfee&quot;,                      &amp;psbtbumpfee,                   {&quot;txid&quot;, &quot;options&quot;} },</span></a>
<a name="4373"><span class="lineNum">    4373 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;createwallet&quot;,                     &amp;createwallet,                  {&quot;wallet_name&quot;, &quot;disable_private_keys&quot;, &quot;blank&quot;, &quot;passphrase&quot;, &quot;avoid_reuse&quot;, &quot;descriptors&quot;, &quot;load_on_startup&quot;} },</span></a>
<a name="4374"><span class="lineNum">    4374 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;dumpprivkey&quot;,                      &amp;dumpprivkey,                   {&quot;address&quot;}  },</span></a>
<a name="4375"><span class="lineNum">    4375 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;dumpwallet&quot;,                       &amp;dumpwallet,                    {&quot;filename&quot;} },</span></a>
<a name="4376"><span class="lineNum">    4376 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;encryptwallet&quot;,                    &amp;encryptwallet,                 {&quot;passphrase&quot;} },</span></a>
<a name="4377"><span class="lineNum">    4377 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getaddressesbylabel&quot;,              &amp;getaddressesbylabel,           {&quot;label&quot;} },</span></a>
<a name="4378"><span class="lineNum">    4378 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getaddressinfo&quot;,                   &amp;getaddressinfo,                {&quot;address&quot;} },</span></a>
<a name="4379"><span class="lineNum">    4379 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getbalance&quot;,                       &amp;getbalance,                    {&quot;dummy&quot;,&quot;minconf&quot;,&quot;include_watchonly&quot;,&quot;avoid_reuse&quot;} },</span></a>
<a name="4380"><span class="lineNum">    4380 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getnewaddress&quot;,                    &amp;getnewaddress,                 {&quot;label&quot;,&quot;address_type&quot;} },</span></a>
<a name="4381"><span class="lineNum">    4381 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getrawchangeaddress&quot;,              &amp;getrawchangeaddress,           {&quot;address_type&quot;} },</span></a>
<a name="4382"><span class="lineNum">    4382 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getreceivedbyaddress&quot;,             &amp;getreceivedbyaddress,          {&quot;address&quot;,&quot;minconf&quot;} },</span></a>
<a name="4383"><span class="lineNum">    4383 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getreceivedbylabel&quot;,               &amp;getreceivedbylabel,            {&quot;label&quot;,&quot;minconf&quot;} },</span></a>
<a name="4384"><span class="lineNum">    4384 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;gettransaction&quot;,                   &amp;gettransaction,                {&quot;txid&quot;,&quot;include_watchonly&quot;,&quot;verbose&quot;} },</span></a>
<a name="4385"><span class="lineNum">    4385 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getunconfirmedbalance&quot;,            &amp;getunconfirmedbalance,         {} },</span></a>
<a name="4386"><span class="lineNum">    4386 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getbalances&quot;,                      &amp;getbalances,                   {} },</span></a>
<a name="4387"><span class="lineNum">    4387 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;getwalletinfo&quot;,                    &amp;getwalletinfo,                 {} },</span></a>
<a name="4388"><span class="lineNum">    4388 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importaddress&quot;,                    &amp;importaddress,                 {&quot;address&quot;,&quot;label&quot;,&quot;rescan&quot;,&quot;p2sh&quot;} },</span></a>
<a name="4389"><span class="lineNum">    4389 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importdescriptors&quot;,                &amp;importdescriptors,             {&quot;requests&quot;} },</span></a>
<a name="4390"><span class="lineNum">    4390 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importmulti&quot;,                      &amp;importmulti,                   {&quot;requests&quot;,&quot;options&quot;} },</span></a>
<a name="4391"><span class="lineNum">    4391 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importprivkey&quot;,                    &amp;importprivkey,                 {&quot;privkey&quot;,&quot;label&quot;,&quot;rescan&quot;} },</span></a>
<a name="4392"><span class="lineNum">    4392 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importprunedfunds&quot;,                &amp;importprunedfunds,             {&quot;rawtransaction&quot;,&quot;txoutproof&quot;} },</span></a>
<a name="4393"><span class="lineNum">    4393 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importpubkey&quot;,                     &amp;importpubkey,                  {&quot;pubkey&quot;,&quot;label&quot;,&quot;rescan&quot;} },</span></a>
<a name="4394"><span class="lineNum">    4394 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;importwallet&quot;,                     &amp;importwallet,                  {&quot;filename&quot;} },</span></a>
<a name="4395"><span class="lineNum">    4395 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;keypoolrefill&quot;,                    &amp;keypoolrefill,                 {&quot;newsize&quot;} },</span></a>
<a name="4396"><span class="lineNum">    4396 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listaddressgroupings&quot;,             &amp;listaddressgroupings,          {} },</span></a>
<a name="4397"><span class="lineNum">    4397 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listlabels&quot;,                       &amp;listlabels,                    {&quot;purpose&quot;} },</span></a>
<a name="4398"><span class="lineNum">    4398 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listlockunspent&quot;,                  &amp;listlockunspent,               {} },</span></a>
<a name="4399"><span class="lineNum">    4399 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listreceivedbyaddress&quot;,            &amp;listreceivedbyaddress,         {&quot;minconf&quot;,&quot;include_empty&quot;,&quot;include_watchonly&quot;,&quot;address_filter&quot;} },</span></a>
<a name="4400"><span class="lineNum">    4400 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listreceivedbylabel&quot;,              &amp;listreceivedbylabel,           {&quot;minconf&quot;,&quot;include_empty&quot;,&quot;include_watchonly&quot;} },</span></a>
<a name="4401"><span class="lineNum">    4401 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listsinceblock&quot;,                   &amp;listsinceblock,                {&quot;blockhash&quot;,&quot;target_confirmations&quot;,&quot;include_watchonly&quot;,&quot;include_removed&quot;} },</span></a>
<a name="4402"><span class="lineNum">    4402 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listtransactions&quot;,                 &amp;listtransactions,              {&quot;label|dummy&quot;,&quot;count&quot;,&quot;skip&quot;,&quot;include_watchonly&quot;} },</span></a>
<a name="4403"><span class="lineNum">    4403 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listunspent&quot;,                      &amp;listunspent,                   {&quot;minconf&quot;,&quot;maxconf&quot;,&quot;addresses&quot;,&quot;include_unsafe&quot;,&quot;query_options&quot;} },</span></a>
<a name="4404"><span class="lineNum">    4404 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listwalletdir&quot;,                    &amp;listwalletdir,                 {} },</span></a>
<a name="4405"><span class="lineNum">    4405 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;listwallets&quot;,                      &amp;listwallets,                   {} },</span></a>
<a name="4406"><span class="lineNum">    4406 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;loadwallet&quot;,                       &amp;loadwallet,                    {&quot;filename&quot;, &quot;load_on_startup&quot;} },</span></a>
<a name="4407"><span class="lineNum">    4407 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;lockunspent&quot;,                      &amp;lockunspent,                   {&quot;unlock&quot;,&quot;transactions&quot;} },</span></a>
<a name="4408"><span class="lineNum">    4408 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;removeprunedfunds&quot;,                &amp;removeprunedfunds,             {&quot;txid&quot;} },</span></a>
<a name="4409"><span class="lineNum">    4409 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;rescanblockchain&quot;,                 &amp;rescanblockchain,              {&quot;start_height&quot;, &quot;stop_height&quot;} },</span></a>
<a name="4410"><span class="lineNum">    4410 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;send&quot;,                             &amp;send,                          {&quot;outputs&quot;,&quot;conf_target&quot;,&quot;estimate_mode&quot;,&quot;options&quot;} },</span></a>
<a name="4411"><span class="lineNum">    4411 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;sendmany&quot;,                         &amp;sendmany,                      {&quot;dummy&quot;,&quot;amounts&quot;,&quot;minconf&quot;,&quot;comment&quot;,&quot;subtractfeefrom&quot;,&quot;replaceable&quot;,&quot;conf_target&quot;,&quot;estimate_mode&quot;} },</span></a>
<a name="4412"><span class="lineNum">    4412 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;sendtoaddress&quot;,                    &amp;sendtoaddress,                 {&quot;address&quot;,&quot;amount&quot;,&quot;comment&quot;,&quot;comment_to&quot;,&quot;subtractfeefromamount&quot;,&quot;replaceable&quot;,&quot;conf_target&quot;,&quot;estimate_mode&quot;,&quot;avoid_reuse&quot;} },</span></a>
<a name="4413"><span class="lineNum">    4413 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;sethdseed&quot;,                        &amp;sethdseed,                     {&quot;newkeypool&quot;,&quot;seed&quot;} },</span></a>
<a name="4414"><span class="lineNum">    4414 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;setlabel&quot;,                         &amp;setlabel,                      {&quot;address&quot;,&quot;label&quot;} },</span></a>
<a name="4415"><span class="lineNum">    4415 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;settxfee&quot;,                         &amp;settxfee,                      {&quot;amount&quot;} },</span></a>
<a name="4416"><span class="lineNum">    4416 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;setwalletflag&quot;,                    &amp;setwalletflag,                 {&quot;flag&quot;,&quot;value&quot;} },</span></a>
<a name="4417"><span class="lineNum">    4417 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;signmessage&quot;,                      &amp;signmessage,                   {&quot;address&quot;,&quot;message&quot;} },</span></a>
<a name="4418"><span class="lineNum">    4418 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;signrawtransactionwithwallet&quot;,     &amp;signrawtransactionwithwallet,  {&quot;hexstring&quot;,&quot;prevtxs&quot;,&quot;sighashtype&quot;} },</span></a>
<a name="4419"><span class="lineNum">    4419 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;unloadwallet&quot;,                     &amp;unloadwallet,                  {&quot;wallet_name&quot;, &quot;load_on_startup&quot;} },</span></a>
<a name="4420"><span class="lineNum">    4420 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;upgradewallet&quot;,                    &amp;upgradewallet,                 {&quot;version&quot;} },</span></a>
<a name="4421"><span class="lineNum">    4421 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;walletcreatefundedpsbt&quot;,           &amp;walletcreatefundedpsbt,        {&quot;inputs&quot;,&quot;outputs&quot;,&quot;locktime&quot;,&quot;options&quot;,&quot;bip32derivs&quot;} },</span></a>
<a name="4422"><span class="lineNum">    4422 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;walletlock&quot;,                       &amp;walletlock,                    {} },</span></a>
<a name="4423"><span class="lineNum">    4423 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;walletpassphrase&quot;,                 &amp;walletpassphrase,              {&quot;passphrase&quot;,&quot;timeout&quot;} },</span></a>
<a name="4424"><span class="lineNum">    4424 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;walletpassphrasechange&quot;,           &amp;walletpassphrasechange,        {&quot;oldpassphrase&quot;,&quot;newpassphrase&quot;} },</span></a>
<a name="4425"><span class="lineNum">    4425 </span><span class="lineCov">        525 :     { &quot;wallet&quot;,             &quot;walletprocesspsbt&quot;,                &amp;walletprocesspsbt,             {&quot;psbt&quot;,&quot;sign&quot;,&quot;sighashtype&quot;,&quot;bip32derivs&quot;} },</span></a>
<a name="4426"><span class="lineNum">    4426 </span>            : };</a>
<a name="4427"><span class="lineNum">    4427 </span>            : // clang-format on</a>
<a name="4428"><span class="lineNum">    4428 </span><span class="lineCov">        531 :     return MakeSpan(commands);</span></a>
<a name="4429"><span class="lineNum">    4429 </span><span class="lineCov">      31500 : }</span></a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.15</a></td></tr>
  </table>
  <br>

</body>
</html>
